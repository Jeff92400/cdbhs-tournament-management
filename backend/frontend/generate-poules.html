<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G√©n√©rer Poules - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .player-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .player-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .player-item:hover {
      background: #f5f5f5;
    }
    .player-item.selected {
      background: #e3f2fd;
    }
    .player-item.new-player {
      background: #fff3e0;
    }
    .player-item.new-player.selected {
      background: #ffe0b2;
    }
    .player-item input[type="checkbox"] {
      margin-right: 15px;
      transform: scale(1.2);
    }
    .player-rank {
      width: 40px;
      font-weight: bold;
      color: #1F4788;
    }
    .player-name {
      flex: 1;
      font-weight: 500;
    }
    .player-club {
      color: #666;
      font-size: 0.9em;
      margin-left: 10px;
    }
    .player-licence {
      color: #999;
      font-size: 0.85em;
      margin-left: 10px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      margin-left: 10px;
    }
    .badge-new {
      background: #ff9800;
      color: white;
    }
    .badge-forfait {
      background: #dc3545;
      color: white;
    }
    .poule-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .poule-card {
      border: 2px solid #1F4788;
      border-radius: 8px;
      padding: 15px;
      background: white;
    }
    .poule-card h4 {
      margin: 0 0 10px 0;
      color: #1F4788;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .poule-player {
      padding: 5px 0;
      display: flex;
      align-items: center;
    }
    .poule-player-rank {
      width: 25px;
      font-weight: bold;
      color: #666;
    }
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }
    .step {
      display: flex;
      align-items: center;
      color: #999;
    }
    .step.active {
      color: #1F4788;
      font-weight: bold;
    }
    .step.completed {
      color: #28a745;
    }
    .step-number {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-weight: bold;
    }
    .step.active .step-number {
      background: #1F4788;
      color: white;
    }
    .step.completed .step-number {
      background: #28a745;
      color: white;
    }
    .step-separator {
      width: 50px;
      height: 2px;
      background: #ddd;
      margin: 0 15px;
    }
    .summary-box {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> G√©n√©rer Poules</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="players-list.html">Joueurs</a>
        <a href="import-external.html" class="admin-only">Import Externe</a>
        <a href="tournaments-list.html">Tournois</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">G√©n√©rer Poules</a>
        <a href="settings.html">Parametres</a>
        <a href="#" id="logoutBtn">Deconnexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step1Indicator">
        <span class="step-number">1</span>
        <span>S√©lection</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" id="step2Indicator">
        <span class="step-number">2</span>
        <span>Joueurs</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" id="step3Indicator">
        <span class="step-number">3</span>
        <span>Validation</span>
      </div>
      <div class="step-separator"></div>
      <div class="step" id="step4Indicator">
        <span class="step-number">4</span>
        <span>G√©n√©ration</span>
      </div>
    </div>

    <!-- Step 1: Select Tournament -->
    <div class="card" id="step1">
      <h3>√âtape 1: S√©lectionner le Tournoi</h3>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
        <div>
          <label for="categorySelect" style="display: block; margin-bottom: 5px; font-weight: 500;">Cat√©gorie</label>
          <select id="categorySelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- S√©lectionner --</option>
          </select>
        </div>
        <div>
          <label for="seasonSelect" style="display: block; margin-bottom: 5px; font-weight: 500;">Saison</label>
          <select id="seasonSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- S√©lectionner --</option>
          </select>
        </div>
        <div>
          <label for="tournamentSelect" style="display: block; margin-bottom: 5px; font-weight: 500;">Tournoi √† pr√©parer</label>
          <select id="tournamentSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">-- S√©lectionner --</option>
            <option value="1">Tournoi 1</option>
            <option value="2">Tournoi 2</option>
            <option value="3">Tournoi 3</option>
            <option value="4">Finale D√©partementale</option>
          </select>
        </div>
      </div>

      <div id="tournamentInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1F4788;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong id="tournamentInfoName" style="color: #1F4788; font-size: 1.1em;">-</strong>
            <p style="margin: 5px 0 0 0; color: #666;">
              Date: <strong id="tournamentInfoDate">-</strong> |
              Lieu: <strong id="tournamentInfoLieu">-</strong> |
              Inscrits: <strong id="tournamentInfoInscrits">-</strong>
            </p>
          </div>
        </div>
      </div>

      <button class="btn" id="loadPlayersBtn" disabled>Charger les joueurs</button>
    </div>

    <!-- Step 2: Select Players -->
    <div class="card" id="step2" style="display: none;">
      <h3>√âtape 2: S√©lectionner les Joueurs</h3>

      <div class="summary-box">
        <div class="summary-row">
          <span>Joueurs s√©lectionn√©s:</span>
          <strong id="selectedCount">0</strong>
        </div>
        <div class="summary-row">
          <span>Configuration des poules:</span>
          <strong id="pouleConfig">-</strong>
        </div>
        <div class="summary-row">
          <span>Tables n√©cessaires:</span>
          <strong id="tablesNeeded">-</strong>
        </div>
      </div>

      <div style="margin-bottom: 15px; display: flex; gap: 10px;">
        <button class="btn" id="selectAllBtn">Tout s√©lectionner</button>
        <button class="btn" id="deselectAllBtn" style="background: #6c757d;">Tout d√©s√©lectionner</button>
        <button class="btn" id="selectRegisteredBtn" style="background: #17a2b8;">S√©lectionner les inscrits</button>
      </div>

      <h4>Joueurs class√©s (du classement actuel)</h4>
      <div class="player-list" id="rankedPlayersList">
        <p style="padding: 20px; color: #666; text-align: center;">Chargement...</p>
      </div>

      <h4 style="margin-top: 20px;">Nouveaux joueurs (inscrits non class√©s)</h4>
      <div class="player-list" id="newPlayersList">
        <p style="padding: 20px; color: #666; text-align: center;">Aucun nouveau joueur</p>
      </div>

      <div class="action-buttons">
        <button class="btn" id="backToStep1Btn" style="background: #6c757d;">Retour</button>
        <button class="btn" id="validatePlayersBtn" disabled>Valider la liste</button>
      </div>
    </div>

    <!-- Step 3: Validate & Preview -->
    <div class="card" id="step3" style="display: none;">
      <h3>√âtape 3: Validation et Aper√ßu</h3>

      <div class="summary-box">
        <div class="summary-row">
          <span>Cat√©gorie:</span>
          <strong id="summaryCategory">-</strong>
        </div>
        <div class="summary-row">
          <span>Tournoi:</span>
          <strong id="summaryTournament">-</strong>
        </div>
        <div class="summary-row">
          <span>Date:</span>
          <strong id="summaryDate">-</strong>
        </div>
        <div class="summary-row">
          <span>Lieu:</span>
          <strong id="summaryLieu">-</strong>
        </div>
        <div class="summary-row">
          <span>Nombre de joueurs:</span>
          <strong id="summaryPlayers">-</strong>
        </div>
        <div class="summary-row">
          <span>Configuration:</span>
          <strong id="summaryConfig">-</strong>
        </div>
        <div class="summary-row">
          <span>Tables n√©cessaires:</span>
          <strong id="summaryTables">-</strong>
        </div>
      </div>

      <h4>Aper√ßu des Poules (Distribution Serpentine)</h4>
      <div class="poule-preview" id="poulePreview">
        <!-- Poules will be rendered here -->
      </div>

      <div class="action-buttons">
        <button class="btn" id="backToStep2Btn" style="background: #6c757d;">Modifier la liste</button>
        <button class="btn btn-success" id="generateExcelBtn" style="background: #28a745;">G√©n√©rer le fichier Excel</button>
      </div>
    </div>

    <!-- Step 4: Download -->
    <div class="card" id="step4" style="display: none;">
      <h3>√âtape 4: T√©l√©chargement</h3>
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚úÖ</div>
        <h4>Fichier g√©n√©r√© avec succ√®s !</h4>
        <p style="color: #666; margin-bottom: 20px;">Le fichier Excel a √©t√© t√©l√©charg√© automatiquement.</p>
        <div class="action-buttons" style="justify-content: center;">
          <button class="btn" id="backToStep3Btn" style="background: #6c757d;">Retour √† l'aper√ßu</button>
          <button class="btn" id="newGenerationBtn">Nouvelle g√©n√©ration</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // State
    let categories = [];
    let rankedPlayers = [];
    let newPlayers = [];
    let selectedPlayers = [];
    let currentCategory = null;
    let currentSeason = null;
    let currentTournament = null;
    let externalTournois = [];
    let matchingTournoi = null;

    // Poule configuration based on number of players
    const POULE_CONFIG = {
      3: { poules: [3], tables: 1 },
      4: { poules: [4], tables: 2 },
      5: { poules: [5], tables: 2 },
      6: { poules: [3, 3], tables: 2 },
      7: { poules: [3, 4], tables: 3 },
      8: { poules: [3, 5], tables: 3 },
      9: { poules: [3, 3, 3], tables: 3 },
      10: { poules: [3, 3, 4], tables: 4 },
      11: { poules: [3, 3, 5], tables: 4 },
      12: { poules: [3, 3, 3, 3], tables: 4 },
      13: { poules: [3, 3, 3, 4], tables: 5 },
      14: { poules: [3, 3, 3, 5], tables: 5 },
      15: { poules: [3, 3, 3, 3, 3], tables: 5 },
      16: { poules: [3, 3, 3, 3, 4], tables: 6 },
      17: { poules: [3, 3, 3, 3, 5], tables: 6 },
      18: { poules: [3, 3, 3, 3, 3, 3], tables: 6 },
      19: { poules: [3, 3, 3, 3, 3, 4], tables: 7 },
      20: { poules: [3, 3, 3, 3, 3, 5], tables: 7 }
    };

    // Get poule configuration for a given number of players
    function getPouleConfig(numPlayers) {
      if (numPlayers < 3) {
        return { poules: [], tables: 0, description: 'Pas assez de joueurs' };
      }
      if (numPlayers > 20) {
        // Extend pattern for more than 20 players
        const base = Math.floor(numPlayers / 3);
        const remainder = numPlayers % 3;
        const poules = Array(base).fill(3);
        if (remainder === 1) {
          poules[poules.length - 1] = 4;
        } else if (remainder === 2) {
          poules[poules.length - 1] = 5;
        }
        return {
          poules,
          tables: poules.length + 1,
          description: poules.map((p, i) => `Poule ${i + 1}: ${p}`).join(', ')
        };
      }
      const config = POULE_CONFIG[numPlayers];
      const description = config.poules.length === 1
        ? `1 poule de ${config.poules[0]}`
        : config.poules.map((p, i) => `${p}`).join(' + ') + ` (${config.poules.length} poules)`;
      return { ...config, description };
    }

    // Serpentine distribution
    function distributeSerpentine(players, pouleSizes) {
      const numPoules = pouleSizes.length;
      const poules = pouleSizes.map((size, i) => ({
        number: i + 1,
        size,
        players: []
      }));

      let playerIndex = 0;
      let round = 0;

      while (playerIndex < players.length) {
        const isLeftToRight = round % 2 === 0;

        for (let i = 0; i < numPoules && playerIndex < players.length; i++) {
          const pouleIndex = isLeftToRight ? i : (numPoules - 1 - i);
          const poule = poules[pouleIndex];

          if (poule.players.length < poule.size) {
            poules[pouleIndex].players.push({
              ...players[playerIndex],
              originalRank: playerIndex + 1
            });
            playerIndex++;
          }
        }
        round++;
      }

      return poules;
    }

    // Load categories
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const tournaments = await response.json();

          // Extract unique categories
          const categoryMap = new Map();
          tournaments.forEach(t => {
            const key = `${t.game_type}-${t.level}`;
            if (!categoryMap.has(key)) {
              categoryMap.set(key, {
                id: t.category_id,
                game_type: t.game_type,
                level: t.level,
                display_name: t.display_name
              });
            }
          });

          categories = Array.from(categoryMap.values());

          const select = document.getElementById('categorySelect');
          select.innerHTML = '<option value="">-- S√©lectionner --</option>';
          categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.id}">${cat.display_name}</option>`;
          });

          // Extract unique seasons
          const seasons = [...new Set(tournaments.map(t => t.season))].sort().reverse();
          const seasonSelect = document.getElementById('seasonSelect');
          seasonSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
          seasons.forEach(season => {
            seasonSelect.innerHTML += `<option value="${season}">${season}</option>`;
          });

          // Pre-select current season if available
          if (seasons.length > 0) {
            seasonSelect.value = seasons[0];
            currentSeason = seasons[0];
          }
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    loadCategories();

    // Update load button state and load tournament info
    function updateLoadButtonState() {
      const categoryId = document.getElementById('categorySelect').value;
      const season = document.getElementById('seasonSelect').value;
      const tournament = document.getElementById('tournamentSelect').value;

      document.getElementById('loadPlayersBtn').disabled = !categoryId || !season || !tournament;

      // Load tournament info if all fields are selected
      if (categoryId && tournament) {
        loadTournamentInfo(categoryId, tournament);
      } else {
        document.getElementById('tournamentInfo').style.display = 'none';
        matchingTournoi = null;
      }
    }

    // Load external tournament info
    async function loadTournamentInfo(categoryId, tournamentNum) {
      const category = categories.find(c => c.id == categoryId);
      if (!category) return;

      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi?mode=${category.game_type}&categorie=${category.level}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          externalTournois = await response.json();

          // Find matching tournament by name
          const targetName = tournamentNum === '4' ? 'FINALE' : `TOURNOI ${tournamentNum}`;
          matchingTournoi = externalTournois.find(t =>
            t.nom.toUpperCase().includes(targetName) ||
            (tournamentNum === '4' && t.nom.toUpperCase().includes('FINALE'))
          );

          if (matchingTournoi) {
            // Load inscription count
            const inscResponse = await fetch(`${API_URL}/inscriptions/tournoi/${matchingTournoi.tournoi_id}/inscriptions`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            let inscCount = 0;
            if (inscResponse.ok) {
              const inscriptions = await inscResponse.json();
              inscCount = inscriptions.filter(i => i.forfait !== 1).length;
            }

            // Format date
            const dateStr = matchingTournoi.debut
              ? new Date(matchingTournoi.debut).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
              : 'Non d√©finie';

            document.getElementById('tournamentInfoName').textContent =
              `${category.display_name} - ${matchingTournoi.nom}`;
            document.getElementById('tournamentInfoDate').textContent = dateStr;
            document.getElementById('tournamentInfoLieu').textContent = matchingTournoi.lieu || 'Non d√©fini';
            document.getElementById('tournamentInfoInscrits').textContent = `${inscCount} joueurs`;
            document.getElementById('tournamentInfo').style.display = 'block';
          } else {
            document.getElementById('tournamentInfo').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading tournament info:', error);
        document.getElementById('tournamentInfo').style.display = 'none';
      }
    }

    document.getElementById('categorySelect').addEventListener('change', updateLoadButtonState);
    document.getElementById('seasonSelect').addEventListener('change', updateLoadButtonState);
    document.getElementById('tournamentSelect').addEventListener('change', updateLoadButtonState);

    // Load players for selected category
    document.getElementById('loadPlayersBtn').addEventListener('click', async () => {
      const categoryId = document.getElementById('categorySelect').value;
      const season = document.getElementById('seasonSelect').value;
      const tournamentNum = document.getElementById('tournamentSelect').value;

      currentCategory = categories.find(c => c.id == categoryId);
      currentSeason = season;
      currentTournament = tournamentNum;

      // Determine which ranking to load based on tournament number
      const previousTournament = parseInt(tournamentNum) - 1;

      try {
        // Load ranking from previous tournament(s)
        if (previousTournament >= 1) {
          const rankingResponse = await fetch(`${API_URL}/rankings?categoryId=${categoryId}&season=${season}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (rankingResponse.ok) {
            const rankings = await rankingResponse.json();
            rankedPlayers = rankings.map((r, index) => ({
              licence: r.licence,
              first_name: r.first_name,
              last_name: r.last_name,
              club: r.club,
              rank: r.rank_position,
              total_match_points: r.total_match_points,
              isRanked: true
            }));
          }
        } else {
          // T1 - no previous ranking, would need to use player list
          rankedPlayers = [];
        }

        // Load inscriptions using the already-matched tournament
        if (matchingTournoi) {
          const inscriptionsResponse = await fetch(`${API_URL}/inscriptions/tournoi/${matchingTournoi.tournoi_id}/inscriptions`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (inscriptionsResponse.ok) {
            const inscriptions = await inscriptionsResponse.json();

            // Find new players (inscribed but not in ranking)
            const rankedLicences = new Set(rankedPlayers.map(p => p.licence.replace(/\s/g, '')));

            newPlayers = inscriptions
              .filter(i => !rankedLicences.has(i.licence?.replace(/\s/g, '')) && i.forfait !== 1)
              .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
              .map((i, index) => ({
                licence: i.licence,
                first_name: i.first_name || 'Inconnu',
                last_name: i.last_name || 'Inconnu',
                club: i.club || '',
                timestamp: i.timestamp,
                isNew: true,
                forfait: i.forfait
              }));

            // Mark ranked players who are inscribed or forfait
            rankedPlayers.forEach(p => {
              const inscription = inscriptions.find(i =>
                i.licence?.replace(/\s/g, '') === p.licence?.replace(/\s/g, '')
              );
              if (inscription) {
                p.isInscribed = true;
                p.forfait = inscription.forfait === 1;
              }
            });
          }
        } else {
          // No matching external tournament found - clear new players
          newPlayers = [];
        }

        renderPlayerLists();
        goToStep(2);

      } catch (error) {
        console.error('Error loading players:', error);
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des joueurs';
        document.getElementById('errorMessage').style.display = 'block';
      }
    });

    // Render player lists
    function renderPlayerLists() {
      const rankedList = document.getElementById('rankedPlayersList');
      const newList = document.getElementById('newPlayersList');

      if (rankedPlayers.length === 0) {
        rankedList.innerHTML = '<p style="padding: 20px; color: #666; text-align: center;">Aucun classement disponible pour ce tournoi</p>';
      } else {
        rankedList.innerHTML = rankedPlayers.map((p, index) => `
          <div class="player-item ${p.selected ? 'selected' : ''} ${p.forfait ? 'forfait' : ''}"
               data-licence="${p.licence}" data-type="ranked" data-index="${index}">
            <input type="checkbox" ${p.selected ? 'checked' : ''} ${p.forfait ? 'disabled' : ''}>
            <span class="player-rank">#${p.rank}</span>
            <span class="player-name">${p.last_name} ${p.first_name}</span>
            <span class="player-club">${p.club || ''}</span>
            <span class="player-licence">${p.licence}</span>
            ${p.forfait ? '<span class="badge badge-forfait">Forfait</span>' : ''}
          </div>
        `).join('');
      }

      if (newPlayers.length === 0) {
        newList.innerHTML = '<p style="padding: 20px; color: #666; text-align: center;">Aucun nouveau joueur inscrit</p>';
      } else {
        newList.innerHTML = newPlayers.map((p, index) => `
          <div class="player-item new-player ${p.selected ? 'selected' : ''}"
               data-licence="${p.licence}" data-type="new" data-index="${index}">
            <input type="checkbox" ${p.selected ? 'checked' : ''}>
            <span class="player-rank">-</span>
            <span class="player-name">${p.last_name} ${p.first_name}</span>
            <span class="player-club">${p.club || ''}</span>
            <span class="player-licence">${p.licence}</span>
            <span class="badge badge-new">Nouveau</span>
          </div>
        `).join('');
      }

      // Add click handlers
      document.querySelectorAll('.player-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if (e.target.type === 'checkbox') return;
          if (item.classList.contains('forfait')) return;

          const checkbox = item.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          togglePlayerSelection(item);
        });

        item.querySelector('input[type="checkbox"]').addEventListener('change', () => {
          togglePlayerSelection(item);
        });
      });

      updateSelectionSummary();
    }

    function togglePlayerSelection(item) {
      const type = item.dataset.type;
      const index = parseInt(item.dataset.index);
      const checkbox = item.querySelector('input[type="checkbox"]');

      if (type === 'ranked') {
        rankedPlayers[index].selected = checkbox.checked;
      } else {
        newPlayers[index].selected = checkbox.checked;
      }

      item.classList.toggle('selected', checkbox.checked);
      updateSelectionSummary();
    }

    function updateSelectionSummary() {
      const selectedRanked = rankedPlayers.filter(p => p.selected);
      const selectedNew = newPlayers.filter(p => p.selected);
      const totalSelected = selectedRanked.length + selectedNew.length;

      document.getElementById('selectedCount').textContent = totalSelected;

      if (totalSelected >= 3) {
        const config = getPouleConfig(totalSelected);
        document.getElementById('pouleConfig').textContent = config.description;
        document.getElementById('tablesNeeded').textContent = config.tables;
        document.getElementById('validatePlayersBtn').disabled = false;
      } else {
        document.getElementById('pouleConfig').textContent = '-';
        document.getElementById('tablesNeeded').textContent = '-';
        document.getElementById('validatePlayersBtn').disabled = true;
      }
    }

    // Selection buttons
    document.getElementById('selectAllBtn').addEventListener('click', () => {
      rankedPlayers.forEach(p => { if (!p.forfait) p.selected = true; });
      newPlayers.forEach(p => p.selected = true);
      renderPlayerLists();
    });

    document.getElementById('deselectAllBtn').addEventListener('click', () => {
      rankedPlayers.forEach(p => p.selected = false);
      newPlayers.forEach(p => p.selected = false);
      renderPlayerLists();
    });

    document.getElementById('selectRegisteredBtn').addEventListener('click', () => {
      rankedPlayers.forEach(p => {
        p.selected = p.isInscribed && !p.forfait;
      });
      newPlayers.forEach(p => p.selected = true);
      renderPlayerLists();
    });

    // Navigation
    function goToStep(stepNum) {
      document.querySelectorAll('.card[id^="step"]').forEach(card => card.style.display = 'none');
      document.getElementById(`step${stepNum}`).style.display = 'block';

      document.querySelectorAll('.step').forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index + 1 < stepNum) step.classList.add('completed');
        if (index + 1 === stepNum) step.classList.add('active');
      });
    }

    document.getElementById('backToStep1Btn').addEventListener('click', () => goToStep(1));
    document.getElementById('backToStep2Btn').addEventListener('click', () => goToStep(2));
    document.getElementById('backToStep3Btn').addEventListener('click', () => goToStep(3));
    document.getElementById('newGenerationBtn').addEventListener('click', () => {
      // Reset state
      rankedPlayers = [];
      newPlayers = [];
      selectedPlayers = [];
      goToStep(1);
    });

    // Validate and preview
    document.getElementById('validatePlayersBtn').addEventListener('click', () => {
      // Build final player list with re-ranking
      selectedPlayers = [];

      // First add selected ranked players (maintaining their rank order but re-numbering)
      let newRank = 1;
      rankedPlayers.filter(p => p.selected).forEach(p => {
        selectedPlayers.push({
          ...p,
          finalRank: newRank++
        });
      });

      // Then add new players sorted by timestamp
      newPlayers.filter(p => p.selected).forEach(p => {
        selectedPlayers.push({
          ...p,
          finalRank: newRank++
        });
      });

      // Update summary
      document.getElementById('summaryCategory').textContent = currentCategory.display_name;
      document.getElementById('summaryTournament').textContent =
        currentTournament === '4' ? 'Finale D√©partementale' : `Tournoi ${currentTournament}`;

      // Add tournament date and lieu from external tournament
      if (matchingTournoi) {
        const dateStr = matchingTournoi.debut
          ? new Date(matchingTournoi.debut).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })
          : 'Non d√©finie';
        document.getElementById('summaryDate').textContent = dateStr;
        document.getElementById('summaryLieu').textContent = matchingTournoi.lieu || 'Non d√©fini';
      } else {
        document.getElementById('summaryDate').textContent = 'Non d√©finie';
        document.getElementById('summaryLieu').textContent = 'Non d√©fini';
      }

      document.getElementById('summaryPlayers').textContent = selectedPlayers.length;

      const config = getPouleConfig(selectedPlayers.length);
      document.getElementById('summaryConfig').textContent = config.description;
      document.getElementById('summaryTables').textContent = config.tables;

      // Generate poule preview
      const poules = distributeSerpentine(selectedPlayers, config.poules);
      renderPoulePreview(poules);

      goToStep(3);
    });

    function renderPoulePreview(poules) {
      const container = document.getElementById('poulePreview');
      container.innerHTML = poules.map(poule => `
        <div class="poule-card">
          <h4>Poule ${poule.number} (${poule.players.length} joueurs)</h4>
          ${poule.players.map((p, index) => `
            <div class="poule-player">
              <span class="poule-player-rank">${index + 1}.</span>
              <span>${p.last_name} ${p.first_name} <strong style="color: #1F4788;">(${p.finalRank})</strong></span>
              ${p.isNew ? '<span class="badge badge-new" style="margin-left: auto;">Nouveau</span>' : ''}
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    // Generate Excel
    document.getElementById('generateExcelBtn').addEventListener('click', async () => {
      const config = getPouleConfig(selectedPlayers.length);
      const poules = distributeSerpentine(selectedPlayers, config.poules);

      try {
        const response = await fetch(`${API_URL}/inscriptions/generate-poules`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            category: currentCategory,
            season: currentSeason,
            tournament: currentTournament,
            players: selectedPlayers,
            poules: poules,
            config: config,
            tournamentDate: matchingTournoi?.debut || null,
            tournamentLieu: matchingTournoi?.lieu || null
          })
        });

        if (response.ok) {
          // Download the file
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Poules_${currentCategory.display_name}_T${currentTournament}_${currentSeason}.xlsx`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);

          goToStep(4);
        } else {
          const error = await response.json();
          document.getElementById('errorMessage').textContent = error.error || 'Erreur lors de la g√©n√©ration';
          document.getElementById('errorMessage').style.display = 'block';
        }
      } catch (error) {
        console.error('Error generating Excel:', error);
        document.getElementById('errorMessage').textContent = 'Erreur lors de la g√©n√©ration du fichier';
        document.getElementById('errorMessage').style.display = 'block';
      }
    });
  </script>
</body>
</html>
