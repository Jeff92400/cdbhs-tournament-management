<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="active">Accueil</a>

        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">Fichiers</button>
          <div class="nav-dropdown-content">
            <a href="players-list.html"><span class="nav-icon">üë•</span> Joueurs</a>
            <a href="tournaments-list.html"><span class="nav-icon">üèÜ</span> Tournois jou√©s</a>
            <a href="import-external.html"><span class="nav-icon">üìã</span> Comp√©titions & Inscriptions</a>
            <a href="clubs.html"><span class="nav-icon">üè¢</span> Clubs</a>
            <div class="nav-divider admin-only"></div>
            <a href="import-players.html" class="admin-only"><span class="nav-icon">üì•</span> Import Joueurs</a>
            <a href="import-tournament.html" class="admin-only"><span class="nav-icon">üì§</span> Import Tournoi</a>
          </div>
        </div>

        <a href="rankings.html">Classements</a>
        <a href="tournaments-list.html">Tournois jou√©s</a>
        <a href="generate-poules.html">Tournois √† jouer</a>

        <div class="nav-dropdown">
          <button class="nav-dropdown-btn">Param√®tres</button>
          <div class="nav-dropdown-content">
            <a href="settings.html"><span class="nav-icon">‚öôÔ∏è</span> Configuration</a>
            <a href="calendar.html"><span class="nav-icon">üìÖ</span> Calendrier</a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <h4>Joueurs Actifs</h4>
        <div class="stat-value" id="activePlayerCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Total Joueurs</h4>
        <div class="stat-value" id="totalPlayerCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Comp√©titions Import√©es</h4>
        <div class="stat-value" id="tournamentCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Cat√©gories</h4>
        <div class="stat-value">13</div>
      </div>
    </div>

    <div class="card">
      <h3>Actions Rapides</h3>
      <div class="action-buttons">
        <button class="btn" onclick="window.location.href='players-list.html'">
          Liste des Joueurs
        </button>
        <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
          Importer un Tournoi
        </button>
        <button class="btn" onclick="window.location.href='rankings.html'">
          Voir les Classements
        </button>
      </div>
    </div>

    <div class="card">
      <h3>Derniers Tournois Import√©s</h3>
      <div id="loadingTournaments" class="loading">
        <div class="spinner"></div>
        Chargement...
      </div>
      <div id="tournamentsTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Cat√©gorie</th>
                <th>Tournoi</th>
                <th>Saison</th>
                <th>Participants</th>
                <th>Date du tournoi</th>
                <th style="width: 120px; text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="tournamentsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load player counts (active and total)
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        // Check for authentication errors
        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
          document.getElementById('totalPlayerCount').textContent = allPlayers.length;
        }

        // Load tournaments
        const tournamentsResponse = await fetch(`${API_URL}/tournaments`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        // Check for authentication errors
        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Sort tournaments by import date (newest first)
          tournaments.sort((a, b) => {
            const dateA = new Date(a.tournament_date || a.import_date);
            const dateB = new Date(b.tournament_date || b.import_date);
            return dateB - dateA; // Descending order (newest first)
          });

          // Get the 5 most recent tournaments
          const recentTournaments = tournaments.slice(0, 5);
          const tbody = document.getElementById('tournamentsBody');
          tbody.innerHTML = '';

          if (recentTournaments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Aucun tournoi import√©</td></tr>';
          } else {
            // Display the 5 most recent tournaments
            recentTournaments.forEach(tournament => {
              const row = document.createElement('tr');
              const tournamentLabel = tournament.tournament_number === 4 ? 'Finale D√©partementale' : `Tournoi ${tournament.tournament_number}`;
              const deleteBtn = userRole === 'admin'
                ? `<button class="btn-delete" data-tournament-id="${tournament.id}" data-tournament-name="${tournament.display_name} - T${tournament.tournament_number} - ${tournament.season}" title="Supprimer ce tournoi" style="background: #dc3545; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 16px;">üóëÔ∏è</button>`
                : '';
              row.innerHTML = `
                <td class="tournament-cell">${tournament.display_name}</td>
                <td class="tournament-cell">${tournamentLabel}</td>
                <td class="tournament-cell">${tournament.season}</td>
                <td class="tournament-cell">${tournament.player_count}</td>
                <td class="tournament-cell">${tournament.tournament_date ? new Date(tournament.tournament_date).toLocaleDateString('fr-FR') : 'N/A'}</td>
                <td style="text-align: center; padding: 8px;">
                  <button class="btn-view" data-tournament-id="${tournament.id}" title="Voir les resultats" style="background: #28a745; color: white; border: none; padding: 6px 10px; cursor: pointer; border-radius: 4px; font-size: 14px; margin-right: 5px;">Voir</button>
                  ${deleteBtn}
                </td>
              `;

              // Make cells clickable for navigation (but not delete button)
              const cells = row.querySelectorAll('.tournament-cell');
              cells.forEach(cell => {
                cell.style.cursor = 'pointer';
                cell.onclick = () => {
                  window.location.href = `rankings.html?categoryId=${tournament.category_id}&season=${encodeURIComponent(tournament.season)}`;
                };
                cell.onmouseover = () => row.style.background = '#f5f5f5';
                cell.onmouseout = () => row.style.background = '';
              });

              // Handle view button click
              const viewBtn = row.querySelector('.btn-view');
              viewBtn.onclick = (e) => {
                e.stopPropagation();
                window.location.href = `tournament-results.html?id=${tournament.id}`;
              };

              // Handle delete button click (only for admin)
              const deleteBtnEl = row.querySelector('.btn-delete');
              if (deleteBtnEl) {
                deleteBtnEl.onclick = async (e) => {
                  e.stopPropagation();
                  const tournamentName = deleteBtnEl.getAttribute('data-tournament-name');
                  if (confirm(`√ätes-vous s√ªr de vouloir supprimer le tournoi "${tournamentName}" ?\n\nCette action supprimera tous les r√©sultats et recalculera les classements.`)) {
                    await deleteTournament(tournament.id);
                  }
                };
              }

              tbody.appendChild(row);
            });
          }

          document.getElementById('loadingTournaments').style.display = 'none';
          document.getElementById('tournamentsTable').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loadingTournaments').innerHTML = '<p style="color: red;">Erreur de chargement des donn√©es</p>';
      }
    }

    // Delete tournament function
    async function deleteTournament(tournamentId) {
      try {
        console.log('Deleting tournament:', tournamentId);
        console.log('URL:', `${API_URL}/tournaments/${tournamentId}`);

        const response = await fetch(`${API_URL}/tournaments/${tournamentId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('Delete response status:', response.status);

        if (response.ok) {
          // Show success message
          const successDiv = document.getElementById('successMessage');
          successDiv.textContent = 'Tournoi supprim√© avec succ√®s ! Les classements ont √©t√© recalcul√©s.';
          successDiv.style.display = 'block';

          // Hide success message after 3 seconds
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);

          // Reload dashboard to show updated list
          loadDashboard();
        } else {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            errorData = { error: errorText };
          }
          alert(`Erreur lors de la suppression: ${errorData.error || 'Erreur inconnue'}`);
        }
      } catch (error) {
        console.error('Error deleting tournament:', error);
        console.error('Error details:', error.message, error.stack);
        alert(`Erreur de connexion lors de la suppression du tournoi: ${error.message}`);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
