<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Joueurs - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .club-cell {
      position: relative;
      cursor: pointer;
    }
    .club-cell:hover {
      background-color: #f5f5f5;
    }
    .club-edit-container {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .club-edit-select {
      padding: 4px 8px;
      border: 1px solid #4CAF50;
      border-radius: 4px;
      font-size: 14px;
      max-width: 200px;
    }
    .club-edit-btn {
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .club-edit-save {
      background-color: #4CAF50;
      color: white;
    }
    .club-edit-cancel {
      background-color: #dc3545;
      color: white;
    }
    .club-edit-indicator {
      color: #4CAF50;
      font-size: 12px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Joueurs</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="activity-logs.html" class="admin-only nav-tooltip" data-tooltip="Logs d'activit√© Player App">Logs</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="R√©serv√© aux administrateurs">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card">
        <h4>Joueurs Actifs</h4>
        <div class="stat-value" id="activeCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Joueurs Inactifs</h4>
        <div class="stat-value" id="inactiveCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Total</h4>
        <div class="stat-value" id="totalCount">-</div>
      </div>
      <div class="stat-card admin-only">
        <h4>Utilisateurs App</h4>
        <div class="stat-value" id="appUserCount" style="color: #2e7d32;">-</div>
      </div>
      <div class="stat-card admin-only">
        <h4>Admins App</h4>
        <div class="stat-value" id="adminCount" style="color: #d32f2f;">-</div>
      </div>
    </div>

    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; gap: 10px;">
        <button id="exportPlayersBtn" class="btn" style="background-color: #28a745; color: white;">
          üì• Exporter Excel
        </button>
        <button class="btn admin-only" onclick="window.location.href='import-players.html'" style="background-color: #28a745; color: white;">
          üì§ Importer Joueurs
        </button>
        <button id="createPlayerBtn" class="btn admin-only" style="background-color: #1F4788; color: white;">
          ‚ûï Cr√©er Joueur
        </button>
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="clearPlayersBtn" class="btn admin-only" style="background-color: #dc3545; color: white;">
          üóëÔ∏è Effacer tous les joueurs
        </button>
      </div>
    </div>

    <div class="card">
      <h3>Tous les Joueurs</h3>

      <!-- Advanced Filters -->
      <div style="margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
        <div style="flex: 1; min-width: 250px;">
          <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Nom</label>
          <div style="display: flex; gap: 4px;">
            <select id="filterNameType" style="width: 120px; padding: 8px 4px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="contains">Contient</option>
              <option value="not_contains">Ne contient pas</option>
              <option value="equals">√âgal √†</option>
              <option value="not_equals">Diff√©rent de</option>
              <option value="starts_with">Commence par</option>
            </select>
            <input type="text" id="searchInput" placeholder="Ex: DUPONT" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        </div>
        <div class="admin-only" style="min-width: 150px;">
          <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Player App</label>
          <select id="filterAppUser" style="width: 100%; padding: 8px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Tous</option>
            <option value="true">‚úì Utilisateurs App</option>
            <option value="false">Non utilisateurs</option>
          </select>
        </div>
        <div style="min-width: 120px;">
          <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">Statut</label>
          <select id="filterStatus" style="width: 100%; padding: 8px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Tous</option>
            <option value="active">Actifs</option>
            <option value="inactive">Inactifs</option>
          </select>
        </div>
        <button class="btn" onclick="applyFilters()" style="padding: 8px 16px; font-size: 13px;">Filtrer</button>
        <button class="btn" onclick="resetFilters()" style="padding: 8px 16px; font-size: 13px; background: #6c757d;">R√©initialiser</button>
      </div>

      <div id="loadingPlayers" class="loading">
        <div class="spinner"></div>
        Chargement des joueurs...
      </div>

      <div id="playersTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Licence</th>
                <th>Nom</th>
                <th>Pr√©nom</th>
                <th>Club</th>
                <th>Email</th>
                <th>T√©l√©phone</th>
                <!-- Dynamic ranking columns will be inserted here -->
                <th id="rankingColumnsPlaceholder" style="display:none;"></th>
                <th>Statut</th>
                <th class="admin-only" title="Utilisateur de l'app mobile">üì± App</th>
                <th class="admin-only">Player App role</th>
                <th class="admin-only" title="Consentement RGPD">üìã RGPD</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="playersBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Player Modal -->
    <div id="editPlayerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">‚úèÔ∏è Modifier le joueur</h3>
        <form id="editPlayerForm">
          <input type="hidden" id="edit_licence">

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Licence</label>
            <input type="text" id="edit_licence_display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Pr√©nom</label>
            <input type="text" id="edit_first_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom</label>
            <input type="text" id="edit_last_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Club</label>
            <select id="edit_club" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- S√©lectionner un club --</option>
            </select>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #1F4788;">Classements FFB</label>
            <div id="edit_rankings_container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <!-- Dynamic ranking fields will be inserted here by JavaScript -->
            </div>
          </div>

          <div style="margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-radius: 6px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="edit_player_app_user" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-weight: bold; color: #2e7d32;">Utilisateur Player App</span>
            </label>
            <p style="margin: 8px 0 0 28px; font-size: 12px; color: #666;">Cochez si ce joueur utilise l'application mobile Player App</p>
          </div>

          <div id="gdprConsentSection" style="margin-bottom: 15px; padding: 12px; background: #e3f2fd; border-radius: 6px; display: none;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="edit_gdpr_consent" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-weight: bold; color: #1565c0;">üìã Consentement RGPD</span>
            </label>
            <p style="margin: 8px 0 0 28px; font-size: 12px; color: #666;">Cochez pour marquer le consentement √† la politique de confidentialit√©</p>
            <div id="gdprConsentInfo" style="margin: 8px 0 0 28px; font-size: 12px; color: #1565c0; display: none;"></div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
            <button type="button" id="cancelEditBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Player Modal -->
    <div id="createPlayerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">‚ûï Cr√©er un nouveau joueur</h3>
        <form id="createPlayerForm">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Licence *</label>
            <input type="text" id="create_licence" required placeholder="Ex: 123456A" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Pr√©nom *</label>
            <input type="text" id="create_first_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom *</label>
            <input type="text" id="create_last_name" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Club</label>
            <select id="create_club" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- S√©lectionner un club --</option>
            </select>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
            <input type="email" id="create_email" placeholder="joueur@email.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">T√©l√©phone</label>
            <input type="text" id="create_phone" placeholder="0612345678" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #1F4788;">Classements FFB</label>
            <div id="create_rankings_container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <!-- Dynamic ranking fields will be inserted here by JavaScript -->
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Player App Role</label>
            <select id="create_player_app_role" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- Aucun --</option>
              <option value="joueur">Joueur</option>
              <option value="admin">Admin</option>
              <option value="test" selected>Test</option>
            </select>
          </div>

          <div style="margin-bottom: 15px; padding: 12px; background: #e8f5e9; border-radius: 6px;">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="create_player_app_user" checked style="width: 18px; height: 18px; cursor: pointer;">
              <span style="font-weight: bold; color: #2e7d32;">Utilisateur Player App</span>
            </label>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #1F4788;">Cr√©er le joueur</button>
            <button type="button" id="cancelCreateBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Get user role from JWT token
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Hide admin-only elements for non-admin users
    if (!isAdmin) {
      // Hide all admin-only elements (including nav links)
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');

      // Hide Actions column header
      const actionsHeader = document.querySelector('thead th:last-child');
      if (actionsHeader && actionsHeader.textContent === 'Actions') {
        actionsHeader.style.display = 'none';
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    let allPlayers = [];

    // Load players
    async function loadPlayers() {
      try {
        const response = await fetch(`${API_URL}/players`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load players');
        }

        allPlayers = await response.json();

        // Defensive check: ensure allPlayers is an array
        if (!Array.isArray(allPlayers)) {
          console.error('Invalid players data:', allPlayers);
          throw new Error('Invalid data received');
        }

        // Count active/inactive/admins/app users (excluding "test" role)
        const realPlayers = allPlayers.filter(p => p.player_app_role !== 'test');
        const activePlayers = realPlayers.filter(p => p.is_active === 1);
        const inactivePlayers = realPlayers.filter(p => p.is_active === 0);
        const adminPlayers = realPlayers.filter(p => p.player_app_role === 'admin');
        const appUsers = realPlayers.filter(p => p.player_app_user === true);

        document.getElementById('activeCount').textContent = activePlayers.length;
        document.getElementById('inactiveCount').textContent = inactivePlayers.length;
        document.getElementById('totalCount').textContent = realPlayers.length;
        document.getElementById('appUserCount').textContent = appUsers.length;
        document.getElementById('adminCount').textContent = adminPlayers.length;

        displayPlayers(allPlayers);

        document.getElementById('loadingPlayers').style.display = 'none';
        document.getElementById('playersTable').style.display = 'block';

      } catch (error) {
        console.error('Error loading players:', error);
        document.getElementById('loadingPlayers').style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des joueurs';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Get standardized club names from database
    let clubsList = [];

    async function loadClubsList() {
      try {
        const response = await fetch(`${API_URL}/clubs`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const clubs = await response.json();
          clubsList = clubs.map(club => club.name).sort();
        }
      } catch (error) {
        console.error('Error loading clubs list:', error);
      }
    }

    function getStandardClubNames() {
      return clubsList;
    }

    // Get game modes from database for dynamic ranking fields
    let gameModesList = [];

    async function loadGameModes() {
      try {
        const response = await fetch(`${API_URL}/reference-data/game-modes`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          gameModesList = await response.json();
          // Sort by display_order
          gameModesList.sort((a, b) => (a.display_order || 0) - (b.display_order || 0));
        }
      } catch (error) {
        console.error('Error loading game modes:', error);
      }
      return gameModesList;
    }

    // Generate dynamic ranking fields HTML
    function generateRankingFieldsHTML(prefix, playerRankings = {}) {
      if (!gameModesList || gameModesList.length === 0) {
        // Fallback to hardcoded fields if game modes not loaded
        return `
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Libre</label>
            <input type="text" id="${prefix}_rank_libre" placeholder="NC" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cadre</label>
            <input type="text" id="${prefix}_rank_cadre" placeholder="NC" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Bande</label>
            <input type="text" id="${prefix}_rank_bande" placeholder="NC" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">3 Bandes</label>
            <input type="text" id="${prefix}_rank_3bandes" placeholder="NC" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
        `;
      }

      return gameModesList
        .filter(mode => mode.is_active !== false)
        .map(mode => {
          // Get ranking value from player_rankings (keyed by game_mode_id)
          const rankingData = playerRankings[mode.id] || {};
          const rankingValue = rankingData.ranking || '';

          return `
            <div>
              <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 5px; font-weight: bold;">
                <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${mode.color || '#1F4788'};"></span>
                ${mode.display_name}
              </label>
              <input type="text"
                     id="${prefix}_rank_${mode.id}"
                     data-game-mode-id="${mode.id}"
                     placeholder="NC"
                     value="${rankingValue}"
                     style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          `;
        })
        .join('');
    }

    // Collect rankings from dynamic form fields
    function collectRankingsFromForm(prefix) {
      const rankings = {};
      gameModesList.forEach(mode => {
        const input = document.getElementById(`${prefix}_rank_${mode.id}`);
        if (input) {
          rankings[mode.id] = input.value || null;
        }
      });
      return rankings;
    }

    // Number of ranking columns to show in the table (to avoid table being too wide)
    const MAX_TABLE_RANKING_COLUMNS = 4;

    // Get game modes to display in table (first N active modes by display_order)
    function getTableGameModes() {
      return gameModesList
        .filter(mode => mode.is_active !== false)
        .slice(0, MAX_TABLE_RANKING_COLUMNS);
    }

    // Populate table header with dynamic ranking columns
    function populateRankingHeaders() {
      const headerRow = document.querySelector('thead tr');
      const placeholder = document.getElementById('rankingColumnsPlaceholder');

      if (!headerRow || !placeholder) return;

      // Remove old dynamic headers if any
      headerRow.querySelectorAll('.dynamic-rank-header').forEach(el => el.remove());

      // Insert new headers before the placeholder
      const tableModes = getTableGameModes();
      tableModes.forEach(mode => {
        const th = document.createElement('th');
        th.className = 'dynamic-rank-header';
        th.textContent = mode.display_name;
        th.title = mode.display_name;
        th.style.textAlign = 'center';
        headerRow.insertBefore(th, placeholder);
      });
    }

    // Generate ranking cells HTML for a player row
    function generateRankingCellsHTML(player, inactiveStyle) {
      const tableModes = getTableGameModes();

      return tableModes.map(mode => {
        // Try to get ranking from player_rankings (new format) or legacy columns
        let ranking = 'NC';

        if (player.player_rankings && player.player_rankings[mode.id]) {
          ranking = player.player_rankings[mode.id].ranking || 'NC';
        } else {
          // Fallback to legacy columns
          const legacyColumn = `rank_${mode.code.toLowerCase().replace(/\s+/g, '')}`;
          if (player[legacyColumn]) {
            ranking = player[legacyColumn];
          }
        }

        return `<td style="text-align: center; ${inactiveStyle}">${ranking}</td>`;
      }).join('');
    }

    // Update club name for a player
    async function updateClubName(licence, newClubName) {
      try {
        const response = await fetch(`${API_URL}/players/${licence}/club`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ club: newClubName })
        });

        if (!response.ok) {
          throw new Error('Failed to update club name');
        }

        // Update local data
        const player = allPlayers.find(p => p.licence === licence);
        if (player) {
          player.club = newClubName;
        }

        return true;
      } catch (error) {
        console.error('Error updating club name:', error);
        alert('Erreur lors de la mise √† jour du club');
        return false;
      }
    }

    // Make club cell editable
    function makeClubEditable(cell, licence, currentClub) {
      // Remove click handler to prevent re-triggering
      cell.onclick = null;
      cell.classList.remove('club-cell');

      const standardClubs = getStandardClubNames();

      cell.innerHTML = `
        <div class="club-edit-container">
          <select class="club-edit-select">
            <option value="">-- S√©lectionner un club --</option>
            ${standardClubs.map(club => `
              <option value="${club}" ${club === currentClub ? 'selected' : ''}>
                ${club}
              </option>
            `).join('')}
          </select>
          <button class="club-edit-btn club-edit-save" title="Enregistrer">‚úì</button>
          <button class="club-edit-btn club-edit-cancel" title="Annuler">‚úó</button>
        </div>
      `;

      const select = cell.querySelector('.club-edit-select');
      const saveBtn = cell.querySelector('.club-edit-save');
      const cancelBtn = cell.querySelector('.club-edit-cancel');

      // Stop propagation on the container
      const container = cell.querySelector('.club-edit-container');
      container.onclick = (e) => e.stopPropagation();

      // Focus on select
      setTimeout(() => select.focus(), 0);

      // Save button click
      saveBtn.onclick = async (e) => {
        e.stopPropagation();
        const newClub = select.value;

        if (!newClub) {
          alert('Veuillez s√©lectionner un club');
          return;
        }

        const success = await updateClubName(licence, newClub);
        if (success) {
          cell.innerHTML = `${newClub} <span class="club-edit-indicator">‚úì Mis √† jour</span>`;
          setTimeout(() => {
            cell.innerHTML = newClub;
            cell.classList.add('club-cell');
            cell.onclick = () => makeClubEditable(cell, licence, newClub);
          }, 2000);
        } else {
          // Restore on error
          cell.innerHTML = currentClub || '-';
          cell.classList.add('club-cell');
          cell.onclick = () => makeClubEditable(cell, licence, currentClub);
        }
      };

      // Cancel button click
      cancelBtn.onclick = (e) => {
        e.stopPropagation();
        cell.innerHTML = currentClub || '-';
        cell.classList.add('club-cell');
        cell.onclick = () => makeClubEditable(cell, licence, currentClub);
      };

      // Enter key to save, Escape to cancel
      select.onkeydown = (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          saveBtn.click();
        } else if (e.key === 'Escape') {
          e.preventDefault();
          cancelBtn.click();
        }
      };
    }

    // Open edit modal - fetch full player data including rankings
    async function openEditModal(playerFromList) {
      // Show loading state
      document.getElementById('editPlayerModal').style.display = 'flex';
      const rankingsContainer = document.getElementById('edit_rankings_container');
      rankingsContainer.innerHTML = '<p style="color: #666; font-style: italic;">Chargement des classements...</p>';

      // Fetch full player data with player_rankings
      let player = playerFromList;
      try {
        const response = await fetch(`${API_URL}/players/${playerFromList.licence}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          player = await response.json();
        }
      } catch (err) {
        console.error('Error fetching player details:', err);
      }

      document.getElementById('edit_licence').value = player.licence;
      document.getElementById('edit_licence_display').value = player.licence;
      document.getElementById('edit_first_name').value = player.first_name || '';
      document.getElementById('edit_last_name').value = player.last_name || '';
      document.getElementById('edit_player_app_user').checked = player.player_app_user === true;

      // Populate dynamic ranking fields with data from player_rankings table
      rankingsContainer.innerHTML = generateRankingFieldsHTML('edit', player.player_rankings || {});

      // Populate club dropdown
      const clubSelect = document.getElementById('edit_club');
      clubSelect.innerHTML = '<option value="">-- S√©lectionner un club --</option>' +
        clubsList.map(club => `<option value="${club}" ${club === player.club ? 'selected' : ''}>${club}</option>`).join('');

      // GDPR consent section - always visible, editable for any player
      const gdprSection = document.getElementById('gdprConsentSection');
      const gdprCheckbox = document.getElementById('edit_gdpr_consent');
      const gdprInfo = document.getElementById('gdprConsentInfo');

      gdprSection.style.display = 'block';
      gdprCheckbox.disabled = false;

      // Use GDPR data from player object (stored in players table)
      if (player.gdpr_consent_date) {
        gdprCheckbox.checked = true;
        const date = new Date(player.gdpr_consent_date).toLocaleDateString('fr-FR');
        gdprInfo.textContent = `‚úì Consentement donn√© le ${date} (v${player.gdpr_consent_version || '1.0'})`;
        gdprInfo.style.display = 'block';
      } else {
        gdprCheckbox.checked = false;
        gdprInfo.style.display = 'none';
      }
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editPlayerModal').style.display = 'none';
    }

    // Update player
    async function updatePlayer(playerData) {
      try {
        const response = await fetch(`${API_URL}/players/${playerData.licence}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(playerData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update player');
        }

        return true;
      } catch (error) {
        console.error('Error updating player:', error);
        alert('Erreur lors de la mise √† jour: ' + error.message);
        return false;
      }
    }

    // Delete player
    async function deletePlayer(player) {
      const confirmDelete = confirm(`Voulez-vous vraiment supprimer le joueur ${player.first_name} ${player.last_name} (${player.licence}) ?`);
      if (!confirmDelete) return;

      try {
        const response = await fetch(`${API_URL}/players/${player.licence}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete player');
        }

        // Reload players
        await loadPlayers();
        alert('Joueur supprim√© avec succ√®s!');
      } catch (error) {
        console.error('Error deleting player:', error);
        alert('Erreur lors de la suppression: ' + error.message);
      }
    }

    // Display players in table
    function displayPlayers(players) {
      const tbody = document.getElementById('playersBody');
      tbody.innerHTML = '';

      if (players.length === 0) {
        // Calculate colspan: 6 fixed + N ranking + 5 admin or 1 non-admin
        const rankingCols = getTableGameModes().length;
        const colspan = isAdmin ? (6 + rankingCols + 5) : (6 + rankingCols + 2);
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px;">Aucun joueur trouv√©</td></tr>`;
        return;
      }

      players.forEach(player => {
        const row = document.createElement('tr');
        const inactiveStyle = player.is_active === 0 ? 'opacity: 0.5;' : '';

        row.innerHTML = `
          <td style="${inactiveStyle}">${player.licence}</td>
          <td style="${inactiveStyle}"><a href="player-history.html?licence=${player.licence}" class="player-link">${player.last_name}</a></td>
          <td style="${inactiveStyle}"><a href="player-history.html?licence=${player.licence}" class="player-link">${player.first_name}</a></td>
          <td style="${inactiveStyle}">${player.club || '-'}</td>
          <td style="${inactiveStyle}; font-size: 0.85em;">${player.email || '-'}</td>
          <td style="${inactiveStyle}">${player.telephone || '-'}</td>
          ${generateRankingCellsHTML(player, inactiveStyle)}
          <td style="text-align: center;">
            <span style="color: ${player.is_active ? '#4CAF50' : '#999'}; font-weight: bold;">
              ${player.is_active ? '‚úì Actif' : '‚úó Inactif'}
            </span>
          </td>
          ${isAdmin ? `
          <td style="text-align: center;" title="${player.player_app_user ? 'Utilisateur Player App' : 'Non utilisateur'}">
            ${player.player_app_user ? '<span style="color: #2e7d32; font-size: 16px;">‚úì</span>' : '<span style="color: #ccc;">-</span>'}
          </td>
          ` : ''}
          ${isAdmin ? `
          <td style="text-align: center;" class="role-cell" data-licence="${player.licence}">
            <select class="role-select" data-licence="${player.licence}" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px; ${player.player_app_role === 'admin' ? 'background: #ffebee; color: #d32f2f; font-weight: bold;' : ''}">
              <option value="" ${!player.player_app_role ? 'selected' : ''}>--</option>
              <option value="joueur" ${player.player_app_role === 'joueur' ? 'selected' : ''}>Joueur</option>
              <option value="admin" ${player.player_app_role === 'admin' ? 'selected' : ''}>Admin</option>
              <option value="test" ${player.player_app_role === 'test' ? 'selected' : ''}>Test</option>
            </select>
          </td>
          ` : ''}
          ${isAdmin ? `
          <td style="text-align: center;" title="${player.gdpr_consent_date ? new Date(player.gdpr_consent_date).toLocaleDateString('fr-FR') : 'Pas de consentement'}">
            ${player.gdpr_consent_date
              ? '<span style="color: #2e7d32; font-size: 16px;">‚úì</span>'
              : (player.player_app_user ? '<span style="color: #ff9800; font-size: 14px;">‚ö†</span>' : '<span style="color: #ccc;">-</span>')}
          </td>
          ` : ''}
          ${isAdmin ? `
          <td style="text-align: center;">
            <button class="btn btn-small edit-player-btn" style="background: #4CAF50; padding: 5px 10px; font-size: 12px;">‚úèÔ∏è</button>
            <button class="btn btn-small reset-pwd-btn" style="background: #ff9800; padding: 5px 10px; font-size: 12px; display: none;" title="R√©initialiser le mot de passe">üîë</button>
            <button class="btn btn-small delete-player-btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button>
          </td>
          ` : ''}
        `;

        tbody.appendChild(row);

        // Add click event to edit button (only for admin)
        if (isAdmin) {
          const editBtn = row.querySelector('.edit-player-btn');
          if (editBtn) {
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openEditModal(player);
            };
          }

          const deleteBtn = row.querySelector('.delete-player-btn');
          if (deleteBtn) {
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              deletePlayer(player);
            };
          }

          // Role dropdown change
          const roleSelect = row.querySelector('.role-select');
          if (roleSelect) {
            roleSelect.onchange = async (e) => {
              const newRole = e.target.value || null;
              await updatePlayerRole(player.licence, newRole);
            };
          }

          // Check if player has account and show reset button
          const resetBtn = row.querySelector('.reset-pwd-btn');
          if (resetBtn) {
            checkPlayerAccount(player.licence).then(hasAccount => {
              if (hasAccount) {
                resetBtn.style.display = 'inline-block';
                resetBtn.onclick = (e) => {
                  e.stopPropagation();
                  resetPlayerPassword(player);
                };
              }
            });
          }
        }
      });
    }

    // Update player role
    async function updatePlayerRole(licence, role) {
      try {
        const response = await fetch(`${API_URL}/players/${licence}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ player_app_role: role })
        });

        if (!response.ok) {
          throw new Error('Erreur lors de la mise √† jour');
        }

        // Update local data
        const player = allPlayers.find(p => p.licence === licence);
        if (player) {
          player.player_app_role = role;
        }

        // Update admin count
        const adminCount = allPlayers.filter(p => p.player_app_role === 'admin').length;
        document.getElementById('adminCount').textContent = adminCount;

        // Update select styling
        const select = document.querySelector(`.role-select[data-licence="${licence}"]`);
        if (select) {
          if (role === 'admin') {
            select.style.background = '#ffebee';
            select.style.color = '#d32f2f';
            select.style.fontWeight = 'bold';
          } else {
            select.style.background = '';
            select.style.color = '';
            select.style.fontWeight = '';
          }
        }

      } catch (error) {
        console.error('Error updating role:', error);
        alert('Erreur lors de la mise √† jour du r√¥le');
        // Reload to reset select
        loadPlayers();
      }
    }

    // Check if player has an account
    async function checkPlayerAccount(licence) {
      try {
        const response = await fetch(`${API_URL}/players/${licence}/account`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return false;
        const data = await response.json();
        return data.hasAccount;
      } catch (error) {
        return false;
      }
    }

    // Reset player password
    async function resetPlayerPassword(player) {
      const newPassword = prompt(`Nouveau mot de passe pour ${player.first_name} ${player.last_name}:\n\n(minimum 8 caract√®res)`);

      if (!newPassword) return;

      if (newPassword.length < 8) {
        alert('Le mot de passe doit contenir au moins 8 caract√®res');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/players/${player.licence}/reset-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ newPassword })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur');
        }

        alert('‚úÖ Mot de passe r√©initialis√© avec succ√®s');

      } catch (error) {
        alert('‚ùå Erreur: ' + error.message);
      }
    }

    // Edit form submission
    document.getElementById('editPlayerForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const clubValue = document.getElementById('edit_club').value;
      const gdprCheckbox = document.getElementById('edit_gdpr_consent');

      // Collect rankings from dynamic form fields
      const playerRankings = collectRankingsFromForm('edit');

      const playerData = {
        licence: document.getElementById('edit_licence').value,
        first_name: document.getElementById('edit_first_name').value,
        last_name: document.getElementById('edit_last_name').value,
        player_rankings: playerRankings,  // New format: { game_mode_id: 'ranking_value', ... }
        player_app_user: document.getElementById('edit_player_app_user').checked
      };

      // Only include club if a value is selected (don't clear existing club)
      if (clubValue) {
        playerData.club = clubValue;
      }

      // Always include GDPR consent value (allows setting/clearing)
      playerData.gdpr_consent = gdprCheckbox.checked;

      const success = await updatePlayer(playerData);
      if (success) {
        closeEditModal();
        // Reload players
        await loadPlayers();
        alert('Joueur mis √† jour avec succ√®s!');
      }
    });

    // Cancel button
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

    // Filter functionality
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const nameFilterType = document.getElementById('filterNameType').value;
      const appUserFilter = document.getElementById('filterAppUser')?.value || '';
      const statusFilter = document.getElementById('filterStatus').value;

      const filteredPlayers = allPlayers.filter(player => {
        // Name filter
        if (searchTerm) {
          const fullName = `${player.last_name} ${player.first_name}`.toLowerCase();
          const lastName = (player.last_name || '').toLowerCase();

          let nameMatch = false;
          switch (nameFilterType) {
            case 'contains':
              nameMatch = fullName.includes(searchTerm) ||
                          player.licence.toLowerCase().includes(searchTerm) ||
                          (player.club && player.club.toLowerCase().includes(searchTerm));
              break;
            case 'not_contains':
              nameMatch = !fullName.includes(searchTerm);
              break;
            case 'equals':
              nameMatch = lastName === searchTerm;
              break;
            case 'not_equals':
              nameMatch = lastName !== searchTerm;
              break;
            case 'starts_with':
              nameMatch = lastName.startsWith(searchTerm);
              break;
          }
          if (!nameMatch) return false;
        }

        // Player App User filter
        if (appUserFilter === 'true' && player.player_app_user !== true) return false;
        if (appUserFilter === 'false' && player.player_app_user === true) return false;

        // Status filter
        if (statusFilter === 'active' && player.is_active !== 1) return false;
        if (statusFilter === 'inactive' && player.is_active !== 0) return false;

        return true;
      });

      displayPlayers(filteredPlayers);
    }

    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterNameType').value = 'contains';
      if (document.getElementById('filterAppUser')) {
        document.getElementById('filterAppUser').value = '';
      }
      document.getElementById('filterStatus').value = '';
      displayPlayers(allPlayers);
    }

    // Auto-filter on Enter key or input change
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') applyFilters();
    });
    document.getElementById('searchInput').addEventListener('input', () => {
      // Debounce: apply filter after user stops typing
      clearTimeout(window.searchTimeout);
      window.searchTimeout = setTimeout(applyFilters, 300);
    });
    document.getElementById('filterNameType').addEventListener('change', applyFilters);
    if (document.getElementById('filterAppUser')) {
      document.getElementById('filterAppUser').addEventListener('change', applyFilters);
    }
    document.getElementById('filterStatus').addEventListener('change', applyFilters);

    // Create player button and modal handlers
    const createPlayerBtn = document.getElementById('createPlayerBtn');
    if (createPlayerBtn) {
      createPlayerBtn.addEventListener('click', openCreateModal);
    }

    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    if (cancelCreateBtn) {
      cancelCreateBtn.addEventListener('click', closeCreateModal);
    }

    const createPlayerForm = document.getElementById('createPlayerForm');
    if (createPlayerForm) {
      createPlayerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await createPlayer();
      });
    }

    function openCreateModal() {
      // Reset form
      document.getElementById('createPlayerForm').reset();
      // Pre-select "Test" role
      document.getElementById('create_player_app_role').value = 'test';
      document.getElementById('create_player_app_user').checked = true;

      // Populate clubs dropdown
      const clubSelect = document.getElementById('create_club');
      clubSelect.innerHTML = '<option value="">-- S√©lectionner un club --</option>' +
        clubsList.map(club => `<option value="${club}">${club}</option>`).join('');

      // Populate dynamic ranking fields (empty for new player)
      const rankingsContainer = document.getElementById('create_rankings_container');
      rankingsContainer.innerHTML = generateRankingFieldsHTML('create', {});

      document.getElementById('createPlayerModal').style.display = 'flex';
    }

    function closeCreateModal() {
      document.getElementById('createPlayerModal').style.display = 'none';
    }

    async function createPlayer() {
      const licence = document.getElementById('create_licence').value.trim().toUpperCase();
      const firstName = document.getElementById('create_first_name').value.trim();
      const lastName = document.getElementById('create_last_name').value.trim().toUpperCase();
      const club = document.getElementById('create_club').value;
      const email = document.getElementById('create_email').value.trim();
      const phone = document.getElementById('create_phone').value.trim();
      const playerAppRole = document.getElementById('create_player_app_role').value;
      const playerAppUser = document.getElementById('create_player_app_user').checked;

      // Collect rankings from dynamic form fields
      const playerRankings = collectRankingsFromForm('create');

      if (!licence || !firstName || !lastName) {
        alert('Licence, pr√©nom et nom sont obligatoires');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/players`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            licence,
            first_name: firstName,
            last_name: lastName,
            club,
            email,
            phone,
            player_rankings: playerRankings,  // New format: { game_mode_id: 'ranking_value', ... }
            player_app_role: playerAppRole,
            player_app_user: playerAppUser,
            is_active: true
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur lors de la cr√©ation');
        }

        alert('Joueur cr√©√© avec succ√®s !');
        closeCreateModal();
        loadPlayers(); // Refresh the list
      } catch (error) {
        console.error('Create player error:', error);
        alert('Erreur: ' + error.message);
      }
    }

    // Export players button
    document.getElementById('exportPlayersBtn').addEventListener('click', async () => {
      const btn = document.getElementById('exportPlayersBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Export en cours...';

      try {
        const response = await fetch(`${API_URL}/backup/export-players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Erreur lors de l\'export');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Joueurs_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Export error:', error);
        alert('Erreur lors de l\'export');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì• Exporter Excel';
      }
    });

    // Clear all players button
    document.getElementById('clearPlayersBtn').addEventListener('click', async () => {
      const password = prompt('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCette action va supprimer TOUS les joueurs de la base de donn√©es.\n\nPour confirmer, entrez votre mot de passe admin :');

      if (!password) {
        return; // User cancelled
      }

      // Verify password by attempting to login
      try {
        const loginResponse = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: 'admin',
            password: password
          })
        });

        if (!loginResponse.ok) {
          alert('‚ùå Mot de passe incorrect');
          return;
        }

        // Password is correct, proceed with deletion
        const confirmDelete = confirm(`√ätes-vous absolument s√ªr ?\n\nCette action supprimera ${allPlayers.length} joueurs et ne peut pas √™tre annul√©e.`);

        if (!confirmDelete) {
          return;
        }

        // Delete all players
        const deleteResponse = await fetch(`${API_URL}/players/all`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!deleteResponse.ok) {
          throw new Error('Erreur lors de la suppression');
        }

        const result = await deleteResponse.json();
        alert(`‚úÖ ${result.deleted} joueurs supprim√©s avec succ√®s`);

        // Reload the page
        loadPlayers();
      } catch (error) {
        console.error('Error clearing players:', error);
        alert('‚ùå Erreur lors de la suppression des joueurs');
      }
    });

    // Initialize
    async function initialize() {
      await Promise.all([
        loadClubsList(),
        loadGameModes()
      ]);
      // Populate dynamic ranking headers after game modes are loaded
      populateRankingHeaders();
      loadPlayers();
    }

    initialize();
  </script>
</body>
</html>

