<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Tournois - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Comp√©titions Jou√©es</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="activity-logs.html" class="admin-only nav-tooltip" data-tooltip="Logs d'activit√© Player App">Logs</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="R√©serv√© aux administrateurs">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Tous les Tournois</h3>
        <div style="display: flex; gap: 10px;">
          <button id="exportTournamentsBtn" class="btn" style="background-color: #28a745;">
            üì• Exporter Excel
          </button>
          <button id="markAllSentBtn" class="btn admin-only" style="background-color: #17a2b8;">
            üìß‚úì Tout marquer envoy√©
          </button>
          <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
            Importer un Tournoi
          </button>
        </div>
      </div>

      <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
        <input type="text" id="searchInput" placeholder="üîç Rechercher par cat√©gorie..." style="flex: 1; min-width: 250px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">

        <select id="seasonFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">Toutes les saisons</option>
        </select>

        <select id="tournamentNumberFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          <option value="">Tous les tournois</option>
          <option value="1">Tournoi 1</option>
          <option value="2">Tournoi 2</option>
          <option value="3">Tournoi 3</option>
          <option value="4">Finale</option>
        </select>

        <button class="btn" onclick="resetFilters()">R√©initialiser</button>
      </div>

      <div id="loadingTournaments" class="loading">
        <div class="spinner"></div>
        Chargement...
      </div>

      <div id="tournamentsTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="cursor: pointer;" onclick="sortTable('display_name')">Cat√©gorie ‚¨ç</th>
                <th style="cursor: pointer;" onclick="sortTable('tournament_number')">Tournoi ‚¨ç</th>
                <th style="cursor: pointer;" onclick="sortTable('season')">Saison ‚¨ç</th>
                <th style="cursor: pointer;" onclick="sortTable('player_count')">Participants ‚¨ç</th>
                <th style="cursor: pointer;" onclick="sortTable('tournament_date')">Date ‚¨ç</th>
                <th style="cursor: pointer;" onclick="sortTable('location')">Lieu ‚¨ç</th>
                <th style="width: 140px; text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody id="tournamentsBody"></tbody>
          </table>
        </div>
        <div style="margin-top: 15px; color: #666; font-size: 14px;">
          <span id="tournamentCount">0</span> tournoi(s) affich√©(s)
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    let allTournaments = [];
    let currentSort = { column: 'tournament_date', direction: 'desc' };

    // Load all tournaments
    async function loadTournaments() {
      try {
        const response = await fetch(`${API_URL}/tournaments`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          allTournaments = await response.json();

          // Populate season filter
          const seasons = [...new Set(allTournaments.map(t => t.season))].sort().reverse();
          const seasonFilter = document.getElementById('seasonFilter');
          seasons.forEach(season => {
            const option = document.createElement('option');
            option.value = season;
            option.textContent = season;
            seasonFilter.appendChild(option);
          });

          renderTournaments();
          document.getElementById('loadingTournaments').style.display = 'none';
          document.getElementById('tournamentsTable').style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading tournaments:', error);
        document.getElementById('loadingTournaments').innerHTML = '<p style="color: red;">Erreur de chargement des tournois</p>';
      }
    }

    // Filter tournaments
    function filterTournaments() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const seasonFilter = document.getElementById('seasonFilter').value;
      const tournamentNumberFilter = document.getElementById('tournamentNumberFilter').value;

      return allTournaments.filter(tournament => {
        const matchesSearch = tournament.display_name.toLowerCase().includes(searchTerm);
        const matchesSeason = !seasonFilter || tournament.season === seasonFilter;
        const matchesTournamentNumber = !tournamentNumberFilter || tournament.tournament_number.toString() === tournamentNumberFilter;

        return matchesSearch && matchesSeason && matchesTournamentNumber;
      });
    }

    // Sort tournaments
    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }
      renderTournaments();
    }

    // Render tournaments table
    function renderTournaments() {
      const filtered = filterTournaments();

      // Sort
      filtered.sort((a, b) => {
        let aVal = a[currentSort.column];
        let bVal = b[currentSort.column];

        // Handle date sorting
        if (currentSort.column === 'tournament_date') {
          aVal = aVal ? new Date(aVal) : new Date(0);
          bVal = bVal ? new Date(bVal) : new Date(0);
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      const tbody = document.getElementById('tournamentsBody');
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">Aucun tournoi trouv√©</td></tr>';
      } else {
        filtered.forEach(tournament => {
          const row = document.createElement('tr');
          const tournamentLabel = tournament.tournament_number === 4 ? 'Finale D√©partementale' : `Tournoi ${tournament.tournament_number}`;

          const editBtn = userRole === 'admin'
            ? `<button onclick="editTournament(${tournament.id}, '${(tournament.location || '').replace(/'/g, "\\'")}', ${tournament.results_email_sent ? 'true' : 'false'})" title="Modifier" style="background: #ffc107; color: black; border: none; padding: 4px 6px; cursor: pointer; border-radius: 3px; font-size: 12px;">‚úèÔ∏è</button>`
            : '';

          const deleteBtn = userRole === 'admin'
            ? `<button onclick="deleteTournament(${tournament.id}, '${tournament.display_name} - T${tournament.tournament_number} - ${tournament.season}')" title="Supprimer" style="background: #dc3545; color: white; border: none; padding: 4px 6px; cursor: pointer; border-radius: 3px; font-size: 12px;">üóëÔ∏è</button>`
            : '';

          // Email status indicator - clear checkbox style (admin only for actions)
          const emailSent = tournament.results_email_sent;
          const emailStatusBtn = userRole === 'admin'
            ? (emailSent
              ? `<button onclick="toggleEmailStatus(${tournament.id}, false)" title="R√©sultats envoy√©s${tournament.results_email_sent_at ? ' le ' + new Date(tournament.results_email_sent_at).toLocaleDateString('fr-FR') : ''}" style="background: #28a745; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-size: 14px; font-weight: bold;">‚òë</button>`
              : `<button onclick="sendResultsEmail(${tournament.id})" title="R√©sultats non envoy√©s - Cliquez pour envoyer" style="background: #007bff; color: white; border: none; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-size: 14px; font-weight: bold;">‚òê</button>`)
            : (emailSent
              ? `<span title="R√©sultats envoy√©s${tournament.results_email_sent_at ? ' le ' + new Date(tournament.results_email_sent_at).toLocaleDateString('fr-FR') : ''}" style="color: #28a745; font-size: 14px; font-weight: bold;">‚òë</span>`
              : `<span title="R√©sultats non envoy√©s" style="color: #6c757d; font-size: 14px;">‚òê</span>`);

          row.innerHTML = `
            <td>${tournament.display_name}</td>
            <td>${tournamentLabel}</td>
            <td>${tournament.season}</td>
            <td style="text-align: center;">${tournament.player_count}</td>
            <td>${tournament.tournament_date ? new Date(tournament.tournament_date).toLocaleDateString('fr-FR') : 'N/A'}</td>
            <td title="${tournament.location || 'Non d√©fini'}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${tournament.location || '-'}</td>
            <td style="text-align: center; padding: 4px; white-space: nowrap;">
              <button onclick="viewTournament(${tournament.id})" title="Voir les r√©sultats" style="background: #28a745; color: white; border: none; padding: 4px 6px; cursor: pointer; border-radius: 3px; font-size: 12px;">üëÅÔ∏è</button>
              ${editBtn}
              ${emailStatusBtn}
              ${deleteBtn}
            </td>
          `;

          tbody.appendChild(row);
        });
      }

      document.getElementById('tournamentCount').textContent = filtered.length;
    }

    // View tournament
    function viewTournament(id) {
      window.location.href = `tournament-results.html?id=${id}`;
    }

    // Export tournament
    async function exportTournament(id) {
      try {
        const response = await fetch(`${API_URL}/tournaments/${id}/export`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'export');
        }

        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `Tournoi_${id}.xlsx`; // fallback
        if (contentDisposition) {
          const matches = /filename="([^"]+)"/.exec(contentDisposition);
          if (matches && matches[1]) {
            filename = matches[1];
          }
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Error exporting tournament:', error);
        alert('Erreur lors de l\'export Excel');
      }
    }

    // Send results email - redirect to emailing page
    function sendResultsEmail(tournamentId) {
      window.location.href = `emailing.html?tab=results&tournamentId=${tournamentId}`;
    }

    // Toggle email status (mark as sent/unsent)
    async function toggleEmailStatus(tournamentId, markAsSent) {
      const action = markAsSent ? 'mark-results-sent' : 'mark-results-unsent';
      const confirmMsg = markAsSent
        ? 'Marquer les r√©sultats comme envoy√©s ?'
        : 'Annuler le statut "envoy√©" des r√©sultats ?';

      if (!confirm(confirmMsg)) return;

      try {
        const response = await fetch(`${API_URL}/tournaments/${tournamentId}/${action}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          await loadTournaments();
        } else {
          const data = await response.json();
          alert(data.error || 'Erreur lors de la mise √† jour');
        }
      } catch (error) {
        console.error('Error toggling email status:', error);
        alert('Erreur lors de la mise √† jour du statut');
      }
    }

    // Delete tournament
    async function deleteTournament(id, name) {
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le tournoi "${name}" ?\n\nCette action supprimera tous les r√©sultats et recalculera les classements.`)) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/tournaments/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const successDiv = document.getElementById('successMessage');
          successDiv.textContent = 'Tournoi supprim√© avec succ√®s ! Les classements ont √©t√© recalcul√©s.';
          successDiv.style.display = 'block';

          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);

          // Reload tournaments
          await loadTournaments();
        } else {
          const errorData = await response.json();
          alert(`Erreur lors de la suppression: ${errorData.error || 'Erreur inconnue'}`);
        }
      } catch (error) {
        console.error('Error deleting tournament:', error);
        alert(`Erreur de connexion lors de la suppression du tournoi: ${error.message}`);
      }
    }

    // Reset filters
    function resetFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('seasonFilter').value = '';
      document.getElementById('tournamentNumberFilter').value = '';
      renderTournaments();
    }

    // Setup event listeners
    document.getElementById('searchInput').addEventListener('input', renderTournaments);
    document.getElementById('seasonFilter').addEventListener('change', renderTournaments);
    document.getElementById('tournamentNumberFilter').addEventListener('change', renderTournaments);

    // Edit tournament
    let editingTournamentId = null;

    function editTournament(id, location, resultsSent) {
      editingTournamentId = id;
      document.getElementById('editLocation').value = location || '';
      document.getElementById('editResultsSent').checked = resultsSent;
      document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      editingTournamentId = null;
    }

    async function saveTournament() {
      if (!editingTournamentId) return;

      const location = document.getElementById('editLocation').value.trim();
      const results_email_sent = document.getElementById('editResultsSent').checked;

      try {
        const response = await fetch(`${API_URL}/tournaments/${editingTournamentId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ location, results_email_sent })
        });

        if (response.ok) {
          const successDiv = document.getElementById('successMessage');
          successDiv.textContent = 'Tournoi mis √† jour avec succ√®s !';
          successDiv.style.display = 'block';
          setTimeout(() => successDiv.style.display = 'none', 3000);

          closeEditModal();
          await loadTournaments();
        } else {
          const errorData = await response.json();
          alert(`Erreur: ${errorData.error || 'Erreur inconnue'}`);
        }
      } catch (error) {
        console.error('Error updating tournament:', error);
        alert(`Erreur: ${error.message}`);
      }
    }

    // Export tournaments button
    document.getElementById('exportTournamentsBtn').addEventListener('click', async () => {
      const btn = document.getElementById('exportTournamentsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Export en cours...';

      try {
        const response = await fetch(`${API_URL}/backup/export-tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Erreur lors de l\'export');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Competitions_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Export error:', error);
        alert('Erreur lors de l\'export');
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì• Exporter Excel';
      }
    });

    // Mark all tournaments as results sent
    document.getElementById('markAllSentBtn').addEventListener('click', async () => {
      if (!confirm('Marquer TOUS les tournois comme "r√©sultats envoy√©s" ?')) return;

      try {
        const response = await fetch(`${API_URL}/tournaments/mark-all-results-sent`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          const data = await response.json();
          const successDiv = document.getElementById('successMessage');
          successDiv.textContent = data.message;
          successDiv.style.display = 'block';
          setTimeout(() => successDiv.style.display = 'none', 3000);
          await loadTournaments();
        } else {
          const data = await response.json();
          alert(data.error || 'Erreur');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Erreur: ' + error.message);
      }
    });

    // Initialize
    loadTournaments();
  </script>

  <!-- Edit Tournament Modal -->
  <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
      <h3 style="margin-top: 0;">Modifier le tournoi</h3>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">Lieu du tournoi</label>
        <input type="text" id="editLocation" placeholder="Ex: BC Boulogne" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" id="editResultsSent" style="width: 18px; height: 18px; cursor: pointer;">
          <span style="font-weight: bold;">R√©sultats envoy√©s</span>
        </label>
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="saveTournament()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditModal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>
</body>
</html>
