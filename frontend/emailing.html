<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Com joueurs - CDBHS</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <style>
    /* Quill editor styling */
    .ql-container {
      font-family: inherit;
      font-size: 14px;
    }
    .ql-editor {
      min-height: 200px;
    }
    .ql-toolbar {
      background: #f8f9fa;
      border-radius: 4px 4px 0 0;
    }
    .ql-container.ql-snow {
      border-radius: 0 0 4px 4px;
    }
    .emailing-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1200px) {
      .emailing-container {
        grid-template-columns: 1fr;
      }
    }
    .contacts-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .contact-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }
    .contact-item:last-child {
      border-bottom: none;
    }
    .contact-item:hover {
      background: #f5f5f5;
    }
    .contact-item.selected {
      background: #e3f2fd;
    }
    .contact-info {
      flex: 1;
    }
    .contact-name {
      font-weight: bold;
      color: #333;
    }
    .contact-details {
      font-size: 12px;
      color: #666;
    }
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar input, .filter-bar select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .filter-bar input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .selection-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .selection-actions button {
      padding: 8px 15px;
      font-size: 12px;
    }
    .compose-area {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .compose-area label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    .compose-area input, .compose-area textarea, .compose-area select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }
    .compose-area textarea {
      min-height: 200px;
      resize: vertical;
    }
    .template-vars {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
    }
    .template-vars code {
      background: #e9ecef;
      padding: 2px 5px;
      border-radius: 3px;
      margin: 0 3px;
    }
    .schedule-section {
      background: #fff3e0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .schedule-section input[type="datetime-local"] {
      width: auto;
    }
    .send-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    .send-actions button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-actif { background: #e8f5e9; color: #2e7d32; }
    .badge-inactif { background: #ffebee; color: #c62828; }
    .badge-optin { background: #e3f2fd; color: #1565c0; }
    .badge-optout { background: #fff3e0; color: #e65100; }
    .stats-mini {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    .stat-mini {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }
    .stat-mini .value {
      font-size: 24px;
      font-weight: bold;
      color: #1F4788;
    }
    .stat-mini .label {
      font-size: 12px;
      color: #666;
    }
    .history-table {
      font-size: 14px;
    }
    .history-table th, .history-table td {
      padding: 10px;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: #666;
    }
    .tab:hover {
      color: #1F4788;
    }
    .tab.active {
      color: #1F4788;
      border-bottom-color: #1F4788;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .progress-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
    }
    .progress-box h3 {
      margin-top: 0;
    }
    .scheduled-list {
      margin-top: 20px;
    }
    .scheduled-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    /* Announcements styles */
    .announcement-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      background: white;
      margin-bottom: 15px;
    }
    .announcement-card.inactive {
      opacity: 0.6;
      background: #f5f5f5;
    }
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .announcement-title {
      font-weight: bold;
      font-size: 15px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .announcement-type {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      text-transform: uppercase;
      font-weight: 600;
    }
    .announcement-type.type-info { background: #e3f2fd; color: #1565c0; }
    .announcement-type.type-resultats { background: #e8f5e9; color: #2e7d32; }
    .announcement-type.type-warning { background: #fff3e0; color: #e65100; }
    .announcement-type.type-urgent { background: #ffebee; color: #c62828; }
    .announcement-type.type-perso { background: #f3e5f5; color: #7b1fa2; }
    .announcement-message {
      color: #555;
      font-size: 13px;
      white-space: pre-wrap;
      margin: 10px 0;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .announcement-meta {
      font-size: 12px;
      color: #888;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .announcement-actions {
      display: flex;
      gap: 8px;
    }
    .announcement-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-toggle { background: #ff9800; color: white; }
    .btn-toggle.active { background: #4CAF50; }
    .btn-edit { background: #2196F3; color: white; }
    .btn-delete { background: #dc3545; color: white; }
    .status-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .status-expired { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';">Com joueurs</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="active nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="R√©serv√© aux administrateurs">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="tabs">
      <div class="tab active tooltip" data-tab="announcements" data-tooltip="Annonces affich√©es dans l'Espace Joueur">Annonces</div>
      <div class="tab tooltip" data-tab="compose" data-tooltip="Email avec texte libre et destinataires √† s√©lectionner depuis la base joueurs">Composer</div>
      <div class="tab tooltip" data-tab="relances" data-tooltip="Rappels d'inscription par tournois et finales">Relances</div>
      <div class="tab tooltip" data-tab="results" data-tooltip="Classement √† l'issue de chaque rencontre">R√©sultats Tournoi</div>
      <div class="tab tooltip" data-tab="contacts" data-tooltip="Modification infos joueur">Gestion Contacts</div>
      <div class="tab tooltip" data-tab="templates" data-tooltip="Emails type √† composer et √† utiliser pour relance et convocation">Templates</div>
      <div class="tab tooltip" data-tab="history" data-tooltip="Logs d'envois des emails">Historique</div>
      <div class="tab tooltip" data-tab="scheduled" data-tooltip="Envoi d'emails d√©cal√©">Programm√©s</div>
    </div>

    <!-- TAB: Announcements -->
    <div id="tab-announcements" class="tab-content active">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
          <div>
            <h3 style="margin: 0;">Nouvelle annonce</h3>
            <p style="color: #666; margin: 5px 0 0 0;">
              Les annonces s'affichent dans l'Espace Joueur pour informer les joueurs.
            </p>
          </div>
          <div style="background: #e3f2fd; padding: 12px 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 24px; font-weight: bold; color: #1565c0;" id="audienceCount">-</div>
            <div style="font-size: 12px; color: #666;">joueurs inscrits</div>
          </div>
        </div>
        <form id="addAnnouncementForm">
          <!-- Destinataire Section -->
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-width: 600px;">
            <label style="font-weight: bold; color: #333; margin-bottom: 10px; display: block;">üì¨ Destinataire :</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: white; border: 2px solid #1F4788; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="recipient-option selected">
                <input type="radio" name="announcementRecipient" value="all" checked style="width: 16px; height: 16px;">
                <span style="font-size: 14px;">üë• Tous les joueurs</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="recipient-option">
                <input type="radio" name="announcementRecipient" value="one" style="width: 16px; height: 16px;">
                <span style="font-size: 14px;">üë§ Un joueur</span>
              </label>
            </div>
            <!-- Player search (hidden by default) -->
            <div id="playerSearchSection" style="display: none; margin-top: 15px;">
              <label style="font-size: 13px; color: #666;">Rechercher le joueur :</label>
              <div style="position: relative;">
                <input type="text" id="playerSearchInput" placeholder="Tapez un nom ou une licence..." style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <div id="playerSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; display: none; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
              </div>
              <div id="selectedPlayer" style="display: none; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px; display: none;">
                <span style="font-weight: bold; color: #2e7d32;">‚úì Joueur s√©lectionn√© : </span>
                <span id="selectedPlayerName"></span>
                <input type="hidden" id="selectedPlayerLicence">
                <button type="button" onclick="clearSelectedPlayer()" style="margin-left: 10px; background: none; border: none; color: #c62828; cursor: pointer; font-size: 16px;">‚úï</button>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="announcementTitle">Titre :</label>
            <input type="text" id="announcementTitle" required placeholder="Ex: Nouveau calendrier disponible" style="width: 100%; max-width: 500px;">
          </div>
          <div class="form-group">
            <label for="announcementMessage">Message :</label>
            <textarea id="announcementMessage" required placeholder="Ecrivez votre message ici... (les URLs seront cliquables)" style="width: 100%; max-width: 500px; min-height: 100px;"></textarea>
          </div>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div class="form-group">
              <label for="announcementType">Type :</label>
              <select id="announcementType" style="padding: 8px;">
                <option value="info">‚ÑπÔ∏è Information</option>
                <option value="resultats">üèÜ R√©sultats</option>
                <option value="warning">‚ö†Ô∏è Avertissement</option>
                <option value="urgent">üö® Urgent</option>
                <option value="perso">üí¨ Message perso</option>
              </select>
            </div>
            <div class="form-group">
              <label for="announcementExpiry">Expiration (optionnel) :</label>
              <input type="datetime-local" id="announcementExpiry" style="padding: 8px;">
            </div>
          </div>
          <div style="background: #1F4788; padding: 15px; border-radius: 8px; margin: 15px 0; max-width: 500px;">
            <h4 style="color: white; margin: 0 0 8px 0; font-size: 13px; opacity: 0.8;">Aper√ßu dans l'Espace Joueur :</h4>
            <div id="announcementPreview" style="background: white; border-radius: 6px; padding: 12px 15px; border-left: 4px solid #1565c0;">
              <strong id="previewTitle" style="font-size: 14px;">Titre de l'annonce</strong>
              <p id="previewMessage" style="margin: 5px 0 0 0; font-size: 13px; color: #333;">Message de l'annonce...</p>
            </div>
          </div>
          <!-- Test mode (collapsed) -->
          <details style="margin: 15px 0; max-width: 500px;">
            <summary style="cursor: pointer; color: #e65100; font-weight: bold; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffb74d;">
              üß™ Mode test (aper√ßu avant envoi)
            </summary>
            <div style="padding: 15px; background: #fff3e0; border-radius: 0 0 8px 8px; border: 1px solid #ffb74d; border-top: none;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <input type="checkbox" id="announcementTestMode" style="width: 18px; height: 18px; cursor: pointer;">
                <label for="announcementTestMode" style="color: #e65100; cursor: pointer; margin: 0;">Activer le mode test</label>
              </div>
              <div id="announcementTestFields" style="display: none;">
                <label for="announcementTestLicence" style="font-size: 13px; color: #666;">Licence du testeur :</label>
                <input type="text" id="announcementTestLicence" placeholder="Ex: 123456A" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <p style="font-size: 11px; color: #888; margin: 5px 0 0 0;">L'annonce sera visible uniquement par ce joueur pour validation</p>
              </div>
            </div>
          </details>
          <button type="submit" class="btn btn-primary" style="margin-top: 10px;">üì¢ Publier l'annonce</button>
        </form>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3>Annonces existantes</h3>
        <div id="announcementsList" style="margin-top: 15px;">
          <div style="text-align: center; padding: 20px; color: #666;">Chargement...</div>
        </div>
      </div>
    </div>

    <!-- TAB: Compose Email -->
    <div id="tab-compose" class="tab-content">
      <div class="stats-mini">
        <div class="stat-mini">
          <div class="value" id="totalContacts">-</div>
          <div class="label">Contacts</div>
        </div>
        <div class="stat-mini">
          <div class="value" id="selectedCount">0</div>
          <div class="label">Selectionnes</div>
        </div>
        <div class="stat-mini">
          <div class="value" id="optinCount">-</div>
          <div class="label">Opt-in</div>
        </div>
      </div>

      <div class="emailing-container">
        <!-- Left: Contact Selection -->
        <div class="card">
          <h3>Destinataires</h3>

          <div class="filter-bar" style="flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
              <input type="checkbox" id="activeOnlyFilter" checked> Actifs seulement
            </label>
            <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap; background: #e8f5e9; padding: 5px 10px; border-radius: 4px;">
              <input type="checkbox" id="playerAppUsersFilter"> Utilisateurs Espace Joueur
            </label>
            <select id="clubFilter">
              <option value="">Tous les clubs</option>
            </select>
            <select id="modeFilter">
              <option value="">Mode de jeu : tous</option>
              <!-- Options loaded dynamically from API -->
            </select>
            <select id="categoryFilter" disabled>
              <option value="">Classement FFB : tous</option>
            </select>
            <select id="tournoiFilter">
              <option value="">-- Tournois saison en cours --</option>
            </select>
            <select id="rankingFilter" style="min-width: 200px;">
              <option value="">-- Classements --</option>
            </select>
          </div>
          <div class="filter-bar">
            <input type="text" id="contactSearch" placeholder="Rechercher par nom, email, club..." style="flex: 1;">
          </div>

          <div class="selection-actions">
            <button class="btn" id="selectAllBtn" style="background: #4CAF50;">Tout selectionner</button>
            <button class="btn" id="deselectAllBtn" style="background: #999;">Tout deselectionner</button>
          </div>

          <div id="loadingContacts" class="loading">
            <div class="spinner"></div>
            Chargement des contacts...
          </div>

          <div class="contacts-list" id="contactsList" style="display: none;"></div>
        </div>

        <!-- Right: Compose -->
        <div class="card">
          <h3>Message</h3>

          <div class="compose-area">
            <div>
              <label>Template (optionnel)</label>
              <select id="templateSelect">
                <option value="">-- Aucun template --</option>
              </select>
            </div>

            <div>
              <label>Sujet *</label>
              <input type="text" id="emailSubject" placeholder="Objet de l'email" required>
            </div>

            <div>
              <label>Message *</label>
              <div id="emailBodyEditor"></div>
            </div>

            <div class="template-vars">
              <strong>Variables disponibles:</strong>
              <code>{player_name}</code>
              <code>{first_name}</code>
              <code>{last_name}</code>
              <code>{club}</code>
            </div>

            <div style="margin-top: 15px;">
              <label>Image (optionnel)</label>
              <div id="imagePasteZone" style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 10px; min-height: 60px; background: #fafafa; transition: all 0.2s;">
                <div id="imagePasteContent">
                  <span style="color: #666;">üìã Collez une capture d'√©cran (Ctrl+V) ou cliquez pour saisir une URL</span>
                </div>
                <div id="imagePreview" style="display: none; margin-top: 10px;">
                  <img id="imagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 4px;">
                  <button type="button" id="removeImageBtn" style="display: block; margin: 10px auto 0; background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;">Supprimer l'image</button>
                </div>
              </div>
              <div id="imageUrlSection" style="display: none;">
                <input type="url" id="imageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%;">
                <p style="font-size: 11px; color: #666; margin-top: 5px;">L'image sera affich√©e en haut du message.</p>
              </div>
              <div id="imageUploadProgress" style="display: none; margin-top: 10px;">
                <div style="background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                  <div style="background: #1F4788; height: 4px; width: 0%; transition: width 0.3s;" id="uploadProgressBar"></div>
                </div>
                <p style="font-size: 11px; color: #666; margin-top: 5px;">T√©l√©chargement en cours...</p>
              </div>
            </div>

            <div class="schedule-section">
              <label>
                <input type="checkbox" id="scheduleCheck"> Programmer l'envoi
              </label>
              <div id="scheduleOptions" style="display: none; margin-top: 10px;">
                <label>Date et heure d'envoi:</label>
                <input type="datetime-local" id="scheduledAt">
              </div>
            </div>

            <!-- Summary Email Option for One-Shot -->
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="oneShotCcCheck" checked style="width: 18px; height: 18px;">
                <strong>üìã R√©capitulatif</strong> - Envoyer un email de synth√®se √† :
              </label>
              <p style="margin: 5px 0 0 28px; font-size: 12px; color: #666;">Un seul email avec la liste des destinataires et le contenu envoy√©</p>
              <div id="oneShotCcEmailInput" style="margin-top: 10px;">
                <input type="email" id="oneShotCcEmail" value="cdbhs92@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <!-- Test Mode for One-Shot -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="oneShotTestModeCheck" style="width: 18px; height: 18px;">
                <strong>Mode Test</strong> - Envoyer uniquement √† mon adresse
              </label>
              <div id="oneShotTestEmailInput" style="display: none; margin-top: 10px;">
                <input type="email" id="oneShotTestEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <div class="send-actions">
              <button class="btn" id="sendNowBtn" style="background: #1F4788;">Envoyer maintenant</button>
              <button class="btn" id="scheduleBtn" style="background: #FF9800; display: none;">Programmer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Relances Inscriptions -->
    <div id="tab-relances" class="tab-content">
      <div class="card">
        <h3>Relances Inscriptions</h3>
        <p style="color: #666; margin-bottom: 20px;">
          Envoyez des relances automatiques aux joueurs pour les inviter √† s'inscrire aux tournois.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left: Selection -->
          <div>
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Mode</label>
                <select id="relanceModeFilter" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 150px;">
                  <option value="">-- S√©lectionner --</option>
                  <!-- Options loaded dynamically from API -->
                </select>
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Cat√©gorie</label>
                <select id="relanceCategoryFilter" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 120px;" disabled>
                  <option value="">-- S√©lectionner --</option>
                </select>
              </div>
              <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Type de Relance</label>
                <select id="relanceTypeSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;" disabled>
                  <option value="">-- S√©lectionner --</option>
                  <option value="t2">Relance T2 (joueurs du T1)</option>
                  <option value="t3">Relance T3 (joueurs au classement)</option>
                  <option value="finale">Relance Finale (qualifi√©s)</option>
                </select>
              </div>
            </div>

            <button class="btn" id="loadRelanceParticipantsBtn" style="background: #1F4788; margin-bottom: 20px;" disabled>
              Charger les destinataires
            </button>

            <!-- Info Box -->
            <div id="relanceInfo" style="display: none; padding: 15px; background: #e7f3ff; border-radius: 8px; margin-bottom: 20px;">
              <div id="relanceInfoContent"></div>
            </div>

            <!-- Already Sent Warning -->
            <div id="relanceAlreadySentWarning" style="display: none; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin-bottom: 20px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <div>
                  <strong style="color: #856404;">Cette relance a d√©j√† √©t√© envoy√©e!</strong>
                  <div id="relanceAlreadySentDetails" style="font-size: 13px; color: #856404; margin-top: 5px;"></div>
                </div>
              </div>
            </div>

            <!-- Participants List -->
            <div id="relanceParticipantsSection" style="display: none;">
              <h4>Destinataires (<span id="relanceParticipantCount">0</span> joueurs, <span id="relanceEmailCount">0</span> avec email, <span id="relanceSelectedCount">0</span> s√©lectionn√©s)</h4>
              <div class="selection-actions" style="margin-bottom: 10px;">
                <button class="btn" id="relanceSelectAllBtn" style="background: #4CAF50; padding: 8px 15px; font-size: 12px;">Tout s√©lectionner</button>
                <button class="btn" id="relanceDeselectAllBtn" style="background: #999; padding: 8px 15px; font-size: 12px;">Tout d√©s√©lectionner</button>
              </div>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                <table style="width: 100%; font-size: 13px;">
                  <thead style="background: #f8f9fa; position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 10px; text-align: center; width: 40px;"></th>
                      <th style="padding: 10px; text-align: left;">Pos</th>
                      <th style="padding: 10px; text-align: left;">Joueur</th>
                      <th style="padding: 10px; text-align: left;">Club</th>
                      <th style="padding: 10px; text-align: center;">Email</th>
                    </tr>
                  </thead>
                  <tbody id="relanceParticipantsBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right: Template & Send -->
          <div>
            <!-- Custom Fields based on relance type -->
            <div id="relanceCustomFields" style="display: none; margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
              <h4 style="margin-top: 0;">Informations du tournoi</h4>
              <div id="relanceCustomFieldsContent"></div>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Sujet</label>
              <input type="text" id="relanceSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Message d'introduction</label>
              <div id="relanceIntroEditor"></div>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Message de conclusion</label>
              <div id="relanceOutroEditor"></div>
            </div>

            <div class="template-vars" style="margin-bottom: 15px;">
              <strong>Variables disponibles:</strong>
              <code>{first_name}</code> <code>{last_name}</code> <code>{club}</code> <code>{category}</code>
              <span id="relanceExtraVars"></span>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Image (optionnel) - URL</label>
              <input type="url" id="relanceImageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <!-- Summary Email -->
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="relanceCcCheck" checked style="width: 18px; height: 18px;">
                <strong>R√©capitulatif</strong>
              </label>
              <input type="email" id="relanceCcEmail" value="cdbhs92@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;">
            </div>

            <!-- Test Mode -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="relanceTestModeCheck" style="width: 18px; height: 18px;">
                <strong>Mode Test</strong> - Envoyer uniquement √† mon adresse
              </label>
              <div id="relanceTestEmailInput" style="display: none; margin-top: 10px;">
                <input type="email" id="relanceTestEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <button class="btn" id="sendRelanceBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #28a745;" disabled>
              Envoyer les Relances
            </button>

            <!-- Schedule Option -->
            <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
              <label style="display: block; font-weight: bold; margin-bottom: 10px;">Programmer l'envoi</label>
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="datetime-local" id="relanceScheduleDate" style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button class="btn" id="scheduleRelanceBtn" style="background: #17a2b8; padding: 10px 20px;" disabled>
                  Programmer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Historique Relances -->
      <div class="card" style="margin-top: 20px;">
        <h3 style="display: flex; align-items: center; justify-content: space-between;">
          Historique Relances
          <button class="btn" onclick="loadRelanceHistory()" style="background: #6c757d; padding: 8px 15px; font-size: 12px;">
            Actualiser
          </button>
        </h3>
        <p style="color: #666; margin-bottom: 15px;">
          Suivi des relances envoy√©es cette saison.
        </p>
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
          <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
            <thead style="background: #f8f9fa; position: sticky; top: 0;">
              <tr>
                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Tournoi</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Mode</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Cat√©gorie</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Date Tournoi</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Relance Envoy√©e</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Par</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Destinataires</th>
              </tr>
            </thead>
            <tbody id="relanceHistoryBody">
              <tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: Tournament Results -->
    <div id="tab-results" class="tab-content">
      <div class="card">
        <h3>Envoyer les R√©sultats d'un Tournoi</h3>
        <p style="color: #666; margin-bottom: 20px;">
          S√©lectionnez un tournoi import√© pour envoyer les r√©sultats √† tous les participants par email.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left: Tournament Selection -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 10px;">S√©lectionner un tournoi import√©</label>
            <select id="resultsTournamentSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              <option value="">-- Choisir un tournoi --</option>
            </select>

            <div id="tournamentInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;" id="tournamentInfoTitle">-</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                <div><strong>Date:</strong> <span id="tournamentInfoDate">-</span></div>
                <div><strong>Lieu:</strong> <span id="tournamentInfoLieu">-</span></div>
                <div><strong>Mode:</strong> <span id="tournamentInfoMode">-</span></div>
                <div><strong>Cat√©gorie:</strong> <span id="tournamentInfoCategory">-</span></div>
                <div><strong>Participants:</strong> <span id="tournamentInfoParticipants">-</span></div>
                <div><strong>Emails disponibles:</strong> <span id="tournamentInfoEmails">-</span></div>
              </div>
            </div>

            <div id="tournamentResultsPreview" style="display: none; margin-top: 20px;">
              <h4>Aper√ßu des R√©sultats</h4>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                <table style="width: 100%; font-size: 13px;">
                  <thead style="background: #f8f9fa; position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 10px; text-align: left;">Pos</th>
                      <th style="padding: 10px; text-align: left;">Joueur</th>
                      <th style="padding: 10px; text-align: center;">Points</th>
                      <th style="padding: 10px; text-align: center;">Email</th>
                    </tr>
                  </thead>
                  <tbody id="resultsPreviewBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right: Email Customization -->
          <div>
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte d'introduction</label>
              <div id="resultsIntroTextEditor"></div>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte de conclusion</label>
              <div id="resultsOutroTextEditor"></div>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Image (optionnel) - URL</label>
              <input type="url" id="resultsImageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="template-vars" style="margin-bottom: 20px;">
              <strong>Variables disponibles:</strong>
              <code>{first_name}</code>
              <code>{last_name}</code>
              <code>{tournament_name}</code>
              <code>{tournament_date}</code>
              <code>{tournament_lieu}</code>
              <code>{player_position}</code>
              <code>{player_points}</code>
            </div>

            <!-- Summary Email Option -->
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="ccCheck" checked style="width: 18px; height: 18px;">
                <strong>üìã R√©capitulatif</strong> - Envoyer un email de synth√®se √† :
              </label>
              <p style="margin: 5px 0 0 28px; font-size: 12px; color: #666;">Un seul email avec la liste des destinataires et les r√©sultats</p>
              <div id="ccEmailInput" style="margin-top: 10px;">
                <input type="email" id="ccEmail" value="cdbhs92@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" id="saveCcEmailBtn" style="margin-top: 5px; padding: 5px 10px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Sauvegarder par d√©faut</button>
              </div>
            </div>

            <!-- Test Mode -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="testModeCheck" style="width: 18px; height: 18px;">
                <strong>Mode Test</strong> - Envoyer uniquement √† mon adresse
              </label>
              <div id="testEmailInput" style="display: none; margin-top: 10px;">
                <input type="email" id="testEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <button class="btn" id="sendResultsBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #1F4788;" disabled>
              Envoyer les R√©sultats
            </button>

            <!-- Schedule Option -->
            <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
              <label style="display: block; font-weight: bold; margin-bottom: 10px;">Programmer l'envoi</label>
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="datetime-local" id="resultsScheduleDate" style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button class="btn" id="scheduleResultsBtn" style="background: #17a2b8; padding: 10px 20px;" disabled>
                  Programmer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Contacts Management -->
    <div id="tab-contacts" class="tab-content">
      <!-- Settings Section -->
      <div class="card" style="margin-bottom: 20px; background: #f0f7ff;">
        <h3 style="margin-top: 0;">‚öôÔ∏è Param√®tres Email</h3>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 300px;">
            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Email r√©capitulatif (synth√®se des envois)</label>
            <div style="display: flex; gap: 10px;">
              <input type="email" id="summaryEmailSetting" placeholder="email@exemple.com" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              <button class="btn" id="saveSummaryEmailBtn" style="background: #28a745; white-space: nowrap;">Sauvegarder</button>
            </div>
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
              Cet email recevra un r√©capitulatif unique apr√®s chaque envoi de convocations (au lieu d'un CC sur chaque email).
            </p>
          </div>
        </div>
      </div>

      <!-- Club Emails Section -->
      <div class="card" style="margin-bottom: 20px;">
        <h3 style="margin-top: 0;">üìß Emails des Clubs</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
          Configurez les emails des clubs pour recevoir automatiquement un rappel lors des convocations de tournois h√©berg√©s.
        </p>
        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
          <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
            <thead style="background: #f8f9fa; position: sticky; top: 0;">
              <tr>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Club</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd; width: 100px;">Action</th>
              </tr>
            </thead>
            <tbody id="clubEmailsBody">
              <tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Gestion des Contacts</h3>

        <div style="margin-bottom: 20px;">
          <button class="btn" id="syncContactsBtn" style="background: #4CAF50;">
            Synchroniser avec les joueurs/inscriptions
          </button>
          <p style="color: #666; font-size: 12px; margin-top: 5px;">
            Importe les donnees de la table Joueurs et met a jour les emails depuis les Inscriptions.
          </p>
        </div>

        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
            <input type="checkbox" id="filterActifOnly" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
            <span style="font-weight: 500;">Afficher uniquement les contacts Actifs</span>
          </label>
          <span id="contactsCountDisplay" style="color: #666; font-size: 13px; margin-left: 15px;"></span>
        </div>

        <div id="loadingAllContacts" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div class="table-container">
          <table id="allContactsTable">
            <thead>
              <tr>
                <th>Licence</th>
                <th>Nom</th>
                <th>Prenom</th>
                <th>Club</th>
                <th>Email</th>
                <th>Telephone</th>
                <th>Statut</th>
                <th>Opt-in</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allContactsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Edit Contact Modal -->
      <div id="editContactModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-top: 0;">Modifier le contact</h3>
          <form id="editContactForm">
            <input type="hidden" id="edit_contact_id">

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
              <input type="email" id="edit_contact_email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telephone</label>
              <input type="text" id="edit_contact_telephone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Statut</label>
              <select id="edit_contact_statut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="Actif">Actif</option>
                <option value="Inactif">Inactif</option>
                <option value="Suspendu">Suspendu</option>
              </select>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Commentaires</label>
              <textarea id="edit_contact_comments" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label>
                <input type="checkbox" id="edit_contact_optin"> Accepte les emails (opt-in)
              </label>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
              <button type="button" id="cancelEditContactBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- TAB: Templates -->
    <div id="tab-templates" class="tab-content">
      <!-- Convocation Template -->
      <div class="card">
        <h3>Template Convocation</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de convocation aux tournois.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{player_name}</code>
          <code>{category}</code> <code>{tournament}</code> <code>{date}</code> <code>{lieu}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Objet</label>
          <input type="text" id="convocationSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Corps du message</label>
          <div id="convocationBodyEditor"></div>
        </div>

        <button class="btn" id="saveConvocationTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetConvocationTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Convocation Finale Template -->
      <div class="card" style="margin-top: 20px;">
        <h3>üèÜ Template Convocation Finale</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de convocation aux finales d√©partementales.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{player_name}</code>
          <code>{category}</code> <code>{finale_name}</code> <code>{date}</code> <code>{lieu}</code>
          <code>{mode}</code> <code>{rank_position}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Objet</label>
          <input type="text" id="finaleConvocationSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Corps du message</label>
          <div id="finaleConvocationBodyEditor"></div>
        </div>

        <button class="btn" id="saveFinaleConvocationTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetFinaleConvocationTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Results Template -->
      <div class="card" style="margin-top: 20px;">
        <h3>Template R√©sultats Tournoi</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de r√©sultats apr√®s un tournoi.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{tournament_name}</code>
          <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{player_position}</code> <code>{player_points}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte d'introduction</label>
          <div id="resultsIntroTemplateEditor"></div>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte de conclusion</label>
          <div id="resultsOutroTemplateEditor"></div>
        </div>

        <button class="btn" id="saveResultsTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetResultsTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Relance Templates -->
      <div class="card" style="margin-top: 20px;">
        <h3>Templates Relances Inscriptions</h3>
        <p style="color: #666; margin-bottom: 15px;">Personnalisez les templates pour les relances d'inscription (T2, T3, Finale).</p>

        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold;">S√©lectionner un template:</label>
          <select id="relanceTemplateSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
            <option value="">-- Choisir --</option>
            <option value="relance_t2">Relance T2 (joueurs du T1)</option>
            <option value="relance_t3">Relance T3 (joueurs au classement)</option>
            <option value="relance_finale">Relance Finale (qualifi√©s)</option>
          </select>
        </div>

        <div id="relanceTemplateEditor" style="display: none;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Sujet</label>
            <input type="text" id="relanceTemplateSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Message d'introduction</label>
            <div id="relanceTemplateIntroEditor"></div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Message de conclusion</label>
            <div id="relanceTemplateOutroEditor"></div>
          </div>

          <div class="template-vars" style="margin-bottom: 15px;">
            <strong>Variables disponibles:</strong>
            <code>{first_name}</code> <code>{last_name}</code> <code>{club}</code> <code>{category}</code>
            <span id="relanceTemplateExtraVars"></span>
          </div>

          <button class="btn" id="saveRelanceTemplateBtn" style="background: #28a745;">Enregistrer</button>
          <button class="btn" id="resetRelanceTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
        </div>
      </div>

      <!-- Club Reminder Template -->
      <div class="card" style="margin-top: 20px;">
        <h3>üìß Template Rappel Club</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de rappel envoy√©s aux clubs h√©bergeant les comp√©titions.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{club_name}</code> <code>{category}</code> <code>{tournament}</code>
          <code>{date}</code> <code>{time}</code> <code>{num_players}</code> <code>{num_tables}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Sujet</label>
          <input type="text" id="clubReminderSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Corps du message</label>
          <div id="clubReminderBodyEditor"></div>
        </div>

        <button class="btn" id="saveClubReminderTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetClubReminderTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>

        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px;">Tester le template</label>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <input type="email" id="clubReminderTestEmail" placeholder="Email de test" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 250px;">
            <button class="btn" id="testClubReminderBtn" style="background: #17a2b8;">Envoyer un test</button>
          </div>
          <p style="margin-top: 10px; font-size: 12px; color: #856404;">Envoie un email de test avec des donn√©es fictives pour v√©rifier le rendu.</p>
        </div>
      </div>

      <!-- Custom Templates -->
      <div class="card" style="margin-top: 20px;">
        <h3>Templates Personnalis√©s</h3>

        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold;">S√©lectionner un template:</label>
          <select id="templateEditSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
            <option value="">-- Choisir --</option>
          </select>
          <button class="btn" id="newTemplateBtn" style="margin-left: 10px; background: #4CAF50;">Nouveau template</button>
        </div>

        <div id="templateEditor" style="display: none;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cl√© du template</label>
            <input type="text" id="templateKey" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sujet</label>
            <input type="text" id="templateSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Corps du message</label>
            <div id="templateBodyEditor"></div>
          </div>

          <div class="template-vars">
            <strong>Variables disponibles:</strong>
            <code>{player_name}</code>
            <code>{first_name}</code>
            <code>{last_name}</code>
            <code>{club}</code>
          </div>

          <button class="btn" id="saveTemplateBtn" style="margin-top: 15px; background: #1F4788;">Sauvegarder</button>
        </div>
      </div>
    </div>

    <!-- TAB: History -->
    <div id="tab-history" class="tab-content">
      <!-- Historique Inscriptions/D√©sinscriptions (Player App) -->
      <div class="card">
        <h3>Historique Inscriptions (App Joueur)</h3>
        <p style="color: #666; font-size: 0.875rem; margin-bottom: 15px;">
          Emails automatiques envoy√©s lors des inscriptions et d√©sinscriptions via l'application joueur.
        </p>

        <div class="filter-bar" style="margin-bottom: 15px;">
          <select id="inscriptionTypeFilter" style="min-width: 150px;">
            <option value="">Tous les types</option>
            <option value="inscription">Inscriptions</option>
            <option value="desinscription">D√©sinscriptions</option>
          </select>
          <select id="inscriptionStatusFilter" style="min-width: 120px;">
            <option value="">Tous statuts</option>
            <option value="sent">Envoy√©</option>
            <option value="failed">√âchec</option>
          </select>
          <input type="date" id="inscriptionDateFrom" title="Date d√©but">
          <input type="date" id="inscriptionDateTo" title="Date fin">
          <button class="btn" onclick="loadInscriptionEmailLogs()" style="background: #1F4788;">Filtrer</button>
        </div>

        <div id="loadingInscriptionLogs" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Joueur</th>
                <th>Email</th>
                <th>Tournoi</th>
                <th>Mode</th>
                <th>Cat√©gorie</th>
                <th>Statut</th>
                <th class="admin-only-column" style="display: none;">Actions</th>
              </tr>
            </thead>
            <tbody id="inscriptionLogsBody"></tbody>
          </table>
        </div>

        <div id="noInscriptionLogs" style="display: none; text-align: center; padding: 30px; color: #666;">
          Aucun email d'inscription/d√©sinscription enregistr√©.
        </div>
      </div>

      <!-- Historique des campagnes -->
      <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0;">Historique des campagnes</h3>
          <button id="purgeCampaignsBtn" class="btn" style="background: #dc3545; padding: 8px 15px; font-size: 13px; display: none;">
            üóëÔ∏è Purger saison pr√©c√©dente
          </button>
        </div>

        <div id="loadingHistory" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Sujet</th>
                <th>Par</th>
                <th>Dest.</th>
                <th>Env.</th>
                <th>Ech.</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: Scheduled -->
    <div id="tab-scheduled" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="margin: 0;">Emails programm√©s</h3>
          <button id="triggerSchedulerBtn" class="btn" style="background: #17a2b8; padding: 8px 15px; font-size: 13px;">
            üîÑ Traiter maintenant
          </button>
        </div>

        <div id="loadingScheduled" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div id="scheduledList" class="scheduled-list"></div>
        <div id="noScheduled" style="text-align: center; color: #666; padding: 40px; display: none;">
          Aucun email programm√©.
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-box">
      <h3>Envoi en cours...</h3>
      <div class="spinner" style="margin: 20px auto;"></div>
      <p id="progressText">Preparation...</p>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Initialize Quill rich text editor
    const quill = new Quill('#emailBodyEditor', {
      theme: 'snow',
      placeholder: 'Contenu de l\'email...',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      }
    });

    // Initialize Quill for template editor
    const quillTemplate = new Quill('#templateBodyEditor', {
      theme: 'snow',
      placeholder: 'Corps du template...',
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline', 'strike'],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'align': [] }],
          ['link'],
          ['clean']
        ]
      }
    });

    // Shared Quill toolbar configuration
    const quillToolbar = [
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'align': [] }],
      ['link'],
      ['clean']
    ];

    // Initialize all Quill editors for templates
    const quillRelanceIntro = new Quill('#relanceIntroEditor', { theme: 'snow', placeholder: 'Message d\'introduction...', modules: { toolbar: quillToolbar } });
    const quillRelanceOutro = new Quill('#relanceOutroEditor', { theme: 'snow', placeholder: 'Message de conclusion...', modules: { toolbar: quillToolbar } });
    const quillResultsIntroText = new Quill('#resultsIntroTextEditor', { theme: 'snow', placeholder: 'Texte d\'introduction...', modules: { toolbar: quillToolbar } });
    const quillResultsOutroText = new Quill('#resultsOutroTextEditor', { theme: 'snow', placeholder: 'Texte de conclusion...', modules: { toolbar: quillToolbar } });
    const quillConvocationBody = new Quill('#convocationBodyEditor', { theme: 'snow', placeholder: 'Corps du message...', modules: { toolbar: quillToolbar } });
    const quillFinaleConvocationBody = new Quill('#finaleConvocationBodyEditor', { theme: 'snow', placeholder: 'Corps du message...', modules: { toolbar: quillToolbar } });
    const quillResultsIntroTemplate = new Quill('#resultsIntroTemplateEditor', { theme: 'snow', placeholder: 'Texte d\'introduction...', modules: { toolbar: quillToolbar } });
    const quillResultsOutroTemplate = new Quill('#resultsOutroTemplateEditor', { theme: 'snow', placeholder: 'Texte de conclusion...', modules: { toolbar: quillToolbar } });
    const quillRelanceTemplateIntro = new Quill('#relanceTemplateIntroEditor', { theme: 'snow', placeholder: 'Message d\'introduction...', modules: { toolbar: quillToolbar } });
    const quillRelanceTemplateOutro = new Quill('#relanceTemplateOutroEditor', { theme: 'snow', placeholder: 'Message de conclusion...', modules: { toolbar: quillToolbar } });
    const quillClubReminderBody = new Quill('#clubReminderBodyEditor', { theme: 'snow', placeholder: 'Corps du message...', modules: { toolbar: quillToolbar } });

    // Get user role
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Hide "Traiter maintenant" button for non-admins
    if (!isAdmin) {
      const triggerBtn = document.getElementById('triggerSchedulerBtn');
      if (triggerBtn) {
        triggerBtn.style.display = 'none';
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        // Load data for specific tabs
        if (tab.dataset.tab === 'relances') loadRelanceTemplates();
        if (tab.dataset.tab === 'results') loadImportedTournaments();
        if (tab.dataset.tab === 'contacts') { loadAllContacts(); loadClubEmails(); }
        if (tab.dataset.tab === 'templates') {
          loadConvocationTemplate();
          loadFinaleConvocationTemplate();
          loadResultsTemplate();
          loadRelanceTemplates();
          loadClubReminderTemplate();
        }
        if (tab.dataset.tab === 'history') {
          loadHistory();
          loadInscriptionEmailLogs();
        }
        if (tab.dataset.tab === 'scheduled') loadScheduled();
      });
    });

    let allContacts = [];
    let selectedContactIds = new Set();
    let allTournois = [];
    let allRankingCategories = [];
    let gameModesList = [];

    // Categories by mode - will be populated from API
    let categoriesByMode = {};

    // Load game modes from reference data API
    async function loadGameModes() {
      try {
        const response = await fetch(`${API_URL}/reference-data/game-modes?active_only=true`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          gameModesList = await response.json();

          // Populate modeFilter dropdown (Composer tab)
          const modeFilter = document.getElementById('modeFilter');
          modeFilter.innerHTML = '<option value="">Mode de jeu : tous</option>' +
            gameModesList.map(gm => `<option value="${gm.code}">${gm.display_name}</option>`).join('');

          // Populate relanceModeFilter dropdown (Relances tab)
          const relanceModeFilter = document.getElementById('relanceModeFilter');
          relanceModeFilter.innerHTML = '<option value="">-- S√©lectionner --</option>' +
            gameModesList.map(gm => `<option value="${gm.code}">${gm.display_name}</option>`).join('');
        }

        // Load categories to build categoriesByMode mapping
        const catResponse = await fetch(`${API_URL}/reference-data/categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (catResponse.ok) {
          const categories = await catResponse.json();
          // Build categoriesByMode from categories data (categories table is the single source of truth)
          categoriesByMode = {};
          categories.forEach(cat => {
            // Normalize mode: remove spaces and uppercase to match selector values
            const normalizedMode = cat.game_type.toUpperCase().replace(/ /g, '');

            if (!categoriesByMode[normalizedMode]) {
              categoriesByMode[normalizedMode] = [];
            }
            if (!categoriesByMode[normalizedMode].includes(cat.level)) {
              categoriesByMode[normalizedMode].push(cat.level);
            }
          });
        }
      } catch (error) {
        console.error('Error loading game modes:', error);
        // Fallback to default values if API fails
        categoriesByMode = {
          'LIBRE': ['N3', 'R1', 'R2', 'R3', 'R4'],
          'CADRE': ['N3', 'R1'],
          'BANDE': ['N3', 'R1', 'R2'],
          '3BANDES': ['N3', 'R1', 'R2']
        };
      }
    }

    // ==================== CONTACTS ====================

    async function loadContacts() {
      try {
        // Build query params from filters
        const params = new URLSearchParams();
        if (document.getElementById('activeOnlyFilter').checked) {
          params.append('activeOnly', 'true');
        }
        if (document.getElementById('playerAppUsersFilter').checked) {
          params.append('playerAppUsers', 'true');
        }
        const club = document.getElementById('clubFilter').value;
        if (club) params.append('club', club);
        const mode = document.getElementById('modeFilter').value;
        if (mode) params.append('mode', mode);
        const category = document.getElementById('categoryFilter').value;
        if (category) params.append('category', category);
        const tournoiId = document.getElementById('tournoiFilter').value;
        if (tournoiId) params.append('tournoiId', tournoiId);

        const url = `${API_URL}/emailing/contacts${params.toString() ? '?' + params.toString() : ''}`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load contacts');

        allContacts = await response.json();

        // Update stats
        document.getElementById('totalContacts').textContent = allContacts.length;
        document.getElementById('optinCount').textContent = allContacts.filter(c => c.email_optin === 1).length;

        displayContacts(allContacts);

        document.getElementById('loadingContacts').style.display = 'none';
        document.getElementById('contactsList').style.display = 'block';

      } catch (error) {
        console.error('Error loading contacts:', error);
        showError('Erreur lors du chargement des contacts');
      }
    }

    async function loadClubs() {
      try {
        const response = await fetch(`${API_URL}/emailing/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const clubs = await response.json();
          const select = document.getElementById('clubFilter');
          select.innerHTML = '<option value="">Tous les clubs</option>';
          clubs.forEach(club => {
            const option = document.createElement('option');
            option.value = club;
            option.textContent = club;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    async function loadTournois() {
      try {
        const response = await fetch(`${API_URL}/emailing/tournois`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          allTournois = await response.json();
          filterTournoisDropdown();
        }
      } catch (error) {
        console.error('Error loading tournois:', error);
      }
    }

    // Filter tournament dropdown based on selected mode/category
    function filterTournoisDropdown() {
      const selectedMode = document.getElementById('modeFilter').value;
      const selectedCategory = document.getElementById('categoryFilter').value;
      const select = document.getElementById('tournoiFilter');
      select.innerHTML = '<option value="">-- Tournois saison en cours --</option>';

      // Filter tournaments based on mode and category
      let filtered = allTournois;
      if (selectedMode) {
        filtered = filtered.filter(t => t.mode.toUpperCase() === selectedMode.toUpperCase());
      }
      if (selectedCategory) {
        filtered = filtered.filter(t => t.categorie.toUpperCase() === selectedCategory.toUpperCase());
      }

      // Group by mode
      const byMode = {};
      filtered.forEach(t => {
        if (!byMode[t.mode]) byMode[t.mode] = [];
        byMode[t.mode].push(t);
      });

      Object.keys(byMode).sort().forEach(mode => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = mode;
        byMode[mode].forEach(t => {
          const option = document.createElement('option');
          option.value = t.tournoi_id;
          const date = t.debut ? new Date(t.debut).toLocaleDateString('fr-FR') : '';
          option.textContent = `${t.nom} ${t.categorie} ${date} (${t.nb_inscrits} inscrits)`;
          optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
      });
    }

    async function loadRankingCategories() {
      try {
        const response = await fetch(`${API_URL}/emailing/ranking-categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          allRankingCategories = await response.json();
          filterRankingsDropdown();
        }
      } catch (error) {
        console.error('Error loading ranking categories:', error);
      }
    }

    // Filter rankings dropdown based on selected mode/category
    function filterRankingsDropdown() {
      const selectedMode = document.getElementById('modeFilter').value;
      const selectedCategory = document.getElementById('categoryFilter').value;
      const select = document.getElementById('rankingFilter');
      select.innerHTML = '<option value="">-- Classements --</option>';

      // Filter rankings based on mode and category
      let filtered = allRankingCategories;
      if (selectedMode) {
        filtered = filtered.filter(c => c.game_type.toUpperCase() === selectedMode.toUpperCase());
      }
      if (selectedCategory) {
        filtered = filtered.filter(c => c.level.toUpperCase() === selectedCategory.toUpperCase());
      }

      // Group by game_type
      const byMode = {};
      filtered.forEach(c => {
        if (!byMode[c.game_type]) byMode[c.game_type] = [];
        byMode[c.game_type].push(c);
      });

      Object.keys(byMode).sort().forEach(mode => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = mode;
        byMode[mode].forEach(c => {
          const option = document.createElement('option');
          option.value = c.id;
          option.textContent = `${c.display_name} (${c.player_count} joueurs)`;
          optgroup.appendChild(option);
        });
        select.appendChild(optgroup);
      });
    }

    async function loadRankingContacts(categoryId) {
      try {
        document.getElementById('loadingContacts').style.display = 'block';
        document.getElementById('contactsList').style.display = 'none';

        const response = await fetch(`${API_URL}/emailing/ranking-contacts?categoryId=${categoryId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load ranking contacts');

        allContacts = await response.json();

        // Update stats
        document.getElementById('totalContacts').textContent = allContacts.length;
        document.getElementById('optinCount').textContent = allContacts.filter(c => c.email_optin === 1).length;

        displayContacts(allContacts);

        document.getElementById('loadingContacts').style.display = 'none';
        document.getElementById('contactsList').style.display = 'block';

      } catch (error) {
        console.error('Error loading ranking contacts:', error);
        showError('Erreur lors du chargement des contacts du classement');
      }
    }

    // Update category dropdown based on selected mode
    function updateCategoryFilter() {
      const modeRaw = document.getElementById('modeFilter').value;
      const categorySelect = document.getElementById('categoryFilter');

      categorySelect.innerHTML = '<option value="">Classement FFB : tous</option>';

      // Normalize mode to match categoriesByMode keys (remove spaces, uppercase)
      const mode = modeRaw ? modeRaw.toUpperCase().replace(/ /g, '') : '';

      if (mode && categoriesByMode[mode]) {
        categorySelect.disabled = false;
        categoriesByMode[mode].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
      } else {
        categorySelect.disabled = true;
      }
    }

    function displayContacts(contacts) {
      const list = document.getElementById('contactsList');
      list.innerHTML = '';

      if (contacts.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Aucun contact trouve</div>';
        return;
      }

      contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'contact-item' + (selectedContactIds.has(contact.id) ? ' selected' : '');
        div.innerHTML = `
          <input type="checkbox" class="contact-checkbox" data-id="${contact.id}" ${selectedContactIds.has(contact.id) ? 'checked' : ''}>
          <div class="contact-info">
            <div class="contact-name">${contact.last_name} ${contact.first_name}</div>
            <div class="contact-details">
              ${contact.email || 'Pas d\'email'} | ${contact.club || '-'}
            </div>
          </div>
          ${contact.statut === 'Actif' ? '<span class="badge badge-actif">Actif</span>' : '<span class="badge badge-inactif">Inactif</span>'}
        `;

        const checkbox = div.querySelector('.contact-checkbox');
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedContactIds.add(contact.id);
            div.classList.add('selected');
          } else {
            selectedContactIds.delete(contact.id);
            div.classList.remove('selected');
          }
          updateSelectedCount();
        });

        list.appendChild(div);
      });
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedContactIds.size;
    }

    function applyContactFilters() {
      const searchTerm = document.getElementById('contactSearch').value.toLowerCase();

      let filtered = allContacts;

      if (searchTerm) {
        filtered = filtered.filter(c =>
          (c.first_name || '').toLowerCase().includes(searchTerm) ||
          (c.last_name || '').toLowerCase().includes(searchTerm) ||
          (c.email || '').toLowerCase().includes(searchTerm) ||
          (c.club || '').toLowerCase().includes(searchTerm)
        );
      }

      displayContacts(filtered);
    }

    // Reload contacts when filters change (server-side filtering)
    async function onFilterChange() {
      selectedContactIds.clear();
      updateSelectedCount();
      document.getElementById('loadingContacts').style.display = 'block';
      document.getElementById('contactsList').style.display = 'none';
      await loadContacts();
    }

    // Filter event listeners
    document.getElementById('contactSearch').addEventListener('input', applyContactFilters);
    document.getElementById('activeOnlyFilter').addEventListener('change', onFilterChange);
    document.getElementById('playerAppUsersFilter').addEventListener('change', onFilterChange);
    document.getElementById('clubFilter').addEventListener('change', onFilterChange);
    document.getElementById('modeFilter').addEventListener('change', () => {
      updateCategoryFilter();
      filterTournoisDropdown();
      filterRankingsDropdown();
      onFilterChange();
    });
    document.getElementById('categoryFilter').addEventListener('change', () => {
      filterTournoisDropdown();
      filterRankingsDropdown();
      onFilterChange();
    });
    document.getElementById('tournoiFilter').addEventListener('change', () => {
      // Clear ranking filter when selecting tournament
      if (document.getElementById('tournoiFilter').value) {
        document.getElementById('rankingFilter').value = '';
      }
      onFilterChange();
    });
    document.getElementById('rankingFilter').addEventListener('change', () => {
      const rankingId = document.getElementById('rankingFilter').value;
      if (rankingId) {
        // Clear tournament filter when selecting ranking
        document.getElementById('tournoiFilter').value = '';
        loadRankingContacts(rankingId);
      } else {
        loadContacts();
      }
    });

    // Select all / Deselect all
    document.getElementById('selectAllBtn').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.contact-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedContactIds.add(parseInt(cb.dataset.id));
        cb.closest('.contact-item').classList.add('selected');
      });
      updateSelectedCount();
    });

    document.getElementById('deselectAllBtn').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.contact-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
        cb.closest('.contact-item').classList.remove('selected');
      });
      selectedContactIds.clear();
      updateSelectedCount();
    });

    // ==================== SEND EMAILS ====================

    document.getElementById('scheduleCheck').addEventListener('change', (e) => {
      const options = document.getElementById('scheduleOptions');
      const sendNowBtn = document.getElementById('sendNowBtn');
      const scheduleBtn = document.getElementById('scheduleBtn');

      if (e.target.checked) {
        options.style.display = 'block';
        sendNowBtn.style.display = 'none';
        scheduleBtn.style.display = 'block';
      } else {
        options.style.display = 'none';
        sendNowBtn.style.display = 'block';
        scheduleBtn.style.display = 'none';
      }
    });

    // One-Shot: Recap checkbox toggle
    document.getElementById('oneShotCcCheck').addEventListener('change', (e) => {
      document.getElementById('oneShotCcEmailInput').style.opacity = e.target.checked ? '1' : '0.5';
      document.getElementById('oneShotCcEmail').disabled = !e.target.checked;
    });

    // One-Shot: Test mode toggle
    document.getElementById('oneShotTestModeCheck').addEventListener('change', (e) => {
      const testEmailInput = document.getElementById('oneShotTestEmailInput');
      const sendBtn = document.getElementById('sendNowBtn');

      if (e.target.checked) {
        testEmailInput.style.display = 'block';
        sendBtn.textContent = 'Envoyer le Test';
        sendBtn.style.background = '#FF9800';
      } else {
        testEmailInput.style.display = 'none';
        sendBtn.textContent = 'Envoyer maintenant';
        sendBtn.style.background = '#1F4788';
      }
    });

    // Load saved summary email for one-shot
    async function loadOneShotCcEmail() {
      try {
        const response = await fetch(`${API_URL}/emailing/summary-email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.email) {
            document.getElementById('oneShotCcEmail').value = data.email;
          }
        }
      } catch (error) {
        console.log('Using default summary email for one-shot');
      }
    }
    loadOneShotCcEmail();

    document.getElementById('sendNowBtn').addEventListener('click', sendEmails);
    document.getElementById('scheduleBtn').addEventListener('click', scheduleEmail);

    async function sendEmails() {
      const isTestMode = document.getElementById('oneShotTestModeCheck').checked;
      const testEmail = document.getElementById('oneShotTestEmail').value.trim();

      // In test mode, we don't require contact selection
      if (selectedContactIds.size === 0 && !isTestMode) {
        showError('Veuillez selectionner au moins un destinataire.');
        return;
      }

      const subject = document.getElementById('emailSubject').value.trim();
      const body = quill.root.innerHTML;
      const bodyText = quill.getText().trim();

      if (!subject || !bodyText) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      // Validate test mode email
      if (isTestMode && (!testEmail || !testEmail.includes('@'))) {
        showError('Mode Test activ√©: veuillez saisir une adresse email valide.');
        return;
      }

      const confirmMsg = isTestMode
        ? `MODE TEST: Envoyer l'email uniquement √† ${testEmail} ?`
        : `Envoyer l'email a ${selectedContactIds.size} destinataire(s) ?`;

      if (!confirm(confirmMsg)) {
        return;
      }

      showProgress('Envoi en cours...');

      try {
        const response = await fetch(`${API_URL}/emailing/send`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientIds: Array.from(selectedContactIds),
            subject,
            body,
            templateKey: document.getElementById('templateSelect').value || null,
            imageUrl: document.getElementById('imageUrl').value || null,
            testMode: isTestMode,
            testEmail: isTestMode ? testEmail : null,
            ccEmail: document.getElementById('oneShotCcCheck').checked ? document.getElementById('oneShotCcEmail').value.trim() : null
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);
          // Only clear form if NOT in test mode (keep content for final send)
          if (!isTestMode) {
            document.getElementById('emailSubject').value = '';
            quill.setContents([]);
            resetImageUI();
            selectedContactIds.clear();
            updateSelectedCount();
            applyContactFilters();
          }
        } else {
          showError(result.error || 'Erreur lors de l\'envoi.');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    }

    async function scheduleEmail() {
      if (selectedContactIds.size === 0) {
        showError('Veuillez selectionner au moins un destinataire.');
        return;
      }

      const subject = document.getElementById('emailSubject').value.trim();
      const body = quill.root.innerHTML;
      const bodyText = quill.getText().trim();
      const scheduledAt = document.getElementById('scheduledAt').value;

      if (!subject || !bodyText) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      if (!scheduledAt) {
        showError('Veuillez choisir une date et heure.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/schedule`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientIds: Array.from(selectedContactIds),
            subject,
            body,
            templateKey: document.getElementById('templateSelect').value || null,
            imageUrl: document.getElementById('imageUrl').value || null,
            scheduledAt
          })
        });

        const result = await response.json();

        if (response.ok) {
          showSuccess(result.message);
          // Clear form
          document.getElementById('emailSubject').value = '';
          quill.setContents([]);
          resetImageUI();
          document.getElementById('scheduledAt').value = '';
          document.getElementById('scheduleCheck').checked = false;
          document.getElementById('scheduleOptions').style.display = 'none';
          document.getElementById('sendNowBtn').style.display = 'block';
          document.getElementById('scheduleBtn').style.display = 'none';
          selectedContactIds.clear();
          updateSelectedCount();
          applyContactFilters();
        } else {
          showError(result.error || 'Erreur lors de la programmation.');
        }

      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    // ==================== TEMPLATES ====================

    async function loadTemplates() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const templates = await response.json();

          // Templates that have dedicated editors or are automatic (exclude from Composer)
          const excludedFromComposer = ['convocation', 'finale_convocation', 'results', 'results_cc_email', 'club_reminder'];

          // Update the template selector (for using templates in Composer)
          const select = document.getElementById('templateSelect');
          select.innerHTML = '<option value="">-- Aucun template --</option>';
          templates
            .filter(t => !excludedFromComposer.includes(t.template_key) && !t.template_key.startsWith('relance_'))
            .forEach(t => {
              const option = document.createElement('option');
              option.value = t.template_key;
              option.textContent = t.template_key;
              select.appendChild(option);
            });

          // Update the template editor selector (for editing templates)
          const editSelect = document.getElementById('templateEditSelect');
          editSelect.innerHTML = '<option value="">-- Choisir --</option>';
          templates.forEach(t => {
            const option = document.createElement('option');
            option.value = t.template_key;
            option.textContent = t.template_key;
            editSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    document.getElementById('templateSelect').addEventListener('change', async (e) => {
      if (!e.target.value) return;

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${e.target.value}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('emailSubject').value = template.subject_template;
          // Convert plain text line breaks to HTML for Quill
          const htmlContent = template.body_template.replace(/\n/g, '<br>');
          quill.clipboard.dangerouslyPasteHTML(htmlContent);
        }
      } catch (error) {
        console.error('Error loading template:', error);
      }
    });

    document.getElementById('templateEditSelect').addEventListener('change', async (e) => {
      const key = e.target.value;
      if (!key) {
        document.getElementById('templateEditor').style.display = 'none';
        return;
      }

      document.getElementById('templateEditor').style.display = 'block';
      document.getElementById('templateKey').value = key;
      document.getElementById('templateKey').readOnly = true;

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${key}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('templateSubject').value = template.subject_template;
          // Convert plain text line breaks to HTML for Quill
          const htmlContent = (template.body_template || '').replace(/\n/g, '<br>');
          quillTemplate.clipboard.dangerouslyPasteHTML(htmlContent);
        } else {
          // New template
          document.getElementById('templateSubject').value = '';
          quillTemplate.setContents([]);
        }
      } catch (error) {
        document.getElementById('templateSubject').value = '';
        quillTemplate.setContents([]);
      }
    });

    document.getElementById('newTemplateBtn').addEventListener('click', () => {
      document.getElementById('templateEditSelect').value = '';
      document.getElementById('templateEditor').style.display = 'block';
      document.getElementById('templateKey').value = '';
      document.getElementById('templateKey').readOnly = false;
      document.getElementById('templateSubject').value = '';
      quillTemplate.setContents([]);
    });

    document.getElementById('saveTemplateBtn').addEventListener('click', async () => {
      const key = document.getElementById('templateKey').value.trim();
      const subject = document.getElementById('templateSubject').value.trim();
      const body = quillTemplate.root.innerHTML;
      const bodyText = quillTemplate.getText().trim();

      if (!key || !subject || !bodyText) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${key}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template sauvegard√© !');
          loadTemplates();
          // Clear form and hide editor
          document.getElementById('templateKey').value = '';
          document.getElementById('templateSubject').value = '';
          quillTemplate.setContents([]);
          document.getElementById('templateEditor').style.display = 'none';
          document.getElementById('templateEditSelect').value = '';
        } else {
          const errorData = await response.json().catch(() => ({}));
          showError(errorData.error || 'Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== CONVOCATION & RESULTS TEMPLATES ====================

    const DEFAULT_CONVOCATION_TEMPLATE = {
      subject: 'Convocation {category} - {tournament} - {date}',
      body: `Bonjour {player_name},

Le CDBHS a le plaisir de vous convier au tournoi suivant.

Veuillez trouver en attachement votre convocation d√©taill√©e avec la composition de toutes les poules du tournoi.

En cas d'emp√™chement, merci d'informer d√®s que possible l'√©quipe en charge du sportif √† l'adresse ci-dessous.

Nous vous souhaitons une excellente comp√©tition.

Cordialement,
Comit√© D√©partemental Billard Hauts-de-Seine`
    };

    const DEFAULT_FINALE_CONVOCATION_TEMPLATE = {
      subject: 'Convocation Finale D√©partementale {mode} - {category} - {date}',
      body: `Bonjour {player_name},

Suite aux trois tournois de la saison, nous avons le plaisir de vous informer que vous √™tes qualifi√©(e) pour la Finale D√©partementale {mode} - {category}.

Vous trouverez ci-joint votre convocation avec la liste des finalistes.

En cas d'emp√™chement, merci de nous pr√©venir d√®s que possible √† l'adresse ci-dessous.

Nous vous souhaitons une excellente finale !

Sportivement,
Comit√© D√©partemental Billard Hauts-de-Seine`
    };

    const DEFAULT_RESULTS_TEMPLATE = {
      intro: `Bonjour {first_name},

Voici les r√©sultats du tournoi {tournament_name} qui s'est d√©roul√© le {tournament_date} √† {tournament_lieu}.

F√©licitations √† tous les participants !`,
      outro: `Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine`
    };

    const DEFAULT_CLUB_REMINDER_TEMPLATE = {
      subject: 'Rappel Organisation - {category} {tournament}',
      body: `Bonjour,

Votre club {club_name} accueille prochainement une comp√©tition du CDBHS.

D√âTAILS DE LA COMP√âTITION:
- Comp√©tition: {category} - {tournament}
- Date: {date}
- Horaire: {time}
- Participants: {num_players} joueur(s)
- Tables n√©cessaires: {num_tables} table(s)

RAPPELS IMPORTANTS:
- Ma√Ætre de jeu: Merci de pr√©voir la pr√©sence d'un ma√Ætre de jeu pour encadrer la comp√©tition
- Arbitrage: Si vous avez des arbitres disponibles, merci de nous le signaler. Sinon, l'autoarbitrage sera mis en place
- R√©sultats FFB: Les r√©sultats devront √™tre saisis sur le site de la FFB √† l'issue de la comp√©tition
- Rafra√Æchissements: Merci de pr√©voir des rafra√Æchissements pour les joueurs

Pour toute question, contactez-nous √† l'adresse: cdbhs92@gmail.com

Sportivement,
Le CDBHS`
    };

    async function loadConvocationTemplate() {
      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('convocationSubject').value = template.subject_template || DEFAULT_CONVOCATION_TEMPLATE.subject;
          quillConvocationBody.clipboard.dangerouslyPasteHTML((template.body_template || DEFAULT_CONVOCATION_TEMPLATE.body).replace(/\n/g, '<br>'));
        } else {
          document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
          quillConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
        }
      } catch (error) {
        document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
        quillConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
      }
    }

    async function loadFinaleConvocationTemplate() {
      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation-finale`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('finaleConvocationSubject').value = template.subject_template || DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
          quillFinaleConvocationBody.setContents([]);
          quillFinaleConvocationBody.clipboard.dangerouslyPasteHTML((template.body_template || DEFAULT_FINALE_CONVOCATION_TEMPLATE.body).replace(/\n/g, '<br>'));
        } else {
          document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
          quillFinaleConvocationBody.setContents([]);
          quillFinaleConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_FINALE_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
        }
      } catch (error) {
        document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
        quillFinaleConvocationBody.setContents([]);
        quillFinaleConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_FINALE_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
      }
    }

    async function loadResultsTemplate() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates/results`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        let intro = DEFAULT_RESULTS_TEMPLATE.intro;
        let outro = DEFAULT_RESULTS_TEMPLATE.outro;

        if (response.ok) {
          const template = await response.json();
          // Parse the body which contains intro and outro separated by a delimiter
          const parts = (template.body_template || '').split('---OUTRO---');
          intro = parts[0] || DEFAULT_RESULTS_TEMPLATE.intro;
          outro = parts[1] || DEFAULT_RESULTS_TEMPLATE.outro;
        }

        // Update both the Templates tab fields AND the Results tab fields
        quillResultsIntroTemplate.setContents([]);
        quillResultsIntroTemplate.clipboard.dangerouslyPasteHTML(intro.replace(/\n/g, '<br>'));
        quillResultsOutroTemplate.setContents([]);
        quillResultsOutroTemplate.clipboard.dangerouslyPasteHTML(outro.replace(/\n/g, '<br>'));
        quillResultsIntroText.setContents([]);
        quillResultsIntroText.clipboard.dangerouslyPasteHTML(intro.replace(/\n/g, '<br>'));
        quillResultsOutroText.setContents([]);
        quillResultsOutroText.clipboard.dangerouslyPasteHTML(outro.replace(/\n/g, '<br>'));

      } catch (error) {
        quillResultsIntroTemplate.setContents([]);
        quillResultsIntroTemplate.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.intro.replace(/\n/g, '<br>'));
        quillResultsOutroTemplate.setContents([]);
        quillResultsOutroTemplate.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.outro.replace(/\n/g, '<br>'));
        quillResultsIntroText.setContents([]);
        quillResultsIntroText.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.intro.replace(/\n/g, '<br>'));
        quillResultsOutroText.setContents([]);
        quillResultsOutroText.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.outro.replace(/\n/g, '<br>'));
      }
    }

    document.getElementById('saveConvocationTemplateBtn').addEventListener('click', async () => {
      const subject = document.getElementById('convocationSubject').value.trim();
      const body = quillConvocationBody.root.innerHTML;
      const bodyText = quillConvocationBody.getText().trim();

      if (!subject || !bodyText) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template convocation enregistr√©!');
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetConvocationTemplateBtn').addEventListener('click', () => {
      document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
      quillConvocationBody.setContents([]);
      quillConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    // Finale Convocation Template handlers
    document.getElementById('saveFinaleConvocationTemplateBtn').addEventListener('click', async () => {
      const subject = document.getElementById('finaleConvocationSubject').value.trim();
      const body = quillFinaleConvocationBody.root.innerHTML;
      const bodyText = quillFinaleConvocationBody.getText().trim();

      if (!subject || !bodyText) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation-finale`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template convocation finale enregistr√©!');
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetFinaleConvocationTemplateBtn').addEventListener('click', () => {
      document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
      quillFinaleConvocationBody.setContents([]);
      quillFinaleConvocationBody.clipboard.dangerouslyPasteHTML(DEFAULT_FINALE_CONVOCATION_TEMPLATE.body.replace(/\n/g, '<br>'));
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    document.getElementById('saveResultsTemplateBtn').addEventListener('click', async () => {
      const intro = quillResultsIntroTemplate.root.innerHTML;
      const introText = quillResultsIntroTemplate.getText().trim();
      const outro = quillResultsOutroTemplate.root.innerHTML;
      const outroText = quillResultsOutroTemplate.getText().trim();

      if (!introText || !outroText) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/results`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: 'R√©sultats Tournoi',
            body_template: intro + '---OUTRO---' + outro
          })
        });

        if (response.ok) {
          showSuccess('Template r√©sultats enregistr√©!');
          // Also update the Results tab Quill editors
          quillResultsIntroText.setContents([]);
          quillResultsIntroText.clipboard.dangerouslyPasteHTML(intro);
          quillResultsOutroText.setContents([]);
          quillResultsOutroText.clipboard.dangerouslyPasteHTML(outro);
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetResultsTemplateBtn').addEventListener('click', () => {
      quillResultsIntroTemplate.setContents([]);
      quillResultsIntroTemplate.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.intro.replace(/\n/g, '<br>'));
      quillResultsOutroTemplate.setContents([]);
      quillResultsOutroTemplate.clipboard.dangerouslyPasteHTML(DEFAULT_RESULTS_TEMPLATE.outro.replace(/\n/g, '<br>'));
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    // ==================== CLUB REMINDER TEMPLATE ====================

    async function loadClubReminderTemplate() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates/club_reminder`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('clubReminderSubject').value = template.subject_template || DEFAULT_CLUB_REMINDER_TEMPLATE.subject;
          quillClubReminderBody.setContents([]);
          quillClubReminderBody.clipboard.dangerouslyPasteHTML((template.body_template || DEFAULT_CLUB_REMINDER_TEMPLATE.body).replace(/\n/g, '<br>'));
        } else {
          document.getElementById('clubReminderSubject').value = DEFAULT_CLUB_REMINDER_TEMPLATE.subject;
          quillClubReminderBody.setContents([]);
          quillClubReminderBody.clipboard.dangerouslyPasteHTML(DEFAULT_CLUB_REMINDER_TEMPLATE.body.replace(/\n/g, '<br>'));
        }
      } catch (error) {
        document.getElementById('clubReminderSubject').value = DEFAULT_CLUB_REMINDER_TEMPLATE.subject;
        quillClubReminderBody.setContents([]);
        quillClubReminderBody.clipboard.dangerouslyPasteHTML(DEFAULT_CLUB_REMINDER_TEMPLATE.body.replace(/\n/g, '<br>'));
      }
    }

    document.getElementById('saveClubReminderTemplateBtn').addEventListener('click', async () => {
      const subject = document.getElementById('clubReminderSubject').value.trim();
      const body = quillClubReminderBody.root.innerHTML;
      const bodyText = quillClubReminderBody.getText().trim();

      if (!subject || !bodyText) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/club_reminder`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template rappel club enregistr√©!');
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetClubReminderTemplateBtn').addEventListener('click', () => {
      document.getElementById('clubReminderSubject').value = DEFAULT_CLUB_REMINDER_TEMPLATE.subject;
      quillClubReminderBody.setContents([]);
      quillClubReminderBody.clipboard.dangerouslyPasteHTML(DEFAULT_CLUB_REMINDER_TEMPLATE.body.replace(/\n/g, '<br>'));
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    document.getElementById('testClubReminderBtn').addEventListener('click', async () => {
      const testEmail = document.getElementById('clubReminderTestEmail').value.trim();
      if (!testEmail) {
        showError('Veuillez entrer une adresse email de test.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/email/send-club-reminder`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            clubName: 'Club Test (Exemple)',
            clubEmail: testEmail,
            category: 'LIBRE R3',
            tournament: '2',
            tournamentDate: new Date().toISOString(),
            startTime: '14H00',
            numPlayers: 6,
            numTables: 2
          })
        });

        const result = await response.json();
        if (result.success) {
          showSuccess(`Email de test envoy√© √† ${testEmail}`);
        } else {
          showError(result.error || result.message || 'Erreur lors de l\'envoi');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== RELANCE TEMPLATES EDITOR ====================

    const DEFAULT_RELANCE_TEMPLATES_CLIENT = {
      relance_t2: {
        subject: 'Inscription T2 {category} - Confirmez votre participation',
        intro: `Bonjour {first_name},

Vous avez particip√© au premier tournoi {category} qui s'est d√©roul√© le {t1_date} o√π vous avez termin√© √† la {t1_position}√®me place.

Le deuxi√®me tournoi de la saison aura lieu le {tournament_date} √† {tournament_lieu}.

Pour participer, merci de confirmer votre inscription en r√©pondant √† cet email avant le {deadline_date}.`,
        outro: `Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine`
      },
      relance_t3: {
        subject: 'Inscription T3 {category} - Confirmez votre participation',
        intro: `Bonjour {first_name},

Vous √™tes actuellement class√©(e) {rank_position}√®me au classement g√©n√©ral {category} avec {total_points} points match.

Le troisi√®me et dernier tournoi qualificatif aura lieu le {tournament_date} √† {tournament_lieu}.

Ce tournoi est d√©terminant pour la qualification √† la finale d√©partementale. Pour participer, merci de confirmer votre inscription en r√©pondant √† cet email avant le {deadline_date}.`,
        outro: `Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine`
      },
      relance_finale: {
        subject: 'Confirmation participation Finale {category}',
        intro: `Bonjour {first_name},

F√©licitations ! Vous √™tes qualifi√©(e) pour la finale d√©partementale {category} !

Vous avez termin√© {rank_position}√®me au classement g√©n√©ral avec {total_points} points match, ce qui vous place parmi les {qualified_count} finalistes.

La finale aura lieu le {finale_date} √† {finale_lieu}.

Merci de confirmer votre participation en r√©pondant √† cet email avant le {deadline_date}.`,
        outro: `Nous comptons sur votre pr√©sence !

Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine`
      }
    };

    let currentRelanceTemplateKey = '';

    document.getElementById('relanceTemplateSelect').addEventListener('change', async (e) => {
      const key = e.target.value;
      const editor = document.getElementById('relanceTemplateEditor');
      const extraVarsSpan = document.getElementById('relanceTemplateExtraVars');

      if (!key) {
        editor.style.display = 'none';
        currentRelanceTemplateKey = '';
        return;
      }

      currentRelanceTemplateKey = key;
      editor.style.display = 'block';

      // Set extra vars based on template type
      if (key === 'relance_t2') {
        extraVarsSpan.innerHTML = '<code>{t1_position}</code> <code>{t1_points}</code> <code>{t1_date}</code> <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{deadline_date}</code>';
      } else if (key === 'relance_t3') {
        extraVarsSpan.innerHTML = '<code>{rank_position}</code> <code>{total_points}</code> <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{deadline_date}</code>';
      } else if (key === 'relance_finale') {
        extraVarsSpan.innerHTML = '<code>{rank_position}</code> <code>{total_points}</code> <code>{qualified_count}</code> <code>{finale_date}</code> <code>{finale_lieu}</code> <code>{deadline_date}</code>';
      }

      // Load template from server or use default
      const template = relanceTemplates[key] || DEFAULT_RELANCE_TEMPLATES_CLIENT[key];
      document.getElementById('relanceTemplateSubject').value = template.subject || '';
      quillRelanceTemplateIntro.setContents([]);
      quillRelanceTemplateIntro.clipboard.dangerouslyPasteHTML((template.intro || '').replace(/\n/g, '<br>'));
      quillRelanceTemplateOutro.setContents([]);
      quillRelanceTemplateOutro.clipboard.dangerouslyPasteHTML((template.outro || '').replace(/\n/g, '<br>'));
    });

    document.getElementById('saveRelanceTemplateBtn').addEventListener('click', async () => {
      if (!currentRelanceTemplateKey) return;

      const subject = document.getElementById('relanceTemplateSubject').value.trim();
      const intro = quillRelanceTemplateIntro.root.innerHTML;
      const introText = quillRelanceTemplateIntro.getText().trim();
      const outro = quillRelanceTemplateOutro.root.innerHTML;

      if (!subject || !introText) {
        showError('Le sujet et le message d\'introduction sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/relance-templates/${currentRelanceTemplateKey}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ subject, intro, outro })
        });

        if (response.ok) {
          showSuccess('Template relance enregistr√©!');
          // Update local cache
          relanceTemplates[currentRelanceTemplateKey] = { subject, intro, outro };
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetRelanceTemplateBtn').addEventListener('click', () => {
      if (!currentRelanceTemplateKey) return;

      const defaultTemplate = DEFAULT_RELANCE_TEMPLATES_CLIENT[currentRelanceTemplateKey];
      document.getElementById('relanceTemplateSubject').value = defaultTemplate.subject;
      quillRelanceTemplateIntro.setContents([]);
      quillRelanceTemplateIntro.clipboard.dangerouslyPasteHTML(defaultTemplate.intro.replace(/\n/g, '<br>'));
      quillRelanceTemplateOutro.setContents([]);
      quillRelanceTemplateOutro.clipboard.dangerouslyPasteHTML(defaultTemplate.outro.replace(/\n/g, '<br>'));
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    // ==================== CLUB EMAILS ====================

    async function loadClubEmails() {
      const tbody = document.getElementById('clubEmailsBody');
      tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">Chargement...</td></tr>';

      try {
        const response = await fetch(`${API_URL}/emailing/clubs-with-emails`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Erreur chargement clubs');

        const clubs = await response.json();

        if (clubs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #666;">Aucun club trouv√©</td></tr>';
          return;
        }

        tbody.innerHTML = clubs.map(club => `
          <tr style="border-bottom: 1px solid #eee;" data-club="${club.name.replace(/"/g, '&quot;')}">
            <td style="padding: 10px; font-weight: 500;">${club.name}</td>
            <td style="padding: 10px;">
              <input type="email" class="club-email-input" value="${club.email || ''}"
                     placeholder="email@club.com"
                     style="width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
            </td>
            <td style="padding: 10px; text-align: center;">
              <button class="btn save-club-email-btn" style="background: #28a745; padding: 5px 12px; font-size: 12px;">
                Sauver
              </button>
            </td>
          </tr>
        `).join('');

        // Add event listeners
        document.querySelectorAll('.save-club-email-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const row = e.target.closest('tr');
            const clubName = row.dataset.club;
            const emailInput = row.querySelector('.club-email-input');
            const email = emailInput.value.trim();

            if (email && !email.includes('@')) {
              showError('Format email invalide');
              return;
            }

            try {
              const response = await fetch(`${API_URL}/emailing/clubs/${encodeURIComponent(clubName)}/email`, {
                method: 'PUT',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email || null })
              });

              if (!response.ok) throw new Error('Erreur sauvegarde');

              showSuccess(`Email ${email ? 'mis √† jour' : 'supprim√©'} pour ${clubName}`);
              e.target.style.background = '#28a745';
              setTimeout(() => e.target.style.background = '#28a745', 2000);
            } catch (error) {
              showError('Erreur: ' + error.message);
            }
          });
        });

      } catch (error) {
        console.error('Error loading club emails:', error);
        tbody.innerHTML = '<tr><td colspan="3" style="padding: 20px; text-align: center; color: #dc3545;">Erreur chargement</td></tr>';
      }
    }

    // ==================== ALL CONTACTS (Management) ====================

    let allContactsData = []; // Store contacts globally for filtering

    async function loadAllContacts() {
      document.getElementById('loadingAllContacts').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load contacts');

        allContactsData = await response.json();
        displayAllContacts();

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingAllContacts').style.display = 'none';
      }
    }

    // Toggle filter event listener
    document.getElementById('filterActifOnly').addEventListener('change', displayAllContacts);

    function displayAllContacts() {
      const tbody = document.getElementById('allContactsBody');
      tbody.innerHTML = '';

      const filterActif = document.getElementById('filterActifOnly').checked;
      const contacts = filterActif
        ? allContactsData.filter(c => (c.statut || 'Actif') === 'Actif')
        : allContactsData;

      // Update count display
      const countDisplay = document.getElementById('contactsCountDisplay');
      if (filterActif) {
        countDisplay.textContent = `${contacts.length} actif(s) sur ${allContactsData.length} total`;
      } else {
        countDisplay.textContent = `${allContactsData.length} contact(s)`;
      }

      if (contacts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Aucun contact. Utilisez le bouton "Synchroniser" pour importer les joueurs.</td></tr>';
        return;
      }

      contacts.forEach(c => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${c.licence || '-'}</td>
          <td>${c.last_name || '-'}</td>
          <td>${c.first_name || '-'}</td>
          <td>${c.club || '-'}</td>
          <td>${c.email || '-'}</td>
          <td>${c.telephone || '-'}</td>
          <td><span class="badge badge-${(c.statut || 'Actif').toLowerCase()}">${c.statut || 'Actif'}</span></td>
          <td>${c.email_optin === 1 ? '<span class="badge badge-optin">Oui</span>' : '<span class="badge badge-optout">Non</span>'}</td>
          <td>
            <button class="btn btn-small edit-contact-btn" data-id="${c.id}" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Add edit button handlers
      document.querySelectorAll('.edit-contact-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const contact = allContactsData.find(c => c.id === parseInt(btn.dataset.id));
          openEditContactModal(contact);
        });
      });
    }

    function openEditContactModal(contact) {
      document.getElementById('edit_contact_id').value = contact.id;
      document.getElementById('edit_contact_email').value = contact.email || '';
      document.getElementById('edit_contact_telephone').value = contact.telephone || '';
      document.getElementById('edit_contact_statut').value = contact.statut || 'Actif';
      document.getElementById('edit_contact_comments').value = contact.comments || '';
      document.getElementById('edit_contact_optin').checked = contact.email_optin === 1;

      document.getElementById('editContactModal').style.display = 'flex';
    }

    document.getElementById('cancelEditContactBtn').addEventListener('click', () => {
      document.getElementById('editContactModal').style.display = 'none';
    });

    document.getElementById('editContactForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('edit_contact_id').value;
      const data = {
        email: document.getElementById('edit_contact_email').value || null,
        telephone: document.getElementById('edit_contact_telephone').value || null,
        statut: document.getElementById('edit_contact_statut').value,
        comments: document.getElementById('edit_contact_comments').value || null,
        email_optin: document.getElementById('edit_contact_optin').checked ? 1 : 0
      };

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          document.getElementById('editContactModal').style.display = 'none';
          showSuccess('Contact mis √† jour!');
          loadAllContacts();
          loadContacts(); // Refresh the contacts list in compose tab
        } else {
          showError('Erreur lors de la mise √† jour.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('syncContactsBtn').addEventListener('click', async () => {
      if (!confirm('Synchroniser les contacts avec les donnees joueurs/inscriptions ?')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/sync`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (response.ok) {
          showSuccess(result.message);
          loadAllContacts();
          loadContacts();
        } else {
          showError(result.error || 'Erreur lors de la synchronisation.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== RELANCES INSCRIPTIONS ====================

    let relanceTemplates = {};
    let relanceParticipants = [];
    let relanceData = {};
    let selectedRelanceIds = new Set();
    let relanceClubs = [];

    async function loadRelanceClubs() {
      try {
        const response = await fetch(`${API_URL}/emailing/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          relanceClubs = await response.json();
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    function getClubOptionsHtml() {
      let html = '<option value="">-- S√©lectionner --</option>';
      relanceClubs.forEach(club => {
        html += `<option value="${club}">${club}</option>`;
      });
      return html;
    }

    async function loadRelanceTemplates() {
      try {
        // Load clubs first
        await loadRelanceClubs();

        const response = await fetch(`${API_URL}/emailing/relance-templates`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          relanceTemplates = await response.json();
        }
      } catch (error) {
        console.error('Error loading relance templates:', error);
      }
    }

    async function loadRelanceHistory() {
      const tbody = document.getElementById('relanceHistoryBody');
      tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">Chargement...</td></tr>';

      try {
        const response = await fetch(`${API_URL}/inscriptions/relances`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement');
        }

        const relances = await response.json();

        if (relances.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">Aucune relance envoy√©e cette saison</td></tr>';
          return;
        }

        tbody.innerHTML = relances.map(r => {
          const sentDate = new Date(r.relance_sent_at);
          const tournamentDate = r.debut ? new Date(r.debut) : null;

          return `
            <tr style="border-bottom: 1px solid #eee;">
              <td style="padding: 10px;">${r.nom || '-'}</td>
              <td style="padding: 10px; text-align: center;">${r.mode || '-'}</td>
              <td style="padding: 10px; text-align: center;">${r.categorie || '-'}</td>
              <td style="padding: 10px; text-align: center;">${tournamentDate ? tournamentDate.toLocaleDateString('fr-FR') : '-'}</td>
              <td style="padding: 10px; text-align: center;">
                ${sentDate.toLocaleDateString('fr-FR')}
                <span style="color: #666; font-size: 11px;">${sentDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</span>
              </td>
              <td style="padding: 10px; text-align: center;">${r.sent_by || '-'}</td>
              <td style="padding: 10px; text-align: center;">
                <span style="background: #e7f3ff; padding: 3px 8px; border-radius: 12px; font-weight: bold;">
                  ${r.recipients_count || 0}
                </span>
              </td>
            </tr>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading relance history:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #dc3545;">Erreur lors du chargement</td></tr>';
      }
    }

    function updateRelanceCategoryFilter() {
      const modeRaw = document.getElementById('relanceModeFilter').value;
      const categorySelect = document.getElementById('relanceCategoryFilter');
      const typeSelect = document.getElementById('relanceTypeSelect');

      categorySelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

      // Normalize mode to match categoriesByMode keys (remove spaces, uppercase)
      const mode = modeRaw ? modeRaw.toUpperCase().replace(/ /g, '') : '';

      if (mode && categoriesByMode[mode]) {
        categorySelect.disabled = false;
        categoriesByMode[mode].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
      } else {
        categorySelect.disabled = true;
        typeSelect.disabled = true;
      }
    }

    function updateRelanceTypeEnabled() {
      const mode = document.getElementById('relanceModeFilter').value;
      const category = document.getElementById('relanceCategoryFilter').value;
      const typeSelect = document.getElementById('relanceTypeSelect');
      const loadBtn = document.getElementById('loadRelanceParticipantsBtn');

      if (mode && category) {
        typeSelect.disabled = false;
      } else {
        typeSelect.disabled = true;
        typeSelect.value = '';
      }

      loadBtn.disabled = !(mode && category && typeSelect.value);
    }

    async function updateRelanceTemplate() {
      const relanceType = document.getElementById('relanceTypeSelect').value;
      const extraVarsSpan = document.getElementById('relanceExtraVars');
      const customFieldsDiv = document.getElementById('relanceCustomFields');
      const customFieldsContent = document.getElementById('relanceCustomFieldsContent');

      if (!relanceType) {
        document.getElementById('relanceSubject').value = '';
        quillRelanceIntro.setContents([]);
        quillRelanceOutro.setContents([]);
        extraVarsSpan.innerHTML = '';
        customFieldsDiv.style.display = 'none';
        return;
      }

      const templateKey = `relance_${relanceType}`;
      const template = relanceTemplates[templateKey] || {};

      document.getElementById('relanceSubject').value = template.subject || '';
      quillRelanceIntro.setContents([]);
      quillRelanceIntro.clipboard.dangerouslyPasteHTML((template.intro || '').replace(/\n/g, '<br>'));
      quillRelanceOutro.setContents([]);
      quillRelanceOutro.clipboard.dangerouslyPasteHTML((template.outro || '').replace(/\n/g, '<br>'));

      // Club options for lieu dropdowns (dynamic from database)
      const clubOptions = getClubOptionsHtml();

      // Update extra variables based on type
      if (relanceType === 't2') {
        extraVarsSpan.innerHTML = '<code>{t1_position}</code> <code>{t1_points}</code> <code>{t1_date}</code> <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{deadline_date}</code>';
        customFieldsContent.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 12px;">Date du T2</label>
              <input type="date" id="relanceT2Date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px;">Lieu du T2</label>
              <select id="relanceT2Lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                ${clubOptions}
              </select>
            </div>
          </div>
        `;
        customFieldsDiv.style.display = 'block';
      } else if (relanceType === 't3') {
        extraVarsSpan.innerHTML = '<code>{rank_position}</code> <code>{total_points}</code> <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{deadline_date}</code>';
        customFieldsContent.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 12px;">Date du T3</label>
              <input type="date" id="relanceT3Date" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px;">Lieu du T3</label>
              <select id="relanceT3Lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                ${clubOptions}
              </select>
            </div>
          </div>
        `;
        customFieldsDiv.style.display = 'block';
      } else if (relanceType === 'finale') {
        extraVarsSpan.innerHTML = '<code>{rank_position}</code> <code>{total_points}</code> <code>{qualified_count}</code> <code>{finale_date}</code> <code>{finale_lieu}</code> <code>{deadline_date}</code>';
        customFieldsContent.innerHTML = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <label style="font-size: 12px;">Date de la Finale</label>
              <input type="date" id="relanceFinaleDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 12px;">Lieu de la Finale</label>
              <select id="relanceFinaleLieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                ${clubOptions}
              </select>
            </div>
            <div style="grid-column: span 2;">
              <label style="font-size: 12px;">Date limite de r√©ponse</label>
              <input type="date" id="relanceDeadlineDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        `;
        customFieldsDiv.style.display = 'block';
      }

      // After updating the template, fetch the tournament info from DB
      await fetchNextTournamentInfo();
    }

    // Fetch tournament date/lieu from DB and populate the fields
    async function fetchNextTournamentInfo() {
      const mode = document.getElementById('relanceModeFilter').value;
      const category = document.getElementById('relanceCategoryFilter').value;
      const relanceType = document.getElementById('relanceTypeSelect').value;

      if (!mode || !category || !relanceType) return;

      // Show info message area
      const infoDiv = document.getElementById('relanceInfo');

      // Helper function to match location with dropdown options
      function setLocationDropdown(selectId, locationValue) {
        const lieuSelect = document.getElementById(selectId);
        if (!lieuSelect || !locationValue) return false;

        const locationUpper = locationValue.toUpperCase().trim();

        // First try exact match
        for (let opt of lieuSelect.options) {
          if (opt.value === locationValue || opt.text === locationValue) {
            lieuSelect.value = opt.value;
            return true;
          }
        }

        // Then try case-insensitive partial match (location name contained in option)
        for (let opt of lieuSelect.options) {
          const optUpper = opt.text.toUpperCase().trim();
          if (optUpper.includes(locationUpper) || locationUpper.includes(optUpper.split(' ')[0])) {
            lieuSelect.value = opt.value;
            return true;
          }
        }

        // Try matching just the city name (e.g., "Clichy" matches "BC Clichy" or "Billard Club Clichy")
        for (let opt of lieuSelect.options) {
          const optUpper = opt.text.toUpperCase().trim();
          // Check if any word in the option matches the location
          const optWords = optUpper.split(/[\s-]+/);
          if (optWords.some(word => word === locationUpper || locationUpper === word)) {
            lieuSelect.value = opt.value;
            return true;
          }
        }

        // If still not found, add as a new option
        const newOption = document.createElement('option');
        newOption.value = locationValue;
        newOption.text = locationValue;
        lieuSelect.add(newOption);
        lieuSelect.value = locationValue;
        return true;
      }

      // Check if we have pending values from dashboard (these take priority)
      const pendingLieu = window.pendingRelanceLieu;
      const pendingDebut = window.pendingRelanceDebut;

      // Clear pending values after reading
      if (pendingLieu) window.pendingRelanceLieu = null;
      if (pendingDebut) window.pendingRelanceDebut = null;

      // If we have pending values from dashboard, use them directly
      if (pendingLieu || pendingDebut) {
        if (infoDiv) infoDiv.style.display = 'none';

        if (relanceType === 't2') {
          if (pendingDebut) {
            const dateInput = document.getElementById('relanceT2Date');
            if (dateInput) dateInput.value = pendingDebut.split('T')[0];
          }
          if (pendingLieu) {
            setLocationDropdown('relanceT2Lieu', pendingLieu);
          }
        } else if (relanceType === 't3') {
          if (pendingDebut) {
            const dateInput = document.getElementById('relanceT3Date');
            if (dateInput) dateInput.value = pendingDebut.split('T')[0];
          }
          if (pendingLieu) {
            setLocationDropdown('relanceT3Lieu', pendingLieu);
          }
        } else if (relanceType === 'finale') {
          if (pendingDebut) {
            const dateInput = document.getElementById('relanceFinaleDate');
            if (dateInput) dateInput.value = pendingDebut.split('T')[0];
          }
          if (pendingLieu) {
            setLocationDropdown('relanceFinaleLieu', pendingLieu);
          }
        }
        return; // Don't fetch from DB, we already have the data
      }

      // Fetch from DB (normal flow when not coming from dashboard)
      try {
        const response = await fetch(`${API_URL}/emailing/next-tournament?mode=${mode}&category=${category}&relanceType=${relanceType}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();

        if (!data.found) {
          // Tournament not found - show message
          if (infoDiv) {
            infoDiv.innerHTML = `<p style="color: #856404;"><strong>Info:</strong> ${data.message || 'Tournoi non trouv√© dans la base de donn√©es. Veuillez saisir les informations manuellement.'}</p>`;
            infoDiv.style.display = 'block';
            infoDiv.style.background = '#fff3cd';
          }
          return;
        }

        // Tournament found - hide warning
        if (infoDiv && !data.tournament_date && !data.location) {
          infoDiv.innerHTML = `<p style="color: #856404;"><strong>Info:</strong> Date et lieu non renseign√©s dans la base. Veuillez les saisir manuellement.</p>`;
          infoDiv.style.display = 'block';
          infoDiv.style.background = '#fff3cd';
        } else if (infoDiv) {
          infoDiv.style.display = 'none';
        }

        if (relanceType === 't2') {
          if (data.tournament_date) {
            const dateInput = document.getElementById('relanceT2Date');
            if (dateInput) dateInput.value = data.tournament_date.split('T')[0];
          }
          if (data.location) {
            setLocationDropdown('relanceT2Lieu', data.location);
          }
        } else if (relanceType === 't3') {
          if (data.tournament_date) {
            const dateInput = document.getElementById('relanceT3Date');
            if (dateInput) dateInput.value = data.tournament_date.split('T')[0];
          }
          if (data.location) {
            setLocationDropdown('relanceT3Lieu', data.location);
          }
        } else if (relanceType === 'finale') {
          if (data.tournament_date) {
            const dateInput = document.getElementById('relanceFinaleDate');
            if (dateInput) dateInput.value = data.tournament_date.split('T')[0];
          }
          if (data.location) {
            setLocationDropdown('relanceFinaleLieu', data.location);
          }
        }
      } catch (error) {
        console.log('Could not fetch tournament info:', error);
      }
    }

    async function loadRelanceParticipants() {
      const mode = document.getElementById('relanceModeFilter').value;
      const category = document.getElementById('relanceCategoryFilter').value;
      const relanceType = document.getElementById('relanceTypeSelect').value;

      if (!mode || !category || !relanceType) return;

      try {
        let endpoint = '';
        if (relanceType === 't2') {
          endpoint = `${API_URL}/emailing/t1-participants?mode=${mode}&category=${category}`;
        } else if (relanceType === 't3') {
          endpoint = `${API_URL}/emailing/ranking-for-relance?mode=${mode}&category=${category}`;
        } else if (relanceType === 'finale') {
          endpoint = `${API_URL}/emailing/finale-qualified?mode=${mode}&category=${category}`;
        }

        const response = await fetch(endpoint, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const err = await response.json();
          throw new Error(err.error || 'Erreur chargement');
        }

        relanceData = await response.json();
        relanceParticipants = relanceData.participants || [];

        // Check if this relance was already sent
        const warningDiv = document.getElementById('relanceAlreadySentWarning');
        const warningDetails = document.getElementById('relanceAlreadySentDetails');
        const campaignCheck = await checkCampaignAlreadySent(`relance_${relanceType}`, mode, category);

        if (campaignCheck && campaignCheck.alreadySent) {
          warningDetails.innerHTML = `
            <strong>Date:</strong> ${formatCampaignDate(campaignCheck.lastSent)}<br>
            <strong>Par:</strong> ${campaignCheck.sentBy || 'Inconnu'}<br>
            <strong>Destinataires:</strong> ${campaignCheck.recipientCount || 0}
          `;
          warningDiv.style.display = 'block';
        } else {
          warningDiv.style.display = 'none';
        }

        // Update info box
        const infoDiv = document.getElementById('relanceInfo');
        const infoContent = document.getElementById('relanceInfoContent');
        infoDiv.style.display = 'block';

        if (relanceType === 't2' && relanceData.t1Tournament) {
          const t1Date = relanceData.t1Tournament.date ? new Date(relanceData.t1Tournament.date).toLocaleDateString('fr-FR') : '-';
          infoContent.innerHTML = `
            <strong>T1 jou√©:</strong> ${t1Date} √† ${relanceData.t1Tournament.location || '-'}<br>
            <strong>Cat√©gorie:</strong> ${relanceData.t1Tournament.category}<br>
            <strong>Participants T1:</strong> ${relanceParticipants.length} joueurs
          `;
        } else if (relanceType === 't3' && relanceData.category) {
          infoContent.innerHTML = `
            <strong>Cat√©gorie:</strong> ${relanceData.category.display_name}<br>
            <strong>Joueurs au classement:</strong> ${relanceParticipants.length}
          `;
        } else if (relanceType === 'finale' && relanceData.category) {
          infoContent.innerHTML = `
            <strong>Cat√©gorie:</strong> ${relanceData.category.display_name}<br>
            <strong>Qualifi√©s:</strong> ${relanceData.qualifiedCount} / ${relanceData.totalInRanking} joueurs au classement
            ${relanceData.finale ? `<br><strong>Finale:</strong> ${relanceData.finale.nom}` : ''}
          `;

          // Auto-populate deadline date from backend calculation or calculate from finale date
          const deadlineInput = document.getElementById('relanceDeadlineDate');
          if (deadlineInput) {
            if (relanceData.deadlineDate) {
              deadlineInput.value = relanceData.deadlineDate;
            } else {
              // Calculate from finale date field if backend didn't return deadline
              const finaleDateInput = document.getElementById('relanceFinaleDate');
              if (finaleDateInput && finaleDateInput.value) {
                const finaleDate = new Date(finaleDateInput.value);
                finaleDate.setDate(finaleDate.getDate() - 7);
                deadlineInput.value = finaleDate.toISOString().split('T')[0];
              }
            }
          }

          // Show warning if convocation not sent - block everything
          if (relanceData.convocationRequired) {
            showError('La convocation finale doit √™tre envoy√©e avant de pouvoir envoyer une relance. Veuillez d\'abord envoyer la convocation aux finalistes.');
            document.getElementById('sendRelanceBtn').disabled = true;
            document.getElementById('scheduleRelanceBtn').disabled = true;
            document.getElementById('relanceParticipantsSection').style.display = 'none';
            return; // Don't show participants
          }
        }

        // Update participants table with checkboxes
        const tbody = document.getElementById('relanceParticipantsBody');
        tbody.innerHTML = '';
        selectedRelanceIds.clear();

        relanceParticipants.forEach((p, idx) => {
          const pos = p.t1_position || p.rank_position || '-';
          const hasEmail = p.email && p.email.includes('@');
          const tr = document.createElement('tr');
          tr.className = hasEmail ? 'relance-participant selected' : 'relance-participant';
          tr.dataset.idx = idx;

          // Auto-select participants with email
          if (hasEmail) {
            selectedRelanceIds.add(idx);
          }

          tr.innerHTML = `
            <td style="padding: 8px; text-align: center;">
              <input type="checkbox" class="relance-checkbox" data-idx="${idx}" ${hasEmail ? 'checked' : ''} ${!hasEmail ? 'disabled' : ''}>
            </td>
            <td style="padding: 8px;">${pos}</td>
            <td style="padding: 8px;">${p.player_name || (p.first_name + ' ' + p.last_name)}</td>
            <td style="padding: 8px;">${p.club || '-'}</td>
            <td style="padding: 8px; text-align: center;">${hasEmail ? '‚úÖ' : '‚ùå'}</td>
          `;

          // Add checkbox event listener
          const checkbox = tr.querySelector('.relance-checkbox');
          if (checkbox && !checkbox.disabled) {
            checkbox.addEventListener('change', () => {
              if (checkbox.checked) {
                selectedRelanceIds.add(idx);
                tr.classList.add('selected');
              } else {
                selectedRelanceIds.delete(idx);
                tr.classList.remove('selected');
              }
              updateRelanceSelectedCount();
            });
          }

          tbody.appendChild(tr);
        });

        document.getElementById('relanceParticipantCount').textContent = relanceParticipants.length;
        document.getElementById('relanceEmailCount').textContent = relanceData.emailCount || 0;
        updateRelanceSelectedCount();
        document.getElementById('relanceParticipantsSection').style.display = 'block';
        document.getElementById('sendRelanceBtn').disabled = selectedRelanceIds.size === 0;
        document.getElementById('scheduleRelanceBtn').disabled = false;

      } catch (error) {
        console.error('Error loading relance participants:', error);
        showError('Erreur: ' + error.message);
      }
    }

    async function sendRelance() {
      const mode = document.getElementById('relanceModeFilter').value;
      const category = document.getElementById('relanceCategoryFilter').value;
      const relanceType = document.getElementById('relanceTypeSelect').value;
      const subject = document.getElementById('relanceSubject').value.trim();
      const intro = quillRelanceIntro.root.innerHTML;
      const introText = quillRelanceIntro.getText().trim();
      const outro = quillRelanceOutro.root.innerHTML;
      const imageUrl = document.getElementById('relanceImageUrl').value.trim();
      const testMode = document.getElementById('relanceTestModeCheck').checked;
      const testEmail = document.getElementById('relanceTestEmail').value.trim();
      const ccEmail = document.getElementById('relanceCcCheck').checked ? document.getElementById('relanceCcEmail').value.trim() : null;

      if (!subject || !introText) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      if (testMode && (!testEmail || !testEmail.includes('@'))) {
        showError('Email de test invalide.');
        return;
      }

      // Check that at least one participant is selected (unless test mode)
      if (!testMode && selectedRelanceIds.size === 0) {
        showError('Veuillez s√©lectionner au moins un destinataire.');
        return;
      }

      // Get selected participant licences
      const selectedLicences = Array.from(selectedRelanceIds).map(idx => relanceParticipants[idx]?.licence).filter(Boolean);

      // Build custom data based on relance type
      let customData = {};
      if (relanceType === 't2') {
        const dateInput = document.getElementById('relanceT2Date');
        const lieuInput = document.getElementById('relanceT2Lieu');
        customData.tournament_date = dateInput?.value ? new Date(dateInput.value).toLocaleDateString('fr-FR') : '';
        customData.tournament_lieu = lieuInput?.value || '';
      } else if (relanceType === 't3') {
        const dateInput = document.getElementById('relanceT3Date');
        const lieuInput = document.getElementById('relanceT3Lieu');
        customData.tournament_date = dateInput?.value ? new Date(dateInput.value).toLocaleDateString('fr-FR') : '';
        customData.tournament_lieu = lieuInput?.value || '';
      } else if (relanceType === 'finale') {
        const dateInput = document.getElementById('relanceFinaleDate');
        const lieuInput = document.getElementById('relanceFinaleLieu');
        const deadlineInput = document.getElementById('relanceDeadlineDate');
        customData.finale_date = dateInput?.value ? new Date(dateInput.value).toLocaleDateString('fr-FR') : '';
        customData.finale_lieu = lieuInput?.value || '';
        customData.deadline_date = deadlineInput?.value ? new Date(deadlineInput.value).toLocaleDateString('fr-FR') : '';
      }

      const selectedCount = selectedRelanceIds.size;

      // Check if this campaign was already sent (only for non-test mode)
      if (!testMode) {
        const campaignCheck = await checkCampaignAlreadySent(`relance_${relanceType}`, mode, category);
        if (campaignCheck && campaignCheck.alreadySent) {
          const warningMsg = `‚ö†Ô∏è ATTENTION: Une relance ${relanceType.toUpperCase()} pour ${mode} ${category} a d√©j√† √©t√© envoy√©e!\n\n` +
            `üìÖ Date: ${formatCampaignDate(campaignCheck.lastSent)}\n` +
            `üë§ Par: ${campaignCheck.sentBy || 'Inconnu'}\n` +
            `üìß Destinataires: ${campaignCheck.recipientCount || 0}\n\n` +
            `Voulez-vous quand m√™me envoyer √† nouveau √† ${selectedCount} destinataire(s) ?`;

          if (!confirm(warningMsg)) return;
        } else {
          // Normal confirmation
          if (!confirm(`Envoyer la relance √† ${selectedCount} destinataire(s) s√©lectionn√©(s) ?`)) return;
        }
      } else {
        if (!confirm(`MODE TEST: Envoyer l'email uniquement √† ${testEmail} ?`)) return;
      }

      showProgress('Envoi des relances...');

      try {
        const response = await fetch(`${API_URL}/emailing/send-relance`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            relanceType,
            mode,
            category,
            subject,
            intro,
            outro,
            imageUrl: imageUrl || null,
            testMode,
            testEmail: testMode ? testEmail : null,
            ccEmail,
            customData,
            selectedLicences: testMode ? null : selectedLicences
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);

          // Mark tournament relance as sent (not in test mode)
          if (!testMode) {
            try {
              // First try by tournoiId if coming from dashboard
              if (window.currentRelanceTournoiId) {
                const markByIdResponse = await fetch(`${API_URL}/inscriptions/relances/${window.currentRelanceTournoiId}`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    recipients_count: selectedCount
                  })
                });
                if (markByIdResponse.ok) {
                  console.log('Tournament relance marked as sent (by tournoiId)');
                } else {
                  console.error('Failed to mark relance by tournoiId:', await markByIdResponse.text());
                }
                window.currentRelanceTournoiId = null;
              } else {
                // Otherwise try to find and mark by mode/category/type
                const markResponse = await fetch(`${API_URL}/inscriptions/relances/mark-by-type`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    mode,
                    category,
                    relanceType,
                    recipients_count: selectedCount
                  })
                });
                const markResult = await markResponse.json();
                if (markResult.marked) {
                  console.log(`Tournament relance marked as sent (by type: ${mode} ${category} ${relanceType})`);
                } else {
                  console.log('No matching tournament found to mark');
                }
              }
              // Refresh the history table
              loadRelanceHistory();
            } catch (e) {
              console.error('Error marking relance as sent:', e);
            }
          }
        } else {
          showError(result.error || 'Erreur lors de l\'envoi.');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    }

    // Relances event listeners
    document.getElementById('relanceModeFilter').addEventListener('change', () => {
      updateRelanceCategoryFilter();
      updateRelanceTypeEnabled();
      // Reset
      document.getElementById('relanceInfo').style.display = 'none';
      document.getElementById('relanceAlreadySentWarning').style.display = 'none';
      document.getElementById('relanceParticipantsSection').style.display = 'none';
      document.getElementById('sendRelanceBtn').disabled = true;
    });

    document.getElementById('relanceCategoryFilter').addEventListener('change', () => {
      updateRelanceTypeEnabled();
      document.getElementById('relanceInfo').style.display = 'none';
      document.getElementById('relanceAlreadySentWarning').style.display = 'none';
      document.getElementById('relanceParticipantsSection').style.display = 'none';
      document.getElementById('sendRelanceBtn').disabled = true;
    });

    document.getElementById('relanceTypeSelect').addEventListener('change', () => {
      updateRelanceTypeEnabled();
      updateRelanceTemplate();
      document.getElementById('relanceInfo').style.display = 'none';
      document.getElementById('relanceAlreadySentWarning').style.display = 'none';
      document.getElementById('relanceParticipantsSection').style.display = 'none';
      document.getElementById('sendRelanceBtn').disabled = true;
    });

    document.getElementById('loadRelanceParticipantsBtn').addEventListener('click', loadRelanceParticipants);
    document.getElementById('sendRelanceBtn').addEventListener('click', sendRelance);

    // Helper function to update selected count
    function updateRelanceSelectedCount() {
      document.getElementById('relanceSelectedCount').textContent = selectedRelanceIds.size;
      document.getElementById('sendRelanceBtn').disabled = selectedRelanceIds.size === 0;
    }

    // Select all / Deselect all buttons
    document.getElementById('relanceSelectAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.relance-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = true;
        const idx = parseInt(cb.dataset.idx);
        selectedRelanceIds.add(idx);
        cb.closest('tr').classList.add('selected');
      });
      updateRelanceSelectedCount();
    });

    document.getElementById('relanceDeselectAllBtn').addEventListener('click', () => {
      document.querySelectorAll('.relance-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = false;
        const idx = parseInt(cb.dataset.idx);
        selectedRelanceIds.delete(idx);
        cb.closest('tr').classList.remove('selected');
      });
      updateRelanceSelectedCount();
    });

    document.getElementById('relanceTestModeCheck').addEventListener('change', (e) => {
      document.getElementById('relanceTestEmailInput').style.display = e.target.checked ? 'block' : 'none';
    });

    // Schedule relance button
    document.getElementById('scheduleRelanceBtn').addEventListener('click', async () => {
      const scheduledAt = document.getElementById('relanceScheduleDate').value;
      if (!scheduledAt) {
        showError('Veuillez s√©lectionner une date et heure');
        return;
      }

      const mode = document.getElementById('relanceModeFilter').value;
      const category = document.getElementById('relanceCategoryFilter').value;
      const relanceType = document.getElementById('relanceTypeSelect').value;
      const subject = document.getElementById('relanceSubject').value.trim();
      const intro = quillRelanceIntro.root.innerHTML;
      const introText = quillRelanceIntro.getText().trim();
      const outro = quillRelanceOutro.root.innerHTML;
      const imageUrl = document.getElementById('relanceImageUrl').value.trim();
      const ccEmail = document.getElementById('relanceCcCheck').checked ? document.getElementById('relanceCcEmail').value.trim() : null;
      const testMode = document.getElementById('relanceTestModeCheck').checked;
      const testEmail = testMode ? document.getElementById('relanceTestEmail').value.trim() : null;

      if (!subject || !introText) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      if (testMode && !testEmail) {
        showError('Email de test requis en mode test');
        return;
      }

      let customData = {};
      if (relanceType === 't2') {
        customData.tournament_date = document.getElementById('relanceT2Date')?.value || '';
        customData.tournament_lieu = document.getElementById('relanceT2Lieu')?.value || '';
      } else if (relanceType === 't3') {
        customData.tournament_date = document.getElementById('relanceT3Date')?.value || '';
        customData.tournament_lieu = document.getElementById('relanceT3Lieu')?.value || '';
      } else if (relanceType === 'finale') {
        customData.finale_date = document.getElementById('relanceFinaleDate')?.value || '';
        customData.finale_lieu = document.getElementById('relanceFinaleLieu')?.value || '';
        customData.deadline_date = document.getElementById('relanceDeadlineDate')?.value || '';
      }

      const modeLabel = testMode ? ' (MODE TEST)' : '';
      if (!confirm(`Programmer la relance pour le ${new Date(scheduledAt).toLocaleString('fr-FR')}${modeLabel} ?`)) return;

      try {
        const response = await fetch(`${API_URL}/emailing/schedule-relance`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            relanceType, mode, category, subject, intro, outro, imageUrl, scheduledAt, ccEmail, customData, testMode, testEmail
          })
        });

        const result = await response.json();
        if (response.ok) {
          showSuccess(result.message);
          document.getElementById('relanceScheduleDate').value = '';
        } else {
          showError(result.error || 'Erreur');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // Enable schedule button when participants loaded
    document.getElementById('relanceScheduleDate').addEventListener('input', () => {
      const hasDate = document.getElementById('relanceScheduleDate').value;
      const hasParticipants = relanceParticipants.length > 0;
      document.getElementById('scheduleRelanceBtn').disabled = !hasDate || !hasParticipants;
    });

    // ==================== HISTORY ====================

    async function loadHistory() {
      document.getElementById('loadingHistory').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/history`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load history');

        const history = await response.json();
        displayHistory(history);

        // Check if purge is available (admin only, after June 30)
        checkPurgeAvailability();

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingHistory').style.display = 'none';
      }
    }

    async function checkPurgeAvailability() {
      try {
        const response = await fetch(`${API_URL}/emailing/campaigns/purge-count`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          document.getElementById('purgeCampaignsBtn').style.display = 'none';
          return;
        }

        const data = await response.json();
        const btn = document.getElementById('purgeCampaignsBtn');

        if (data.allowed && data.count > 0) {
          btn.style.display = 'inline-block';
          btn.title = `${data.count} enregistrement(s) avant le ${new Date(data.beforeDate).toLocaleDateString('fr-FR')}`;
        } else if (!data.allowed) {
          btn.style.display = 'none';
        } else {
          btn.style.display = 'none';
        }
      } catch (error) {
        console.error('Error checking purge availability:', error);
        document.getElementById('purgeCampaignsBtn').style.display = 'none';
      }
    }

    async function purgeCampaigns() {
      try {
        // First get the count
        const countResponse = await fetch(`${API_URL}/emailing/campaigns/purge-count`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!countResponse.ok) {
          showError('Erreur lors de la v√©rification');
          return;
        }

        const countData = await countResponse.json();

        if (!countData.allowed) {
          showError(countData.message || 'Purge non autoris√©e');
          return;
        }

        if (countData.count === 0) {
          showSuccess('Aucun enregistrement √† purger');
          return;
        }

        // Confirm with user
        const beforeDate = new Date(countData.beforeDate).toLocaleDateString('fr-FR');
        if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${countData.count} enregistrement(s) ant√©rieurs au ${beforeDate} ?\n\nCette action est irr√©versible.`)) {
          return;
        }

        // Execute purge
        const purgeResponse = await fetch(`${API_URL}/emailing/campaigns/purge`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!purgeResponse.ok) {
          const error = await purgeResponse.json();
          throw new Error(error.error || 'Erreur lors de la purge');
        }

        const result = await purgeResponse.json();
        showSuccess(result.message);

        // Reload history
        loadHistory();

      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    document.getElementById('purgeCampaignsBtn').addEventListener('click', purgeCampaigns);

    const CAMPAIGN_TYPES = {
      'tournament_results': 'Resultats',
      'finale_convocation': 'Convoc. Finale',
      'relance_t2': 'Relance T2',
      'relance_t3': 'Relance T3',
      'relance_finale': 'Relance Finale',
      'convocation': 'Convocation',
      'club_reminder': 'Rappel Club',
      'custom': 'Autre'
    };

    function formatCampaignType(h) {
      if (h.test_mode) return '<span style="color: #FF9800; font-weight: bold;">TEST</span>';
      if (!h.campaign_type) return '-';
      return CAMPAIGN_TYPES[h.campaign_type] || h.campaign_type;
    }

    function createTypeDropdown(campaignId, currentType, isTestMode) {
      if (isTestMode) {
        return '<span style="color: #FF9800; font-weight: bold;">TEST</span>';
      }

      let options = '<option value="">-</option>';
      for (const [value, label] of Object.entries(CAMPAIGN_TYPES)) {
        const selected = value === currentType ? 'selected' : '';
        options += `<option value="${value}" ${selected}>${label}</option>`;
      }

      return `<select class="campaign-type-select" data-id="${campaignId}" style="padding: 2px 5px; font-size: 12px; border-radius: 3px;">
        ${options}
      </select>`;
    }

    async function updateCampaignType(campaignId, newType) {
      try {
        const response = await fetch(`${API_URL}/emailing/campaigns/${campaignId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ campaign_type: newType || null })
        });

        if (!response.ok) throw new Error('Failed to update');
        showSuccess('Type mis √† jour');
      } catch (error) {
        showError('Erreur: ' + error.message);
        loadHistory(); // Reload to revert
      }
    }

    function displayHistory(history) {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Aucune campagne.</td></tr>';
        return;
      }

      history.forEach(h => {
        const row = document.createElement('tr');
        const date = h.sent_at ? new Date(h.sent_at).toLocaleString('fr-FR') : new Date(h.created_at).toLocaleString('fr-FR');
        const typeDropdown = createTypeDropdown(h.id, h.campaign_type, h.test_mode);
        const sentBy = h.sent_by || '-';
        row.innerHTML = `
          <td>${date}</td>
          <td>${typeDropdown}</td>
          <td>${h.subject}</td>
          <td>${sentBy}</td>
          <td>${h.recipients_count}</td>
          <td style="color: green;">${h.sent_count}</td>
          <td style="color: ${h.failed_count > 0 ? 'red' : 'inherit'};">${h.failed_count}</td>
          <td><span class="badge badge-${h.status === 'completed' ? 'actif' : 'inactif'}">${h.status}</span></td>
        `;
        tbody.appendChild(row);
      });

      // Add event listeners for type dropdowns
      document.querySelectorAll('.campaign-type-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const campaignId = e.target.dataset.id;
          const newType = e.target.value;
          updateCampaignType(campaignId, newType);
        });
      });
    }

    // ==================== INSCRIPTION EMAIL LOGS ====================

    async function loadInscriptionEmailLogs() {
      const loadingEl = document.getElementById('loadingInscriptionLogs');
      const tbody = document.getElementById('inscriptionLogsBody');
      const noLogsEl = document.getElementById('noInscriptionLogs');

      loadingEl.style.display = 'block';
      noLogsEl.style.display = 'none';
      tbody.innerHTML = '';

      try {
        // Build query params from filters
        const params = new URLSearchParams();
        const typeFilter = document.getElementById('inscriptionTypeFilter').value;
        const statusFilter = document.getElementById('inscriptionStatusFilter').value;
        const dateFrom = document.getElementById('inscriptionDateFrom').value;
        const dateTo = document.getElementById('inscriptionDateTo').value;

        if (typeFilter) params.append('type', typeFilter);
        if (statusFilter) params.append('status', statusFilter);
        if (dateFrom) params.append('from', dateFrom);
        if (dateTo) params.append('to', dateTo);

        const response = await fetch(`${API_URL}/email/inscription-logs?${params.toString()}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load inscription logs');

        const logs = await response.json();
        displayInscriptionLogs(logs);

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        loadingEl.style.display = 'none';
      }
    }

    function displayInscriptionLogs(logs) {
      const tbody = document.getElementById('inscriptionLogsBody');
      const noLogsEl = document.getElementById('noInscriptionLogs');
      tbody.innerHTML = '';

      // Check if user is admin to show delete buttons
      const isAdmin = userRole === 'admin';
      if (isAdmin) {
        document.querySelectorAll('.admin-only-column').forEach(el => el.style.display = '');
      }

      if (!logs || logs.length === 0) {
        noLogsEl.style.display = 'block';
        return;
      }

      noLogsEl.style.display = 'none';

      logs.forEach(log => {
        const row = document.createElement('tr');
        const date = new Date(log.created_at).toLocaleString('fr-FR');
        const typeLabel = log.email_type === 'inscription' ? 'Inscription' : 'D√©sinscription';
        const typeColor = log.email_type === 'inscription' ? '#28a745' : '#dc3545';
        const statusBadge = log.status === 'sent'
          ? '<span class="badge badge-actif">Envoy√©</span>'
          : `<span class="badge badge-inactif" title="${log.error_message || ''}">√âchec</span>`;

        const deleteBtn = isAdmin
          ? `<td><button class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 0.75rem;" onclick="deleteInscriptionLog(${log.id})">üóëÔ∏è</button></td>`
          : '';

        row.innerHTML = `
          <td>${date}</td>
          <td><span style="color: ${typeColor}; font-weight: 500;">${typeLabel}</span></td>
          <td>${log.player_name || '-'}</td>
          <td style="font-size: 0.85rem;">${log.player_email || '-'}</td>
          <td>${log.tournament_name || '-'}</td>
          <td>${log.mode || '-'}</td>
          <td>${log.category || '-'}</td>
          <td>${statusBadge}</td>
          ${deleteBtn}
        `;
        tbody.appendChild(row);
      });
    }

    async function deleteInscriptionLog(logId) {
      if (!confirm('Supprimer cet enregistrement de l\'historique ?')) return;

      try {
        const response = await fetch(`${API_URL}/email/inscription-logs/${logId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete log');

        showSuccess('Enregistrement supprim√©');
        loadInscriptionEmailLogs();
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    // ==================== SCHEDULED ====================

    async function loadScheduled() {
      document.getElementById('loadingScheduled').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/scheduled`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load scheduled');

        const scheduled = await response.json();
        displayScheduled(scheduled);

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingScheduled').style.display = 'none';
      }
    }

    const SCHEDULED_STATUS_LABELS = {
      'pending': { label: 'Programm√©', color: '#17a2b8', bg: '#d1ecf1' },
      'completed': { label: 'Envoy√©', color: '#28a745', bg: '#d4edda' },
      'failed': { label: '√âchec', color: '#dc3545', bg: '#f8d7da' },
      'blocked': { label: 'Bloqu√©', color: '#6c757d', bg: '#e2e3e5' },
      'cancelled': { label: 'Annul√©', color: '#6c757d', bg: '#e2e3e5' }
    };

    const SCHEDULED_TYPE_LABELS = {
      'relance_t2': 'Relance T2',
      'relance_t3': 'Relance T3',
      'relance_finale': 'Relance Finale',
      'tournament_results': 'R√©sultats',
      'finale_convocation': 'Convoc. Finale'
    };

    function displayScheduled(scheduled) {
      const list = document.getElementById('scheduledList');
      const noScheduled = document.getElementById('noScheduled');
      list.innerHTML = '';

      if (scheduled.length === 0) {
        noScheduled.style.display = 'block';
        return;
      }

      noScheduled.style.display = 'none';

      scheduled.forEach(s => {
        // Remove Z suffix to prevent UTC interpretation - treat as local Paris time
        const rawDate = s.scheduled_at ? s.scheduled_at.replace('Z', '').replace('.000', '') : '';
        const date = rawDate ? new Date(rawDate).toLocaleString('fr-FR') : '';
        const dateValue = rawDate ? rawDate.slice(0, 16) : ''; // Format for datetime-local input
        const recipientIds = s.recipient_ids ? JSON.parse(s.recipient_ids) : [];
        const status = SCHEDULED_STATUS_LABELS[s.status] || { label: s.status, color: '#6c757d', bg: '#e2e3e5' };
        const emailType = SCHEDULED_TYPE_LABELS[s.email_type] || s.email_type || 'Custom';
        const categoryInfo = s.mode && s.category ? ` (${s.mode} ${s.category})` : '';
        const isTestMode = s.test_mode === true || s.test_mode === 1;
        const testBadge = isTestMode ? `<span style="background: #ffc107; color: #000; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">TEST</span>` : '';
        const testEmailInfo = isTestMode && s.test_email ? ` ‚Üí ${s.test_email}` : '';

        const div = document.createElement('div');
        div.className = 'scheduled-item';
        div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; background: white;';
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px; flex-wrap: wrap;">
              <span style="background: ${status.bg}; color: ${status.color}; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">${status.label}</span>
              ${testBadge}
              <span style="background: #e7f3ff; color: #1F4788; padding: 3px 10px; border-radius: 12px; font-size: 11px;">${emailType}${categoryInfo}</span>
            </div>
            <strong>${s.subject}</strong>
            <div style="font-size: 12px; color: #666; margin-top: 5px;" class="scheduled-date-display" data-id="${s.id}">
              üìÖ <span class="date-text" style="cursor: ${s.status === 'pending' ? 'pointer' : 'default'}; ${s.status === 'pending' ? 'text-decoration: underline dotted;' : ''}" title="${s.status === 'pending' ? 'Cliquer pour modifier' : ''}">${date}</span>
              ${s.created_by ? ` ‚Ä¢ Par: ${s.created_by}` : ''}${recipientIds.length > 0 ? ` ‚Ä¢ ${recipientIds.length} dest.` : ''}${testEmailInfo}
            </div>
            ${s.status === 'pending' ? `
            <div class="scheduled-date-edit" data-id="${s.id}" style="display: none; margin-top: 8px;">
              <input type="datetime-local" class="edit-scheduled-date" data-id="${s.id}" value="${dateValue}" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
              <button class="btn save-scheduled-date" data-id="${s.id}" style="background: #28a745; padding: 6px 12px; margin-left: 5px; font-size: 12px;">OK</button>
              <button class="btn cancel-edit-date" data-id="${s.id}" style="background: #6c757d; padding: 6px 12px; margin-left: 5px; font-size: 12px;">X</button>
            </div>
            ` : ''}
          </div>
          ${s.status === 'pending' ? `<button class="btn cancel-scheduled-btn" data-id="${s.id}" style="background: #dc3545; padding: 8px 15px;">Annuler</button>` : ''}
        `;
        list.appendChild(div);
      });

      // Click on date to edit
      document.querySelectorAll('.scheduled-date-display .date-text').forEach(span => {
        span.addEventListener('click', (e) => {
          const id = e.target.closest('.scheduled-date-display').dataset.id;
          const displayDiv = document.querySelector(`.scheduled-date-display[data-id="${id}"]`);
          const editDiv = document.querySelector(`.scheduled-date-edit[data-id="${id}"]`);
          if (editDiv) {
            displayDiv.style.display = 'none';
            editDiv.style.display = 'block';
          }
        });
      });

      // Cancel edit
      document.querySelectorAll('.cancel-edit-date').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          document.querySelector(`.scheduled-date-display[data-id="${id}"]`).style.display = 'block';
          document.querySelector(`.scheduled-date-edit[data-id="${id}"]`).style.display = 'none';
        });
      });

      // Save new date
      document.querySelectorAll('.save-scheduled-date').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.dataset.id;
          const newDate = document.querySelector(`.edit-scheduled-date[data-id="${id}"]`).value;
          if (!newDate) {
            showError('Veuillez s√©lectionner une date');
            return;
          }

          try {
            const response = await fetch(`${API_URL}/emailing/scheduled/${id}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ scheduled_at: newDate })
            });

            if (response.ok) {
              showSuccess('Date modifi√©e');
              loadScheduled();
            } else {
              const result = await response.json();
              showError(result.error || 'Erreur');
            }
          } catch (error) {
            showError('Erreur: ' + error.message);
          }
        });
      });

      // Cancel scheduled email
      document.querySelectorAll('.cancel-scheduled-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Annuler cet email programm√© ?')) return;

          try {
            const response = await fetch(`${API_URL}/emailing/scheduled/${btn.dataset.id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
              showSuccess('Email annul√©.');
              loadScheduled();
            }
          } catch (error) {
            showError('Erreur: ' + error.message);
          }
        });
      });
    }

    // Trigger scheduler manually
    document.getElementById('triggerSchedulerBtn').addEventListener('click', async () => {
      const btn = document.getElementById('triggerSchedulerBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Traitement...';

      try {
        const response = await fetch(`${API_URL}/emailing/trigger-scheduler`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();
        console.log('Scheduler result:', result);
        if (response.ok) {
          const msg = result.result ? `${result.result.message} (pending: ${result.result.pending}, due: ${result.result.due})` : 'Scheduler ex√©cut√©';
          showSuccess(msg);
          loadScheduled(); // Refresh the list
        } else {
          showError(result.error || 'Erreur lors du d√©clenchement');
          console.error('Scheduler error:', result);
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
        console.error('Scheduler error:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ Traiter maintenant';
      }
    });

    // ==================== HELPERS ====================

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showProgress(text) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressOverlay').style.display = 'flex';
    }

    function hideProgress() {
      document.getElementById('progressOverlay').style.display = 'none';
    }

    // Check if a campaign was already sent
    async function checkCampaignAlreadySent(campaignType, mode, category, tournamentId = null) {
      try {
        let url = `${API_URL}/emailing/check-campaign?campaign_type=${encodeURIComponent(campaignType)}`;
        if (mode) url += `&mode=${encodeURIComponent(mode)}`;
        if (category) url += `&category=${encodeURIComponent(category)}`;
        if (tournamentId) url += `&tournament_id=${encodeURIComponent(tournamentId)}`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return null;
        return await response.json();
      } catch (error) {
        console.error('Error checking campaign:', error);
        return null;
      }
    }

    // Format date for display
    function formatCampaignDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ==================== TOURNAMENT RESULTS ====================

    let selectedTournamentData = null;
    let tournamentResults = [];

    async function loadImportedTournaments() {
      try {
        const response = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load tournaments');

        const tournaments = await response.json();
        const select = document.getElementById('resultsTournamentSelect');
        select.innerHTML = '<option value="">-- Choisir un tournoi --</option>';

        // Group by season
        const bySeason = {};
        tournaments.forEach(t => {
          const season = t.season || 'Autre';
          if (!bySeason[season]) bySeason[season] = [];
          bySeason[season].push(t);
        });

        // Sort seasons descending and add to select
        Object.keys(bySeason).sort().reverse().forEach(season => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = `Saison ${season}`;
          bySeason[season].forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            const date = t.tournament_date ? new Date(t.tournament_date).toLocaleDateString('fr-FR') : '';
            option.textContent = `${t.display_name} - ${date} (${t.player_count} joueurs)`;
            option.dataset.tournament = JSON.stringify(t);
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });

      } catch (error) {
        console.error('Error loading tournaments:', error);
      }
    }

    document.getElementById('resultsTournamentSelect').addEventListener('change', async (e) => {
      const tournamentId = e.target.value;
      const infoDiv = document.getElementById('tournamentInfo');
      const previewDiv = document.getElementById('tournamentResultsPreview');
      const sendBtn = document.getElementById('sendResultsBtn');

      if (!tournamentId) {
        infoDiv.style.display = 'none';
        previewDiv.style.display = 'none';
        sendBtn.disabled = true;
        return;
      }

      try {
        // Load tournament details and results from single endpoint
        const response = await fetch(`${API_URL}/emailing/tournament-results/${tournamentId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to load data');
        }

        const data = await response.json();
        const tournament = data.tournament;

        selectedTournamentData = tournament;
        tournamentResults = data.results || [];

        // Update info section
        document.getElementById('tournamentInfoTitle').textContent = tournament.display_name || '-';
        document.getElementById('tournamentInfoDate').textContent = tournament.tournament_date ? new Date(tournament.tournament_date).toLocaleDateString('fr-FR') : '-';
        document.getElementById('tournamentInfoLieu').textContent = tournament.location || '-';
        document.getElementById('tournamentInfoMode').textContent = tournament.game_type || '-';
        document.getElementById('tournamentInfoCategory').textContent = tournament.level || '-';
        document.getElementById('tournamentInfoParticipants').textContent = tournamentResults.length;
        document.getElementById('tournamentInfoEmails').textContent = data.emailCount || 0;

        infoDiv.style.display = 'block';

        // Update results preview
        const tbody = document.getElementById('resultsPreviewBody');
        tbody.innerHTML = '';

        tournamentResults.forEach((r, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding: 8px;">${idx + 1}</td>
            <td style="padding: 8px;">${r.player_name}</td>
            <td style="padding: 8px; text-align: center;">${r.points || '-'}</td>
            <td style="padding: 8px; text-align: center;">${r.email ? '‚úÖ' : '‚ùå'}</td>
          `;
          tbody.appendChild(row);
        });

        previewDiv.style.display = 'block';
        sendBtn.disabled = data.emailCount === 0;

      } catch (error) {
        console.error('Error loading tournament data:', error);
        showError('Erreur lors du chargement des donn√©es du tournoi');
      }
    });

    // CC checkbox toggle
    document.getElementById('ccCheck').addEventListener('change', (e) => {
      document.getElementById('ccEmailInput').style.opacity = e.target.checked ? '1' : '0.5';
      document.getElementById('ccEmail').disabled = !e.target.checked;
    });

    // Load saved CC email
    async function loadCcEmail() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates/results_cc_email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.subject_template) {
            document.getElementById('ccEmail').value = data.subject_template;
          }
        }
      } catch (error) {
        console.log('Using default CC email');
      }
    }

    // Save CC email as default
    document.getElementById('saveCcEmailBtn').addEventListener('click', async () => {
      const ccEmail = document.getElementById('ccEmail').value.trim();
      if (!ccEmail || !ccEmail.includes('@')) {
        showError('Veuillez entrer une adresse email valide');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/results_cc_email`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: ccEmail,
            body_template: 'CC email for tournament results'
          })
        });

        if (response.ok) {
          showSuccess('Adresse CC sauvegard√©e par d√©faut');
        } else {
          showError('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // Test mode toggle
    document.getElementById('testModeCheck').addEventListener('change', (e) => {
      const testEmailInput = document.getElementById('testEmailInput');
      const sendBtn = document.getElementById('sendResultsBtn');

      if (e.target.checked) {
        testEmailInput.style.display = 'block';
        sendBtn.textContent = 'Envoyer le Test';
        sendBtn.style.background = '#FF9800';
      } else {
        testEmailInput.style.display = 'none';
        sendBtn.textContent = 'Envoyer les R√©sultats';
        sendBtn.style.background = '#1F4788';
      }
    });

    document.getElementById('sendResultsBtn').addEventListener('click', async () => {
      if (!selectedTournamentData || tournamentResults.length === 0) {
        showError('Veuillez s√©lectionner un tournoi');
        return;
      }

      const isTestMode = document.getElementById('testModeCheck').checked;
      const testEmail = document.getElementById('testEmail').value.trim();

      if (isTestMode) {
        if (!testEmail || !testEmail.includes('@')) {
          showError('Veuillez entrer une adresse email valide pour le test.');
          return;
        }
        if (!confirm(`Envoyer un email de test √† ${testEmail} ?`)) {
          return;
        }
      } else {
        const emailCount = tournamentResults.filter(r => r.email).length;

        // Check if results were already sent for this tournament
        const campaignCheck = await checkCampaignAlreadySent(
          'tournament_results',
          selectedTournamentData.game_type,
          selectedTournamentData.level,
          selectedTournamentData.id
        );

        if (campaignCheck && campaignCheck.alreadySent) {
          const warningMsg = `‚ö†Ô∏è ATTENTION: Les r√©sultats de ce tournoi ont d√©j√† √©t√© envoy√©s!\n\n` +
            `üìÖ Date: ${formatCampaignDate(campaignCheck.lastSent)}\n` +
            `üë§ Par: ${campaignCheck.sentBy || 'Inconnu'}\n` +
            `üìß Destinataires: ${campaignCheck.recipientCount || 0}\n\n` +
            `Voulez-vous quand m√™me envoyer √† nouveau √† ${emailCount} participant(s) ?`;

          if (!confirm(warningMsg)) return;
        } else {
          if (!confirm(`Envoyer les r√©sultats √† ${emailCount} participant(s) ?`)) {
            return;
          }
        }
      }

      showProgress(isTestMode ? 'Envoi du test...' : 'Envoi des r√©sultats en cours...');

      try {
        const response = await fetch(`${API_URL}/emailing/send-results`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tournamentId: selectedTournamentData.id,
            introText: quillResultsIntroText.root.innerHTML,
            outroText: quillResultsOutroText.root.innerHTML,
            imageUrl: document.getElementById('resultsImageUrl').value || null,
            testMode: isTestMode,
            testEmail: isTestMode ? testEmail : null,
            ccEmail: document.getElementById('ccCheck').checked ? document.getElementById('ccEmail').value.trim() : null
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);
        } else {
          showError(result.error || 'Erreur lors de l\'envoi');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    });

    // Schedule results button
    document.getElementById('scheduleResultsBtn').addEventListener('click', async () => {
      const scheduledAt = document.getElementById('resultsScheduleDate').value;
      if (!scheduledAt) {
        showError('Veuillez s√©lectionner une date et heure');
        return;
      }

      if (!selectedTournamentData) {
        showError('Veuillez s√©lectionner un tournoi');
        return;
      }

      const testMode = document.getElementById('testModeCheck').checked;
      const testEmail = testMode ? document.getElementById('testEmail').value.trim() : null;

      if (testMode && !testEmail) {
        showError('Email de test requis en mode test');
        return;
      }

      const modeLabel = testMode ? ' (MODE TEST)' : '';
      if (!confirm(`Programmer l'envoi des r√©sultats pour le ${new Date(scheduledAt).toLocaleString('fr-FR')}${modeLabel} ?`)) return;

      try {
        const response = await fetch(`${API_URL}/emailing/schedule-results`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tournamentId: selectedTournamentData.id,
            introText: quillResultsIntroText.root.innerHTML,
            outroText: quillResultsOutroText.root.innerHTML,
            imageUrl: document.getElementById('resultsImageUrl').value || null,
            scheduledAt,
            ccEmail: document.getElementById('ccCheck').checked ? document.getElementById('ccEmail').value.trim() : null,
            testMode,
            testEmail
          })
        });

        const result = await response.json();
        if (response.ok) {
          showSuccess(result.message);
          document.getElementById('resultsScheduleDate').value = '';
        } else {
          showError(result.error || 'Erreur');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // Enable schedule results button when tournament selected
    document.getElementById('resultsScheduleDate').addEventListener('input', () => {
      const hasDate = document.getElementById('resultsScheduleDate').value;
      document.getElementById('scheduleResultsBtn').disabled = !hasDate || !selectedTournamentData;
    });

    // ==================== SUMMARY EMAIL SETTING ====================

    async function loadSummaryEmailSetting() {
      try {
        const response = await fetch(`${API_URL}/settings/app/summary_email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          const email = data.value || 'cdbhs92@gmail.com';
          document.getElementById('summaryEmailSetting').value = email;
          // Also update the default value in the CC field
          document.getElementById('ccEmail').value = email;
        }
      } catch (error) {
        console.error('Error loading summary email setting:', error);
      }
    }

    document.getElementById('saveSummaryEmailBtn').addEventListener('click', async () => {
      const email = document.getElementById('summaryEmailSetting').value.trim();
      if (!email || !email.includes('@')) {
        showError('Veuillez entrer une adresse email valide');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/app/summary_email`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: email })
        });

        if (response.ok) {
          showSuccess('Email r√©capitulatif sauvegard√©');
          // Update the CC fields with the new value
          document.getElementById('ccEmail').value = email;
          document.getElementById('finaleCcEmail').value = email;
        } else {
          const data = await response.json();
          showError(data.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== IMAGE PASTE HANDLER ====================

    // Reset image UI to initial state
    function resetImageUI() {
      const imageUrlInput = document.getElementById('imageUrl');
      const imagePreview = document.getElementById('imagePreview');
      const pasteContent = document.getElementById('imagePasteContent');
      const pasteZone = document.getElementById('imagePasteZone');
      const imageUrlSection = document.getElementById('imageUrlSection');

      if (imageUrlInput) imageUrlInput.value = '';
      if (imagePreview) imagePreview.style.display = 'none';
      if (pasteContent) {
        pasteContent.style.display = 'block';
        pasteContent.innerHTML = '<span style="color: #666;">üìã Collez une capture d\'√©cran (Ctrl+V) ou cliquez pour saisir une URL</span>';
      }
      if (pasteZone) {
        pasteZone.style.borderColor = '#ccc';
        pasteZone.style.background = '#fafafa';
      }
      if (imageUrlSection) imageUrlSection.style.display = 'none';
    }

    // Handle image paste in the paste zone
    function setupImagePasteHandler() {
      const pasteZone = document.getElementById('imagePasteZone');
      const imageUrlInput = document.getElementById('imageUrl');
      const imageUrlSection = document.getElementById('imageUrlSection');
      const imagePreview = document.getElementById('imagePreview');
      const imagePreviewImg = document.getElementById('imagePreviewImg');
      const removeImageBtn = document.getElementById('removeImageBtn');
      const pasteContent = document.getElementById('imagePasteContent');

      // Click on paste zone to show URL input
      pasteZone.addEventListener('click', (e) => {
        if (e.target !== removeImageBtn && !imagePreview.style.display.includes('block')) {
          imageUrlSection.style.display = imageUrlSection.style.display === 'none' ? 'block' : 'none';
        }
      });

      // Handle paste event on the whole document (for convenience)
      document.addEventListener('paste', async (e) => {
        // Only handle if we're in the compose tab
        const composeTab = document.getElementById('tab-compose');
        if (!composeTab.classList.contains('active')) return;

        const items = e.clipboardData?.items;
        if (!items) return;

        for (const item of items) {
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            const file = item.getAsFile();
            if (file) {
              await uploadImage(file);
            }
            break;
          }
        }
      });

      // Remove image button
      removeImageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        imageUrlInput.value = '';
        imagePreview.style.display = 'none';
        pasteContent.style.display = 'block';
        pasteZone.style.borderColor = '#ccc';
        pasteZone.style.background = '#fafafa';
      });

      // Upload image function
      async function uploadImage(file) {
        const progressDiv = document.getElementById('imageUploadProgress');
        const progressBar = document.getElementById('uploadProgressBar');

        try {
          // Show progress
          progressDiv.style.display = 'block';
          pasteContent.innerHTML = '<span style="color: #1F4788;">T√©l√©chargement en cours...</span>';
          progressBar.style.width = '30%';

          const formData = new FormData();
          formData.append('image', file);

          progressBar.style.width = '60%';

          const response = await fetch(`${API_URL}/emailing/upload-image`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`
            },
            body: formData
          });

          progressBar.style.width = '90%';

          if (!response.ok) {
            throw new Error('Upload failed');
          }

          const result = await response.json();
          progressBar.style.width = '100%';

          // Set the URL and show preview
          imageUrlInput.value = result.url;
          imagePreviewImg.src = result.url;
          imagePreview.style.display = 'block';
          pasteContent.style.display = 'none';
          pasteZone.style.borderColor = '#28a745';
          pasteZone.style.background = '#e8f5e9';

          setTimeout(() => {
            progressDiv.style.display = 'none';
            progressBar.style.width = '0%';
          }, 500);

          showSuccess('Image t√©l√©charg√©e avec succ√®s');

        } catch (error) {
          console.error('Error uploading image:', error);
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
          pasteContent.innerHTML = '<span style="color: #666;">üìã Collez une capture d\'√©cran (Ctrl+V) ou cliquez pour saisir une URL</span>';
          showError('Erreur lors du t√©l√©chargement de l\'image');
        }
      }

      // Also handle URL input changes to show preview
      imageUrlInput.addEventListener('change', () => {
        const url = imageUrlInput.value.trim();
        if (url) {
          imagePreviewImg.src = url;
          imagePreview.style.display = 'block';
          pasteContent.style.display = 'none';
          pasteZone.style.borderColor = '#28a745';
          pasteZone.style.background = '#e8f5e9';
        }
      });
    }

    // ==================== INIT ====================

    async function initialize() {
      await loadGameModes(); // Load game modes for dropdowns
      await loadClubs();
      await loadTournois();
      await loadRankingCategories();
      await loadContacts();
      await loadTemplates();
      await loadImportedTournaments();
      await loadCcEmail();
      await loadResultsTemplate();
      await loadSummaryEmailSetting();
      await loadRelanceHistory();
      setupImagePasteHandler(); // Setup image paste functionality

      // Check for relance action from URL params (from dashboard alert)
      await handleRelanceFromDashboard();
    }

    // Handle relance action when coming from dashboard
    async function handleRelanceFromDashboard() {
      const urlParams = new URLSearchParams(window.location.search);
      const action = urlParams.get('action');
      const tournoiId = urlParams.get('tournoi');

      if (action === 'relance' && tournoiId) {
        // Get tournament info from localStorage (set by dashboard)
        const relanceInfo = localStorage.getItem('relanceTournoi');
        let mode = '';
        let category = '';
        let nom = '';
        let lieu = '';
        let debut = '';

        if (relanceInfo) {
          try {
            const info = JSON.parse(relanceInfo);
            mode = info.mode || '';
            category = info.categorie || '';
            nom = info.nom || '';
            lieu = info.lieu || '';
            debut = info.debut || '';
            // Clear after use
            localStorage.removeItem('relanceTournoi');
          } catch (e) {
            console.error('Error parsing relance info:', e);
          }
        }

        // If we don't have mode/category from localStorage, try to find from allTournois
        if ((!mode || !category) && allTournois.length > 0) {
          const tournoi = allTournois.find(t => t.tournoi_id == tournoiId);
          if (tournoi) {
            mode = tournoi.mode;
            category = tournoi.categorie;
            nom = tournoi.nom;
            lieu = tournoi.lieu || '';
            debut = tournoi.debut || '';
          }
        }

        if (mode && category) {
          // Store tournoiId for marking relance as sent later
          window.currentRelanceTournoiId = tournoiId;
          // Store lieu and debut for pre-filling after template loads
          window.pendingRelanceLieu = lieu;
          window.pendingRelanceDebut = debut;

          // Switch to relances tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

          const relancesTab = document.querySelector('.tab[data-tab="relances"]');
          if (relancesTab) {
            relancesTab.classList.add('active');
            document.getElementById('tab-relances').classList.add('active');
          }

          // Pre-select mode (normalize: remove spaces and uppercase to match dropdown values like "3BANDES")
          const modeSelect = document.getElementById('relanceModeFilter');
          const normalizedMode = mode.toUpperCase().replace(/\s+/g, '');
          modeSelect.value = normalizedMode;

          // Update and pre-select category
          updateRelanceCategoryFilter();
          const categorySelect = document.getElementById('relanceCategoryFilter');
          // Normalize category: extract just the base level (e.g., "N3" from "N3 GC" or "R2" from "R2 PC")
          // Categories are like N1, N2, N3, R1, R2, R3, R4, R5
          const categoryMatch = category.toUpperCase().match(/^(N[1-3]|R[1-5])/);
          const normalizedCategory = categoryMatch ? categoryMatch[1] : category.toUpperCase();
          categorySelect.value = normalizedCategory;

          // Determine relance type from tournament name
          let relanceType = '';
          const nomLower = nom.toLowerCase();
          if (nomLower.includes('finale')) {
            relanceType = 'finale';
          } else if (nomLower.includes('tournoi 3') || nomLower.includes('t3')) {
            relanceType = 't3';
          } else if (nomLower.includes('tournoi 2') || nomLower.includes('t2')) {
            relanceType = 't2';
          }

          // Load relance templates FIRST (this loads clubs too)
          await loadRelanceTemplates();

          // Pre-select relance type if determined AND category was set
          if (relanceType && categorySelect.value) {
            const typeSelect = document.getElementById('relanceTypeSelect');
            typeSelect.disabled = false; // Enable first
            typeSelect.value = relanceType;
            // Await updateRelanceTemplate so fetchNextTournamentInfo uses pending values
            await updateRelanceTemplate();
          }

          // Enable the "Charger" button
          updateRelanceTypeEnabled();

          // Show info message
          const lieuInfo = lieu ? ` @ ${lieu}` : '';
          showSuccess(`Pr√©paration de relance pour: ${mode} ${category}${lieuInfo}. Chargez les destinataires pour continuer.`);

          // Clean URL without reloading
          window.history.replaceState({}, document.title, 'emailing.html');
        }
      }
    }

    // ==================== ANNOUNCEMENTS ====================

    // Live preview for announcements
    document.getElementById('announcementTitle')?.addEventListener('input', updateAnnouncementPreview);
    document.getElementById('announcementMessage')?.addEventListener('input', updateAnnouncementPreview);
    document.getElementById('announcementType')?.addEventListener('change', updateAnnouncementPreview);

    function updateAnnouncementPreview() {
      const title = document.getElementById('announcementTitle').value || 'Titre de l\'annonce';
      const message = document.getElementById('announcementMessage').value || 'Message de l\'annonce...';
      const type = document.getElementById('announcementType').value;

      document.getElementById('previewTitle').textContent = title;
      document.getElementById('previewMessage').textContent = message;

      const preview = document.getElementById('announcementPreview');
      const colors = {
        info: '#1565c0',
        resultats: '#2e7d32',
        warning: '#e65100',
        urgent: '#c62828',
        perso: '#7b1fa2'
      };
      const backgrounds = {
        info: '#e3f2fd',
        resultats: '#e8f5e9',
        warning: '#fff3e0',
        urgent: '#ffebee',
        perso: '#f3e5f5'
      };
      preview.style.borderLeftColor = colors[type] || colors.info;
      preview.style.background = backgrounds[type] || 'white';
    }

    // Load announcements
    async function loadAnnouncements() {
      try {
        const response = await fetch(`${API_URL}/announcements`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load announcements');

        const announcements = await response.json();
        const container = document.getElementById('announcementsList');

        if (!announcements || announcements.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Aucune annonce pour le moment.</div>';
          return;
        }

        container.innerHTML = announcements.map(a => {
          const isExpired = a.expires_at && new Date(a.expires_at) < new Date();
          const statusClass = !a.is_active ? 'inactive' : '';
          const statusBadge = !a.is_active
            ? '<span class="status-badge status-inactive">Inactive</span>'
            : isExpired
              ? '<span class="status-badge status-expired">Expiree</span>'
              : '<span class="status-badge status-active">Active</span>';
          const testBadge = a.test_licence
            ? `<span style="background: #ff9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">üß™ TEST: ${a.test_licence}</span>`
            : '';
          const targetBadge = a.target_licence && !a.test_licence
            ? `<span style="background: #7b1fa2; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">üë§ ${a.target_licence}</span>`
            : '';

          return `
            <div class="announcement-card ${statusClass}">
              <div class="announcement-header">
                <h4 class="announcement-title">
                  <span class="announcement-type type-${a.type}">${a.type}</span>
                  ${escapeHtmlAnn(a.title)}
                  ${statusBadge}
                  ${testBadge}
                  ${targetBadge}
                </h4>
                <div class="announcement-actions">
                  <button class="btn-toggle ${a.is_active ? 'active' : ''}" onclick="toggleAnnouncement(${a.id})">
                    ${a.is_active ? 'Desactiver' : 'Activer'}
                  </button>
                  <button class="btn-delete" onclick="deleteAnnouncement(${a.id})">Supprimer</button>
                </div>
              </div>
              <div class="announcement-message">${escapeHtmlAnn(a.message)}</div>
              <div class="announcement-meta">
                <span>Creee le ${formatDateAnn(a.created_at)}</span>
                ${a.created_by ? `<span>Par ${a.created_by}</span>` : ''}
                ${a.expires_at ? `<span>Expire le ${formatDateAnn(a.expires_at)}</span>` : '<span>Pas d\'expiration</span>'}
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading announcements:', error);
        document.getElementById('announcementsList').innerHTML =
          '<div style="text-align: center; padding: 40px; color: #c62828;">Erreur lors du chargement des annonces.</div>';
      }
    }

    // Toggle test mode fields
    document.getElementById('announcementTestMode')?.addEventListener('change', (e) => {
      const testFields = document.getElementById('announcementTestFields');
      testFields.style.display = e.target.checked ? 'block' : 'none';
      if (!e.target.checked) {
        document.getElementById('announcementTestLicence').value = '';
      }
    });

    // Recipient selection
    document.querySelectorAll('input[name="announcementRecipient"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const playerSearch = document.getElementById('playerSearchSection');
        const options = document.querySelectorAll('.recipient-option');

        options.forEach(opt => {
          opt.style.borderColor = '#ddd';
          opt.classList.remove('selected');
        });
        e.target.closest('.recipient-option').style.borderColor = '#1F4788';
        e.target.closest('.recipient-option').classList.add('selected');

        if (e.target.value === 'one') {
          playerSearch.style.display = 'block';
        } else {
          playerSearch.style.display = 'none';
          clearSelectedPlayer();
        }
      });
    });

    // Player search autocomplete
    let searchTimeout;
    let allPlayersCache = null;

    document.getElementById('playerSearchInput')?.addEventListener('input', async (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim().toLowerCase();

      if (query.length < 2) {
        document.getElementById('playerSearchResults').style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(async () => {
        // Load players if not cached
        if (!allPlayersCache) {
          try {
            const response = await fetch(`${API_URL}/players`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
              allPlayersCache = await response.json();
            }
          } catch (err) {
            console.error('Error loading players:', err);
            return;
          }
        }

        // Filter players
        const matches = allPlayersCache.filter(p =>
          p.last_name?.toLowerCase().includes(query) ||
          p.first_name?.toLowerCase().includes(query) ||
          p.licence?.toLowerCase().includes(query)
        ).slice(0, 10);

        const resultsDiv = document.getElementById('playerSearchResults');
        if (matches.length === 0) {
          resultsDiv.innerHTML = '<div style="padding: 10px; color: #666;">Aucun joueur trouv√©</div>';
        } else {
          resultsDiv.innerHTML = matches.map(p => `
            <div onclick="selectPlayer('${p.licence}', '${escapeHtmlAnn(p.first_name)} ${escapeHtmlAnn(p.last_name)}')"
                 style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                 onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
              <strong>${escapeHtmlAnn(p.first_name)} ${escapeHtmlAnn(p.last_name)}</strong>
              <span style="color: #666; font-size: 12px; margin-left: 8px;">${p.licence}</span>
            </div>
          `).join('');
        }
        resultsDiv.style.display = 'block';
      }, 300);
    });

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#playerSearchSection')) {
        document.getElementById('playerSearchResults').style.display = 'none';
      }
    });

    function selectPlayer(licence, name) {
      document.getElementById('selectedPlayerLicence').value = licence;
      document.getElementById('selectedPlayerName').textContent = `${name} (${licence})`;
      document.getElementById('selectedPlayer').style.display = 'block';
      document.getElementById('playerSearchInput').value = '';
      document.getElementById('playerSearchResults').style.display = 'none';
    }

    function clearSelectedPlayer() {
      document.getElementById('selectedPlayerLicence').value = '';
      document.getElementById('selectedPlayerName').textContent = '';
      document.getElementById('selectedPlayer').style.display = 'none';
      document.getElementById('playerSearchInput').value = '';
    }

    // Add announcement
    document.getElementById('addAnnouncementForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const isTestMode = document.getElementById('announcementTestMode').checked;
      const testLicence = document.getElementById('announcementTestLicence').value.trim();
      const recipientType = document.querySelector('input[name="announcementRecipient"]:checked').value;
      const targetLicence = document.getElementById('selectedPlayerLicence').value.trim();

      if (isTestMode && !testLicence) {
        showError('Veuillez saisir la licence du testeur');
        return;
      }

      if (recipientType === 'one' && !targetLicence) {
        showError('Veuillez s√©lectionner un joueur');
        return;
      }

      const data = {
        title: document.getElementById('announcementTitle').value,
        message: document.getElementById('announcementMessage').value,
        type: document.getElementById('announcementType').value,
        expires_at: document.getElementById('announcementExpiry').value || null,
        test_licence: isTestMode ? testLicence : null,
        target_licence: recipientType === 'one' ? targetLicence : null
      };

      try {
        const response = await fetch(`${API_URL}/announcements`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create announcement');
        }

        // Success message based on mode
        let successMsg = 'Annonce publi√©e avec succ√®s !';
        if (isTestMode) {
          successMsg = `Annonce test publi√©e ! Visible uniquement par ${testLicence}`;
        } else if (recipientType === 'one') {
          const playerName = document.getElementById('selectedPlayerName').textContent;
          successMsg = `Message envoy√© √† ${playerName}`;
        }
        showSuccess(successMsg);

        // Reset form
        e.target.reset();
        document.getElementById('announcementTestFields').style.display = 'none';
        document.getElementById('playerSearchSection').style.display = 'none';
        clearSelectedPlayer();
        // Reset recipient selection UI
        document.querySelectorAll('.recipient-option').forEach((opt, i) => {
          opt.style.borderColor = i === 0 ? '#1F4788' : '#ddd';
        });
        updateAnnouncementPreview();
        loadAnnouncements();

      } catch (error) {
        showError(error.message);
      }
    });

    // Toggle announcement
    async function toggleAnnouncement(id) {
      try {
        const response = await fetch(`${API_URL}/announcements/${id}/toggle`, {
          method: 'PATCH',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to toggle announcement');

        loadAnnouncements();
      } catch (error) {
        showError(error.message);
      }
    }

    // Delete announcement
    async function deleteAnnouncement(id) {
      if (!confirm('Etes-vous sur de vouloir supprimer cette annonce ?')) return;

      try {
        const response = await fetch(`${API_URL}/announcements/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete announcement');

        showSuccess('Annonce supprimee');
        loadAnnouncements();
      } catch (error) {
        showError(error.message);
      }
    }

    function escapeHtmlAnn(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDateAnn(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Load announcements on tab switch
    const originalTabHandler = document.querySelectorAll('.tab')[0]?.onclick;
    document.querySelectorAll('.tab').forEach(tab => {
      const originalClick = tab.onclick;
      tab.addEventListener('click', () => {
        if (tab.dataset.tab === 'announcements') {
          loadAnnouncements();
        }
      });
    });

    // Load audience count
    async function loadAudienceCount() {
      try {
        const response = await fetch(`${API_URL}/announcements/audience-count`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          document.getElementById('audienceCount').textContent = data.count || 0;
        }
      } catch (error) {
        console.error('Error loading audience count:', error);
      }
    }

    // Initial load of announcements (since it's the default tab now)
    loadAnnouncements();
    loadAudienceCount();

    initialize();
  </script>
</body>
</html>
