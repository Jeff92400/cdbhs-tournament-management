<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emailing - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .emailing-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 1200px) {
      .emailing-container {
        grid-template-columns: 1fr;
      }
    }
    .contacts-list {
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .contact-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }
    .contact-item:last-child {
      border-bottom: none;
    }
    .contact-item:hover {
      background: #f5f5f5;
    }
    .contact-item.selected {
      background: #e3f2fd;
    }
    .contact-info {
      flex: 1;
    }
    .contact-name {
      font-weight: bold;
      color: #333;
    }
    .contact-details {
      font-size: 12px;
      color: #666;
    }
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar input, .filter-bar select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .filter-bar input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .selection-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .selection-actions button {
      padding: 8px 15px;
      font-size: 12px;
    }
    .compose-area {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .compose-area label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    .compose-area input, .compose-area textarea, .compose-area select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: inherit;
    }
    .compose-area textarea {
      min-height: 200px;
      resize: vertical;
    }
    .template-vars {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
    }
    .template-vars code {
      background: #e9ecef;
      padding: 2px 5px;
      border-radius: 3px;
      margin: 0 3px;
    }
    .schedule-section {
      background: #fff3e0;
      padding: 15px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .schedule-section input[type="datetime-local"] {
      width: auto;
    }
    .send-actions {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    .send-actions button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-actif { background: #e8f5e9; color: #2e7d32; }
    .badge-inactif { background: #ffebee; color: #c62828; }
    .badge-optin { background: #e3f2fd; color: #1565c0; }
    .badge-optout { background: #fff3e0; color: #e65100; }
    .stats-mini {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
    }
    .stat-mini {
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 4px;
      text-align: center;
    }
    .stat-mini .value {
      font-size: 24px;
      font-weight: bold;
      color: #1F4788;
    }
    .stat-mini .label {
      font-size: 12px;
      color: #666;
    }
    .history-table {
      font-size: 14px;
    }
    .history-table th, .history-table td {
      padding: 10px;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: #666;
    }
    .tab:hover {
      color: #1F4788;
    }
    .tab.active {
      color: #1F4788;
      border-bottom-color: #1F4788;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .progress-box {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
    }
    .progress-box h3 {
      margin-top: 0;
    }
    .scheduled-list {
      margin-top: 20px;
    }
    .scheduled-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="icon" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none';"> Emailing</h2>
      <div class="nav-links">
        <a href="rankings.html">Classements</a>
        <a href="tournaments-list.html">Tournois jou√©s</a>
        <a href="generate-poules.html">Comp√©titions √† jouer</a>
        <a href="dashboard.html">Accueil</a>
        <a href="#" id="logoutBtn">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="tabs">
      <div class="tab active" data-tab="compose">Composer</div>
      <div class="tab" data-tab="results">R√©sultats Tournoi</div>
      <div class="tab" data-tab="finale">Convocation Finale</div>
      <div class="tab" data-tab="contacts">Gestion Contacts</div>
      <div class="tab" data-tab="templates">Templates</div>
      <div class="tab" data-tab="history">Historique</div>
      <div class="tab" data-tab="scheduled">Programm√©s</div>
    </div>

    <!-- TAB: Compose Email -->
    <div id="tab-compose" class="tab-content active">
      <div class="stats-mini">
        <div class="stat-mini">
          <div class="value" id="totalContacts">-</div>
          <div class="label">Contacts</div>
        </div>
        <div class="stat-mini">
          <div class="value" id="selectedCount">0</div>
          <div class="label">Selectionnes</div>
        </div>
        <div class="stat-mini">
          <div class="value" id="optinCount">-</div>
          <div class="label">Opt-in</div>
        </div>
      </div>

      <div class="emailing-container">
        <!-- Left: Contact Selection -->
        <div class="card">
          <h3>Destinataires</h3>

          <div class="filter-bar" style="flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
              <input type="checkbox" id="activeOnlyFilter" checked> Actifs seulement
            </label>
            <select id="clubFilter">
              <option value="">Tous les clubs</option>
            </select>
            <select id="modeFilter">
              <option value="">Tous les modes</option>
              <option value="LIBRE">LIBRE</option>
              <option value="CADRE">CADRE</option>
              <option value="BANDE">BANDE</option>
              <option value="3BANDES">3 BANDES</option>
            </select>
            <select id="categoryFilter" disabled>
              <option value="">Toutes categories</option>
            </select>
            <select id="tournoiFilter">
              <option value="">-- Tournois saison en cours --</option>
            </select>
          </div>
          <div class="filter-bar">
            <input type="text" id="contactSearch" placeholder="Rechercher par nom, email, club..." style="flex: 1;">
          </div>

          <div class="selection-actions">
            <button class="btn" id="selectAllBtn" style="background: #4CAF50;">Tout selectionner</button>
            <button class="btn" id="deselectAllBtn" style="background: #999;">Tout deselectionner</button>
          </div>

          <div id="loadingContacts" class="loading">
            <div class="spinner"></div>
            Chargement des contacts...
          </div>

          <div class="contacts-list" id="contactsList" style="display: none;"></div>
        </div>

        <!-- Right: Compose -->
        <div class="card">
          <h3>Message</h3>

          <div class="compose-area">
            <div>
              <label>Template (optionnel)</label>
              <select id="templateSelect">
                <option value="">-- Aucun template --</option>
              </select>
            </div>

            <div>
              <label>Sujet *</label>
              <input type="text" id="emailSubject" placeholder="Objet de l'email" required>
            </div>

            <div>
              <label>Message *</label>
              <textarea id="emailBody" placeholder="Contenu de l'email..."></textarea>
            </div>

            <div class="template-vars">
              <strong>Variables disponibles:</strong>
              <code>{player_name}</code>
              <code>{first_name}</code>
              <code>{last_name}</code>
              <code>{club}</code>
            </div>

            <div style="margin-top: 15px;">
              <label>Image (optionnel) - URL</label>
              <input type="url" id="imageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%;">
              <p style="font-size: 11px; color: #666; margin-top: 5px;">L'image sera affichee en haut du message. Utilisez une URL publique (ex: lien vers image hebergee).</p>
            </div>

            <div class="schedule-section">
              <label>
                <input type="checkbox" id="scheduleCheck"> Programmer l'envoi
              </label>
              <div id="scheduleOptions" style="display: none; margin-top: 10px;">
                <label>Date et heure d'envoi:</label>
                <input type="datetime-local" id="scheduledAt">
              </div>
            </div>

            <div class="send-actions">
              <button class="btn" id="sendNowBtn" style="background: #1F4788;">Envoyer maintenant</button>
              <button class="btn" id="scheduleBtn" style="background: #FF9800; display: none;">Programmer</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Tournament Results -->
    <div id="tab-results" class="tab-content">
      <div class="card">
        <h3>Envoyer les R√©sultats d'un Tournoi</h3>
        <p style="color: #666; margin-bottom: 20px;">
          S√©lectionnez un tournoi import√© pour envoyer les r√©sultats √† tous les participants par email.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left: Tournament Selection -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 10px;">S√©lectionner un tournoi import√©</label>
            <select id="resultsTournamentSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              <option value="">-- Choisir un tournoi --</option>
            </select>

            <div id="tournamentInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;" id="tournamentInfoTitle">-</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                <div><strong>Date:</strong> <span id="tournamentInfoDate">-</span></div>
                <div><strong>Lieu:</strong> <span id="tournamentInfoLieu">-</span></div>
                <div><strong>Mode:</strong> <span id="tournamentInfoMode">-</span></div>
                <div><strong>Cat√©gorie:</strong> <span id="tournamentInfoCategory">-</span></div>
                <div><strong>Participants:</strong> <span id="tournamentInfoParticipants">-</span></div>
                <div><strong>Emails disponibles:</strong> <span id="tournamentInfoEmails">-</span></div>
              </div>
            </div>

            <div id="tournamentResultsPreview" style="display: none; margin-top: 20px;">
              <h4>Aper√ßu des R√©sultats</h4>
              <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                <table style="width: 100%; font-size: 13px;">
                  <thead style="background: #f8f9fa; position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 10px; text-align: left;">Pos</th>
                      <th style="padding: 10px; text-align: left;">Joueur</th>
                      <th style="padding: 10px; text-align: center;">Points</th>
                      <th style="padding: 10px; text-align: center;">Email</th>
                    </tr>
                  </thead>
                  <tbody id="resultsPreviewBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right: Email Customization -->
          <div>
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte d'introduction</label>
              <textarea id="resultsIntroText" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;">Bonjour {first_name},

Voici les r√©sultats du tournoi {tournament_name} qui s'est d√©roul√© le {tournament_date} √† {tournament_lieu}.

F√©licitations √† tous les participants !</textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte de conclusion</label>
              <textarea id="resultsOutroText" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;">Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine</textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Image (optionnel) - URL</label>
              <input type="url" id="resultsImageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="template-vars" style="margin-bottom: 20px;">
              <strong>Variables disponibles:</strong>
              <code>{first_name}</code>
              <code>{last_name}</code>
              <code>{tournament_name}</code>
              <code>{tournament_date}</code>
              <code>{tournament_lieu}</code>
              <code>{player_position}</code>
              <code>{player_points}</code>
            </div>

            <!-- Summary Email Option -->
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="ccCheck" checked style="width: 18px; height: 18px;">
                <strong>üìã R√©capitulatif</strong> - Envoyer un email de synth√®se √† :
              </label>
              <p style="margin: 5px 0 0 28px; font-size: 12px; color: #666;">Un seul email avec la liste des destinataires et les r√©sultats</p>
              <div id="ccEmailInput" style="margin-top: 10px;">
                <input type="email" id="ccEmail" value="cdbhs92@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" id="saveCcEmailBtn" style="margin-top: 5px; padding: 5px 10px; font-size: 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Sauvegarder par d√©faut</button>
              </div>
            </div>

            <!-- Test Mode -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="testModeCheck" style="width: 18px; height: 18px;">
                <strong>Mode Test</strong> - Envoyer uniquement √† mon adresse
              </label>
              <div id="testEmailInput" style="display: none; margin-top: 10px;">
                <input type="email" id="testEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <button class="btn" id="sendResultsBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #1F4788;" disabled>
              Envoyer les R√©sultats
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Finale Convocation -->
    <div id="tab-finale" class="tab-content">
      <div class="card">
        <h3>üèÜ Convocation des Finalistes</h3>
        <p style="color: #666; margin-bottom: 20px;">
          S√©lectionnez une finale pour envoyer les convocations aux joueurs qualifi√©s (bas√© sur le classement apr√®s les 3 tournois).
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <!-- Left: Finale Selection -->
          <div>
            <label style="display: block; font-weight: bold; margin-bottom: 10px;">S√©lectionner une finale</label>
            <select id="finaleSelect" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
              <option value="">-- Finales saison en cours --</option>
            </select>

            <div id="finaleInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;" id="finaleInfoTitle">-</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                <div><strong>Date:</strong> <span id="finaleInfoDate">-</span></div>
                <div><strong>Lieu:</strong> <span id="finaleInfoLieu">-</span></div>
                <div><strong>Mode:</strong> <span id="finaleInfoMode">-</span></div>
                <div><strong>Cat√©gorie:</strong> <span id="finaleInfoCategory">-</span></div>
                <div><strong>Qualifi√©s:</strong> <span id="finaleInfoQualified">-</span></div>
                <div><strong>Emails disponibles:</strong> <span id="finaleInfoEmails">-</span></div>
              </div>
            </div>

            <div id="finalistsPreview" style="display: none; margin-top: 20px;">
              <h4 style="color: #28a745;">Finalistes Qualifi√©s</h4>
              <p style="color: #666; font-size: 13px; margin-bottom: 10px;">
                R√®gle : moins de 9 joueurs = 4 qualifi√©s, 9 joueurs ou plus = 6 qualifi√©s
              </p>
              <div style="max-height: 350px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px;">
                <table style="width: 100%; font-size: 13px;">
                  <thead style="background: #28a745; color: white; position: sticky; top: 0;">
                    <tr>
                      <th style="padding: 10px; text-align: center;">Pos</th>
                      <th style="padding: 10px; text-align: left;">Joueur</th>
                      <th style="padding: 10px; text-align: center;">Pts Match</th>
                      <th style="padding: 10px; text-align: center;">Moyenne</th>
                      <th style="padding: 10px; text-align: center;">Email</th>
                    </tr>
                  </thead>
                  <tbody id="finalistsPreviewBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Right: Email Customization -->
          <div>
            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte d'introduction</label>
              <textarea id="finaleIntroText" rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;">Bonjour {first_name},

Suite aux trois tournois de la saison, nous avons le plaisir de vous informer que vous √™tes qualifi√©(e) pour la finale d√©partementale !

Vous trouverez ci-dessous les informations concernant cette finale ainsi que la liste des finalistes.</textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte de conclusion</label>
              <textarea id="finaleOutroText" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;">En cas d'emp√™chement, merci de nous pr√©venir d√®s que possible.

Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine</textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px;">Image (optionnel) - URL</label>
              <input type="url" id="finaleImageUrl" placeholder="https://exemple.com/image.jpg" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div class="template-vars" style="margin-bottom: 20px;">
              <strong>Variables disponibles:</strong>
              <code>{first_name}</code>
              <code>{last_name}</code>
              <code>{player_name}</code>
              <code>{finale_name}</code>
              <code>{finale_date}</code>
              <code>{finale_lieu}</code>
              <code>{category}</code>
              <code>{rank_position}</code>
            </div>

            <!-- Summary Email Option -->
            <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="finaleCcCheck" checked style="width: 18px; height: 18px;">
                <strong>üìã R√©capitulatif</strong> - Envoyer un email de synth√®se √† :
              </label>
              <p style="margin: 5px 0 0 28px; font-size: 12px; color: #666;">Un seul email avec la liste des convocations envoy√©es</p>
              <div id="finaleCcEmailInput" style="margin-top: 10px;">
                <input type="email" id="finaleCcEmail" value="cdbhs92@gmail.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <!-- Test Mode -->
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="finaleTestModeCheck" style="width: 18px; height: 18px;">
                <strong>Mode Test</strong> - Envoyer uniquement √† mon adresse
              </label>
              <div id="finaleTestEmailInput" style="display: none; margin-top: 10px;">
                <input type="email" id="finaleTestEmail" placeholder="votre.email@exemple.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              </div>
            </div>

            <button class="btn" id="sendFinaleConvocationBtn" style="width: 100%; padding: 15px; font-size: 16px; background: #28a745;" disabled>
              üèÜ Envoyer les Convocations Finale
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB: Contacts Management -->
    <div id="tab-contacts" class="tab-content">
      <!-- Settings Section -->
      <div class="card" style="margin-bottom: 20px; background: #f0f7ff;">
        <h3 style="margin-top: 0;">‚öôÔ∏è Param√®tres Email</h3>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 300px;">
            <label style="display: block; font-weight: 500; margin-bottom: 5px;">Email r√©capitulatif (synth√®se des envois)</label>
            <div style="display: flex; gap: 10px;">
              <input type="email" id="summaryEmailSetting" placeholder="email@exemple.com" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              <button class="btn" id="saveSummaryEmailBtn" style="background: #28a745; white-space: nowrap;">Sauvegarder</button>
            </div>
            <p style="color: #666; font-size: 12px; margin-top: 5px;">
              Cet email recevra un r√©capitulatif unique apr√®s chaque envoi de convocations (au lieu d'un CC sur chaque email).
            </p>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Gestion des Contacts</h3>

        <div style="margin-bottom: 20px;">
          <button class="btn" id="syncContactsBtn" style="background: #4CAF50;">
            Synchroniser avec les joueurs/inscriptions
          </button>
          <p style="color: #666; font-size: 12px; margin-top: 5px;">
            Importe les donnees de la table Joueurs et met a jour les emails depuis les Inscriptions.
          </p>
        </div>

        <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
            <input type="checkbox" id="filterActifOnly" style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
            <span style="font-weight: 500;">Afficher uniquement les contacts Actifs</span>
          </label>
          <span id="contactsCountDisplay" style="color: #666; font-size: 13px; margin-left: 15px;"></span>
        </div>

        <div id="loadingAllContacts" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div class="table-container">
          <table id="allContactsTable">
            <thead>
              <tr>
                <th>Licence</th>
                <th>Nom</th>
                <th>Prenom</th>
                <th>Club</th>
                <th>Email</th>
                <th>Telephone</th>
                <th>Statut</th>
                <th>Opt-in</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="allContactsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Edit Contact Modal -->
      <div id="editContactModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto;">
          <h3 style="margin-top: 0;">Modifier le contact</h3>
          <form id="editContactForm">
            <input type="hidden" id="edit_contact_id">

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
              <input type="email" id="edit_contact_email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telephone</label>
              <input type="text" id="edit_contact_telephone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Statut</label>
              <select id="edit_contact_statut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="Actif">Actif</option>
                <option value="Inactif">Inactif</option>
                <option value="Suspendu">Suspendu</option>
              </select>
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Commentaires</label>
              <textarea id="edit_contact_comments" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label>
                <input type="checkbox" id="edit_contact_optin"> Accepte les emails (opt-in)
              </label>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
              <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
              <button type="button" id="cancelEditContactBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- TAB: Templates -->
    <div id="tab-templates" class="tab-content">
      <!-- Convocation Template -->
      <div class="card">
        <h3>Template Convocation</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de convocation aux tournois.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{player_name}</code>
          <code>{category}</code> <code>{tournament}</code> <code>{date}</code> <code>{lieu}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Objet</label>
          <input type="text" id="convocationSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Corps du message</label>
          <textarea id="convocationBody" rows="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <button class="btn" id="saveConvocationTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetConvocationTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Convocation Finale Template -->
      <div class="card" style="margin-top: 20px;">
        <h3>üèÜ Template Convocation Finale</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de convocation aux finales d√©partementales.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{player_name}</code>
          <code>{category}</code> <code>{finale_name}</code> <code>{date}</code> <code>{lieu}</code>
          <code>{mode}</code> <code>{rank_position}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Objet</label>
          <input type="text" id="finaleConvocationSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Corps du message</label>
          <textarea id="finaleConvocationBody" rows="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <button class="btn" id="saveFinaleConvocationTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetFinaleConvocationTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Results Template -->
      <div class="card" style="margin-top: 20px;">
        <h3>Template R√©sultats Tournoi</h3>
        <p style="color: #666; margin-bottom: 15px;">Template utilis√© pour les emails de r√©sultats apr√®s un tournoi.</p>

        <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
          <strong>Variables disponibles :</strong>
          <code>{first_name}</code> <code>{last_name}</code> <code>{tournament_name}</code>
          <code>{tournament_date}</code> <code>{tournament_lieu}</code> <code>{player_position}</code> <code>{player_points}</code>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte d'introduction</label>
          <textarea id="resultsIntroTemplate" rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">Texte de conclusion</label>
          <textarea id="resultsOutroTemplate" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
        </div>

        <button class="btn" id="saveResultsTemplateBtn" style="background: #28a745;">Enregistrer</button>
        <button class="btn" id="resetResultsTemplateBtn" style="background: #6c757d; margin-left: 10px;">R√©initialiser par d√©faut</button>
      </div>

      <!-- Custom Templates -->
      <div class="card" style="margin-top: 20px;">
        <h3>Templates Personnalis√©s</h3>

        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold;">S√©lectionner un template:</label>
          <select id="templateEditSelect" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;">
            <option value="">-- Choisir --</option>
          </select>
          <button class="btn" id="newTemplateBtn" style="margin-left: 10px; background: #4CAF50;">Nouveau template</button>
        </div>

        <div id="templateEditor" style="display: none;">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Cl√© du template</label>
            <input type="text" id="templateKey" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Sujet</label>
            <input type="text" id="templateSubject" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Corps du message</label>
            <textarea id="templateBody" rows="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
          </div>

          <div class="template-vars">
            <strong>Variables disponibles:</strong>
            <code>{player_name}</code>
            <code>{first_name}</code>
            <code>{last_name}</code>
            <code>{club}</code>
          </div>

          <button class="btn" id="saveTemplateBtn" style="margin-top: 15px; background: #1F4788;">Sauvegarder</button>
        </div>
      </div>
    </div>

    <!-- TAB: History -->
    <div id="tab-history" class="tab-content">
      <div class="card">
        <h3>Historique des campagnes</h3>

        <div id="loadingHistory" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div class="table-container">
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Sujet</th>
                <th>Destinataires</th>
                <th>Envoyes</th>
                <th>Echecs</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody id="historyBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB: Scheduled -->
    <div id="tab-scheduled" class="tab-content">
      <div class="card">
        <h3>Emails programmes</h3>

        <div id="loadingScheduled" class="loading" style="display: none;">
          <div class="spinner"></div>
          Chargement...
        </div>

        <div id="scheduledList" class="scheduled-list"></div>
        <div id="noScheduled" style="text-align: center; color: #666; padding: 40px; display: none;">
          Aucun email programme.
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-box">
      <h3>Envoi en cours...</h3>
      <div class="spinner" style="margin: 20px auto;"></div>
      <p id="progressText">Preparation...</p>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Get user role
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        // Load data for specific tabs
        if (tab.dataset.tab === 'results') loadImportedTournaments();
        if (tab.dataset.tab === 'finale') loadFinales();
        if (tab.dataset.tab === 'contacts') loadAllContacts();
        if (tab.dataset.tab === 'templates') {
          loadConvocationTemplate();
          loadFinaleConvocationTemplate();
          loadResultsTemplate();
        }
        if (tab.dataset.tab === 'history') loadHistory();
        if (tab.dataset.tab === 'scheduled') loadScheduled();
      });
    });

    let allContacts = [];
    let selectedContactIds = new Set();
    let allTournois = [];

    // Categories by mode
    const categoriesByMode = {
      'LIBRE': ['N3', 'R1', 'R2', 'R3', 'R4'],
      'CADRE': ['N3', 'R1'],
      'BANDE': ['N3', 'R1', 'R2'],
      '3BANDES': ['N3', 'R1', 'R2']
    };

    // ==================== CONTACTS ====================

    async function loadContacts() {
      try {
        // Build query params from filters
        const params = new URLSearchParams();
        if (document.getElementById('activeOnlyFilter').checked) {
          params.append('activeOnly', 'true');
        }
        const club = document.getElementById('clubFilter').value;
        if (club) params.append('club', club);
        const mode = document.getElementById('modeFilter').value;
        if (mode) params.append('mode', mode);
        const category = document.getElementById('categoryFilter').value;
        if (category) params.append('category', category);
        const tournoiId = document.getElementById('tournoiFilter').value;
        if (tournoiId) params.append('tournoiId', tournoiId);

        const url = `${API_URL}/emailing/contacts${params.toString() ? '?' + params.toString() : ''}`;

        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load contacts');

        allContacts = await response.json();

        // Update stats
        document.getElementById('totalContacts').textContent = allContacts.length;
        document.getElementById('optinCount').textContent = allContacts.filter(c => c.email_optin === 1).length;

        displayContacts(allContacts);

        document.getElementById('loadingContacts').style.display = 'none';
        document.getElementById('contactsList').style.display = 'block';

      } catch (error) {
        console.error('Error loading contacts:', error);
        showError('Erreur lors du chargement des contacts');
      }
    }

    async function loadClubs() {
      try {
        const response = await fetch(`${API_URL}/emailing/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const clubs = await response.json();
          const select = document.getElementById('clubFilter');
          select.innerHTML = '<option value="">Tous les clubs</option>';
          clubs.forEach(club => {
            const option = document.createElement('option');
            option.value = club;
            option.textContent = club;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    async function loadTournois() {
      try {
        const response = await fetch(`${API_URL}/emailing/tournois`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          allTournois = await response.json();
          const select = document.getElementById('tournoiFilter');
          select.innerHTML = '<option value="">-- Tournois saison en cours --</option>';

          // Group by mode
          const byMode = {};
          allTournois.forEach(t => {
            if (!byMode[t.mode]) byMode[t.mode] = [];
            byMode[t.mode].push(t);
          });

          Object.keys(byMode).sort().forEach(mode => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = mode;
            byMode[mode].forEach(t => {
              const option = document.createElement('option');
              option.value = t.tournoi_id;
              const date = t.debut ? new Date(t.debut).toLocaleDateString('fr-FR') : '';
              option.textContent = `${t.nom} ${t.categorie} ${date} (${t.nb_inscrits} inscrits)`;
              optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
          });
        }
      } catch (error) {
        console.error('Error loading tournois:', error);
      }
    }

    // Update category dropdown based on selected mode
    function updateCategoryFilter() {
      const mode = document.getElementById('modeFilter').value;
      const categorySelect = document.getElementById('categoryFilter');

      categorySelect.innerHTML = '<option value="">Toutes categories</option>';

      if (mode && categoriesByMode[mode]) {
        categorySelect.disabled = false;
        categoriesByMode[mode].forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
      } else {
        categorySelect.disabled = true;
      }
    }

    function displayContacts(contacts) {
      const list = document.getElementById('contactsList');
      list.innerHTML = '';

      if (contacts.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Aucun contact trouve</div>';
        return;
      }

      contacts.forEach(contact => {
        const div = document.createElement('div');
        div.className = 'contact-item' + (selectedContactIds.has(contact.id) ? ' selected' : '');
        div.innerHTML = `
          <input type="checkbox" class="contact-checkbox" data-id="${contact.id}" ${selectedContactIds.has(contact.id) ? 'checked' : ''}>
          <div class="contact-info">
            <div class="contact-name">${contact.last_name} ${contact.first_name}</div>
            <div class="contact-details">
              ${contact.email || 'Pas d\'email'} | ${contact.club || '-'}
            </div>
          </div>
          ${contact.statut === 'Actif' ? '<span class="badge badge-actif">Actif</span>' : '<span class="badge badge-inactif">Inactif</span>'}
        `;

        const checkbox = div.querySelector('.contact-checkbox');
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedContactIds.add(contact.id);
            div.classList.add('selected');
          } else {
            selectedContactIds.delete(contact.id);
            div.classList.remove('selected');
          }
          updateSelectedCount();
        });

        list.appendChild(div);
      });
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = selectedContactIds.size;
    }

    function applyContactFilters() {
      const searchTerm = document.getElementById('contactSearch').value.toLowerCase();

      let filtered = allContacts;

      if (searchTerm) {
        filtered = filtered.filter(c =>
          (c.first_name || '').toLowerCase().includes(searchTerm) ||
          (c.last_name || '').toLowerCase().includes(searchTerm) ||
          (c.email || '').toLowerCase().includes(searchTerm) ||
          (c.club || '').toLowerCase().includes(searchTerm)
        );
      }

      displayContacts(filtered);
    }

    // Reload contacts when filters change (server-side filtering)
    async function onFilterChange() {
      selectedContactIds.clear();
      updateSelectedCount();
      document.getElementById('loadingContacts').style.display = 'block';
      document.getElementById('contactsList').style.display = 'none';
      await loadContacts();
    }

    // Filter event listeners
    document.getElementById('contactSearch').addEventListener('input', applyContactFilters);
    document.getElementById('activeOnlyFilter').addEventListener('change', onFilterChange);
    document.getElementById('clubFilter').addEventListener('change', onFilterChange);
    document.getElementById('modeFilter').addEventListener('change', () => {
      updateCategoryFilter();
      onFilterChange();
    });
    document.getElementById('categoryFilter').addEventListener('change', onFilterChange);
    document.getElementById('tournoiFilter').addEventListener('change', onFilterChange);

    // Select all / Deselect all
    document.getElementById('selectAllBtn').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.contact-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedContactIds.add(parseInt(cb.dataset.id));
        cb.closest('.contact-item').classList.add('selected');
      });
      updateSelectedCount();
    });

    document.getElementById('deselectAllBtn').addEventListener('click', () => {
      const checkboxes = document.querySelectorAll('.contact-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = false;
        cb.closest('.contact-item').classList.remove('selected');
      });
      selectedContactIds.clear();
      updateSelectedCount();
    });

    // ==================== SEND EMAILS ====================

    document.getElementById('scheduleCheck').addEventListener('change', (e) => {
      const options = document.getElementById('scheduleOptions');
      const sendNowBtn = document.getElementById('sendNowBtn');
      const scheduleBtn = document.getElementById('scheduleBtn');

      if (e.target.checked) {
        options.style.display = 'block';
        sendNowBtn.style.display = 'none';
        scheduleBtn.style.display = 'block';
      } else {
        options.style.display = 'none';
        sendNowBtn.style.display = 'block';
        scheduleBtn.style.display = 'none';
      }
    });

    document.getElementById('sendNowBtn').addEventListener('click', sendEmails);
    document.getElementById('scheduleBtn').addEventListener('click', scheduleEmail);

    async function sendEmails() {
      if (selectedContactIds.size === 0) {
        showError('Veuillez selectionner au moins un destinataire.');
        return;
      }

      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();

      if (!subject || !body) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      if (!confirm(`Envoyer l'email a ${selectedContactIds.size} destinataire(s) ?`)) {
        return;
      }

      showProgress('Envoi en cours...');

      try {
        const response = await fetch(`${API_URL}/emailing/send`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientIds: Array.from(selectedContactIds),
            subject,
            body,
            templateKey: document.getElementById('templateSelect').value || null,
            imageUrl: document.getElementById('imageUrl').value || null
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);
          // Clear form
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
          document.getElementById('imageUrl').value = '';
          selectedContactIds.clear();
          updateSelectedCount();
          applyContactFilters();
        } else {
          showError(result.error || 'Erreur lors de l\'envoi.');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    }

    async function scheduleEmail() {
      if (selectedContactIds.size === 0) {
        showError('Veuillez selectionner au moins un destinataire.');
        return;
      }

      const subject = document.getElementById('emailSubject').value.trim();
      const body = document.getElementById('emailBody').value.trim();
      const scheduledAt = document.getElementById('scheduledAt').value;

      if (!subject || !body) {
        showError('Le sujet et le message sont obligatoires.');
        return;
      }

      if (!scheduledAt) {
        showError('Veuillez choisir une date et heure.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/schedule`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            recipientIds: Array.from(selectedContactIds),
            subject,
            body,
            templateKey: document.getElementById('templateSelect').value || null,
            imageUrl: document.getElementById('imageUrl').value || null,
            scheduledAt
          })
        });

        const result = await response.json();

        if (response.ok) {
          showSuccess(result.message);
          // Clear form
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
          document.getElementById('imageUrl').value = '';
          document.getElementById('scheduledAt').value = '';
          document.getElementById('scheduleCheck').checked = false;
          document.getElementById('scheduleOptions').style.display = 'none';
          document.getElementById('sendNowBtn').style.display = 'block';
          document.getElementById('scheduleBtn').style.display = 'none';
          selectedContactIds.clear();
          updateSelectedCount();
          applyContactFilters();
        } else {
          showError(result.error || 'Erreur lors de la programmation.');
        }

      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    }

    // ==================== TEMPLATES ====================

    async function loadTemplates() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const templates = await response.json();
          const select = document.getElementById('templateSelect');
          select.innerHTML = '<option value="">-- Aucun template --</option>';
          templates.forEach(t => {
            const option = document.createElement('option');
            option.value = t.template_key;
            option.textContent = t.template_key;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading templates:', error);
      }
    }

    document.getElementById('templateSelect').addEventListener('change', async (e) => {
      if (!e.target.value) return;

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${e.target.value}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('emailSubject').value = template.subject_template;
          document.getElementById('emailBody').value = template.body_template;
        }
      } catch (error) {
        console.error('Error loading template:', error);
      }
    });

    document.getElementById('templateEditSelect').addEventListener('change', async (e) => {
      const key = e.target.value;
      if (!key) {
        document.getElementById('templateEditor').style.display = 'none';
        return;
      }

      document.getElementById('templateEditor').style.display = 'block';
      document.getElementById('templateKey').value = key;
      document.getElementById('templateKey').readOnly = true;

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${key}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('templateSubject').value = template.subject_template;
          document.getElementById('templateBody').value = template.body_template;
        } else {
          // New template
          document.getElementById('templateSubject').value = '';
          document.getElementById('templateBody').value = '';
        }
      } catch (error) {
        document.getElementById('templateSubject').value = '';
        document.getElementById('templateBody').value = '';
      }
    });

    document.getElementById('newTemplateBtn').addEventListener('click', () => {
      document.getElementById('templateEditSelect').value = '';
      document.getElementById('templateEditor').style.display = 'block';
      document.getElementById('templateKey').value = '';
      document.getElementById('templateKey').readOnly = false;
      document.getElementById('templateSubject').value = '';
      document.getElementById('templateBody').value = '';
    });

    document.getElementById('saveTemplateBtn').addEventListener('click', async () => {
      const key = document.getElementById('templateKey').value.trim();
      const subject = document.getElementById('templateSubject').value.trim();
      const body = document.getElementById('templateBody').value.trim();

      if (!key || !subject || !body) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/${key}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template sauvegarde!');
          loadTemplates();
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== CONVOCATION & RESULTS TEMPLATES ====================

    const DEFAULT_CONVOCATION_TEMPLATE = {
      subject: 'Convocation {category} - {tournament} - {date}',
      body: `Bonjour {player_name},

Le CDBHS a le plaisir de vous convier au tournoi suivant.

Veuillez trouver en attachement votre convocation d√©taill√©e avec la composition de toutes les poules du tournoi.

En cas d'emp√™chement, merci d'informer d√®s que possible l'√©quipe en charge du sportif √† l'adresse ci-dessous.

Nous vous souhaitons une excellente comp√©tition.

Cordialement,
Comit√© D√©partemental Billard Hauts-de-Seine`
    };

    const DEFAULT_FINALE_CONVOCATION_TEMPLATE = {
      subject: 'Convocation Finale D√©partementale {mode} - {category} - {date}',
      body: `Bonjour {player_name},

Suite aux trois tournois de la saison, nous avons le plaisir de vous informer que vous √™tes qualifi√©(e) pour la Finale D√©partementale {mode} - {category}.

Vous trouverez ci-joint votre convocation avec la liste des finalistes.

En cas d'emp√™chement, merci de nous pr√©venir d√®s que possible √† l'adresse ci-dessous.

Nous vous souhaitons une excellente finale !

Sportivement,
Comit√© D√©partemental Billard Hauts-de-Seine`
    };

    const DEFAULT_RESULTS_TEMPLATE = {
      intro: `Bonjour {first_name},

Voici les r√©sultats du tournoi {tournament_name} qui s'est d√©roul√© le {tournament_date} √† {tournament_lieu}.

F√©licitations √† tous les participants !`,
      outro: `Sportivement,
Le Comit√© D√©partemental de Billard des Hauts-de-Seine`
    };

    async function loadConvocationTemplate() {
      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('convocationSubject').value = template.subject_template || DEFAULT_CONVOCATION_TEMPLATE.subject;
          document.getElementById('convocationBody').value = template.body_template || DEFAULT_CONVOCATION_TEMPLATE.body;
        } else {
          document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
          document.getElementById('convocationBody').value = DEFAULT_CONVOCATION_TEMPLATE.body;
        }
      } catch (error) {
        document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
        document.getElementById('convocationBody').value = DEFAULT_CONVOCATION_TEMPLATE.body;
      }
    }

    async function loadFinaleConvocationTemplate() {
      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation-finale`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const template = await response.json();
          document.getElementById('finaleConvocationSubject').value = template.subject_template || DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
          document.getElementById('finaleConvocationBody').value = template.body_template || DEFAULT_FINALE_CONVOCATION_TEMPLATE.body;
        } else {
          document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
          document.getElementById('finaleConvocationBody').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.body;
        }
      } catch (error) {
        document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
        document.getElementById('finaleConvocationBody').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.body;
      }
    }

    async function loadResultsTemplate() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates/results`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        let intro = DEFAULT_RESULTS_TEMPLATE.intro;
        let outro = DEFAULT_RESULTS_TEMPLATE.outro;

        if (response.ok) {
          const template = await response.json();
          // Parse the body which contains intro and outro separated by a delimiter
          const parts = (template.body_template || '').split('---OUTRO---');
          intro = parts[0] || DEFAULT_RESULTS_TEMPLATE.intro;
          outro = parts[1] || DEFAULT_RESULTS_TEMPLATE.outro;
        }

        // Update both the Templates tab fields AND the Results tab fields
        document.getElementById('resultsIntroTemplate').value = intro;
        document.getElementById('resultsOutroTemplate').value = outro;
        document.getElementById('resultsIntroText').value = intro;
        document.getElementById('resultsOutroText').value = outro;

      } catch (error) {
        document.getElementById('resultsIntroTemplate').value = DEFAULT_RESULTS_TEMPLATE.intro;
        document.getElementById('resultsOutroTemplate').value = DEFAULT_RESULTS_TEMPLATE.outro;
        document.getElementById('resultsIntroText').value = DEFAULT_RESULTS_TEMPLATE.intro;
        document.getElementById('resultsOutroText').value = DEFAULT_RESULTS_TEMPLATE.outro;
      }
    }

    document.getElementById('saveConvocationTemplateBtn').addEventListener('click', async () => {
      const subject = document.getElementById('convocationSubject').value.trim();
      const body = document.getElementById('convocationBody').value.trim();

      if (!subject || !body) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template convocation enregistr√©!');
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetConvocationTemplateBtn').addEventListener('click', () => {
      document.getElementById('convocationSubject').value = DEFAULT_CONVOCATION_TEMPLATE.subject;
      document.getElementById('convocationBody').value = DEFAULT_CONVOCATION_TEMPLATE.body;
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    // Finale Convocation Template handlers
    document.getElementById('saveFinaleConvocationTemplateBtn').addEventListener('click', async () => {
      const subject = document.getElementById('finaleConvocationSubject').value.trim();
      const body = document.getElementById('finaleConvocationBody').value.trim();

      if (!subject || !body) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation-finale`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (response.ok) {
          showSuccess('Template convocation finale enregistr√©!');
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetFinaleConvocationTemplateBtn').addEventListener('click', () => {
      document.getElementById('finaleConvocationSubject').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.subject;
      document.getElementById('finaleConvocationBody').value = DEFAULT_FINALE_CONVOCATION_TEMPLATE.body;
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    document.getElementById('saveResultsTemplateBtn').addEventListener('click', async () => {
      const intro = document.getElementById('resultsIntroTemplate').value.trim();
      const outro = document.getElementById('resultsOutroTemplate').value.trim();

      if (!intro || !outro) {
        showError('Tous les champs sont obligatoires.');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/results`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: 'R√©sultats Tournoi',
            body_template: intro + '---OUTRO---' + outro
          })
        });

        if (response.ok) {
          showSuccess('Template r√©sultats enregistr√©!');
          // Also update the Results tab textareas
          document.getElementById('resultsIntroText').value = intro;
          document.getElementById('resultsOutroText').value = outro;
        } else {
          showError('Erreur lors de la sauvegarde.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('resetResultsTemplateBtn').addEventListener('click', () => {
      document.getElementById('resultsIntroTemplate').value = DEFAULT_RESULTS_TEMPLATE.intro;
      document.getElementById('resultsOutroTemplate').value = DEFAULT_RESULTS_TEMPLATE.outro;
      showSuccess('Template r√©initialis√©. Cliquez sur Enregistrer pour sauvegarder.');
    });

    // ==================== ALL CONTACTS (Management) ====================

    let allContactsData = []; // Store contacts globally for filtering

    async function loadAllContacts() {
      document.getElementById('loadingAllContacts').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load contacts');

        allContactsData = await response.json();
        displayAllContacts();

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingAllContacts').style.display = 'none';
      }
    }

    // Toggle filter event listener
    document.getElementById('filterActifOnly').addEventListener('change', displayAllContacts);

    function displayAllContacts() {
      const tbody = document.getElementById('allContactsBody');
      tbody.innerHTML = '';

      const filterActif = document.getElementById('filterActifOnly').checked;
      const contacts = filterActif
        ? allContactsData.filter(c => (c.statut || 'Actif') === 'Actif')
        : allContactsData;

      // Update count display
      const countDisplay = document.getElementById('contactsCountDisplay');
      if (filterActif) {
        countDisplay.textContent = `${contacts.length} actif(s) sur ${allContactsData.length} total`;
      } else {
        countDisplay.textContent = `${allContactsData.length} contact(s)`;
      }

      if (contacts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Aucun contact. Utilisez le bouton "Synchroniser" pour importer les joueurs.</td></tr>';
        return;
      }

      contacts.forEach(c => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${c.licence || '-'}</td>
          <td>${c.last_name || '-'}</td>
          <td>${c.first_name || '-'}</td>
          <td>${c.club || '-'}</td>
          <td>${c.email || '-'}</td>
          <td>${c.telephone || '-'}</td>
          <td><span class="badge badge-${(c.statut || 'Actif').toLowerCase()}">${c.statut || 'Actif'}</span></td>
          <td>${c.email_optin === 1 ? '<span class="badge badge-optin">Oui</span>' : '<span class="badge badge-optout">Non</span>'}</td>
          <td>
            <button class="btn btn-small edit-contact-btn" data-id="${c.id}" style="padding: 5px 10px; font-size: 12px;">Modifier</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Add edit button handlers
      document.querySelectorAll('.edit-contact-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const contact = allContactsData.find(c => c.id === parseInt(btn.dataset.id));
          openEditContactModal(contact);
        });
      });
    }

    function openEditContactModal(contact) {
      document.getElementById('edit_contact_id').value = contact.id;
      document.getElementById('edit_contact_email').value = contact.email || '';
      document.getElementById('edit_contact_telephone').value = contact.telephone || '';
      document.getElementById('edit_contact_statut').value = contact.statut || 'Actif';
      document.getElementById('edit_contact_comments').value = contact.comments || '';
      document.getElementById('edit_contact_optin').checked = contact.email_optin === 1;

      document.getElementById('editContactModal').style.display = 'flex';
    }

    document.getElementById('cancelEditContactBtn').addEventListener('click', () => {
      document.getElementById('editContactModal').style.display = 'none';
    });

    document.getElementById('editContactForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('edit_contact_id').value;
      const data = {
        email: document.getElementById('edit_contact_email').value || null,
        telephone: document.getElementById('edit_contact_telephone').value || null,
        statut: document.getElementById('edit_contact_statut').value,
        comments: document.getElementById('edit_contact_comments').value || null,
        email_optin: document.getElementById('edit_contact_optin').checked ? 1 : 0
      };

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          document.getElementById('editContactModal').style.display = 'none';
          showSuccess('Contact mis a jour!');
          loadAllContacts();
          loadContacts(); // Refresh the contacts list in compose tab
        } else {
          showError('Erreur lors de la mise a jour.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    document.getElementById('syncContactsBtn').addEventListener('click', async () => {
      if (!confirm('Synchroniser les contacts avec les donnees joueurs/inscriptions ?')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/contacts/sync`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const result = await response.json();

        if (response.ok) {
          showSuccess(result.message);
          loadAllContacts();
          loadContacts();
        } else {
          showError(result.error || 'Erreur lors de la synchronisation.');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== HISTORY ====================

    async function loadHistory() {
      document.getElementById('loadingHistory').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/history`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load history');

        const history = await response.json();
        displayHistory(history);

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingHistory').style.display = 'none';
      }
    }

    function displayHistory(history) {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';

      if (history.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Aucune campagne.</td></tr>';
        return;
      }

      history.forEach(h => {
        const row = document.createElement('tr');
        const date = h.sent_at ? new Date(h.sent_at).toLocaleString('fr-FR') : new Date(h.created_at).toLocaleString('fr-FR');
        row.innerHTML = `
          <td>${date}</td>
          <td>${h.subject}</td>
          <td>${h.recipients_count}</td>
          <td style="color: green;">${h.sent_count}</td>
          <td style="color: red;">${h.failed_count}</td>
          <td><span class="badge badge-${h.status === 'completed' ? 'actif' : 'inactif'}">${h.status}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    // ==================== SCHEDULED ====================

    async function loadScheduled() {
      document.getElementById('loadingScheduled').style.display = 'block';

      try {
        const response = await fetch(`${API_URL}/emailing/scheduled`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load scheduled');

        const scheduled = await response.json();
        displayScheduled(scheduled);

      } catch (error) {
        showError('Erreur: ' + error.message);
      } finally {
        document.getElementById('loadingScheduled').style.display = 'none';
      }
    }

    function displayScheduled(scheduled) {
      const list = document.getElementById('scheduledList');
      const noScheduled = document.getElementById('noScheduled');
      list.innerHTML = '';

      if (scheduled.length === 0) {
        noScheduled.style.display = 'block';
        return;
      }

      noScheduled.style.display = 'none';

      scheduled.forEach(s => {
        const date = new Date(s.scheduled_at).toLocaleString('fr-FR');
        const recipientIds = JSON.parse(s.recipient_ids);

        const div = document.createElement('div');
        div.className = 'scheduled-item';
        div.innerHTML = `
          <div>
            <strong>${s.subject}</strong>
            <div style="font-size: 12px; color: #666;">
              ${date} - ${recipientIds.length} destinataire(s)
            </div>
          </div>
          <button class="btn cancel-scheduled-btn" data-id="${s.id}" style="background: #dc3545; padding: 8px 15px;">Annuler</button>
        `;
        list.appendChild(div);
      });

      document.querySelectorAll('.cancel-scheduled-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Annuler cet email programme ?')) return;

          try {
            const response = await fetch(`${API_URL}/emailing/scheduled/${btn.dataset.id}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
              showSuccess('Email annule.');
              loadScheduled();
            }
          } catch (error) {
            showError('Erreur: ' + error.message);
          }
        });
      });
    }

    // ==================== HELPERS ====================

    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function showProgress(text) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressOverlay').style.display = 'flex';
    }

    function hideProgress() {
      document.getElementById('progressOverlay').style.display = 'none';
    }

    // ==================== TOURNAMENT RESULTS ====================

    let selectedTournamentData = null;
    let tournamentResults = [];

    async function loadImportedTournaments() {
      try {
        const response = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load tournaments');

        const tournaments = await response.json();
        const select = document.getElementById('resultsTournamentSelect');
        select.innerHTML = '<option value="">-- Choisir un tournoi --</option>';

        // Group by season
        const bySeason = {};
        tournaments.forEach(t => {
          const season = t.season || 'Autre';
          if (!bySeason[season]) bySeason[season] = [];
          bySeason[season].push(t);
        });

        // Sort seasons descending and add to select
        Object.keys(bySeason).sort().reverse().forEach(season => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = `Saison ${season}`;
          bySeason[season].forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            const date = t.tournament_date ? new Date(t.tournament_date).toLocaleDateString('fr-FR') : '';
            option.textContent = `${t.display_name} - ${date} (${t.player_count} joueurs)`;
            option.dataset.tournament = JSON.stringify(t);
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });

      } catch (error) {
        console.error('Error loading tournaments:', error);
      }
    }

    document.getElementById('resultsTournamentSelect').addEventListener('change', async (e) => {
      const tournamentId = e.target.value;
      const infoDiv = document.getElementById('tournamentInfo');
      const previewDiv = document.getElementById('tournamentResultsPreview');
      const sendBtn = document.getElementById('sendResultsBtn');

      if (!tournamentId) {
        infoDiv.style.display = 'none';
        previewDiv.style.display = 'none';
        sendBtn.disabled = true;
        return;
      }

      try {
        // Load tournament details and results from single endpoint
        const response = await fetch(`${API_URL}/emailing/tournament-results/${tournamentId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to load data');
        }

        const data = await response.json();
        const tournament = data.tournament;

        selectedTournamentData = tournament;
        tournamentResults = data.results || [];

        // Update info section
        document.getElementById('tournamentInfoTitle').textContent = tournament.display_name || '-';
        document.getElementById('tournamentInfoDate').textContent = tournament.tournament_date ? new Date(tournament.tournament_date).toLocaleDateString('fr-FR') : '-';
        document.getElementById('tournamentInfoLieu').textContent = tournament.location || '-';
        document.getElementById('tournamentInfoMode').textContent = tournament.game_type || '-';
        document.getElementById('tournamentInfoCategory').textContent = tournament.level || '-';
        document.getElementById('tournamentInfoParticipants').textContent = tournamentResults.length;
        document.getElementById('tournamentInfoEmails').textContent = data.emailCount || 0;

        infoDiv.style.display = 'block';

        // Update results preview
        const tbody = document.getElementById('resultsPreviewBody');
        tbody.innerHTML = '';

        tournamentResults.forEach((r, idx) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding: 8px;">${idx + 1}</td>
            <td style="padding: 8px;">${r.player_name}</td>
            <td style="padding: 8px; text-align: center;">${r.points || '-'}</td>
            <td style="padding: 8px; text-align: center;">${r.email ? '‚úÖ' : '‚ùå'}</td>
          `;
          tbody.appendChild(row);
        });

        previewDiv.style.display = 'block';
        sendBtn.disabled = data.emailCount === 0;

      } catch (error) {
        console.error('Error loading tournament data:', error);
        showError('Erreur lors du chargement des donn√©es du tournoi');
      }
    });

    // CC checkbox toggle
    document.getElementById('ccCheck').addEventListener('change', (e) => {
      document.getElementById('ccEmailInput').style.opacity = e.target.checked ? '1' : '0.5';
      document.getElementById('ccEmail').disabled = !e.target.checked;
    });

    // Load saved CC email
    async function loadCcEmail() {
      try {
        const response = await fetch(`${API_URL}/emailing/templates/results_cc_email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.subject_template) {
            document.getElementById('ccEmail').value = data.subject_template;
          }
        }
      } catch (error) {
        console.log('Using default CC email');
      }
    }

    // Save CC email as default
    document.getElementById('saveCcEmailBtn').addEventListener('click', async () => {
      const ccEmail = document.getElementById('ccEmail').value.trim();
      if (!ccEmail || !ccEmail.includes('@')) {
        showError('Veuillez entrer une adresse email valide');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/templates/results_cc_email`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: ccEmail,
            body_template: 'CC email for tournament results'
          })
        });

        if (response.ok) {
          showSuccess('Adresse CC sauvegard√©e par d√©faut');
        } else {
          showError('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // Test mode toggle
    document.getElementById('testModeCheck').addEventListener('change', (e) => {
      const testEmailInput = document.getElementById('testEmailInput');
      const sendBtn = document.getElementById('sendResultsBtn');

      if (e.target.checked) {
        testEmailInput.style.display = 'block';
        sendBtn.textContent = 'Envoyer le Test';
        sendBtn.style.background = '#FF9800';
      } else {
        testEmailInput.style.display = 'none';
        sendBtn.textContent = 'Envoyer les R√©sultats';
        sendBtn.style.background = '#1F4788';
      }
    });

    document.getElementById('sendResultsBtn').addEventListener('click', async () => {
      if (!selectedTournamentData || tournamentResults.length === 0) {
        showError('Veuillez s√©lectionner un tournoi');
        return;
      }

      const isTestMode = document.getElementById('testModeCheck').checked;
      const testEmail = document.getElementById('testEmail').value.trim();

      if (isTestMode) {
        if (!testEmail || !testEmail.includes('@')) {
          showError('Veuillez entrer une adresse email valide pour le test.');
          return;
        }
        if (!confirm(`Envoyer un email de test √† ${testEmail} ?`)) {
          return;
        }
      } else {
        const emailCount = tournamentResults.filter(r => r.email).length;
        if (!confirm(`Envoyer les r√©sultats √† ${emailCount} participant(s) ?`)) {
          return;
        }
      }

      showProgress(isTestMode ? 'Envoi du test...' : 'Envoi des r√©sultats en cours...');

      try {
        const response = await fetch(`${API_URL}/emailing/send-results`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tournamentId: selectedTournamentData.id,
            introText: document.getElementById('resultsIntroText').value,
            outroText: document.getElementById('resultsOutroText').value,
            imageUrl: document.getElementById('resultsImageUrl').value || null,
            testMode: isTestMode,
            testEmail: isTestMode ? testEmail : null,
            ccEmail: document.getElementById('ccCheck').checked ? document.getElementById('ccEmail').value.trim() : null
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);
        } else {
          showError(result.error || 'Erreur lors de l\'envoi');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== FINALE CONVOCATIONS ====================

    let selectedFinaleData = null;
    let finalistsList = [];

    async function loadFinales() {
      try {
        const response = await fetch(`${API_URL}/emailing/finales`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load finales');

        const finales = await response.json();
        const select = document.getElementById('finaleSelect');
        select.innerHTML = '<option value="">-- Finales saison en cours --</option>';

        if (finales.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Aucune finale trouv√©e pour cette saison';
          option.disabled = true;
          select.appendChild(option);
          return;
        }

        // Group by mode
        const byMode = {};
        finales.forEach(f => {
          if (!byMode[f.mode]) byMode[f.mode] = [];
          byMode[f.mode].push(f);
        });

        Object.keys(byMode).sort().forEach(mode => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = mode;
          byMode[mode].forEach(f => {
            const option = document.createElement('option');
            option.value = f.tournoi_id;
            const date = f.debut ? new Date(f.debut).toLocaleDateString('fr-FR') : '';
            option.textContent = `${f.mode} - ${f.categorie} - ${date}`;
            option.dataset.finale = JSON.stringify(f);
            optgroup.appendChild(option);
          });
          select.appendChild(optgroup);
        });

      } catch (error) {
        console.error('Error loading finales:', error);
        showError('Erreur lors du chargement des finales');
      }
    }

    document.getElementById('finaleSelect').addEventListener('change', async (e) => {
      const finaleId = e.target.value;
      const infoDiv = document.getElementById('finaleInfo');
      const previewDiv = document.getElementById('finalistsPreview');
      const sendBtn = document.getElementById('sendFinaleConvocationBtn');

      if (!finaleId) {
        infoDiv.style.display = 'none';
        previewDiv.style.display = 'none';
        sendBtn.disabled = true;
        selectedFinaleData = null;
        finalistsList = [];
        return;
      }

      try {
        const response = await fetch(`${API_URL}/emailing/finalists/${finaleId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to load finalists');
        }

        const data = await response.json();
        selectedFinaleData = data;
        finalistsList = data.finalists || [];

        // Update info section
        document.getElementById('finaleInfoTitle').textContent = data.finale.nom || '-';
        document.getElementById('finaleInfoDate').textContent = data.finale.date ? new Date(data.finale.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '-';
        document.getElementById('finaleInfoLieu').textContent = data.finale.lieu || '√Ä confirmer';
        document.getElementById('finaleInfoMode').textContent = data.finale.mode || '-';
        document.getElementById('finaleInfoCategory').textContent = data.category.display_name || '-';
        document.getElementById('finaleInfoQualified').textContent = `${data.qualifiedCount} / ${data.totalPlayers} joueurs`;
        document.getElementById('finaleInfoEmails').textContent = data.emailCount || 0;

        infoDiv.style.display = 'block';

        // Update finalists preview
        const tbody = document.getElementById('finalistsPreviewBody');
        tbody.innerHTML = '';

        finalistsList.forEach(f => {
          const row = document.createElement('tr');
          row.style.background = f.rank_position % 2 === 0 ? '#f8f9fa' : 'white';
          row.innerHTML = `
            <td style="padding: 10px; text-align: center; font-weight: bold; color: #28a745;">${f.rank_position}</td>
            <td style="padding: 10px; text-align: left;">${f.player_name}</td>
            <td style="padding: 10px; text-align: center;">${f.total_match_points || '-'}</td>
            <td style="padding: 10px; text-align: center;">${f.avg_moyenne ? f.avg_moyenne.toFixed(3) : '-'}</td>
            <td style="padding: 10px; text-align: center;">${f.email ? '‚úÖ' : '‚ùå'}</td>
          `;
          tbody.appendChild(row);
        });

        previewDiv.style.display = 'block';
        sendBtn.disabled = data.emailCount === 0;

      } catch (error) {
        console.error('Error loading finalists:', error);
        showError('Erreur: ' + error.message);
        infoDiv.style.display = 'none';
        previewDiv.style.display = 'none';
        sendBtn.disabled = true;
      }
    });

    // CC checkbox toggle for finale
    document.getElementById('finaleCcCheck').addEventListener('change', (e) => {
      document.getElementById('finaleCcEmailInput').style.opacity = e.target.checked ? '1' : '0.5';
      document.getElementById('finaleCcEmail').disabled = !e.target.checked;
    });

    // Test mode toggle for finale
    document.getElementById('finaleTestModeCheck').addEventListener('change', (e) => {
      const testEmailInput = document.getElementById('finaleTestEmailInput');
      const sendBtn = document.getElementById('sendFinaleConvocationBtn');

      if (e.target.checked) {
        testEmailInput.style.display = 'block';
        sendBtn.textContent = 'üß™ Envoyer le Test';
        sendBtn.style.background = '#FF9800';
      } else {
        testEmailInput.style.display = 'none';
        sendBtn.textContent = 'üèÜ Envoyer les Convocations Finale';
        sendBtn.style.background = '#28a745';
      }
    });

    // Send finale convocations
    document.getElementById('sendFinaleConvocationBtn').addEventListener('click', async () => {
      if (!selectedFinaleData || finalistsList.length === 0) {
        showError('Veuillez s√©lectionner une finale');
        return;
      }

      const isTestMode = document.getElementById('finaleTestModeCheck').checked;
      const testEmail = document.getElementById('finaleTestEmail').value.trim();

      if (isTestMode) {
        if (!testEmail || !testEmail.includes('@')) {
          showError('Veuillez entrer une adresse email valide pour le test.');
          return;
        }
        if (!confirm(`Envoyer un email de test √† ${testEmail} ?`)) {
          return;
        }
      } else {
        const emailCount = finalistsList.filter(f => f.email).length;
        if (!confirm(`Envoyer les convocations finale √† ${emailCount} finaliste(s) ?`)) {
          return;
        }
      }

      showProgress(isTestMode ? 'Envoi du test...' : 'Envoi des convocations en cours...');

      try {
        const response = await fetch(`${API_URL}/emailing/send-finale-convocation`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            finaleId: selectedFinaleData.finale.tournoi_id,
            introText: document.getElementById('finaleIntroText').value,
            outroText: document.getElementById('finaleOutroText').value,
            imageUrl: document.getElementById('finaleImageUrl').value || null,
            testMode: isTestMode,
            testEmail: isTestMode ? testEmail : null,
            ccEmail: document.getElementById('finaleCcCheck').checked ? document.getElementById('finaleCcEmail').value.trim() : null
          })
        });

        const result = await response.json();
        hideProgress();

        if (response.ok) {
          showSuccess(result.message);
        } else {
          showError(result.error || 'Erreur lors de l\'envoi');
        }

      } catch (error) {
        hideProgress();
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== SUMMARY EMAIL SETTING ====================

    async function loadSummaryEmailSetting() {
      try {
        const response = await fetch(`${API_URL}/settings/app/summary_email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          const email = data.value || 'cdbhs92@gmail.com';
          document.getElementById('summaryEmailSetting').value = email;
          // Also update the default values in the CC fields
          document.getElementById('ccEmail').value = email;
          document.getElementById('finaleCcEmail').value = email;
        }
      } catch (error) {
        console.error('Error loading summary email setting:', error);
      }
    }

    document.getElementById('saveSummaryEmailBtn').addEventListener('click', async () => {
      const email = document.getElementById('summaryEmailSetting').value.trim();
      if (!email || !email.includes('@')) {
        showError('Veuillez entrer une adresse email valide');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/app/summary_email`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: email })
        });

        if (response.ok) {
          showSuccess('Email r√©capitulatif sauvegard√©');
          // Update the CC fields with the new value
          document.getElementById('ccEmail').value = email;
          document.getElementById('finaleCcEmail').value = email;
        } else {
          const data = await response.json();
          showError(data.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        showError('Erreur: ' + error.message);
      }
    });

    // ==================== INIT ====================

    async function initialize() {
      await loadClubs();
      await loadTournois();
      await loadContacts();
      await loadTemplates();
      await loadImportedTournaments();
      await loadCcEmail();
      await loadResultsTemplate();
      await loadSummaryEmailSetting();
    }

    initialize();
  </script>
</body>
</html>
