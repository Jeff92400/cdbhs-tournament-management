<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuration des imports - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .import-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    .import-tab {
      padding: 10px 20px;
      border: none;
      background: #f8f9fa;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    .import-tab:hover {
      background: #e9ecef;
    }
    .import-tab.active {
      background: var(--color-primary, #1F4788);
      color: white;
    }
    .upload-zone {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.2s;
      margin-bottom: 20px;
    }
    .upload-zone:hover {
      border-color: var(--color-primary, #1F4788);
      background: #e3f2fd;
    }
    .upload-zone.dragover {
      border-color: #28a745;
      background: #d4edda;
    }
    .upload-input {
      display: none;
    }
    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .mapping-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
    }
    .mapping-item.required {
      border-left: 4px solid #dc3545;
    }
    .mapping-item.mapped {
      border-left: 4px solid #28a745;
    }
    .mapping-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    .mapping-item .description {
      font-size: 12px;
      color: #666;
      margin-bottom: 10px;
    }
    .mapping-item select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .mapping-item .sample-data {
      font-size: 11px;
      color: #888;
      margin-top: 8px;
      background: #f8f9fa;
      padding: 5px 8px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 20px;
    }
    .preview-table th {
      background: var(--color-primary, #1F4788);
      color: white;
      padding: 10px;
      text-align: left;
      position: sticky;
      top: 0;
    }
    .preview-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
    }
    .preview-table tr:hover td {
      background: #f8f9fa;
    }
    .preview-scroll {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .config-section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .config-section h4 {
      margin: 0 0 15px 0;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .delimiter-options {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .delimiter-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.configured {
      background: #d4edda;
      color: #155724;
    }
    .status-badge.default {
      background: #fff3cd;
      color: #856404;
    }
    .status-badge.not-configured {
      background: #f8d7da;
      color: #721c24;
    }
    .action-bar {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin-bottom: 20px;
    }
    .info-box h5 {
      margin: 0 0 8px 0;
      color: #1565c0;
    }
    .info-box p {
      margin: 0;
      font-size: 13px;
      color: #1565c0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/FrenchBillard-Icon-small.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;">Configuration des imports</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="settings.html">Parametres</a>
        <a href="#" id="logoutBtn" class="nav-logout">Deconnexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="info-box">
      <h5>Configuration des imports CSV</h5>
      <p>Configurez comment les colonnes de vos fichiers CSV correspondent aux champs de la base de donnees. Cela permet d'importer des fichiers avec differents formats sans modifier le code.</p>
    </div>

    <!-- Import Type Tabs -->
    <div class="import-tabs">
      <button class="import-tab active" data-type="players">Joueurs</button>
      <button class="import-tab" data-type="tournaments">Competitions</button>
      <button class="import-tab" data-type="inscriptions">Inscriptions</button>
    </div>

    <!-- Current Configuration Status -->
    <div class="config-section" id="statusSection">
      <h4>
        <span id="currentTypeIcon">&#128100;</span>
        <span id="currentTypeLabel">Joueurs</span>
        <span class="status-badge" id="configStatus">Chargement...</span>
      </h4>
      <p id="statusDescription" style="color: #666; margin: 0;"></p>
    </div>

    <!-- Upload Sample File -->
    <div class="config-section">
      <h4>&#128194; Charger un fichier exemple</h4>
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" class="upload-input" accept=".csv">
        <div style="font-size: 48px; margin-bottom: 15px;">&#128462;</div>
        <p style="margin: 0; font-size: 16px; color: #666;">
          Glissez-deposez un fichier CSV ici<br>
          <span style="font-size: 13px;">ou cliquez pour selectionner</span>
        </p>
      </div>
    </div>

    <!-- File Preview (hidden until file loaded) -->
    <div class="config-section" id="previewSection" style="display: none;">
      <h4>&#128218; Apercu du fichier</h4>
      <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
        <div>
          <strong>Delimiteur detecte:</strong>
          <span id="detectedDelimiter">;</span>
        </div>
        <div>
          <strong>Lignes:</strong>
          <span id="totalRows">0</span>
        </div>
        <div>
          <strong>Colonnes:</strong>
          <span id="totalColumns">0</span>
        </div>
      </div>
      <div class="preview-scroll">
        <table class="preview-table">
          <thead id="previewHeader"></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Column Mapping -->
    <div class="config-section" id="mappingSection" style="display: none;">
      <h4>&#128279; Correspondance des colonnes</h4>
      <p style="color: #666; margin: 0 0 15px 0;">
        Pour chaque champ cible, selectionnez la colonne CSV correspondante. Les champs obligatoires sont marques en rouge.
      </p>
      <div class="mapping-grid" id="mappingGrid"></div>
    </div>

    <!-- Options -->
    <div class="config-section" id="optionsSection" style="display: none;">
      <h4>&#9881; Options</h4>
      <div style="display: flex; gap: 30px; flex-wrap: wrap;">
        <div>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="hasHeader" checked style="width: 18px; height: 18px;">
            <span>Le fichier a une ligne d'en-tete</span>
          </label>
        </div>
        <div>
          <label style="font-weight: 500;">Delimiteur:</label>
          <div class="delimiter-options" style="margin-top: 8px;">
            <label class="delimiter-option">
              <input type="radio" name="delimiter" value=";" checked> Point-virgule (;)
            </label>
            <label class="delimiter-option">
              <input type="radio" name="delimiter" value=","> Virgule (,)
            </label>
            <label class="delimiter-option">
              <input type="radio" name="delimiter" value="\t"> Tabulation
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="action-bar" id="actionBar" style="display: none;">
      <button class="btn" style="background: #6c757d;" onclick="resetMapping()">Reinitialiser</button>
      <button class="btn btn-primary" onclick="saveMapping()">Enregistrer la configuration</button>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';

    if (!requireAuth()) {
      throw new Error('Not authenticated');
    }
    const token = localStorage.getItem('token');

    let currentType = 'players';
    let fieldDefinitions = {};
    let currentProfile = null;
    let previewData = null;

    // Type icons
    const typeIcons = {
      players: '&#128100;',
      tournaments: '&#127942;',
      inscriptions: '&#128221;'
    };

    const typeLabels = {
      players: 'Joueurs',
      tournaments: 'CompÃ©titions',
      inscriptions: 'Inscriptions'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadFieldDefinitions();
      loadCurrentProfile();
      setupTabHandlers();
      setupFileUpload();
    });

    // Tab handlers
    function setupTabHandlers() {
      document.querySelectorAll('.import-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentType = tab.dataset.type;
          document.getElementById('currentTypeIcon').innerHTML = typeIcons[currentType];
          document.getElementById('currentTypeLabel').textContent = typeLabels[currentType];

          // Reset UI
          document.getElementById('previewSection').style.display = 'none';
          document.getElementById('mappingSection').style.display = 'none';
          document.getElementById('optionsSection').style.display = 'none';
          document.getElementById('actionBar').style.display = 'none';
          previewData = null;

          loadFieldDefinitions();
          loadCurrentProfile();
        });
      });
    }

    // File upload handlers
    function setupFileUpload() {
      const zone = document.getElementById('uploadZone');
      const input = document.getElementById('fileInput');

      zone.addEventListener('click', () => input.click());

      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });

      zone.addEventListener('dragleave', () => {
        zone.classList.remove('dragover');
      });

      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
          uploadFile(e.dataTransfer.files[0]);
        }
      });

      input.addEventListener('change', () => {
        if (input.files.length) {
          uploadFile(input.files[0]);
        }
      });
    }

    // Load field definitions for current type
    async function loadFieldDefinitions() {
      try {
        const response = await fetch(`${API_URL}/import-config/${currentType}/fields`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          fieldDefinitions[currentType] = await response.json();
        }
      } catch (error) {
        console.error('Error loading field definitions:', error);
      }
    }

    // Load current profile
    async function loadCurrentProfile() {
      const statusBadge = document.getElementById('configStatus');
      const description = document.getElementById('statusDescription');

      try {
        const response = await fetch(`${API_URL}/import-config/${currentType}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          currentProfile = await response.json();

          if (currentProfile.column_mappings && Object.keys(currentProfile.column_mappings).length > 0) {
            statusBadge.textContent = 'Configure';
            statusBadge.className = 'status-badge configured';
            description.textContent = `Delimiteur: ${currentProfile.delimiter || ';'}, En-tete: ${currentProfile.has_header !== false ? 'Oui' : 'Non'}`;
          } else {
            statusBadge.textContent = 'Configuration par defaut';
            statusBadge.className = 'status-badge default';
            description.textContent = 'Utilise la configuration par defaut. Chargez un fichier exemple pour personnaliser.';
          }
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        statusBadge.textContent = 'Erreur';
        statusBadge.className = 'status-badge not-configured';
      }
    }

    // Upload and preview file
    async function uploadFile(file) {
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showError('Seuls les fichiers CSV sont acceptes');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch(`${API_URL}/import-config/${currentType}/preview`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de l\'analyse');
        }

        previewData = await response.json();
        showPreview(previewData);
        showMappingUI(previewData);

      } catch (error) {
        showError(error.message);
      }
    }

    // Show file preview
    function showPreview(data) {
      document.getElementById('previewSection').style.display = 'block';
      document.getElementById('detectedDelimiter').textContent = data.detected_delimiter === ';' ? 'Point-virgule (;)' : data.detected_delimiter === ',' ? 'Virgule (,)' : 'Tabulation';
      document.getElementById('totalRows').textContent = data.total_rows;
      document.getElementById('totalColumns').textContent = data.headers.length;

      // Set delimiter option
      document.querySelector(`input[name="delimiter"][value="${data.detected_delimiter}"]`).checked = true;

      // Build preview table
      const thead = document.getElementById('previewHeader');
      const tbody = document.getElementById('previewBody');

      thead.innerHTML = `<tr>${data.headers.map((h, i) => `<th title="Colonne ${i}">${h.value}</th>`).join('')}</tr>`;

      tbody.innerHTML = data.sample_rows.map(row =>
        `<tr>${row.map(cell => `<td>${cell || '<em style="color: #999;">vide</em>'}</td>`).join('')}</tr>`
      ).join('');
    }

    // Show mapping UI
    function showMappingUI(data) {
      document.getElementById('mappingSection').style.display = 'block';
      document.getElementById('optionsSection').style.display = 'block';
      document.getElementById('actionBar').style.display = 'flex';

      const grid = document.getElementById('mappingGrid');
      const fields = fieldDefinitions[currentType] || [];
      const suggested = data.suggested_mappings || {};
      const existing = data.existing_profile?.column_mappings || {};

      grid.innerHTML = fields.map(field => {
        const currentMapping = existing[field.field] || suggested[field.field] || {};
        const currentCol = currentMapping.column;
        const isMapped = currentCol !== undefined;
        const isRequired = field.required;

        // Build options
        let options = '<option value="">-- Non mappe --</option>';
        data.headers.forEach((h, i) => {
          const selected = currentCol === i ? 'selected' : '';
          const samplePreview = h.sample.slice(0, 2).filter(s => s).join(', ');
          options += `<option value="${i}" ${selected}>${h.value} (${samplePreview || 'vide'})</option>`;
        });

        // Sample data display
        let sampleDisplay = '';
        if (isMapped && data.headers[currentCol]) {
          const samples = data.headers[currentCol].sample.filter(s => s).slice(0, 3);
          if (samples.length) {
            sampleDisplay = `<div class="sample-data">Ex: ${samples.join(', ')}</div>`;
          }
        }

        return `
          <div class="mapping-item ${isRequired ? 'required' : ''} ${isMapped ? 'mapped' : ''}" data-field="${field.field}">
            <label>${field.label} ${isRequired ? '<span style="color: #dc3545;">*</span>' : ''}</label>
            <div class="description">${field.description}</div>
            <select onchange="updateMappingPreview(this, '${field.field}')">
              ${options}
            </select>
            ${sampleDisplay}
          </div>
        `;
      }).join('');
    }

    // Update preview when mapping changes
    function updateMappingPreview(select, fieldName) {
      const item = select.closest('.mapping-item');
      const colIndex = select.value ? parseInt(select.value) : null;

      if (colIndex !== null && previewData?.headers[colIndex]) {
        const samples = previewData.headers[colIndex].sample.filter(s => s).slice(0, 3);
        let sampleDiv = item.querySelector('.sample-data');
        if (!sampleDiv) {
          sampleDiv = document.createElement('div');
          sampleDiv.className = 'sample-data';
          item.appendChild(sampleDiv);
        }
        sampleDiv.textContent = samples.length ? `Ex: ${samples.join(', ')}` : '';
        item.classList.add('mapped');
      } else {
        const sampleDiv = item.querySelector('.sample-data');
        if (sampleDiv) sampleDiv.remove();
        item.classList.remove('mapped');
      }
    }

    // Save mapping
    async function saveMapping() {
      const mappings = {};
      document.querySelectorAll('.mapping-item').forEach(item => {
        const field = item.dataset.field;
        const select = item.querySelector('select');
        if (select.value !== '') {
          mappings[field] = {
            column: parseInt(select.value),
            type: 'string' // Default type
          };
        }
      });

      const delimiter = document.querySelector('input[name="delimiter"]:checked').value;
      const hasHeader = document.getElementById('hasHeader').checked;

      try {
        const response = await fetch(`${API_URL}/import-config/${currentType}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            delimiter,
            has_header: hasHeader,
            column_mappings: mappings
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la sauvegarde');
        }

        showSuccess('Configuration enregistree avec succes');
        loadCurrentProfile();

      } catch (error) {
        showError(error.message);
      }
    }

    // Reset mapping
    function resetMapping() {
      if (confirm('Reinitialiser la configuration aux valeurs par defaut ?')) {
        // Reset selects
        document.querySelectorAll('.mapping-item select').forEach(select => {
          select.value = '';
          updateMappingPreview(select, select.closest('.mapping-item').dataset.field);
        });
      }
    }

    // Show messages
    function showError(message) {
      const el = document.getElementById('errorMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function showSuccess(message) {
      const el = document.getElementById('successMessage');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });
  </script>
</body>
</html>
