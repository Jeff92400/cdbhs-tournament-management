<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Tournois - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar select, .filter-bar input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .filter-bar select {
      min-width: 150px;
    }
    .filter-bar input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-libre { background: #e3f2fd; color: #1565c0; }
    .badge-cadre { background: #fff3e0; color: #e65100; }
    .badge-bande { background: #f3e5f5; color: #7b1fa2; }
    .badge-3bandes { background: #e8f5e9; color: #2e7d32; }
    .date-past { color: #999; }
    .date-future { color: #4CAF50; font-weight: bold; }
    .date-today { color: #ff9800; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="emailing.html" class="admin-only">Emailing</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <!-- Total stats (all time) - smaller -->
    <div class="stats-grid" style="margin-bottom: 10px;">
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Total Tournois (toutes saisons)</h4>
        <div class="stat-value" id="totalCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">A venir (toutes saisons)</h4>
        <div class="stat-value" id="upcomingCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Pass√©s (toutes saisons)</h4>
        <div class="stat-value" id="pastCount" style="font-size: 28px;">-</div>
      </div>
    </div>

    <!-- Current season stats - green theme -->
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonTotalLabel">Total Saison en cours</h4>
        <div class="stat-value" id="seasonTotalCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonUpcomingLabel">A venir Saison en cours</h4>
        <div class="stat-value" id="seasonUpcomingCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonPastLabel">Pass√©s Saison en cours</h4>
        <div class="stat-value" id="seasonPastCount">-</div>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Tournois CDBHS</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn admin-only" onclick="openCreateModal()" style="background: #007bff;">
            + Cr√©er un tournoi
          </button>
          <button class="btn btn-success admin-only" onclick="window.location.href='import-tournois.html'" style="background: #28a745;">
            üì§ Importer depuis IONOS
          </button>
        </div>
      </div>

      <div class="filter-bar">
        <select id="seasonFilter">
          <option value="">Toutes les saisons</option>
        </select>
        <select id="modeFilter">
          <option value="">Tous les modes</option>
          <option value="LIBRE">Libre</option>
          <option value="CADRE">Cadre</option>
          <option value="BANDE">Bande</option>
          <option value="3 BANDES">3 Bandes</option>
        </select>
        <select id="categorieFilter">
          <option value="">Toutes categories</option>
        </select>
        <input type="text" id="searchInput" placeholder="Rechercher par nom ou lieu...">
      </div>
      <div class="filter-bar" style="margin-top: -10px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label style="font-size: 13px; color: #666;">Du:</label>
          <input type="date" id="dateFromFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label style="font-size: 13px; color: #666;">Au:</label>
          <input type="date" id="dateToFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button class="btn" onclick="clearDateFilters()" style="background: #6c757d; padding: 8px 12px; font-size: 13px;">Effacer dates</button>
      </div>

      <div id="loadingTournois" class="loading">
        <div class="spinner"></div>
        Chargement des tournois...
      </div>

      <div id="tournoisTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Mode</th>
                <th>Categorie</th>
                <th>Date debut</th>
                <th>Date fin</th>
                <th>Lieu</th>
                <th>Taille</th>
                <th class="admin-only">Actions</th>
              </tr>
            </thead>
            <tbody id="tournoisBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Tournoi Modal -->
    <div id="editTournoiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">Modifier le tournoi</h3>
        <form id="editTournoiForm">
          <input type="hidden" id="edit_tournoi_id">

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom</label>
              <input type="text" id="edit_nom" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mode</label>
              <select id="edit_mode" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="LIBRE">LIBRE</option>
                <option value="CADRE">CADRE</option>
                <option value="BANDE">BANDE</option>
                <option value="3 BANDES">3 BANDES</option>
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Categorie</label>
              <input type="text" id="edit_categorie" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date debut</label>
              <input type="date" id="edit_debut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date fin</label>
              <input type="date" id="edit_fin" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lieu</label>
              <input type="text" id="edit_lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille</label>
              <input type="number" id="edit_taille" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille cadre</label>
              <input type="text" id="edit_taille_cadre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
            <button type="button" id="cancelEditBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Tournoi Modal -->
    <div id="createTournoiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">Cr√©er un nouveau tournoi</h3>
        <form id="createTournoiForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom *</label>
              <input type="text" id="create_nom" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: Tournoi 1, Finale D√©partementale...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mode *</label>
              <select id="create_mode" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- S√©lectionner --</option>
                <option value="LIBRE">LIBRE</option>
                <option value="CADRE">CADRE</option>
                <option value="BANDE">BANDE</option>
                <option value="3 BANDES">3 BANDES</option>
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Categorie *</label>
              <input type="text" id="create_categorie" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: R1, R2, R3, N3...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date debut</label>
              <input type="date" id="create_debut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date fin</label>
              <input type="date" id="create_fin" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lieu</label>
              <input type="text" id="create_lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: Courbevoie, Antony...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille (distance)</label>
              <input type="number" id="create_taille" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: 280, 300...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille cadre</label>
              <input type="text" id="create_taille_cadre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: 47/2, 71/2...">
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #007bff;">Cr√©er le tournoi</button>
            <button type="button" id="cancelCreateBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Get user role from JWT token
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Hide admin-only elements for non-admin users
    if (!isAdmin) {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    let allTournois = [];

    // Load tournois
    async function loadTournois() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load tournois');
        }

        allTournois = await response.json();

        // Populate season filter
        populateSeasonFilter();
        populateCategorieFilter();

        // Calculate stats
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const upcomingTournois = allTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut >= today;
        });

        const pastTournois = allTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut < today;
        });

        document.getElementById('totalCount').textContent = allTournois.length;
        document.getElementById('upcomingCount').textContent = upcomingTournois.length;
        document.getElementById('pastCount').textContent = pastTournois.length;

        // Update season stats (async - fetches from tournaments table)
        await updateSeasonStats();

        displayTournois(allTournois);

        document.getElementById('loadingTournois').style.display = 'none';
        document.getElementById('tournoisTable').style.display = 'block';

      } catch (error) {
        console.error('Error loading tournois:', error);
        document.getElementById('loadingTournois').style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des tournois';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Get season for a given date (Sept-June: season starts Sept, ends June)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Populate season filter based on tournament dates
    function populateSeasonFilter() {
      const seasons = new Set();

      allTournois.forEach(t => {
        if (t.debut) {
          const date = new Date(t.debut);
          seasons.add(getSeasonForDate(date));
        }
      });

      const select = document.getElementById('seasonFilter');
      const sortedSeasons = Array.from(seasons).sort().reverse();

      sortedSeasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = `Saison ${season}`;
        select.appendChild(option);
      });

      // Select current season by default
      const currentSeason = getSeasonForDate(new Date());

      if (sortedSeasons.includes(currentSeason)) {
        select.value = currentSeason;
        applyFilters();
      }
    }

    // Populate categorie filter
    function populateCategorieFilter() {
      const categories = new Set();
      allTournois.forEach(t => {
        if (t.categorie) categories.add(t.categorie);
      });

      const select = document.getElementById('categorieFilter');
      Array.from(categories).sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Get mode badge class
    function getModeBadgeClass(mode) {
      const modeUpper = (mode || '').toUpperCase();
      if (modeUpper.includes('LIBRE')) return 'badge-libre';
      if (modeUpper.includes('CADRE')) return 'badge-cadre';
      if (modeUpper.includes('3') || modeUpper.includes('TROIS')) return 'badge-3bandes';
      if (modeUpper.includes('BANDE')) return 'badge-bande';
      return '';
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR');
    }

    // Get date class (past, today, future)
    function getDateClass(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      date.setHours(0, 0, 0, 0);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (date.getTime() === today.getTime()) return 'date-today';
      if (date < today) return 'date-past';
      return 'date-future';
    }

    // Display tournois in table
    function displayTournois(tournois) {
      const tbody = document.getElementById('tournoisBody');
      tbody.innerHTML = '';

      if (tournois.length === 0) {
        const colspan = isAdmin ? 9 : 8;
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px;">Aucun tournoi trouve</td></tr>`;
        return;
      }

      // Sort by date (most recent first for past, nearest first for future)
      tournois.sort((a, b) => {
        const dateA = a.debut ? new Date(a.debut) : new Date(0);
        const dateB = b.debut ? new Date(b.debut) : new Date(0);
        return dateB - dateA;
      });

      tournois.forEach(tournoi => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${tournoi.tournoi_id}</td>
          <td><strong>${tournoi.nom || '-'}</strong></td>
          <td><span class="badge ${getModeBadgeClass(tournoi.mode)}">${tournoi.mode || '-'}</span></td>
          <td>${tournoi.categorie || '-'}</td>
          <td class="${getDateClass(tournoi.debut)}">${formatDate(tournoi.debut)}</td>
          <td class="${getDateClass(tournoi.fin)}">${formatDate(tournoi.fin)}</td>
          <td>${tournoi.lieu || '-'}</td>
          <td style="text-align: center;">${tournoi.taille || '-'}</td>
          ${isAdmin ? `
          <td style="text-align: center;">
            <button class="btn btn-small edit-tournoi-btn" style="background: #4CAF50; padding: 5px 10px; font-size: 12px;">Modifier</button>
          </td>
          ` : ''}
        `;

        tbody.appendChild(row);

        // Add click event to edit button (only for admin)
        if (isAdmin) {
          const editBtn = row.querySelector('.edit-tournoi-btn');
          if (editBtn) {
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openEditModal(tournoi);
            };
          }
        }
      });
    }

    // Apply filters
    function applyFilters() {
      const seasonFilter = document.getElementById('seasonFilter').value;
      const modeFilter = document.getElementById('modeFilter').value;
      const categorieFilter = document.getElementById('categorieFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateTo = document.getElementById('dateToFilter').value;

      let filtered = allTournois;

      // Season filter (only apply if no date filters are set)
      if (seasonFilter && !dateFrom && !dateTo) {
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const date = new Date(t.debut);
          return getSeasonForDate(date) === seasonFilter;
        });
      }

      // Date from filter
      if (dateFrom) {
        const fromDate = new Date(dateFrom);
        fromDate.setHours(0, 0, 0, 0);
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const tournoiDate = new Date(t.debut);
          return tournoiDate >= fromDate;
        });
      }

      // Date to filter
      if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const tournoiDate = new Date(t.debut);
          return tournoiDate <= toDate;
        });
      }

      // Mode filter
      if (modeFilter) {
        filtered = filtered.filter(t =>
          (t.mode || '').toUpperCase().includes(modeFilter.toUpperCase())
        );
      }

      // Categorie filter
      if (categorieFilter) {
        filtered = filtered.filter(t => t.categorie === categorieFilter);
      }

      // Search filter
      if (searchTerm) {
        filtered = filtered.filter(t =>
          (t.nom || '').toLowerCase().includes(searchTerm) ||
          (t.lieu || '').toLowerCase().includes(searchTerm)
        );
      }

      displayTournois(filtered);
    }

    // Clear date filters
    function clearDateFilters() {
      document.getElementById('dateFromFilter').value = '';
      document.getElementById('dateToFilter').value = '';
      applyFilters();
    }

    // Open edit modal
    function openEditModal(tournoi) {
      document.getElementById('edit_tournoi_id').value = tournoi.tournoi_id;
      document.getElementById('edit_nom').value = tournoi.nom || '';
      document.getElementById('edit_mode').value = tournoi.mode || 'LIBRE';
      document.getElementById('edit_categorie').value = tournoi.categorie || '';
      document.getElementById('edit_debut').value = tournoi.debut ? tournoi.debut.split('T')[0] : '';
      document.getElementById('edit_fin').value = tournoi.fin ? tournoi.fin.split('T')[0] : '';
      document.getElementById('edit_lieu').value = tournoi.lieu || '';
      document.getElementById('edit_taille').value = tournoi.taille || '';
      document.getElementById('edit_taille_cadre').value = tournoi.taille_cadre || '';

      document.getElementById('editTournoiModal').style.display = 'flex';
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editTournoiModal').style.display = 'none';
    }

    // Update tournoi
    async function updateTournoi(data) {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi/${data.tournoi_id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update tournoi');
        }

        return true;
      } catch (error) {
        console.error('Error updating tournoi:', error);
        alert('Erreur lors de la mise a jour: ' + error.message);
        return false;
      }
    }

    // Edit form submission
    document.getElementById('editTournoiForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        tournoi_id: parseInt(document.getElementById('edit_tournoi_id').value),
        nom: document.getElementById('edit_nom').value,
        mode: document.getElementById('edit_mode').value,
        categorie: document.getElementById('edit_categorie').value,
        debut: document.getElementById('edit_debut').value || null,
        fin: document.getElementById('edit_fin').value || null,
        lieu: document.getElementById('edit_lieu').value || null,
        taille: parseInt(document.getElementById('edit_taille').value) || null,
        taille_cadre: document.getElementById('edit_taille_cadre').value || null
      };

      const success = await updateTournoi(data);
      if (success) {
        closeEditModal();
        await loadTournois();
        alert('Tournoi mis a jour avec succes!');
      }
    });

    // Cancel button
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

    // ==================== CREATE TOURNAMENT ====================

    // Open create modal
    function openCreateModal() {
      // Reset form
      document.getElementById('createTournoiForm').reset();
      document.getElementById('createTournoiModal').style.display = 'flex';
    }

    // Close create modal
    function closeCreateModal() {
      document.getElementById('createTournoiModal').style.display = 'none';
    }

    // Create tournoi
    async function createTournoi(data) {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create tournoi');
        }

        return await response.json();
      } catch (error) {
        console.error('Error creating tournoi:', error);
        alert('Erreur lors de la cr√©ation: ' + error.message);
        return null;
      }
    }

    // Create form submission
    document.getElementById('createTournoiForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        nom: document.getElementById('create_nom').value,
        mode: document.getElementById('create_mode').value,
        categorie: document.getElementById('create_categorie').value,
        debut: document.getElementById('create_debut').value || null,
        fin: document.getElementById('create_fin').value || null,
        lieu: document.getElementById('create_lieu').value || null,
        taille: parseInt(document.getElementById('create_taille').value) || null,
        taille_cadre: document.getElementById('create_taille_cadre').value || null
      };

      const result = await createTournoi(data);
      if (result && result.success) {
        closeCreateModal();
        await loadTournois();
        alert('Tournoi cr√©√© avec succ√®s! (ID: ' + result.tournoi_id + ')');
      }
    });

    // Cancel create button
    document.getElementById('cancelCreateBtn').addEventListener('click', closeCreateModal);

    // Filter event listeners
    document.getElementById('seasonFilter').addEventListener('change', applyFilters);
    document.getElementById('modeFilter').addEventListener('change', applyFilters);
    document.getElementById('categorieFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
    document.getElementById('dateToFilter').addEventListener('change', applyFilters);

    // Update season-specific stats (consistent with dashboard)
    async function updateSeasonStats() {
      const currentSeason = getSeasonForDate(new Date());
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      try {
        // Get played competitions from tournaments table (same as dashboard)
        const tournamentsResponse = await fetch(`${API_URL}/tournaments?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        let pastSeason = 0;
        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          pastSeason = tournaments.length;
        }

        // Get upcoming from IONOS tournois (future dates in current season)
        const seasonTournois = allTournois.filter(t => {
          if (!t.debut) return false;
          const date = new Date(t.debut);
          return getSeasonForDate(date) === currentSeason;
        });

        const upcomingSeason = seasonTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut >= today;
        }).length;

        // Total = Pass√©s + A venir (ensures consistency with dashboard)
        const totalSeason = pastSeason + upcomingSeason;

        // Update labels with current season
        document.getElementById('seasonTotalLabel').textContent = `Total Saison ${currentSeason}`;
        document.getElementById('seasonUpcomingLabel').textContent = `A venir Saison ${currentSeason}`;
        document.getElementById('seasonPastLabel').textContent = `Pass√©s Saison ${currentSeason}`;

        // Update values
        document.getElementById('seasonTotalCount').textContent = totalSeason;
        document.getElementById('seasonUpcomingCount').textContent = upcomingSeason;
        document.getElementById('seasonPastCount').textContent = pastSeason;
      } catch (error) {
        console.error('Error updating season stats:', error);
      }
    }

    // Initialize
    loadTournois();
  </script>
</body>
</html>
