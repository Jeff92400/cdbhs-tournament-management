<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Tournois - CDBHS</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar select, .filter-bar input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .filter-bar select {
      min-width: 150px;
    }
    .filter-bar input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-libre { background: #e3f2fd; color: #1565c0; }
    .badge-cadre { background: #fff3e0; color: #e65100; }
    .badge-bande { background: #f3e5f5; color: #7b1fa2; }
    .badge-3bandes { background: #e8f5e9; color: #2e7d32; }
    .date-past { color: #999; }
    .date-future { color: #4CAF50; font-weight: bold; }
    .date-today { color: #ff9800; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';"><span id="app-org-name">CDB Tournois</span></h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="settings.html" class="admin-only nav-tooltip" data-tooltip="R√©serv√© aux administrateurs">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <!-- Total stats (all time) - smaller -->
    <div class="stats-grid" style="margin-bottom: 10px;">
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Total Tournois (toutes saisons)</h4>
        <div class="stat-value" id="totalCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">A venir (toutes saisons)</h4>
        <div class="stat-value" id="upcomingCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Pass√©s (toutes saisons)</h4>
        <div class="stat-value" id="pastCount" style="font-size: 28px;">-</div>
      </div>
    </div>

    <!-- Current season stats - green theme -->
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonTotalLabel">Total Saison en cours</h4>
        <div class="stat-value" id="seasonTotalCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonUpcomingLabel">A venir Saison en cours</h4>
        <div class="stat-value" id="seasonUpcomingCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonPastLabel">Pass√©s Saison en cours</h4>
        <div class="stat-value" id="seasonPastCount">-</div>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Tournois CDBHS</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn" onclick="exportToExcel()" style="background: #17a2b8;">
            üì• Exporter Excel
          </button>
          <button class="btn admin-only" onclick="openCreateModal()" style="background: #007bff;">
            + Cr√©er un tournoi
          </button>
          <button class="btn btn-success admin-only" onclick="window.location.href='import-tournois.html'" style="background: #28a745;">
            üì§ Importer fichier CSV
          </button>
        </div>
      </div>

      <div class="filter-bar">
        <select id="seasonFilter">
          <option value="">Toutes les saisons</option>
        </select>
        <select id="modeFilter">
          <option value="">Mode de jeu : tous</option>
          <!-- Options loaded dynamically from API -->
        </select>
        <select id="categorieFilter">
          <option value="">Classement FFB : tous</option>
        </select>
        <input type="text" id="searchInput" placeholder="Rechercher par nom ou lieu...">
      </div>
      <div class="filter-bar" style="margin-top: -10px;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <label style="font-size: 13px; color: #666;">Du:</label>
          <input type="date" id="dateFromFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <label style="font-size: 13px; color: #666;">Au:</label>
          <input type="date" id="dateToFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <button class="btn" onclick="clearDateFilters()" style="background: #6c757d; padding: 8px 12px; font-size: 13px;">Effacer dates</button>
      </div>

      <div id="loadingTournois" class="loading">
        <div class="spinner"></div>
        Chargement des tournois...
      </div>

      <div id="tournoisTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Mode</th>
                <th>Categorie</th>
                <th>Date debut</th>
                <th>Date fin</th>
                <th>Lieu</th>
                <th>Taille</th>
                <th class="admin-only">Actions</th>
              </tr>
            </thead>
            <tbody id="tournoisBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit Tournoi Modal -->
    <div id="editTournoiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">Modifier le tournoi</h3>
        <form id="editTournoiForm">
          <input type="hidden" id="edit_tournoi_id">

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom</label>
              <input type="text" id="edit_nom" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mode de jeu</label>
              <select id="edit_mode" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <!-- Options loaded dynamically from API -->
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Classement FFB</label>
              <select id="edit_categorie" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- S√©lectionner --</option>
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date debut</label>
              <input type="date" id="edit_debut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date fin</label>
              <input type="date" id="edit_fin" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lieu</label>
              <input type="text" id="edit_lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille</label>
              <input type="number" id="edit_taille" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille cadre</label>
              <input type="text" id="edit_taille_cadre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="grid-column: 1 / -1; margin-top: 10px; padding-top: 15px; border-top: 1px solid #eee;">
              <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                <input type="checkbox" id="edit_notify_on_changes" checked style="width: 18px; height: 18px;">
                <span>Notifier les joueurs en cas de changement de date ou lieu</span>
              </label>
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Statut</label>
              <select id="edit_status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="active">Actif</option>
                <option value="cancelled">Annul√©</option>
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
            <button type="button" id="cancelEditBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Create Tournoi Modal -->
    <div id="createTournoiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">Cr√©er un nouveau tournoi</h3>
        <form id="createTournoiForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom *</label>
              <input type="text" id="create_nom" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: Tournoi 1, Finale D√©partementale...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mode de jeu *</label>
              <select id="create_mode" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- S√©lectionner --</option>
                <!-- Options loaded dynamically from API -->
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Classement FFB *</label>
              <select id="create_categorie" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">-- S√©lectionner --</option>
              </select>
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date debut</label>
              <input type="date" id="create_debut" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date fin</label>
              <input type="date" id="create_fin" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="grid-column: 1 / -1;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lieu</label>
              <input type="text" id="create_lieu" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: Courbevoie, Antony...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille (distance)</label>
              <input type="number" id="create_taille" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: 280, 300...">
            </div>

            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Taille cadre</label>
              <input type="text" id="create_taille_cadre" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ex: 47/2, 71/2...">
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #007bff;">Cr√©er le tournoi</button>
            <button type="button" id="cancelCreateBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Get user role from JWT token
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Hide admin-only elements for non-admin users
    if (!isAdmin) {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    let allTournois = [];
    let gameModesList = [];
    let categories = [];

    // Load game modes from reference data API
    async function loadGameModes() {
      try {
        const response = await fetch(`${API_URL}/reference-data/game-modes?active_only=true`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          gameModesList = await response.json();

          // Use display_name for values - filter uses exact match
          // Populate filter dropdown
          const filterSelect = document.getElementById('modeFilter');
          filterSelect.innerHTML = '<option value="">Mode de jeu : tous</option>' +
            gameModesList.map(gm => `<option value="${gm.display_name.toUpperCase()}">${gm.display_name}</option>`).join('');

          // Populate edit modal dropdown (use display_name for compatibility)
          const editSelect = document.getElementById('edit_mode');
          editSelect.innerHTML = gameModesList.map(gm => `<option value="${gm.display_name.toUpperCase()}">${gm.display_name.toUpperCase()}</option>`).join('');

          // Populate create modal dropdown
          const createSelect = document.getElementById('create_mode');
          createSelect.innerHTML = '<option value="">-- S√©lectionner --</option>' +
            gameModesList.map(gm => `<option value="${gm.display_name.toUpperCase()}">${gm.display_name.toUpperCase()}</option>`).join('');
        }
      } catch (error) {
        console.error('Error loading game modes:', error);
      }
    }

    // Load categories from API
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/tournaments/categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          categories = await response.json();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // Update category dropdown based on selected mode
    function updateCategorieDropdown(modeSelectId, categorieSelectId) {
      const selectedMode = document.getElementById(modeSelectId).value;
      const categorieSelect = document.getElementById(categorieSelectId);
      const currentValue = categorieSelect.value;

      categorieSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';

      if (selectedMode) {
        // Map mode display name to game_type in categories
        // Categories use game_type like "Carambole", "Pool", etc.
        // Modes in tournoi_ext are uppercase like "CARAMBOLE LIBRE", "CARAMBOLE 3 BANDES"
        const modeUpper = selectedMode.toUpperCase().replace(/ /g, '');

        // Find matching categories - exact match on game_type (normalized)
        const matchingLevels = categories
          .filter(c => modeUpper === c.game_type.toUpperCase().replace(/ /g, ''))
          .map(c => c.level)
          .filter((v, i, a) => a.indexOf(v) === i)
          .sort();

        matchingLevels.forEach(level => {
          const option = document.createElement('option');
          option.value = level;
          option.textContent = level;
          categorieSelect.appendChild(option);
        });

        // Try to restore previous value if it exists in the new options
        if (currentValue && matchingLevels.includes(currentValue)) {
          categorieSelect.value = currentValue;
        }
      }
    }

    // Load tournois
    async function loadTournois() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load tournois');
        }

        allTournois = await response.json();

        // Populate season filter
        populateSeasonFilter();
        populateCategorieFilter();

        // Calculate stats
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const upcomingTournois = allTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut >= today;
        });

        const pastTournois = allTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut < today;
        });

        document.getElementById('totalCount').textContent = allTournois.length;
        document.getElementById('upcomingCount').textContent = upcomingTournois.length;
        document.getElementById('pastCount').textContent = pastTournois.length;

        // Update season stats (async - fetches from tournaments table)
        await updateSeasonStats();

        displayTournois(allTournois);

        document.getElementById('loadingTournois').style.display = 'none';
        document.getElementById('tournoisTable').style.display = 'block';

      } catch (error) {
        console.error('Error loading tournois:', error);
        document.getElementById('loadingTournois').style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des tournois';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Get season for a given date (Sept-June: season starts Sept, ends June)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Populate season filter based on tournament dates
    function populateSeasonFilter() {
      const seasons = new Set();
      const currentSeason = getSeasonForDate(new Date());

      allTournois.forEach(t => {
        if (t.debut) {
          const date = new Date(t.debut);
          seasons.add(getSeasonForDate(date));
        }
      });

      const select = document.getElementById('seasonFilter');
      // Only show current season and future seasons (not past)
      const sortedSeasons = Array.from(seasons)
        .filter(season => season >= currentSeason)
        .sort().reverse();

      sortedSeasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = `Saison ${season}`;
        select.appendChild(option);
      });

      // Select current season by default

      if (sortedSeasons.includes(currentSeason)) {
        select.value = currentSeason;
        applyFilters();
      }
    }

    // Populate categorie filter
    function populateCategorieFilter() {
      const tournoiCategories = new Set();
      allTournois.forEach(t => {
        if (t.categorie) tournoiCategories.add(t.categorie);
      });

      const select = document.getElementById('categorieFilter');
      select.innerHTML = '<option value="">Classement FFB : tous</option>';
      Array.from(tournoiCategories).sort().forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Get mode badge class
    function getModeBadgeClass(mode) {
      const modeUpper = (mode || '').toUpperCase();
      if (modeUpper.includes('LIBRE')) return 'badge-libre';
      if (modeUpper.includes('CADRE')) return 'badge-cadre';
      if (modeUpper.includes('3') || modeUpper.includes('TROIS')) return 'badge-3bandes';
      if (modeUpper.includes('BANDE')) return 'badge-bande';
      return '';
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR');
    }

    // Get date class (past, today, future)
    function getDateClass(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      date.setHours(0, 0, 0, 0);
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (date.getTime() === today.getTime()) return 'date-today';
      if (date < today) return 'date-past';
      return 'date-future';
    }

    // Display tournois in table
    function displayTournois(tournois) {
      const tbody = document.getElementById('tournoisBody');
      tbody.innerHTML = '';

      if (tournois.length === 0) {
        const colspan = isAdmin ? 9 : 8;
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px;">Aucun tournoi trouve</td></tr>`;
        return;
      }

      // Sort by date (most recent first for past, nearest first for future)
      tournois.sort((a, b) => {
        const dateA = a.debut ? new Date(a.debut) : new Date(0);
        const dateB = b.debut ? new Date(b.debut) : new Date(0);
        return dateB - dateA;
      });

      tournois.forEach(tournoi => {
        const row = document.createElement('tr');
        // Check if simulation should be available (> 7 days away)
        const tournoiDate = new Date(tournoi.debut);
        const daysUntil = (tournoiDate - new Date()) / (1000 * 60 * 60 * 24);
        const showSimulation = daysUntil >= 7;
        const isCancelled = tournoi.status === 'cancelled';

        // Apply greyed-out style for cancelled tournaments
        if (isCancelled) {
          row.style.opacity = '0.6';
          row.style.backgroundColor = '#f5f5f5';
        }

        const cancelledBadge = isCancelled ? '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">ANNUL√â</span>' : '';

        row.innerHTML = `
          <td>${tournoi.tournoi_id}</td>
          <td><strong>${isCancelled ? '<s>' : ''}${tournoi.nom || '-'}${isCancelled ? '</s>' : ''}</strong>${cancelledBadge}</td>
          <td><span class="badge ${getModeBadgeClass(tournoi.mode)}">${tournoi.mode || '-'}</span></td>
          <td>${tournoi.categorie || '-'}</td>
          <td class="${getDateClass(tournoi.debut)}">${formatDate(tournoi.debut)}</td>
          <td class="${getDateClass(tournoi.fin)}">${formatDate(tournoi.fin)}</td>
          <td>${tournoi.lieu || '-'}</td>
          <td style="text-align: center;">${tournoi.taille || '-'}</td>
          ${isAdmin ? `
          <td style="text-align: center; white-space: nowrap;">
            ${showSimulation && !isCancelled ? `<button class="btn btn-small simulation-btn" data-tournoi-id="${tournoi.tournoi_id}" style="background: #17a2b8; padding: 5px 10px; font-size: 12px; margin-right: 5px;" title="Voir la simulation des poules">Simulation</button>` : ''}
            <button class="btn btn-small edit-tournoi-btn" style="background: #4CAF50; padding: 5px 10px; font-size: 12px;">Modifier</button>
          </td>
          ` : ''}
        `;

        tbody.appendChild(row);

        // Add click event to edit button (only for admin)
        if (isAdmin) {
          const editBtn = row.querySelector('.edit-tournoi-btn');
          if (editBtn) {
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openEditModal(tournoi);
            };
          }
          // Add click event to simulation button
          const simBtn = row.querySelector('.simulation-btn');
          if (simBtn) {
            simBtn.onclick = (e) => {
              e.stopPropagation();
              openSimulationModal(tournoi.tournoi_id);
            };
          }
        }
      });
    }

    // Apply filters
    function applyFilters() {
      const seasonFilter = document.getElementById('seasonFilter').value;
      const modeFilter = document.getElementById('modeFilter').value;
      const categorieFilter = document.getElementById('categorieFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const dateFrom = document.getElementById('dateFromFilter').value;
      const dateTo = document.getElementById('dateToFilter').value;

      let filtered = allTournois;

      // Season filter (only apply if no date filters are set)
      if (seasonFilter && !dateFrom && !dateTo) {
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const date = new Date(t.debut);
          return getSeasonForDate(date) === seasonFilter;
        });
      }

      // Date from filter
      if (dateFrom) {
        const fromDate = new Date(dateFrom);
        fromDate.setHours(0, 0, 0, 0);
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const tournoiDate = new Date(t.debut);
          return tournoiDate >= fromDate;
        });
      }

      // Date to filter
      if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setHours(23, 59, 59, 999);
        filtered = filtered.filter(t => {
          if (!t.debut) return false;
          const tournoiDate = new Date(t.debut);
          return tournoiDate <= toDate;
        });
      }

      // Mode filter (exact match)
      if (modeFilter) {
        filtered = filtered.filter(t =>
          (t.mode || '').toUpperCase() === modeFilter.toUpperCase()
        );
      }

      // Categorie filter
      if (categorieFilter) {
        filtered = filtered.filter(t => t.categorie === categorieFilter);
      }

      // Search filter
      if (searchTerm) {
        filtered = filtered.filter(t =>
          (t.nom || '').toLowerCase().includes(searchTerm) ||
          (t.lieu || '').toLowerCase().includes(searchTerm)
        );
      }

      displayTournois(filtered);
    }

    // Clear date filters
    function clearDateFilters() {
      document.getElementById('dateFromFilter').value = '';
      document.getElementById('dateToFilter').value = '';
      applyFilters();
    }

    // Export to Excel (CSV)
    function exportToExcel() {
      // Get currently filtered tournois from the displayed table
      const rows = document.querySelectorAll('#tournoisBody tr');
      if (rows.length === 0) {
        alert('Aucun tournoi √† exporter');
        return;
      }

      // CSV headers
      const headers = ['ID', 'Nom', 'Mode', 'Categorie', 'Date debut', 'Date fin', 'Lieu', 'Taille'];

      // Build CSV content
      let csvContent = headers.join(';') + '\n';

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 8) {
          const rowData = [
            cells[0].textContent.trim(), // ID
            cells[1].textContent.trim(), // Nom
            cells[2].textContent.trim(), // Mode
            cells[3].textContent.trim(), // Categorie
            cells[4].textContent.trim(), // Date debut
            cells[5].textContent.trim(), // Date fin
            cells[6].textContent.trim(), // Lieu
            cells[7].textContent.trim()  // Taille
          ];
          csvContent += rowData.join(';') + '\n';
        }
      });

      // Create and download file
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `tournois_export_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Open edit modal
    function openEditModal(tournoi) {
      document.getElementById('edit_tournoi_id').value = tournoi.tournoi_id;
      document.getElementById('edit_nom').value = tournoi.nom || '';
      document.getElementById('edit_mode').value = tournoi.mode || 'LIBRE';

      // Update category dropdown based on selected mode
      updateCategorieDropdown('edit_mode', 'edit_categorie');
      document.getElementById('edit_categorie').value = tournoi.categorie || '';

      document.getElementById('edit_debut').value = tournoi.debut ? tournoi.debut.split('T')[0] : '';
      document.getElementById('edit_fin').value = tournoi.fin ? tournoi.fin.split('T')[0] : '';
      document.getElementById('edit_lieu').value = tournoi.lieu || '';
      document.getElementById('edit_taille').value = tournoi.taille || '';
      document.getElementById('edit_taille_cadre').value = tournoi.taille_cadre || '';

      // New fields for notification toggle and status
      document.getElementById('edit_notify_on_changes').checked = tournoi.notify_on_changes !== false;
      document.getElementById('edit_status').value = tournoi.status || 'active';

      document.getElementById('editTournoiModal').style.display = 'flex';
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editTournoiModal').style.display = 'none';
    }

    // Update tournoi
    async function updateTournoi(data) {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi/${data.tournoi_id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update tournoi');
        }

        return true;
      } catch (error) {
        console.error('Error updating tournoi:', error);
        alert('Erreur lors de la mise a jour: ' + error.message);
        return false;
      }
    }

    // Edit form submission
    document.getElementById('editTournoiForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const newStatus = document.getElementById('edit_status').value;
      const currentTournoi = allTournois.find(t => t.tournoi_id === parseInt(document.getElementById('edit_tournoi_id').value));
      const statusChangedToCancelled = newStatus === 'cancelled' && currentTournoi?.status !== 'cancelled';

      // Confirm if cancelling tournament
      if (statusChangedToCancelled) {
        if (!confirm('Voulez-vous vraiment annuler ce tournoi ?\n\nLes joueurs inscrits ne seront PAS notifi√©s automatiquement.')) {
          return;
        }
      }

      const data = {
        tournoi_id: parseInt(document.getElementById('edit_tournoi_id').value),
        nom: document.getElementById('edit_nom').value,
        mode: document.getElementById('edit_mode').value,
        categorie: document.getElementById('edit_categorie').value,
        debut: document.getElementById('edit_debut').value || null,
        fin: document.getElementById('edit_fin').value || null,
        lieu: document.getElementById('edit_lieu').value || null,
        taille: parseInt(document.getElementById('edit_taille').value) || null,
        taille_cadre: document.getElementById('edit_taille_cadre').value || null,
        notify_on_changes: document.getElementById('edit_notify_on_changes').checked,
        status: newStatus
      };

      const success = await updateTournoi(data);
      if (success) {
        closeEditModal();
        await loadTournois();
        alert('Tournoi mis √† jour avec succ√®s!');
      }
    });

    // Cancel button
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

    // ==================== CREATE TOURNAMENT ====================

    // Open create modal
    function openCreateModal() {
      // Reset form
      document.getElementById('createTournoiForm').reset();
      document.getElementById('createTournoiModal').style.display = 'flex';
    }

    // Close create modal
    function closeCreateModal() {
      document.getElementById('createTournoiModal').style.display = 'none';
    }

    // Create tournoi
    async function createTournoi(data) {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create tournoi');
        }

        return await response.json();
      } catch (error) {
        console.error('Error creating tournoi:', error);
        alert('Erreur lors de la cr√©ation: ' + error.message);
        return null;
      }
    }

    // Create form submission
    document.getElementById('createTournoiForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        nom: document.getElementById('create_nom').value,
        mode: document.getElementById('create_mode').value,
        categorie: document.getElementById('create_categorie').value,
        debut: document.getElementById('create_debut').value || null,
        fin: document.getElementById('create_fin').value || null,
        lieu: document.getElementById('create_lieu').value || null,
        taille: parseInt(document.getElementById('create_taille').value) || null,
        taille_cadre: document.getElementById('create_taille_cadre').value || null
      };

      const result = await createTournoi(data);
      if (result && result.success) {
        closeCreateModal();
        await loadTournois();
        alert('Tournoi cr√©√© avec succ√®s! (ID: ' + result.tournoi_id + ')');
      }
    });

    // Cancel create button
    document.getElementById('cancelCreateBtn').addEventListener('click', closeCreateModal);

    // Filter event listeners
    document.getElementById('seasonFilter').addEventListener('change', applyFilters);
    document.getElementById('modeFilter').addEventListener('change', applyFilters);
    document.getElementById('categorieFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
    document.getElementById('dateToFilter').addEventListener('change', applyFilters);

    // Modal mode change listeners - update category dropdown
    document.getElementById('edit_mode').addEventListener('change', () => {
      updateCategorieDropdown('edit_mode', 'edit_categorie');
    });
    document.getElementById('create_mode').addEventListener('change', () => {
      updateCategorieDropdown('create_mode', 'create_categorie');
    });

    // Update season-specific stats (consistent with dashboard)
    async function updateSeasonStats() {
      const currentSeason = getSeasonForDate(new Date());
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      try {
        // Get played competitions from tournaments table (same as dashboard)
        const tournamentsResponse = await fetch(`${API_URL}/tournaments?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        let pastSeason = 0;
        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          pastSeason = tournaments.length;
        }

        // Get upcoming from IONOS tournois (future dates in current season)
        const seasonTournois = allTournois.filter(t => {
          if (!t.debut) return false;
          const date = new Date(t.debut);
          return getSeasonForDate(date) === currentSeason;
        });

        const upcomingSeason = seasonTournois.filter(t => {
          const debut = t.debut ? new Date(t.debut) : null;
          return debut && debut >= today;
        }).length;

        // Total = Pass√©s + A venir (ensures consistency with dashboard)
        const totalSeason = pastSeason + upcomingSeason;

        // Update labels with current season
        document.getElementById('seasonTotalLabel').textContent = `Total Saison ${currentSeason}`;
        document.getElementById('seasonUpcomingLabel').textContent = `A venir Saison ${currentSeason}`;
        document.getElementById('seasonPastLabel').textContent = `Pass√©s Saison ${currentSeason}`;

        // Update values
        document.getElementById('seasonTotalCount').textContent = totalSeason;
        document.getElementById('seasonUpcomingCount').textContent = upcomingSeason;
        document.getElementById('seasonPastCount').textContent = pastSeason;
      } catch (error) {
        console.error('Error updating season stats:', error);
      }
    }

    // ==================== SIMULATION ====================

    // Open simulation modal
    async function openSimulationModal(tournoiId) {
      const modal = document.getElementById('simulationModal');
      const content = document.getElementById('simulationContent');
      const title = document.getElementById('simulationTitle');

      modal.style.display = 'flex';
      content.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';
      title.textContent = 'Chargement...';

      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi/${tournoiId}/simulation`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (!data.available) {
          content.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <div style="font-size: 3rem; margin-bottom: 16px;">${data.reason === 'simulation_disabled' ? 'üîí' : 'üë•'}</div>
              <p style="color: #666;">${data.message}</p>
            </div>
          `;
          title.textContent = 'Simulation non disponible';
          return;
        }

        // Update title
        title.textContent = `${data.tournament.nom} - ${data.tournament.mode} ${data.tournament.categorie}`;

        // Build poules display
        let html = `
          <div style="text-align: center; margin-bottom: 20px;">
            <span style="background: #e3f2fd; color: #1565c0; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600;">
              ${data.simulation.player_count} joueurs ‚Ä¢ ${data.simulation.config_description}
            </span>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
        `;

        data.simulation.poules.forEach(poule => {
          html += `
            <div style="background: #f8f9fa; border-radius: 8px; overflow: hidden; border: 1px solid #e9ecef;">
              <div style="background: #1F4788; color: white; padding: 10px 16px; font-weight: 600;">
                Poule ${poule.number}
              </div>
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #e9ecef;">
                    <th style="padding: 8px; text-align: center; width: 40px;">#</th>
                    <th style="padding: 8px; text-align: left;">Joueur</th>
                    <th style="padding: 8px; text-align: center;">Class.</th>
                  </tr>
                </thead>
                <tbody>
                  ${poule.players.map((player, idx) => `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                      <td style="padding: 8px; text-align: center;">
                        <span style="display: inline-block; width: 24px; height: 24px; background: ${idx === 0 ? '#ffc107' : '#e9ecef'}; color: ${idx === 0 ? '#000' : '#666'}; border-radius: 50%; line-height: 24px; font-size: 12px; font-weight: 600;">
                          ${player.seed}
                        </span>
                      </td>
                      <td style="padding: 8px;">
                        <div style="font-weight: 500;">${player.first_name} ${player.last_name}</div>
                        <div style="font-size: 11px; color: #666;">${player.club || '-'}</div>
                      </td>
                      <td style="padding: 8px; text-align: center;">
                        <span style="background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                          ${player.rank_display}
                        </span>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        });

        html += `</div>
          <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee;">
            <p style="font-size: 12px; color: #666;">
              Simulation g√©n√©r√©e le ${new Date(data.simulation.generated_at).toLocaleString('fr-FR')}
            </p>
          </div>
        `;

        content.innerHTML = html;

      } catch (error) {
        console.error('Simulation error:', error);
        content.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
            <p style="color: #dc3545;">Erreur lors du chargement de la simulation</p>
          </div>
        `;
      }
    }

    function closeSimulationModal() {
      document.getElementById('simulationModal').style.display = 'none';
    }

    // Initialize
    loadGameModes(); // Load game modes for dropdowns
    loadCategories(); // Load categories for modal dropdowns
    loadTournois();
  </script>

  <!-- Simulation Modal -->
  <div id="simulationModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header" style="background: linear-gradient(135deg, #1F4788 0%, #163560 100%); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
        <h3 id="simulationTitle" style="margin: 0; font-size: 18px;">Simulation des poules</h3>
        <span class="close-modal" onclick="closeSimulationModal()">&times;</span>
      </div>
      <div style="background: #fff3cd; padding: 12px 20px; border-bottom: 1px solid #ffc107;">
        <p style="margin: 0; font-size: 13px; color: #856404;">
          ‚ö†Ô∏è <strong>SIMULATION</strong> - Cette r√©partition est indicative et peut diff√©rer de la convocation officielle.
        </p>
      </div>
      <div id="simulationContent" style="padding: 20px;">
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
</body>
</html>
