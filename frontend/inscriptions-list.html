<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Liste des Inscriptions - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar select, .filter-bar input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .filter-bar select {
      min-width: 150px;
    }
    .filter-bar input[type="text"] {
      flex: 1;
      min-width: 200px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-convoque { background: #e8f5e9; color: #2e7d32; }
    .badge-non-convoque { background: #fff3e0; color: #e65100; }
    .badge-forfait { background: #ffebee; color: #c62828; }
    .badge-libre { background: #e3f2fd; color: #1565c0; }
    .badge-cadre { background: #fff3e0; color: #e65100; }
    .badge-bande { background: #f3e5f5; color: #7b1fa2; }
    .badge-3bandes { background: #e8f5e9; color: #2e7d32; }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="emailing.html" class="admin-only">Emailing</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <!-- Total stats (all time) - smaller -->
    <div class="stats-grid" style="margin-bottom: 10px;">
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Total Inscriptions (toutes saisons)</h4>
        <div class="stat-value" id="totalCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Convoqu√©s (toutes saisons)</h4>
        <div class="stat-value" id="convoqueCount" style="font-size: 28px;">-</div>
      </div>
      <div class="stat-card" style="padding: 12px 15px;">
        <h4 style="font-size: 12px; margin-bottom: 5px;">Forfaits (toutes saisons)</h4>
        <div class="stat-value" id="forfaitCount" style="font-size: 28px;">-</div>
      </div>
    </div>

    <!-- Current season stats - green theme -->
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonTotalLabel">Inscriptions Saison en cours</h4>
        <div class="stat-value" id="seasonTotalCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonConvoqueLabel">Convoqu√©s Saison en cours</h4>
        <div class="stat-value" id="seasonConvoqueCount">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4 id="seasonForfaitLabel">Forfaits Saison en cours</h4>
        <div class="stat-value" id="seasonForfaitCount">-</div>
      </div>
    </div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Inscriptions CDBHS</h3>
        <div style="display: flex; gap: 10px;">
          <button class="btn admin-only" onclick="openCreateModal()" style="background: #1F4788;">
            ‚ûï Ajouter
          </button>
          <button class="btn btn-success admin-only" onclick="window.location.href='import-inscriptions.html'" style="background: #28a745;">
            üì§ Importer depuis IONOS
          </button>
        </div>
      </div>

      <div class="filter-bar">
        <select id="seasonFilter">
          <option value="">Toutes les saisons</option>
        </select>
        <select id="modeFilter">
          <option value="">Tous les modes</option>
        </select>
        <select id="categorieFilter">
          <option value="">Toutes les cat√©gories</option>
        </select>
        <select id="tournoiFilter">
          <option value="">Tous les tournois</option>
        </select>
        <select id="statusFilter">
          <option value="">Tous les statuts</option>
          <option value="convoque">Convoques</option>
          <option value="non-convoque">Non convoques</option>
          <option value="forfait">Forfaits</option>
        </select>
        <input type="text" id="searchInput" placeholder="Rechercher par licence ou email...">
      </div>

      <div id="loadingInscriptions" class="loading">
        <div class="spinner"></div>
        Chargement des inscriptions...
      </div>

      <div id="inscriptionsTable" style="display: none;">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Licence</th>
                <th>Tournoi</th>
                <th>Mode</th>
                <th>Categorie</th>
                <th>Email</th>
                <th>Telephone</th>
                <th>Statut</th>
                <th>Date inscription</th>
                <th class="admin-only">Actions</th>
              </tr>
            </thead>
            <tbody id="inscriptionsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Create Inscription Modal -->
    <div id="createInscriptionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; color: #1F4788;">‚ûï Nouvelle inscription</h3>
        <form id="createInscriptionForm">
          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Tournoi *</label>
            <select id="create_tournoi_id" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- S√©lectionner un tournoi --</option>
            </select>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Licence *</label>
            <input type="text" id="create_licence" required placeholder="Ex: 123456A" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <small style="color: #666;">Le joueur doit exister dans le fichier joueurs</small>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
            <input type="email" id="create_email" placeholder="email@exemple.com" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">T√©l√©phone</label>
            <input type="text" id="create_telephone" placeholder="06..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Convoqu√©</label>
              <select id="create_convoque" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0">Non</option>
                <option value="1">Oui</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Forfait</label>
              <select id="create_forfait" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0">Non</option>
                <option value="1">Oui</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Commentaire</label>
            <textarea id="create_commentaire" rows="2" placeholder="Optionnel" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #1F4788;">Cr√©er</button>
            <button type="button" onclick="closeCreateModal()" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Edit Inscription Modal -->
    <div id="editInscriptionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0;">Modifier l'inscription</h3>
        <form id="editInscriptionForm">
          <input type="hidden" id="edit_inscription_id">

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ID Inscription</label>
            <input type="text" id="edit_inscription_id_display" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Licence</label>
            <input type="text" id="edit_licence" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email</label>
            <input type="email" id="edit_email" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Telephone</label>
            <input type="text" id="edit_telephone" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Convoque</label>
              <select id="edit_convoque" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0">Non</option>
                <option value="1">Oui</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Forfait</label>
              <select id="edit_forfait" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="0">Non</option>
                <option value="1">Oui</option>
              </select>
            </div>
          </div>

          <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Commentaire</label>
            <textarea id="edit_commentaire" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button type="submit" class="btn" style="flex: 1; background: #4CAF50;">Enregistrer</button>
            <button type="button" id="cancelEditBtn" class="btn" style="flex: 1; background: #999;">Annuler</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteInscriptionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 450px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; color: #dc3545;">Confirmer la suppression</h3>
        <input type="hidden" id="delete_inscription_id">
        <p style="margin-bottom: 20px;">Etes-vous sur de vouloir supprimer cette inscription ?</p>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <p style="margin: 0 0 8px 0;"><strong>ID:</strong> <span id="delete_inscription_id_display"></span></p>
          <p style="margin: 0 0 8px 0;"><strong>Licence:</strong> <span id="delete_licence_display"></span></p>
          <p style="margin: 0 0 8px 0;"><strong>Tournoi:</strong> <span id="delete_tournoi_display"></span></p>
          <p style="margin: 0;"><strong>Email:</strong> <span id="delete_email_display"></span></p>
        </div>
        <p style="color: #dc3545; font-size: 13px; margin-bottom: 20px;">Cette action est irreversible.</p>
        <div style="display: flex; gap: 10px;">
          <button type="button" onclick="confirmDelete()" class="btn" style="flex: 1; background: #dc3545;">Supprimer</button>
          <button type="button" onclick="closeDeleteModal()" class="btn" style="flex: 1; background: #999;">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Get user role from JWT token
    let userRole = 'viewer';
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      userRole = payload.role || (payload.admin ? 'admin' : 'viewer');
    } catch (e) {
      console.error('Error decoding token:', e);
    }

    const isAdmin = userRole === 'admin';

    // Hide admin-only elements for non-admin users
    if (!isAdmin) {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    let allInscriptions = [];
    let allTournois = [];

    // Parse date that might be in various formats (ISO, DD/MM/YYYY, etc.)
    function parseDate(dateStr) {
      if (!dateStr) return null;
      // If it's already a Date object
      if (dateStr instanceof Date) return dateStr;
      // Try ISO format first (2026-01-03 or 2026-01-03T00:00:00)
      if (dateStr.includes('-')) {
        return new Date(dateStr);
      }
      // Try DD/MM/YYYY format
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // months are 0-indexed
          const year = parseInt(parts[2], 10);
          return new Date(year, month, day);
        }
      }
      // Fallback to default parsing
      return new Date(dateStr);
    }

    // Load tournois for filter and display
    async function loadTournois() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          allTournois = await response.json();
          // Populate all filter dropdowns (season filter will override on load)
          populateModeFilter();
          populateCategorieFilter();
          populateTournoiFilter();
        }
      } catch (error) {
        console.error('Error loading tournois:', error);
      }
    }

    // Populate mode filter
    function populateModeFilter() {
      const select = document.getElementById('modeFilter');
      const selectedSeason = document.getElementById('seasonFilter').value;

      // Clear and add default option
      select.innerHTML = '<option value="">Tous les modes</option>';

      // Filter tournaments by selected season
      let filteredTournois = allTournois;
      if (selectedSeason) {
        filteredTournois = allTournois.filter(t => {
          if (!t.debut) return false;
          const date = parseDate(t.debut);
          if (!date || isNaN(date.getTime())) return false;
          const season = getSeasonForDate(date);
          return season === selectedSeason;
        });
      }

      // Get unique modes
      const modes = [...new Set(filteredTournois.map(t => t.mode).filter(Boolean))].sort();

      modes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode;
        option.textContent = mode;
        select.appendChild(option);
      });
    }

    // Populate categorie filter (filtered by selected mode)
    function populateCategorieFilter() {
      const select = document.getElementById('categorieFilter');
      const selectedSeason = document.getElementById('seasonFilter').value;
      const selectedMode = document.getElementById('modeFilter').value;

      // Clear and add default option
      select.innerHTML = '<option value="">Toutes les cat√©gories</option>';

      // Filter tournaments by selected season and mode
      let filteredTournois = allTournois;
      if (selectedSeason) {
        filteredTournois = filteredTournois.filter(t => {
          if (!t.debut) return false;
          const date = parseDate(t.debut);
          if (!date || isNaN(date.getTime())) return false;
          const season = getSeasonForDate(date);
          return season === selectedSeason;
        });
      }
      if (selectedMode) {
        filteredTournois = filteredTournois.filter(t => t.mode === selectedMode);
      }

      // Get unique categories
      const categories = [...new Set(filteredTournois.map(t => t.categorie).filter(Boolean))].sort();

      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
      });
    }

    // Populate tournoi filter (filtered by selected season, mode, and categorie)
    function populateTournoiFilter() {
      const select = document.getElementById('tournoiFilter');
      const selectedSeason = document.getElementById('seasonFilter').value;
      const selectedMode = document.getElementById('modeFilter').value;
      const selectedCategorie = document.getElementById('categorieFilter').value;

      // Clear and add default option
      select.innerHTML = '<option value="">Tous les tournois</option>';

      // Filter tournaments by selected season, mode, and categorie
      let filteredTournois = allTournois;
      if (selectedSeason) {
        filteredTournois = filteredTournois.filter(t => {
          if (!t.debut) return false;
          const date = parseDate(t.debut);
          if (!date || isNaN(date.getTime())) return false;
          const season = getSeasonForDate(date);
          return season === selectedSeason;
        });
      }
      if (selectedMode) {
        filteredTournois = filteredTournois.filter(t => t.mode === selectedMode);
      }
      if (selectedCategorie) {
        filteredTournois = filteredTournois.filter(t => t.categorie === selectedCategorie);
      }

      // Sort by date (most recent first)
      filteredTournois.sort((a, b) => {
        const dateA = a.debut ? new Date(a.debut) : new Date(0);
        const dateB = b.debut ? new Date(b.debut) : new Date(0);
        return dateB - dateA;
      });

      // Add tournaments as options
      filteredTournois.forEach(t => {
        const option = document.createElement('option');
        option.value = t.tournoi_id;
        const date = t.debut ? new Date(t.debut).toLocaleDateString('fr-FR') : '';
        option.textContent = `${t.nom} ${date ? `(${date})` : ''}`;
        select.appendChild(option);
      });
    }

    // Get tournoi info by ID
    function getTournoiById(tournoiId) {
      return allTournois.find(t => t.tournoi_id === tournoiId) || {};
    }

    // Load inscriptions
    async function loadInscriptions() {
      try {
        const response = await fetch(`${API_URL}/inscriptions`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load inscriptions');
        }

        allInscriptions = await response.json();

        // Populate season filter
        populateSeasonFilter();

        // Calculate total stats (all time)
        const convoques = allInscriptions.filter(i => i.convoque === 1);
        const forfaits = allInscriptions.filter(i => i.forfait === 1);

        document.getElementById('totalCount').textContent = allInscriptions.length;
        document.getElementById('convoqueCount').textContent = convoques.length;
        document.getElementById('forfaitCount').textContent = forfaits.length;

        // Calculate current season stats
        updateSeasonStats();

        displayInscriptions(allInscriptions);

        document.getElementById('loadingInscriptions').style.display = 'none';
        document.getElementById('inscriptionsTable').style.display = 'block';

      } catch (error) {
        console.error('Error loading inscriptions:', error);
        document.getElementById('loadingInscriptions').style.display = 'none';
        document.getElementById('errorMessage').textContent = 'Erreur lors du chargement des inscriptions';
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Load inscriptions while preserving filter state
    async function loadInscriptionsKeepFilters(savedSeason, savedMode, savedCategorie, savedTournoi, savedStatus, savedSearch) {
      try {
        const response = await fetch(`${API_URL}/inscriptions`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load inscriptions');
        }

        allInscriptions = await response.json();

        // Update stats
        const convoques = allInscriptions.filter(i => i.convoque === 1);
        const forfaits = allInscriptions.filter(i => i.forfait === 1);
        document.getElementById('totalCount').textContent = allInscriptions.length;
        document.getElementById('convoqueCount').textContent = convoques.length;
        document.getElementById('forfaitCount').textContent = forfaits.length;
        updateSeasonStats();

        // Restore filter values
        document.getElementById('seasonFilter').value = savedSeason;
        document.getElementById('modeFilter').value = savedMode;
        document.getElementById('categorieFilter').value = savedCategorie;
        document.getElementById('tournoiFilter').value = savedTournoi;
        document.getElementById('statusFilter').value = savedStatus;
        document.getElementById('searchInput').value = savedSearch;

        // Re-populate all filters and restore selections
        populateModeFilter();
        document.getElementById('modeFilter').value = savedMode;
        populateCategorieFilter();
        document.getElementById('categorieFilter').value = savedCategorie;
        populateTournoiFilter();
        document.getElementById('tournoiFilter').value = savedTournoi;

        // Apply filters to show the same view
        applyFilters();

      } catch (error) {
        console.error('Error loading inscriptions:', error);
      }
    }

    // Get season for a given date (Sept-June: season starts Sept, ends June)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Update current season stats
    function updateSeasonStats() {
      const currentSeason = getSeasonForDate(new Date());

      // Filter inscriptions for current season
      const seasonInscriptions = allInscriptions.filter(i => {
        const tournoi = getTournoiById(i.tournoi_id);
        if (!tournoi.debut) return false;
        const date = parseDate(tournoi.debut);
        if (!date || isNaN(date.getTime())) return false;
        return getSeasonForDate(date) === currentSeason;
      });

      const seasonConvoques = seasonInscriptions.filter(i => i.convoque === 1);
      const seasonForfaits = seasonInscriptions.filter(i => i.forfait === 1);

      // Update labels with season
      document.getElementById('seasonTotalLabel').textContent = `Inscriptions Saison ${currentSeason}`;
      document.getElementById('seasonConvoqueLabel').textContent = `Convoqu√©s Saison ${currentSeason}`;
      document.getElementById('seasonForfaitLabel').textContent = `Forfaits Saison ${currentSeason}`;

      // Update values
      document.getElementById('seasonTotalCount').textContent = seasonInscriptions.length;
      document.getElementById('seasonConvoqueCount').textContent = seasonConvoques.length;
      document.getElementById('seasonForfaitCount').textContent = seasonForfaits.length;
    }

    // Populate season filter
    function populateSeasonFilter() {
      const seasons = new Set();

      allInscriptions.forEach(i => {
        const tournoi = getTournoiById(i.tournoi_id);
        if (tournoi.debut) {
          const date = parseDate(tournoi.debut);
          if (date && !isNaN(date.getTime())) {
            seasons.add(getSeasonForDate(date));
          }
        }
      });

      const select = document.getElementById('seasonFilter');
      const sortedSeasons = Array.from(seasons).sort().reverse();

      sortedSeasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = `Saison ${season}`;
        select.appendChild(option);
      });

      // Select current season by default
      const currentSeason = getSeasonForDate(new Date());

      if (sortedSeasons.includes(currentSeason)) {
        select.value = currentSeason;
        // Populate all cascading filters
        populateModeFilter();
        populateCategorieFilter();
        populateTournoiFilter();
        applyFilters();
      }
    }

    // Get mode badge class
    function getModeBadgeClass(mode) {
      const modeUpper = (mode || '').toUpperCase();
      if (modeUpper.includes('LIBRE')) return 'badge-libre';
      if (modeUpper.includes('CADRE')) return 'badge-cadre';
      if (modeUpper.includes('3') || modeUpper.includes('TROIS')) return 'badge-3bandes';
      if (modeUpper.includes('BANDE')) return 'badge-bande';
      return '';
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR');
    }

    // Format datetime
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    // Get status badge
    function getStatusBadge(inscription) {
      if (inscription.forfait === 1) {
        return '<span class="badge badge-forfait">Forfait</span>';
      }
      if (inscription.convoque === 1) {
        return '<span class="badge badge-convoque">Convoque</span>';
      }
      return '<span class="badge badge-non-convoque">Inscrit</span>';
    }

    // Display inscriptions in table
    function displayInscriptions(inscriptions) {
      const tbody = document.getElementById('inscriptionsBody');
      tbody.innerHTML = '';

      if (inscriptions.length === 0) {
        const colspan = isAdmin ? 10 : 9;
        tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px;">Aucune inscription trouvee</td></tr>`;
        return;
      }

      // Sort by timestamp (most recent first)
      inscriptions.sort((a, b) => {
        const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
        const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
        return dateB - dateA;
      });

      inscriptions.forEach(inscription => {
        const tournoi = getTournoiById(inscription.tournoi_id);
        const row = document.createElement('tr');

        if (inscription.forfait === 1) {
          row.style.opacity = '0.6';
          row.style.textDecoration = 'line-through';
        }

        row.innerHTML = `
          <td>${inscription.inscription_id}</td>
          <td><strong>${inscription.licence || '-'}</strong></td>
          <td>${inscription.tournoi_nom || tournoi.nom || `Tournoi #${inscription.tournoi_id}`}</td>
          <td><span class="badge ${getModeBadgeClass(inscription.mode || tournoi.mode)}">${inscription.mode || tournoi.mode || '-'}</span></td>
          <td>${inscription.categorie || tournoi.categorie || '-'}</td>
          <td>${inscription.email || '-'}</td>
          <td>${inscription.telephone || '-'}</td>
          <td>${getStatusBadge(inscription)}</td>
          <td>${formatDateTime(inscription.timestamp)}</td>
          ${isAdmin ? `
          <td style="text-align: center;">
            <button class="btn btn-small edit-inscription-btn" style="background: #4CAF50; padding: 5px 10px; font-size: 12px;">Modifier</button>
            <button class="btn btn-small delete-inscription-btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px; margin-left: 5px;">Supprimer</button>
          </td>
          ` : ''}
        `;

        tbody.appendChild(row);

        // Add click event to edit and delete buttons (only for admin)
        if (isAdmin) {
          const editBtn = row.querySelector('.edit-inscription-btn');
          if (editBtn) {
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openEditModal(inscription);
            };
          }
          const deleteBtn = row.querySelector('.delete-inscription-btn');
          if (deleteBtn) {
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              openDeleteModal(inscription);
            };
          }
        }
      });
    }

    // Apply filters
    function applyFilters() {
      const seasonFilter = document.getElementById('seasonFilter').value;
      const modeFilter = document.getElementById('modeFilter').value;
      const categorieFilter = document.getElementById('categorieFilter').value;
      const tournoiFilter = document.getElementById('tournoiFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      let filtered = allInscriptions;

      // Season filter
      if (seasonFilter) {
        filtered = filtered.filter(i => {
          const tournoi = getTournoiById(i.tournoi_id);
          if (!tournoi.debut) return false;
          const date = parseDate(tournoi.debut);
          if (!date || isNaN(date.getTime())) return false;
          return getSeasonForDate(date) === seasonFilter;
        });
      }

      // Mode filter
      if (modeFilter) {
        filtered = filtered.filter(i => {
          const tournoi = getTournoiById(i.tournoi_id);
          return tournoi.mode === modeFilter;
        });
      }

      // Categorie filter
      if (categorieFilter) {
        filtered = filtered.filter(i => {
          const tournoi = getTournoiById(i.tournoi_id);
          return tournoi.categorie === categorieFilter;
        });
      }

      // Tournoi filter
      if (tournoiFilter) {
        filtered = filtered.filter(i => i.tournoi_id === parseInt(tournoiFilter));
      }

      // Status filter
      if (statusFilter) {
        if (statusFilter === 'convoque') {
          filtered = filtered.filter(i => i.convoque === 1 && i.forfait !== 1);
        } else if (statusFilter === 'non-convoque') {
          filtered = filtered.filter(i => i.convoque !== 1 && i.forfait !== 1);
        } else if (statusFilter === 'forfait') {
          filtered = filtered.filter(i => i.forfait === 1);
        }
      }

      // Search filter
      if (searchTerm) {
        filtered = filtered.filter(i =>
          (i.licence || '').toLowerCase().includes(searchTerm) ||
          (i.email || '').toLowerCase().includes(searchTerm) ||
          (i.telephone || '').toLowerCase().includes(searchTerm)
        );
      }

      displayInscriptions(filtered);
    }

    // Open edit modal
    function openEditModal(inscription) {
      document.getElementById('edit_inscription_id').value = inscription.inscription_id;
      document.getElementById('edit_inscription_id_display').value = inscription.inscription_id;
      document.getElementById('edit_licence').value = inscription.licence || '';
      document.getElementById('edit_email').value = inscription.email || '';
      document.getElementById('edit_telephone').value = inscription.telephone || '';
      document.getElementById('edit_convoque').value = inscription.convoque || 0;
      document.getElementById('edit_forfait').value = inscription.forfait || 0;
      document.getElementById('edit_commentaire').value = inscription.commentaire || '';

      document.getElementById('editInscriptionModal').style.display = 'flex';
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editInscriptionModal').style.display = 'none';
    }

    // Open delete confirmation modal
    function openDeleteModal(inscription) {
      const tournoi = getTournoiById(inscription.tournoi_id);
      document.getElementById('delete_inscription_id').value = inscription.inscription_id;
      document.getElementById('delete_inscription_id_display').textContent = inscription.inscription_id;
      document.getElementById('delete_licence_display').textContent = inscription.licence || '-';
      document.getElementById('delete_tournoi_display').textContent = inscription.tournoi_nom || tournoi.nom || `Tournoi #${inscription.tournoi_id}`;
      document.getElementById('delete_email_display').textContent = inscription.email || '-';
      document.getElementById('deleteInscriptionModal').style.display = 'flex';
    }

    // Close delete modal
    function closeDeleteModal() {
      document.getElementById('deleteInscriptionModal').style.display = 'none';
    }

    // Confirm and execute deletion
    async function confirmDelete() {
      const inscriptionId = document.getElementById('delete_inscription_id').value;

      try {
        const response = await fetch(`${API_URL}/inscriptions/${inscriptionId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to delete inscription');
        }

        closeDeleteModal();

        // Preserve current filter values
        const savedSeason = document.getElementById('seasonFilter').value;
        const savedMode = document.getElementById('modeFilter').value;
        const savedCategorie = document.getElementById('categorieFilter').value;
        const savedTournoi = document.getElementById('tournoiFilter').value;
        const savedStatus = document.getElementById('statusFilter').value;
        const savedSearch = document.getElementById('searchInput').value;

        await loadInscriptionsKeepFilters(savedSeason, savedMode, savedCategorie, savedTournoi, savedStatus, savedSearch);
        alert('Inscription supprimee avec succes!');

      } catch (error) {
        console.error('Error deleting inscription:', error);
        alert('Erreur lors de la suppression: ' + error.message);
      }
    }

    // Update inscription
    async function updateInscription(data) {
      try {
        const response = await fetch(`${API_URL}/inscriptions/${data.inscription_id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to update inscription');
        }

        return true;
      } catch (error) {
        console.error('Error updating inscription:', error);
        alert('Erreur lors de la mise a jour: ' + error.message);
        return false;
      }
    }

    // Edit form submission
    document.getElementById('editInscriptionForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        inscription_id: parseInt(document.getElementById('edit_inscription_id').value),
        licence: document.getElementById('edit_licence').value || null,
        email: document.getElementById('edit_email').value || null,
        telephone: document.getElementById('edit_telephone').value || null,
        convoque: parseInt(document.getElementById('edit_convoque').value),
        forfait: parseInt(document.getElementById('edit_forfait').value),
        commentaire: document.getElementById('edit_commentaire').value || null
      };

      const success = await updateInscription(data);
      if (success) {
        closeEditModal();
        // Preserve current filter values
        const savedSeason = document.getElementById('seasonFilter').value;
        const savedMode = document.getElementById('modeFilter').value;
        const savedCategorie = document.getElementById('categorieFilter').value;
        const savedTournoi = document.getElementById('tournoiFilter').value;
        const savedStatus = document.getElementById('statusFilter').value;
        const savedSearch = document.getElementById('searchInput').value;

        await loadInscriptionsKeepFilters(savedSeason, savedMode, savedCategorie, savedTournoi, savedStatus, savedSearch);
        alert('Inscription mise a jour avec succes!');
      }
    });

    // Cancel button
    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

    // Filter event listeners
    document.getElementById('seasonFilter').addEventListener('change', () => {
      // Reset all cascading filters
      document.getElementById('modeFilter').value = '';
      document.getElementById('categorieFilter').value = '';
      document.getElementById('tournoiFilter').value = '';
      populateModeFilter();
      populateCategorieFilter();
      populateTournoiFilter();
      applyFilters();
    });
    document.getElementById('modeFilter').addEventListener('change', () => {
      // Reset downstream filters
      document.getElementById('categorieFilter').value = '';
      document.getElementById('tournoiFilter').value = '';
      populateCategorieFilter();
      populateTournoiFilter();
      applyFilters();
    });
    document.getElementById('categorieFilter').addEventListener('change', () => {
      // Reset tournament filter
      document.getElementById('tournoiFilter').value = '';
      populateTournoiFilter();
      applyFilters();
    });
    document.getElementById('tournoiFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);

    // ========== CREATE INSCRIPTION FUNCTIONS ==========

    // Open create modal
    function openCreateModal() {
      // Populate tournoi select with all tournaments
      const select = document.getElementById('create_tournoi_id');
      select.innerHTML = '<option value="">-- S√©lectionner un tournoi --</option>';

      // Group by mode/categorie and sort by date (most recent first)
      const sortedTournois = [...allTournois].sort((a, b) => {
        const dateA = a.debut ? new Date(a.debut) : new Date(0);
        const dateB = b.debut ? new Date(b.debut) : new Date(0);
        return dateB - dateA;
      });

      // Group by mode/categorie
      const grouped = {};
      sortedTournois.forEach(t => {
        const key = `${t.mode} - ${t.categorie}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });

      Object.keys(grouped).sort().forEach(key => {
        const optgroup = document.createElement('optgroup');
        optgroup.label = key;

        grouped[key].forEach(t => {
          const option = document.createElement('option');
          option.value = t.tournoi_id;
          const date = t.debut ? new Date(t.debut).toLocaleDateString('fr-FR') : '';
          option.textContent = `${t.nom} ${date ? `(${date})` : ''}`;
          optgroup.appendChild(option);
        });

        select.appendChild(optgroup);
      });

      // Clear form
      document.getElementById('create_licence').value = '';
      document.getElementById('create_email').value = '';
      document.getElementById('create_telephone').value = '';
      document.getElementById('create_convoque').value = '0';
      document.getElementById('create_forfait').value = '0';
      document.getElementById('create_commentaire').value = '';

      document.getElementById('createInscriptionModal').style.display = 'flex';
    }

    // Close create modal
    function closeCreateModal() {
      document.getElementById('createInscriptionModal').style.display = 'none';
    }

    // Create inscription form submit
    document.getElementById('createInscriptionForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        tournoi_id: parseInt(document.getElementById('create_tournoi_id').value),
        licence: document.getElementById('create_licence').value.trim(),
        email: document.getElementById('create_email').value.trim() || null,
        telephone: document.getElementById('create_telephone').value.trim() || null,
        convoque: parseInt(document.getElementById('create_convoque').value),
        forfait: parseInt(document.getElementById('create_forfait').value),
        commentaire: document.getElementById('create_commentaire').value.trim() || null
      };

      if (!data.tournoi_id || !data.licence) {
        alert('Veuillez s√©lectionner un tournoi et entrer une licence');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/inscriptions/create`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to create inscription');
        }

        closeCreateModal();
        await loadInscriptions();
        alert(`Inscription cr√©√©e avec succ√®s (ID: ${result.inscription_id})`);

      } catch (error) {
        console.error('Error creating inscription:', error);
        alert('Erreur lors de la cr√©ation: ' + error.message);
      }
    });

    // Initialize
    async function initialize() {
      await loadTournois();
      await loadInscriptions();
    }

    initialize();
  </script>
</body>
</html>
