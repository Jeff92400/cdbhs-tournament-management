<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Politique de Confidentialit√© - √âditeur</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .editor-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      min-height: 500px;
    }
    .editor-toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      flex-wrap: wrap;
    }
    .editor-toolbar button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .editor-toolbar button:hover {
      background: #e9ecef;
    }
    .editor-textarea {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      resize: none;
    }
    .editor-textarea:focus {
      outline: none;
      border-color: #1F4788;
      box-shadow: 0 0 0 3px rgba(31, 71, 136, 0.1);
    }
    .preview-container {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      overflow-y: auto;
    }
    .preview-container h1 { font-size: 24px; margin-top: 0; }
    .preview-container h2 { font-size: 20px; margin-top: 20px; }
    .preview-container h3 { font-size: 16px; margin-top: 15px; }
    .preview-container p { margin: 10px 0; }
    .preview-container ul, .preview-container ol { margin: 10px 0; padding-left: 25px; }
    .preview-container li { margin: 5px 0; }
    .tab-buttons {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 10px 20px;
      border: none;
      background: #e9ecef;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .tab-btn.active {
      background: #1F4788;
      color: white;
    }
    .char-count {
      text-align: right;
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 48px; width: 48px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';">Politique de Confidentialit√©</h2>
      <div class="nav-links">
        <a href="settings.html">‚Üê Retour aux param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <div>
          <h3 style="margin: 0;">√âditeur de la Politique de Confidentialit√©</h3>
          <p style="color: #666; margin: 5px 0 0 0;">Ce texte sera affich√© dans l'Espace Joueur lorsque les utilisateurs consultent la politique de confidentialit√©.</p>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <input type="file" id="wordFileInput" accept=".docx,.doc" style="display: none;" onchange="uploadWordFile(event)">
          <button onclick="document.getElementById('wordFileInput').click()" class="btn" style="background: #6c757d; padding: 10px 15px;">
            üì• Importer Word
          </button>
          <button onclick="downloadAsWord()" class="btn" style="background: #17a2b8; padding: 10px 15px;">
            üì§ Exporter Word
          </button>
          <button onclick="savePolicy()" class="btn" style="background: #28a745; padding: 10px 25px;">
            Enregistrer
          </button>
        </div>
      </div>

      <div class="tab-buttons">
        <button class="tab-btn active" onclick="showTab('editor')">√âditeur</button>
        <button class="tab-btn" onclick="showTab('preview')">Aper√ßu</button>
      </div>

      <div class="editor-container">
        <div id="editorTab" style="flex: 1; display: flex; flex-direction: column;">
          <div class="editor-toolbar">
            <button onclick="insertMarkdown('# ', '')" title="Titre 1">H1</button>
            <button onclick="insertMarkdown('## ', '')" title="Titre 2">H2</button>
            <button onclick="insertMarkdown('### ', '')" title="Titre 3">H3</button>
            <button onclick="insertMarkdown('**', '**')" title="Gras"><strong>B</strong></button>
            <button onclick="insertMarkdown('*', '*')" title="Italique"><em>I</em></button>
            <button onclick="insertMarkdown('\n- ', '')" title="Liste √† puces">‚Ä¢ Liste</button>
            <button onclick="insertMarkdown('\n1. ', '')" title="Liste num√©rot√©e">1. Liste</button>
            <button onclick="insertMarkdown('\n\n', '')" title="Nouveau paragraphe">¬∂</button>
          </div>
          <textarea id="policyContent" class="editor-textarea" placeholder="Entrez ici le texte de votre politique de confidentialit√©...

Vous pouvez utiliser le format Markdown :
# Titre principal
## Sous-titre
### Section

**Texte en gras**
*Texte en italique*

- Liste √† puces
- Autre √©l√©ment

1. Liste num√©rot√©e
2. Autre √©l√©ment"></textarea>
          <div class="char-count"><span id="charCount">0</span> caract√®res</div>
        </div>

        <div id="previewTab" class="preview-container" style="display: none;">
          <!-- Preview content will be rendered here -->
        </div>
      </div>

      <div id="policyMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Format Markdown support√© :</strong>
        <ul style="margin: 10px 0; padding-left: 20px; color: #666;">
          <li><code># Titre</code>, <code>## Sous-titre</code>, <code>### Section</code> pour les titres</li>
          <li><code>**gras**</code> et <code>*italique*</code> pour le formatage</li>
          <li><code>- √©l√©ment</code> pour les listes √† puces</li>
          <li><code>1. √©l√©ment</code> pour les listes num√©rot√©es</li>
          <li>Lignes vides pour s√©parer les paragraphes</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Mammoth.js for reading Word files (using jsdelivr which is CSP-allowed) -->
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated');
    }
    const token = localStorage.getItem('token');

    // Check user role - admin only
    function checkAdminRole() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') {
          alert('Acc√®s r√©serv√© aux administrateurs');
          window.location.href = 'settings.html';
        }
      } catch (e) {
        console.error('Error parsing token:', e);
        window.location.href = 'login.html';
      }
    }
    checkAdminRole();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('username');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Tab switching
    function showTab(tab) {
      const editorTab = document.getElementById('editorTab');
      const previewTab = document.getElementById('previewTab');
      const buttons = document.querySelectorAll('.tab-btn');

      buttons.forEach(btn => btn.classList.remove('active'));

      if (tab === 'editor') {
        editorTab.style.display = 'flex';
        previewTab.style.display = 'none';
        buttons[0].classList.add('active');
      } else {
        editorTab.style.display = 'none';
        previewTab.style.display = 'block';
        buttons[1].classList.add('active');
        renderPreview();
      }
    }

    // Simple Markdown to HTML converter
    function markdownToHtml(text) {
      if (!text) return '<p style="color: #999; font-style: italic;">Aucun contenu</p>';

      let html = text
        // Escape HTML
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        // Headers
        .replace(/^### (.*)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*)$/gm, '<h1>$1</h1>')
        // Bold and italic
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        // Lists
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/^(\d+)\. (.*)$/gm, '<li>$2</li>')
        // Paragraphs
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

      // Wrap in paragraph if not starting with header
      if (!html.startsWith('<h')) {
        html = '<p>' + html + '</p>';
      }

      // Fix list items
      html = html.replace(/(<li>.*<\/li>)/g, '<ul>$1</ul>');
      html = html.replace(/<\/ul><ul>/g, '');

      return html;
    }

    // Render preview
    function renderPreview() {
      const content = document.getElementById('policyContent').value;
      document.getElementById('previewTab').innerHTML = markdownToHtml(content);
    }

    // Insert markdown formatting
    function insertMarkdown(before, after) {
      const textarea = document.getElementById('policyContent');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const text = textarea.value;
      const selectedText = text.substring(start, end);

      textarea.value = text.substring(0, start) + before + selectedText + after + text.substring(end);
      textarea.focus();
      textarea.setSelectionRange(start + before.length, start + before.length + selectedText.length);
      updateCharCount();
    }

    // Update character count
    function updateCharCount() {
      const count = document.getElementById('policyContent').value.length;
      document.getElementById('charCount').textContent = count.toLocaleString('fr-FR');
    }

    document.getElementById('policyContent').addEventListener('input', updateCharCount);

    // Load policy
    async function loadPolicy() {
      try {
        const response = await fetch(`${API_URL}/settings/app/privacy_policy`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('policyContent').value = data.value;
            updateCharCount();
          }
        }
      } catch (error) {
        console.error('Error loading policy:', error);
      }
    }

    // Save policy
    async function savePolicy() {
      const content = document.getElementById('policyContent').value;
      const msgDiv = document.getElementById('policyMessage');

      try {
        const response = await fetch(`${API_URL}/settings/app/privacy_policy`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: content })
        });

        if (response.ok) {
          msgDiv.textContent = 'Politique de confidentialit√© enregistr√©e avec succ√®s !';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';

          document.getElementById('successMessage').textContent = 'Politique de confidentialit√© enregistr√©e';
          document.getElementById('successMessage').style.display = 'block';
          setTimeout(() => { document.getElementById('successMessage').style.display = 'none'; }, 3000);
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving policy:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';

        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
    }

    // Load on page load
    loadPolicy();

    // ============= WORD FILE IMPORT/EXPORT =============

    // Upload Word file
    async function uploadWordFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Show loading message
      const msgDiv = document.getElementById('policyMessage');
      msgDiv.textContent = '‚è≥ Importation du fichier Word en cours...';
      msgDiv.style.background = '#fff3cd';
      msgDiv.style.color = '#856404';
      msgDiv.style.display = 'block';

      try {
        const arrayBuffer = await file.arrayBuffer();

        // Use mammoth to extract text from Word file
        const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
        const text = result.value;

        if (text) {
          // Convert Word text to markdown-like format
          const formattedText = convertWordToMarkdown(text);
          document.getElementById('policyContent').value = formattedText;
          updateCharCount();

          msgDiv.textContent = `‚úÖ Fichier "${file.name}" import√© avec succ√®s !`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';

          // Show any warnings
          if (result.messages && result.messages.length > 0) {
            console.log('Import warnings:', result.messages);
          }
        } else {
          throw new Error('Le fichier semble vide ou ne peut pas √™tre lu');
        }
      } catch (error) {
        console.error('Error importing Word file:', error);
        msgDiv.textContent = `‚ùå Erreur: ${error.message}`;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      // Reset file input
      event.target.value = '';

      setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
    }

    // Convert Word text to basic markdown format
    function convertWordToMarkdown(text) {
      // Clean up the text
      let result = text
        // Normalize line endings
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        // Remove multiple blank lines
        .replace(/\n{3,}/g, '\n\n')
        // Trim each line
        .split('\n')
        .map(line => line.trim())
        .join('\n');

      // Try to detect and format headings (lines in ALL CAPS or followed by blank line)
      const lines = result.split('\n');
      const formattedLines = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const nextLine = lines[i + 1] || '';

        // Detect main title (first non-empty line, often in caps)
        if (i === 0 && line && line === line.toUpperCase() && line.length < 100) {
          formattedLines.push('# ' + line);
        }
        // Detect section headers (short lines in caps followed by content)
        else if (line && line === line.toUpperCase() && line.length < 80 && nextLine && nextLine !== nextLine.toUpperCase()) {
          formattedLines.push('## ' + line);
        }
        // Detect numbered sections like "1. SECTION NAME"
        else if (/^\d+[\.\)]\s+[A-Z]/.test(line) && line.length < 80) {
          formattedLines.push('### ' + line);
        }
        else {
          formattedLines.push(line);
        }
      }

      return formattedLines.join('\n').trim();
    }

    // Download as Word file
    function downloadAsWord() {
      const content = document.getElementById('policyContent').value;

      if (!content) {
        alert('Aucun contenu √† exporter');
        return;
      }

      // Convert markdown to HTML for Word
      const htmlContent = markdownToHtml(content);

      // Create a Word-compatible HTML document
      const wordDocument = `
        <!DOCTYPE html>
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
          <meta charset="utf-8">
          <title>Politique de Confidentialit√©</title>
          <style>
            body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; line-height: 1.5; margin: 2cm; }
            h1 { font-size: 16pt; color: #1F4788; margin-top: 0; }
            h2 { font-size: 14pt; color: #1F4788; margin-top: 18pt; }
            h3 { font-size: 12pt; color: #333; margin-top: 12pt; }
            p { margin: 6pt 0; }
            ul, ol { margin: 6pt 0 6pt 20pt; }
            li { margin: 3pt 0; }
          </style>
        </head>
        <body>
          ${htmlContent}
        </body>
        </html>
      `;

      // Create blob and download
      const blob = new Blob([wordDocument], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Politique_de_Confidentialite.doc';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      // Show success message
      const msgDiv = document.getElementById('policyMessage');
      msgDiv.textContent = '‚úÖ Fichier Word t√©l√©charg√© !';
      msgDiv.style.background = '#d4edda';
      msgDiv.style.color = '#155724';
      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    // ============= END WORD FILE IMPORT/EXPORT =============
  </script>
</body>
</html>
