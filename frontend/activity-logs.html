<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logs d'activit√© - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .filters-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      align-items: end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .filter-group input, .filter-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card .label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #1F4788;
    }
    .logs-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .logs-table th {
      background: #1F4788;
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
    }
    .logs-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .logs-table tr:hover {
      background: #f8f9fa;
    }
    .action-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .action-badge.login_success { background: #d4edda; color: #155724; }
    .action-badge.login_failed { background: #f8d7da; color: #721c24; }
    .action-badge.account_created { background: #cce5ff; color: #004085; }
    .action-badge.inscription_created { background: #d4edda; color: #155724; }
    .action-badge.inscription_cancelled { background: #fff3cd; color: #856404; }
    .action-badge.password_reset_requested { background: #e2e3e5; color: #383d41; }
    .action-badge.password_reset_completed { background: #d4edda; color: #155724; }
    .action-badge.email_inscription_confirmation { background: #d1ecf1; color: #0c5460; }
    .action-badge.email_cancellation_confirmation { background: #d1ecf1; color: #0c5460; }
    .action-badge.admin_impersonate { background: #f8d7da; color: #721c24; }
    .status-success { color: #28a745; }
    .status-failed { color: #dc3545; }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #1F4788;
      background: white;
      color: #1F4788;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination button:hover:not(:disabled) {
      background: #1F4788;
      color: white;
    }
    .details-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }
    .details-cell:hover {
      white-space: normal;
      word-break: break-word;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .auto-refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: auto;
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 22px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 22px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: #28a745;
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    .auto-refresh-label {
      font-size: 12px;
      color: #666;
    }
    .refresh-indicator {
      display: none;
      font-size: 11px;
      color: #28a745;
      margin-left: 5px;
    }
    .refresh-indicator.active {
      display: inline;
    }
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .export-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img src="images/billiard-icon.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;"></span> CDBHS Tournois</h2>
        <span style="font-size: 18px; color: #1F4788; font-weight: bold; margin-left: 36px;">V2.0</span>
      </div>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="calendar.html">Calendrier</a>
        <a href="emailing.html">Com joueurs</a>
        <a href="activity-logs.html" class="admin-only active">Logs</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <h1 style="margin-bottom: 15px;">Logs d'activit√© - Player App</h1>

    <!-- Stats -->
    <div id="statsContainer" class="stats-grid">
      <div class="stat-card">
        <div class="label">Connexions (7j)</div>
        <div class="value" id="statLogins">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Inscriptions (7j)</div>
        <div class="value" id="statInscriptions">-</div>
      </div>
      <div class="stat-card">
        <div class="label">D√©sinscriptions (7j)</div>
        <div class="value" id="statCancellations">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Nouveaux comptes (7j)</div>
        <div class="value" id="statAccounts">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <div class="label" style="color: rgba(255,255,255,0.9);">Total inscriptions Player App</div>
        <div class="value" style="color: white;" id="statTotalInscriptions">-</div>
      </div>
    </div>

    <!-- Analytics Toggle -->
    <div style="margin-bottom: 15px;">
      <button id="toggleAnalytics" onclick="toggleAnalyticsSection()" class="btn" style="background: #6c757d; padding: 8px 16px; font-size: 13px;">
        üìä Afficher les graphiques
      </button>
    </div>

    <!-- Analytics Section (hidden by default) -->
    <div id="analyticsSection" style="display: none; margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <!-- Activity Trend Chart -->
        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 10px 0; color: #1F4788; font-size: 14px;">Activit√© quotidienne (7 derniers jours)</h4>
          <canvas id="activityChart" height="200"></canvas>
        </div>
        <!-- Action Type Breakdown -->
        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 10px 0; color: #1F4788; font-size: 14px;">R√©partition par type d'action</h4>
          <canvas id="actionChart" height="200"></canvas>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <!-- Peak Hours -->
        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 10px 0; color: #1F4788; font-size: 14px;">Heures de pointe</h4>
          <canvas id="hoursChart" height="150"></canvas>
        </div>
        <!-- Most Active Players -->
        <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h4 style="margin: 0 0 10px 0; color: #1F4788; font-size: 14px;">Joueurs les plus actifs (7j)</h4>
          <div id="activePlayersList" style="max-height: 180px; overflow-y: auto; font-size: 13px;">
            <div style="color: #666; padding: 10px;">Chargement...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-card">
      <div class="filters-grid">
        <div class="filter-group">
          <label>Date d√©but</label>
          <input type="date" id="filterStartDate">
        </div>
        <div class="filter-group">
          <label>Date fin</label>
          <input type="date" id="filterEndDate">
        </div>
        <div class="filter-group">
          <label>Type d'action</label>
          <select id="filterActionType">
            <option value="">Tous</option>
            <option value="login_success">Connexion r√©ussie</option>
            <option value="login_failed">Connexion √©chou√©e</option>
            <option value="account_created">Compte cr√©√©</option>
            <option value="inscription_created">Inscription</option>
            <option value="inscription_cancelled">D√©sinscription</option>
            <option value="password_reset_requested">Demande reset MDP</option>
            <option value="password_reset_completed">Reset MDP effectu√©</option>
            <option value="email_inscription_confirmation,email_cancellation_confirmation">Emails envoy√©s</option>
            <option value="admin_impersonate">Vue joueur (admin)</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Nom joueur</label>
          <div style="display: flex; gap: 4px;">
            <select id="filterNameType" style="width: 110px; padding: 8px 4px; font-size: 12px;">
              <option value="contains">Contient</option>
              <option value="not_contains">Ne contient pas</option>
              <option value="equals">√âgal √†</option>
              <option value="not_equals">Diff√©rent de</option>
              <option value="starts_with">Commence par</option>
            </select>
            <input type="text" id="filterName" placeholder="Ex: DUPONT" style="flex: 1; min-width: 100px;">
          </div>
        </div>
        <div class="filter-group">
          <label>Licence</label>
          <input type="text" id="filterLicence" placeholder="Ex: 123456">
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <button class="btn" onclick="loadLogs()" style="padding: 8px 16px; font-size: 13px;">Filtrer</button>
            <div class="auto-refresh-toggle" style="margin: 0;">
              <label class="toggle-switch">
                <input type="checkbox" id="autoRefreshToggle" onchange="toggleAutoRefresh()">
                <span class="toggle-slider"></span>
              </label>
              <span class="auto-refresh-label">Auto (30s)</span>
              <span id="refreshIndicator" class="refresh-indicator">‚óè</span>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 12px;">
        <button class="export-btn" onclick="exportExcel()">Exporter Excel</button>
        <button class="admin-only" onclick="openResetModal()" style="display: none; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">R√©initialiser</button>
      </div>
    </div>

    <!-- Logs Table -->
    <div id="logsContainer">
      <div class="loading">Chargement des logs...</div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prevBtn" onclick="prevPage()" disabled>Pr√©c√©dent</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn" onclick="nextPage()">Suivant</button>
    </div>

    <!-- Reset Modal -->
    <div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 25px; border-radius: 10px; max-width: 450px; width: 90%;">
        <h3 style="margin-top: 0; color: #dc3545;">R√©initialiser les logs</h3>
        <p style="color: #666; font-size: 14px;">Les logs seront automatiquement sauvegard√©s en Excel avant suppression.</p>

        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 15px; cursor: pointer;">
            <input type="radio" name="resetType" value="all" checked style="margin-right: 8px;">
            <strong>Toute la saison</strong>
            <span style="display: block; margin-left: 22px; font-size: 13px; color: #666;">Supprimer tous les logs</span>
          </label>
          <label style="display: block; cursor: pointer;">
            <input type="radio" name="resetType" value="range" style="margin-right: 8px;">
            <strong>Entre 2 dates</strong>
            <span style="display: block; margin-left: 22px; font-size: 13px; color: #666;">Supprimer les logs d'une p√©riode</span>
          </label>
        </div>

        <div id="dateRangeInputs" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
          <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
              <label style="font-size: 12px; color: #666;">Date d√©but</label>
              <input type="date" id="resetStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label style="font-size: 12px; color: #666;">Date fin</label>
              <input type="date" id="resetEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeResetModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Annuler</button>
          <button onclick="executeReset()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirmer la suppression</button>
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';
    let currentPage = 0;
    const pageSize = 50;
    let totalLogs = 0;
    let currentLogs = [];

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Check user role
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    }

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Format date for display
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Format action type for display
    function formatActionType(type) {
      const labels = {
        'login_success': 'Connexion',
        'login_failed': '√âchec connexion',
        'account_created': 'Nouveau compte',
        'inscription_created': 'Inscription',
        'inscription_cancelled': 'D√©sinscription',
        'password_reset_requested': 'Demande reset MDP',
        'password_reset_completed': 'Reset MDP',
        'email_inscription_confirmation': 'Email inscription',
        'email_cancellation_confirmation': 'Email d√©sinscription',
        'admin_impersonate': 'Vue joueur (admin)'
      };
      return labels[type] || type;
    }

    // Format details for display (make them human-readable)
    function formatDetails(details, actionType) {
      if (!details) return '-';

      // For login failures, show the reason in French
      if (actionType === 'login_failed' && details.reason) {
        const reasons = {
          'account_locked': 'Compte bloqu√©' + (details.remainingMinutes ? ` (${details.remainingMinutes} min)` : ''),
          'account_not_found': 'Compte inexistant',
          'email_not_verified': 'Email non v√©rifi√©',
          'wrong_password': 'Mot de passe incorrect'
        };
        return reasons[details.reason] || details.reason;
      }

      // For login success, show club if available
      if (actionType === 'login_success' && details.club) {
        return `Club: ${details.club}`;
      }

      // For inscriptions, show tournament info
      if ((actionType === 'inscription_created' || actionType === 'inscription_cancelled') && details.tournament) {
        return `${details.mode || ''} ${details.category || ''} - ${details.tournament}`.trim();
      }

      // Default: show as JSON but more compact
      return JSON.stringify(details);
    }

    // Load stats
    async function loadStats() {
      try {
        // Load 7-day stats from activity logs
        const response = await fetch(`${API_URL}/activity-logs/stats?days=7`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to load stats');
        const stats = await response.json();

        // Calculate stats from totals
        const totals = {};
        if (stats && Array.isArray(stats.totals)) {
          stats.totals.forEach(t => totals[t.action_type] = parseInt(t.count));
        }

        document.getElementById('statLogins').textContent = totals['login_success'] || 0;
        document.getElementById('statInscriptions').textContent = totals['inscription_created'] || 0;
        document.getElementById('statCancellations').textContent = totals['inscription_cancelled'] || 0;
        document.getElementById('statAccounts').textContent = totals['account_created'] || 0;

        // Load total inscriptions from Player App (all time)
        const inscResponse = await fetch(`${API_URL}/inscriptions?source=player_app`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (inscResponse.ok) {
          const inscriptions = await inscResponse.json();
          document.getElementById('statTotalInscriptions').textContent = inscriptions.length;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load logs
    async function loadLogs() {
      const container = document.getElementById('logsContainer');
      container.innerHTML = '<div class="loading">Chargement...</div>';

      try {
        const params = new URLSearchParams();
        params.append('limit', pageSize);
        params.append('offset', currentPage * pageSize);

        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        const actionType = document.getElementById('filterActionType').value;
        const name = document.getElementById('filterName').value;
        const nameFilterType = document.getElementById('filterNameType').value;
        const licence = document.getElementById('filterLicence').value;

        if (startDate) params.append('startDate', startDate + 'T00:00:00');
        if (endDate) params.append('endDate', endDate + 'T23:59:59');
        if (actionType) params.append('actionType', actionType);
        if (name) {
          params.append('name', name);
          params.append('nameFilterType', nameFilterType);
        }
        if (licence) params.append('licence', licence);

        const response = await fetch(`${API_URL}/activity-logs?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load logs');
        const data = await response.json();

        currentLogs = Array.isArray(data?.logs) ? data.logs : [];
        totalLogs = data?.total || 0;

        renderLogs();
        updatePagination();
      } catch (error) {
        console.error('Error loading logs:', error);
        container.innerHTML = '<div class="loading" style="color: #dc3545;">Erreur de chargement</div>';
      }
    }

    // Render logs table
    function renderLogs() {
      const container = document.getElementById('logsContainer');

      if (currentLogs.length === 0) {
        container.innerHTML = '<div class="loading">Aucun log trouve</div>';
        return;
      }

      let html = `
        <table class="logs-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Action</th>
              <th>Statut</th>
              <th>Joueur</th>
              <th>Email</th>
              <th>Cible</th>
              <th>Details</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody>
      `;

      currentLogs.forEach(log => {
        const details = formatDetails(log.details, log.action_type);
        const rawDetails = log.details ? JSON.stringify(log.details) : '-';
        const statusClass = log.action_status === 'success' ? 'status-success' : 'status-failed';

        html += `
          <tr>
            <td>${formatDateTime(log.created_at)}</td>
            <td><span class="action-badge ${log.action_type}">${formatActionType(log.action_type)}</span></td>
            <td class="${statusClass}">${log.action_status === 'success' ? 'OK' : '√âchec'}</td>
            <td>${log.user_name || log.licence || '-'}</td>
            <td>${log.user_email || '-'}</td>
            <td>${log.target_name || '-'}</td>
            <td class="details-cell" title="${rawDetails}">${details}</td>
            <td>${log.ip_address || '-'}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} / ${totalPages} (${totalLogs} logs)`;
      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadLogs();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadLogs();
      }
    }

    // Export to Excel
    function exportExcel() {
      if (currentLogs.length === 0) {
        alert('Aucune donn√©e √† exporter');
        return;
      }

      const headers = ['Date', 'Action', 'Statut', 'Licence', 'Nom', 'Email', 'Cible', 'Details', 'IP'];
      const rows = currentLogs.map(log => [
        formatDateTime(log.created_at),
        log.action_type,
        log.action_status,
        log.licence || '',
        log.user_name || '',
        log.user_email || '',
        log.target_name || '',
        log.details ? JSON.stringify(log.details) : '',
        log.ip_address || ''
      ]);

      // Create Excel workbook
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      ws['!cols'] = [
        { wch: 18 }, { wch: 25 }, { wch: 8 }, { wch: 10 },
        { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 40 }, { wch: 15 }
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Logs');
      XLSX.writeFile(wb, `activity-logs-${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // Modal functions
    function openResetModal() {
      document.getElementById('resetModal').style.display = 'flex';
      // Set default dates for range
      const today = new Date();
      document.getElementById('resetEndDate').value = today.toISOString().slice(0, 10);
      const startOfSeason = new Date(today.getFullYear(), 8, 1); // Sept 1
      if (today < startOfSeason) startOfSeason.setFullYear(startOfSeason.getFullYear() - 1);
      document.getElementById('resetStartDate').value = startOfSeason.toISOString().slice(0, 10);
    }

    function closeResetModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    // Toggle date range inputs
    document.addEventListener('change', (e) => {
      if (e.target.name === 'resetType') {
        document.getElementById('dateRangeInputs').style.display =
          e.target.value === 'range' ? 'block' : 'none';
      }
    });

    // Execute reset with backup
    async function executeReset() {
      const resetType = document.querySelector('input[name="resetType"]:checked').value;
      let startDate = null;
      let endDate = null;

      if (resetType === 'range') {
        startDate = document.getElementById('resetStartDate').value;
        endDate = document.getElementById('resetEndDate').value;
        if (!startDate || !endDate) {
          alert('Veuillez s√©lectionner les dates de d√©but et fin.');
          return;
        }
        // Add time to end date to include the full day
        endDate = endDate + 'T23:59:59';
      }

      if (!confirm('Cette action va :\n1. T√©l√©charger une sauvegarde Excel des logs\n2. Supprimer les logs s√©lectionn√©s\n\nContinuer ?')) {
        return;
      }

      try {
        // Step 1: Fetch all logs to be deleted
        let fetchUrl = `${API_URL}/activity-logs?limit=10000`;
        if (startDate) fetchUrl += `&startDate=${startDate}`;
        if (endDate) fetchUrl += `&endDate=${endDate}`;

        const fetchResponse = await fetch(fetchUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!fetchResponse.ok) {
          throw new Error('Impossible de r√©cup√©rer les logs');
        }

        const data = await fetchResponse.json();
        const logsToDelete = data.logs;

        if (logsToDelete.length === 0) {
          alert('Aucun log √† supprimer pour cette p√©riode.');
          closeResetModal();
          return;
        }

        // Step 2: Generate and download Excel backup
        const headers = ['Date/Heure', 'Action', 'Statut', 'Licence', 'Joueur', 'Email', 'Cible', 'Details', 'IP'];
        const rows = logsToDelete.map(log => [
          formatDateTime(log.created_at),
          log.action_type,
          log.action_status,
          log.licence || '',
          log.user_name || '',
          log.user_email || '',
          log.target_name || '',
          log.details ? JSON.stringify(log.details) : '',
          log.ip_address || ''
        ]);

        // Create Excel workbook
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        // Set column widths
        ws['!cols'] = [
          { wch: 18 }, // Date/Heure
          { wch: 25 }, // Action
          { wch: 8 },  // Statut
          { wch: 10 }, // Licence
          { wch: 25 }, // Joueur
          { wch: 30 }, // Email
          { wch: 20 }, // Cible
          { wch: 40 }, // Details
          { wch: 15 }  // IP
        ];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Logs');
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `backup-logs-${dateStr}.xlsx`);

        // Step 3: Delete logs
        let deleteUrl = `${API_URL}/activity-logs`;
        const deleteBody = {};
        if (startDate) deleteBody.startDate = startDate;
        if (endDate) deleteBody.endDate = endDate;

        const deleteResponse = await fetch(deleteUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: Object.keys(deleteBody).length > 0 ? JSON.stringify(deleteBody) : undefined
        });

        if (deleteResponse.ok) {
          const result = await deleteResponse.json();
          alert(`Sauvegarde t√©l√©charg√©e.\n${result.deleted} logs supprim√©s.`);
          closeResetModal();
          loadStats();
          loadLogs();
        } else {
          const error = await deleteResponse.json();
          alert('Erreur: ' + (error.error || 'Impossible de supprimer les logs'));
        }
      } catch (error) {
        console.error('Error during reset:', error);
        alert('Erreur lors de la r√©initialisation : ' + error.message);
      }
    }

    // Set default date range (last 7 days)
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);

    document.getElementById('filterEndDate').value = today.toISOString().slice(0, 10);
    document.getElementById('filterStartDate').value = lastWeek.toISOString().slice(0, 10);

    // Auto-refresh functionality
    let autoRefreshInterval = null;
    const REFRESH_INTERVAL = 30000; // 30 seconds

    function toggleAutoRefresh() {
      const toggle = document.getElementById('autoRefreshToggle');
      const indicator = document.getElementById('refreshIndicator');

      if (toggle.checked) {
        // Start auto-refresh
        autoRefreshInterval = setInterval(() => {
          indicator.classList.add('active');
          loadStats();
          loadLogs();
          // Flash indicator
          setTimeout(() => indicator.classList.remove('active'), 1000);
        }, REFRESH_INTERVAL);
        indicator.classList.add('active');
        setTimeout(() => indicator.classList.remove('active'), 1000);
      } else {
        // Stop auto-refresh
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        indicator.classList.remove('active');
      }
    }

    // Stop auto-refresh when leaving the page
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });

    // Initial load
    loadStats();
    loadLogs();

    // ==================== ANALYTICS ====================
    let activityChart = null;
    let actionChart = null;
    let hoursChart = null;
    let analyticsLoaded = false;

    function toggleAnalyticsSection() {
      const section = document.getElementById('analyticsSection');
      const btn = document.getElementById('toggleAnalytics');

      if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.textContent = 'üìä Masquer les graphiques';
        btn.style.background = '#1F4788';
        if (!analyticsLoaded) {
          loadAnalytics();
          analyticsLoaded = true;
        }
      } else {
        section.style.display = 'none';
        btn.textContent = 'üìä Afficher les graphiques';
        btn.style.background = '#6c757d';
      }
    }

    async function loadAnalytics() {
      try {
        // Fetch stats with daily breakdown
        const response = await fetch(`${API_URL}/activity-logs/stats?days=7`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return;
        const stats = await response.json();

        // 1. Activity Trend Chart (daily)
        createActivityChart(stats.daily || []);

        // 2. Action Type Breakdown
        createActionChart(stats.totals || []);

        // 3. Most Active Players
        displayActivePlayers(stats.activeUsers || []);

        // 4. Peak Hours - need to fetch logs for this
        await loadPeakHours();

      } catch (error) {
        console.error('Error loading analytics:', error);
      }
    }

    function createActivityChart(dailyData) {
      const ctx = document.getElementById('activityChart').getContext('2d');

      // Group by date
      const dateMap = {};
      dailyData.forEach(d => {
        const date = d.date.split('T')[0];
        dateMap[date] = (dateMap[date] || 0) + parseInt(d.count);
      });

      // Get last 7 days
      const dates = [];
      const counts = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        dates.push(date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
        counts.push(dateMap[dateStr] || 0);
      }

      if (activityChart) activityChart.destroy();
      activityChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Actions',
            data: counts,
            borderColor: '#1F4788',
            backgroundColor: 'rgba(31, 71, 136, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    function createActionChart(totals) {
      const ctx = document.getElementById('actionChart').getContext('2d');

      const labels = [];
      const data = [];
      const colors = {
        'login_success': '#28a745',
        'login_failed': '#dc3545',
        'account_created': '#007bff',
        'inscription_created': '#20c997',
        'inscription_cancelled': '#ffc107',
        'password_reset_requested': '#6c757d',
        'password_reset_completed': '#17a2b8',
        'admin_impersonate': '#9c27b0'
      };
      const bgColors = [];

      totals.forEach(t => {
        labels.push(formatActionType(t.action_type));
        data.push(parseInt(t.count));
        bgColors.push(colors[t.action_type] || '#6c757d');
      });

      if (actionChart) actionChart.destroy();
      actionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: bgColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 12, font: { size: 11 } }
            }
          }
        }
      });
    }

    async function loadPeakHours() {
      try {
        // Fetch recent logs to analyze hours
        const params = new URLSearchParams();
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(lastWeek.getDate() - 7);
        params.append('startDate', lastWeek.toISOString());
        params.append('endDate', today.toISOString());
        params.append('limit', 1000);

        const response = await fetch(`${API_URL}/activity-logs?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return;
        const data = await response.json();

        // Count by hour
        const hourCounts = new Array(24).fill(0);
        (data.logs || []).forEach(log => {
          const hour = new Date(log.created_at).getHours();
          hourCounts[hour]++;
        });

        createHoursChart(hourCounts);
      } catch (error) {
        console.error('Error loading peak hours:', error);
      }
    }

    function createHoursChart(hourCounts) {
      const ctx = document.getElementById('hoursChart').getContext('2d');

      const labels = [];
      for (let i = 0; i < 24; i++) {
        labels.push(i + 'h');
      }

      if (hoursChart) hoursChart.destroy();
      hoursChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Actions',
            data: hourCounts,
            backgroundColor: hourCounts.map((count, i) => {
              // Highlight peak hours
              const max = Math.max(...hourCounts);
              return count === max ? '#dc3545' : count > max * 0.7 ? '#ffc107' : '#1F4788';
            })
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } },
            x: { ticks: { font: { size: 9 } } }
          }
        }
      });
    }

    function displayActivePlayers(users) {
      const container = document.getElementById('activePlayersList');

      if (!users || users.length === 0) {
        container.innerHTML = '<div style="color: #666; padding: 10px;">Aucune donn√©e</div>';
        return;
      }

      let html = '<table style="width: 100%; border-collapse: collapse;">';
      html += '<tr style="background: #f8f9fa; font-size: 11px; color: #666;">';
      html += '<th style="padding: 6px; text-align: left;">Joueur</th>';
      html += '<th style="padding: 6px; text-align: center;">Actions</th>';
      html += '<th style="padding: 6px; text-align: right;">Derni√®re</th>';
      html += '</tr>';

      users.slice(0, 10).forEach((user, i) => {
        const lastActivity = new Date(user.last_activity).toLocaleDateString('fr-FR', {
          day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
        });
        const bgColor = i % 2 === 0 ? 'white' : '#f8f9fa';
        html += `<tr style="background: ${bgColor};">`;
        html += `<td style="padding: 6px;">${user.user_name || user.licence || '-'}</td>`;
        html += `<td style="padding: 6px; text-align: center; font-weight: bold; color: #1F4788;">${user.action_count}</td>`;
        html += `<td style="padding: 6px; text-align: right; font-size: 11px; color: #666;">${lastActivity}</td>`;
        html += '</tr>';
      });

      html += '</table>';
      container.innerHTML = html;
    }
  </script>
</body>
</html>
