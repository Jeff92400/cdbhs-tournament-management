<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Logs d'activite - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    .filters-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      align-items: end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-group label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .filter-group input, .filter-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }
    .stat-card {
      background: white;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card .label {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: bold;
      color: #1F4788;
    }
    .logs-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .logs-table th {
      background: #1F4788;
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
    }
    .logs-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    .logs-table tr:hover {
      background: #f8f9fa;
    }
    .action-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    .action-badge.login_success { background: #d4edda; color: #155724; }
    .action-badge.login_failed { background: #f8d7da; color: #721c24; }
    .action-badge.account_created { background: #cce5ff; color: #004085; }
    .action-badge.inscription_created { background: #d4edda; color: #155724; }
    .action-badge.inscription_cancelled { background: #fff3cd; color: #856404; }
    .action-badge.password_reset_requested { background: #e2e3e5; color: #383d41; }
    .action-badge.password_reset_completed { background: #d4edda; color: #155724; }
    .action-badge.email_inscription_confirmation { background: #d1ecf1; color: #0c5460; }
    .action-badge.email_cancellation_confirmation { background: #d1ecf1; color: #0c5460; }
    .action-badge.admin_impersonate { background: #f8d7da; color: #721c24; }
    .status-success { color: #28a745; }
    .status-failed { color: #dc3545; }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
    }
    .pagination button {
      padding: 8px 16px;
      border: 1px solid #1F4788;
      background: white;
      color: #1F4788;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination button:hover:not(:disabled) {
      background: #1F4788;
      color: white;
    }
    .details-cell {
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
    }
    .details-cell:hover {
      white-space: normal;
      word-break: break-word;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .export-btn:hover {
      background: #218838;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img src="images/billiard-icon.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;"></span> CDBHS Tournois</h2>
        <span style="font-size: 18px; color: #1F4788; font-weight: bold; margin-left: 36px;">V2.0</span>
      </div>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Competitions</a>
        <a href="calendar.html">Calendrier</a>
        <a href="emailing.html">Emailing</a>
        <a href="settings.html" class="admin-only">Parametres</a>
        <a href="#" id="logoutBtn" class="nav-logout">Deconnexion</a>
      </div>
    </div>

    <h1 style="margin-bottom: 15px;">Logs d'activite - Player App</h1>

    <!-- Stats -->
    <div id="statsContainer" class="stats-grid">
      <div class="stat-card">
        <div class="label">Connexions (7j)</div>
        <div class="value" id="statLogins">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Inscriptions (7j)</div>
        <div class="value" id="statInscriptions">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Desinscriptions (7j)</div>
        <div class="value" id="statCancellations">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Nouveaux comptes (7j)</div>
        <div class="value" id="statAccounts">-</div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-card">
      <div class="filters-grid">
        <div class="filter-group">
          <label>Date debut</label>
          <input type="date" id="filterStartDate">
        </div>
        <div class="filter-group">
          <label>Date fin</label>
          <input type="date" id="filterEndDate">
        </div>
        <div class="filter-group">
          <label>Type d'action</label>
          <select id="filterActionType">
            <option value="">Tous</option>
            <option value="login_success">Connexion reussie</option>
            <option value="login_failed">Connexion echouee</option>
            <option value="account_created">Compte cree</option>
            <option value="inscription_created">Inscription</option>
            <option value="inscription_cancelled">Desinscription</option>
            <option value="password_reset_requested">Demande reset MDP</option>
            <option value="password_reset_completed">Reset MDP effectue</option>
            <option value="email_inscription_confirmation,email_cancellation_confirmation">Emails envoyes</option>
            <option value="admin_impersonate">Impersonation admin</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Nom joueur</label>
          <input type="text" id="filterName" placeholder="Ex: DUPONT">
        </div>
        <div class="filter-group">
          <button class="btn" onclick="loadLogs()" style="margin-top: auto;">Filtrer</button>
        </div>
        <div class="filter-group">
          <button class="export-btn" onclick="exportExcel()" style="margin-top: auto;">Exporter Excel</button>
        </div>
        <div class="filter-group admin-only" style="display: none;">
          <button onclick="openResetModal()" style="margin-top: auto; background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Reinitialiser</button>
        </div>
        <div class="filter-group">
          <label>Licence</label>
          <input type="text" id="filterLicence" placeholder="Ex: 123456">
        </div>
      </div>
    </div>

    <!-- Logs Table -->
    <div id="logsContainer">
      <div class="loading">Chargement des logs...</div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button id="prevBtn" onclick="prevPage()" disabled>Precedent</button>
      <span id="pageInfo">Page 1</span>
      <button id="nextBtn" onclick="nextPage()">Suivant</button>
    </div>

    <!-- Reset Modal -->
    <div id="resetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 25px; border-radius: 10px; max-width: 450px; width: 90%;">
        <h3 style="margin-top: 0; color: #dc3545;">Reinitialiser les logs</h3>
        <p style="color: #666; font-size: 14px;">Les logs seront automatiquement sauvegardes en CSV avant suppression.</p>

        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 15px; cursor: pointer;">
            <input type="radio" name="resetType" value="all" checked style="margin-right: 8px;">
            <strong>Toute la saison</strong>
            <span style="display: block; margin-left: 22px; font-size: 13px; color: #666;">Supprimer tous les logs</span>
          </label>
          <label style="display: block; cursor: pointer;">
            <input type="radio" name="resetType" value="range" style="margin-right: 8px;">
            <strong>Entre 2 dates</strong>
            <span style="display: block; margin-left: 22px; font-size: 13px; color: #666;">Supprimer les logs d'une periode</span>
          </label>
        </div>

        <div id="dateRangeInputs" style="display: none; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
          <div style="display: flex; gap: 15px;">
            <div style="flex: 1;">
              <label style="font-size: 12px; color: #666;">Date debut</label>
              <input type="date" id="resetStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="flex: 1;">
              <label style="font-size: 12px; color: #666;">Date fin</label>
              <input type="date" id="resetEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button onclick="closeResetModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Annuler</button>
          <button onclick="executeReset()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">Confirmer la suppression</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    let currentPage = 0;
    const pageSize = 50;
    let totalLogs = 0;
    let currentLogs = [];

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    }

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Format date for display
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('fr-FR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Format action type for display
    function formatActionType(type) {
      const labels = {
        'login_success': 'Connexion',
        'login_failed': 'Echec connexion',
        'account_created': 'Nouveau compte',
        'inscription_created': 'Inscription',
        'inscription_cancelled': 'Desinscription',
        'password_reset_requested': 'Demande reset MDP',
        'password_reset_completed': 'Reset MDP',
        'email_inscription_confirmation': 'Email inscription',
        'email_cancellation_confirmation': 'Email desinscription',
        'admin_impersonate': 'Impersonation'
      };
      return labels[type] || type;
    }

    // Load stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/activity-logs/stats?days=7`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to load stats');
        const stats = await response.json();

        // Calculate stats from totals
        const totals = {};
        stats.totals.forEach(t => totals[t.action_type] = parseInt(t.count));

        document.getElementById('statLogins').textContent = totals['login_success'] || 0;
        document.getElementById('statInscriptions').textContent = totals['inscription_created'] || 0;
        document.getElementById('statCancellations').textContent = totals['inscription_cancelled'] || 0;
        document.getElementById('statAccounts').textContent = totals['account_created'] || 0;
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load logs
    async function loadLogs() {
      const container = document.getElementById('logsContainer');
      container.innerHTML = '<div class="loading">Chargement...</div>';

      try {
        const params = new URLSearchParams();
        params.append('limit', pageSize);
        params.append('offset', currentPage * pageSize);

        const startDate = document.getElementById('filterStartDate').value;
        const endDate = document.getElementById('filterEndDate').value;
        const actionType = document.getElementById('filterActionType').value;
        const name = document.getElementById('filterName').value;
        const licence = document.getElementById('filterLicence').value;

        if (startDate) params.append('startDate', startDate + 'T00:00:00');
        if (endDate) params.append('endDate', endDate + 'T23:59:59');
        if (actionType) params.append('actionType', actionType);
        if (name) params.append('name', name);
        if (licence) params.append('licence', licence);

        const response = await fetch(`${API_URL}/activity-logs?${params}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load logs');
        const data = await response.json();

        currentLogs = data.logs;
        totalLogs = data.total;

        renderLogs();
        updatePagination();
      } catch (error) {
        console.error('Error loading logs:', error);
        container.innerHTML = '<div class="loading" style="color: #dc3545;">Erreur de chargement</div>';
      }
    }

    // Render logs table
    function renderLogs() {
      const container = document.getElementById('logsContainer');

      if (currentLogs.length === 0) {
        container.innerHTML = '<div class="loading">Aucun log trouve</div>';
        return;
      }

      let html = `
        <table class="logs-table">
          <thead>
            <tr>
              <th>Date/Heure</th>
              <th>Action</th>
              <th>Statut</th>
              <th>Joueur</th>
              <th>Email</th>
              <th>Cible</th>
              <th>Details</th>
              <th>IP</th>
            </tr>
          </thead>
          <tbody>
      `;

      currentLogs.forEach(log => {
        const details = log.details ? JSON.stringify(log.details) : '-';
        const statusClass = log.action_status === 'success' ? 'status-success' : 'status-failed';

        html += `
          <tr>
            <td>${formatDateTime(log.created_at)}</td>
            <td><span class="action-badge ${log.action_type}">${formatActionType(log.action_type)}</span></td>
            <td class="${statusClass}">${log.action_status === 'success' ? 'OK' : 'Echec'}</td>
            <td>${log.user_name || log.licence || '-'}</td>
            <td>${log.user_email || '-'}</td>
            <td>${log.target_name || '-'}</td>
            <td class="details-cell" title="${details}">${details}</td>
            <td>${log.ip_address || '-'}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Update pagination
    function updatePagination() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      document.getElementById('pageInfo').textContent = `Page ${currentPage + 1} / ${totalPages} (${totalLogs} logs)`;
      document.getElementById('prevBtn').disabled = currentPage === 0;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages - 1;
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadLogs();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadLogs();
      }
    }

    // Export to Excel
    function exportExcel() {
      if (currentLogs.length === 0) {
        alert('Aucune donnee a exporter');
        return;
      }

      const headers = ['Date', 'Action', 'Statut', 'Licence', 'Nom', 'Email', 'Cible', 'Details', 'IP'];
      const rows = currentLogs.map(log => [
        formatDateTime(log.created_at),
        log.action_type,
        log.action_status,
        log.licence || '',
        log.user_name || '',
        log.user_email || '',
        log.target_name || '',
        log.details ? JSON.stringify(log.details) : '',
        log.ip_address || ''
      ]);

      // Create Excel workbook
      const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
      ws['!cols'] = [
        { wch: 18 }, { wch: 25 }, { wch: 8 }, { wch: 10 },
        { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 40 }, { wch: 15 }
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Logs');
      XLSX.writeFile(wb, `activity-logs-${new Date().toISOString().slice(0, 10)}.xlsx`);
    }

    // Modal functions
    function openResetModal() {
      document.getElementById('resetModal').style.display = 'flex';
      // Set default dates for range
      const today = new Date();
      document.getElementById('resetEndDate').value = today.toISOString().slice(0, 10);
      const startOfSeason = new Date(today.getFullYear(), 8, 1); // Sept 1
      if (today < startOfSeason) startOfSeason.setFullYear(startOfSeason.getFullYear() - 1);
      document.getElementById('resetStartDate').value = startOfSeason.toISOString().slice(0, 10);
    }

    function closeResetModal() {
      document.getElementById('resetModal').style.display = 'none';
    }

    // Toggle date range inputs
    document.addEventListener('change', (e) => {
      if (e.target.name === 'resetType') {
        document.getElementById('dateRangeInputs').style.display =
          e.target.value === 'range' ? 'block' : 'none';
      }
    });

    // Execute reset with backup
    async function executeReset() {
      const resetType = document.querySelector('input[name="resetType"]:checked').value;
      let startDate = null;
      let endDate = null;

      if (resetType === 'range') {
        startDate = document.getElementById('resetStartDate').value;
        endDate = document.getElementById('resetEndDate').value;
        if (!startDate || !endDate) {
          alert('Veuillez selectionner les dates de debut et fin.');
          return;
        }
        // Add time to end date to include the full day
        endDate = endDate + 'T23:59:59';
      }

      if (!confirm('Cette action va:\n1. Telecharger une sauvegarde CSV des logs\n2. Supprimer les logs selectionnes\n\nContinuer ?')) {
        return;
      }

      try {
        // Step 1: Fetch all logs to be deleted
        let fetchUrl = `${API_URL}/activity-logs?limit=10000`;
        if (startDate) fetchUrl += `&startDate=${startDate}`;
        if (endDate) fetchUrl += `&endDate=${endDate}`;

        const fetchResponse = await fetch(fetchUrl, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!fetchResponse.ok) {
          throw new Error('Impossible de recuperer les logs');
        }

        const data = await fetchResponse.json();
        const logsToDelete = data.logs;

        if (logsToDelete.length === 0) {
          alert('Aucun log a supprimer pour cette periode.');
          closeResetModal();
          return;
        }

        // Step 2: Generate and download Excel backup
        const headers = ['Date/Heure', 'Action', 'Statut', 'Licence', 'Joueur', 'Email', 'Cible', 'Details', 'IP'];
        const rows = logsToDelete.map(log => [
          formatDateTime(log.created_at),
          log.action_type,
          log.action_status,
          log.licence || '',
          log.user_name || '',
          log.user_email || '',
          log.target_name || '',
          log.details ? JSON.stringify(log.details) : '',
          log.ip_address || ''
        ]);

        // Create Excel workbook
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        // Set column widths
        ws['!cols'] = [
          { wch: 18 }, // Date/Heure
          { wch: 25 }, // Action
          { wch: 8 },  // Statut
          { wch: 10 }, // Licence
          { wch: 25 }, // Joueur
          { wch: 30 }, // Email
          { wch: 20 }, // Cible
          { wch: 40 }, // Details
          { wch: 15 }  // IP
        ];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Logs');
        const dateStr = new Date().toISOString().slice(0, 10);
        XLSX.writeFile(wb, `backup-logs-${dateStr}.xlsx`);

        // Step 3: Delete logs
        let deleteUrl = `${API_URL}/activity-logs`;
        const deleteBody = {};
        if (startDate) deleteBody.startDate = startDate;
        if (endDate) deleteBody.endDate = endDate;

        const deleteResponse = await fetch(deleteUrl, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: Object.keys(deleteBody).length > 0 ? JSON.stringify(deleteBody) : undefined
        });

        if (deleteResponse.ok) {
          const result = await deleteResponse.json();
          alert(`Sauvegarde telechargee.\n${result.deleted} logs supprimes.`);
          closeResetModal();
          loadStats();
          loadLogs();
        } else {
          const error = await deleteResponse.json();
          alert('Erreur: ' + (error.error || 'Impossible de supprimer les logs'));
        }
      } catch (error) {
        console.error('Error during reset:', error);
        alert('Erreur lors de la reinitialisation: ' + error.message);
      }
    }

    // Set default date range (last 7 days)
    const today = new Date();
    const lastWeek = new Date(today);
    lastWeek.setDate(lastWeek.getDate() - 7);

    document.getElementById('filterEndDate').value = today.toISOString().slice(0, 10);
    document.getElementById('filterStartDate').value = lastWeek.toISOString().slice(0, 10);

    // Initial load
    loadStats();
    loadLogs();
  </script>
</body>
</html>
