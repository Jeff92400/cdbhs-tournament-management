<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©sultats du Tournoi - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .podium-container {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 20px;
      margin: 40px 0;
      padding: 20px;
    }

    .podium-place {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .podium-medal {
      font-size: 60px;
      margin-bottom: 15px;
      animation: bounce 0.6s ease-in-out;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .podium-player {
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px 30px;
      min-width: 300px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .podium-place:nth-child(1) .podium-player {
      border-color: #FFD700;
      background: linear-gradient(135deg, #FFF9E6 0%, #FFFEF0 100%);
    }

    .podium-place:nth-child(2) .podium-player {
      border-color: #C0C0C0;
      background: linear-gradient(135deg, #F5F5F5 0%, #FAFAFA 100%);
    }

    .podium-place:nth-child(3) .podium-player {
      border-color: #CD7F32;
      background: linear-gradient(135deg, #FFF0E6 0%, #FFF5ED 100%);
    }

    .podium-rank {
      font-size: 18px;
      font-weight: bold;
      color: #666;
      margin-bottom: 10px;
    }

    .podium-name {
      font-size: 16px;
      font-weight: 600;
      color: #1F4788;
      margin-bottom: 8px;
    }

    .podium-stats {
      font-size: 13px;
      color: #666;
      line-height: 1.6;
    }

    .podium-base {
      background: linear-gradient(to bottom, #E8E8E8, #D0D0D0);
      border-radius: 4px 4px 0 0;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 32px;
      color: #FFFFFF;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .podium-place:nth-child(1) { order: 2; }
    .podium-place:nth-child(2) { order: 1; }
    .podium-place:nth-child(3) { order: 3; }

    .podium-place:nth-child(1) .podium-base {
      height: 100px;
      background: linear-gradient(to bottom, #FFD700, #FFA500);
      color: #FFFFFF;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .podium-place:nth-child(2) .podium-base {
      height: 75px;
      background: linear-gradient(to bottom, #C0C0C0, #A0A0A0);
      color: #FFFFFF;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    .podium-place:nth-child(3) .podium-base {
      height: 60px;
      background: linear-gradient(to bottom, #CD7F32, #8B4513);
      color: #FFFFFF;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> R√©sultats du Tournoi</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="emailing.html" class="admin-only">Emailing</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div id="loadingTournament" class="loading">
      <div class="spinner"></div>
      Chargement...
    </div>

    <div id="tournamentContent" style="display: none;">
      <div class="card">
        <h3 id="tournamentTitle" style="margin-bottom: 15px;">-</h3>
        <div class="filter-section">
          <div class="form-group">
            <label>Saison</label>
            <div style="padding: 8px 0; font-weight: 500;" id="tournamentSeason">-</div>
          </div>
          <div class="form-group">
            <label>Date</label>
            <div style="padding: 8px 0; font-weight: 500;" id="tournamentDate">-</div>
          </div>
          <div class="form-group">
            <label>Participants</label>
            <div style="padding: 8px 0; font-weight: 500;" id="participantCount">-</div>
          </div>
        </div>
      </div>

      <!-- Podium for Finale -->
      <div class="card" id="podiumCard" style="display: none;">
        <h3 style="text-align: center; margin-bottom: 30px;">üèÜ Podium de la Finale</h3>
        <div class="podium-container" id="podiumContainer"></div>
      </div>

      <div class="card">
        <h3 id="tableTitle">Classement du Tournoi</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th style="width: 80px;">Position</th>
                <th>Licence</th>
                <th>Joueur</th>
                <th>Club</th>
                <th style="text-align: center;">Pts Match</th>
                <th style="text-align: center;">Points</th>
                <th style="text-align: center;">Reprises</th>
                <th style="text-align: center;">Moyenne</th>
                <th style="text-align: center;">Meilleure S√©rie</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top: 20px; text-align: center;">
        <button class="btn btn-success" id="exportExcelBtn">
          üìä Exporter en Excel
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Club data for this page only
    let CLUBS_DATA = [];

    // Normalize club name for matching
    function normalizeClubName(clubName) {
      if (!clubName) return '';
      return clubName.toUpperCase().replace(/[._\s-]/g, '').trim();
    }

    // Get club info from loaded data
    function getClubInfo(clubName) {
      if (!clubName) return null;
      const normalizedClubName = normalizeClubName(clubName);

      for (const club of CLUBS_DATA) {
        const normalizedDbName = normalizeClubName(club.name);
        if (normalizedClubName === normalizedDbName) {
          return {
            logo: club.logo_filename,
            displayName: club.display_name
          };
        }
      }
      return null;
    }

    // Get club logo HTML with fallback to text
    function getClubLogoHTML(clubName) {
      if (!clubName || clubName === 'N/A') {
        return '<span style="color: #999;">N/A</span>';
      }

      const clubInfo = getClubInfo(clubName);
      if (!clubInfo || !clubInfo.logo) {
        return `<span>${clubName}</span>`;
      }

      const displayName = clubInfo.displayName || clubName;
      const logoPath = `images/clubs/${clubInfo.logo}`;
      return `
        <div style="display: flex; align-items: center; gap: 8px;">
          <img src="${logoPath}" alt="${displayName}" title="${displayName}" style="height: 24px; width: 24px; vertical-align: middle; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
          <span style="display: none;">${displayName}</span>
          <span>${displayName}</span>
        </div>
      `;
    }

    // Get club logo for podium display
    function getClubLogoForPodium(clubName) {
      if (!clubName || clubName === 'N/A') {
        return '<span style="color: #999;">N/A</span>';
      }

      const clubInfo = getClubInfo(clubName);
      if (!clubInfo || !clubInfo.logo) {
        return `<span style="font-size: 11px;">${clubName}</span>`;
      }

      const displayName = clubInfo.displayName || clubName;
      const logoPath = `images/clubs/${clubInfo.logo}`;
      return `
        <div style="display: flex; align-items: center; gap: 6px; justify-content: center; flex-wrap: wrap;">
          <img src="${logoPath}" alt="${displayName}" title="${displayName}" style="height: 20px; width: 20px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
          <span style="display: none; font-size: 11px;">${displayName}</span>
          <span style="font-size: 11px;">${displayName}</span>
        </div>
      `;
    }

    // Logout (if button exists)
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = 'login.html';
      });
    }

    // Get tournament ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const tournamentId = urlParams.get('id');

    console.log('Tournament ID from URL:', tournamentId);

    if (!tournamentId) {
      document.getElementById('loadingTournament').style.display = 'none';
      document.getElementById('errorMessage').textContent = 'Aucun tournoi sp√©cifi√©';
      document.getElementById('errorMessage').style.display = 'block';
    } else {
      loadTournamentResults();
    }

    async function loadTournamentResults() {
      try {
        console.log('Loading tournament results for ID:', tournamentId);

        // Load clubs data directly for this page
        try {
          const clubsResponse = await fetch(`${API_URL}/clubs`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (clubsResponse.ok) {
            CLUBS_DATA = await clubsResponse.json();
            CLUBS_LOADED = true;
            console.log('Clubs loaded for tournament results:', CLUBS_DATA.length);
          }
        } catch (error) {
          console.warn('Could not load clubs, will show text only:', error);
        }

        const url = `${API_URL}/tournaments/${tournamentId}/results`;
        console.log('Fetching URL:', url);

        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('Error response:', errorData);
          throw new Error(errorData.error || 'Tournoi non trouv√©');
        }

        const data = await response.json();
        console.log('Data received:', data);

        // Display tournament info
        const isFinale = data.tournament.tournament_number === 4;
        const tournamentLabel = isFinale ? 'Finale D√©partementale' : `Tournoi ${data.tournament.tournament_number}`;
        document.getElementById('tournamentTitle').textContent =
          `${data.tournament.display_name} - ${tournamentLabel}`;
        document.getElementById('tournamentSeason').textContent = data.tournament.season;
        document.getElementById('tournamentDate').textContent =
          data.tournament.tournament_date
            ? new Date(data.tournament.tournament_date).toLocaleDateString('fr-FR')
            : 'Non sp√©cifi√©e';
        document.getElementById('participantCount').textContent = data.results.length;

        // Sort results by match points desc, then moyenne desc
        data.results.sort((a, b) => {
          if (b.match_points !== a.match_points) {
            return b.match_points - a.match_points;
          }
          return b.moyenne - a.moyenne;
        });

        // Show podium for finale
        if (isFinale && data.results.length >= 3) {
          displayPodium(data.results.slice(0, 3));
        }

        // Set table title based on tournament type
        document.getElementById('tableTitle').textContent =
          isFinale ? 'Classement de la Finale D√©partementale' : 'Classement du Tournoi';

        // Display results
        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = '';

        data.results.forEach((result, index) => {
          const row = document.createElement('tr');

          // Highlight top 3
          if (index === 0) row.classList.add('rank-1');
          if (index === 1) row.classList.add('rank-2');
          if (index === 2) row.classList.add('rank-3');

          // Calculate moyenne as points / reprises
          const moyenne = result.reprises > 0
            ? (result.points / result.reprises).toFixed(3)
            : '0.000';

          // Format player name as "FirstName LastName" (consistent with global ranking)
          const playerName = result.first_name && result.last_name
            ? `${result.first_name} ${result.last_name}`
            : result.player_name;

          // Create cells individually to use innerHTML for club logo
          row.innerHTML = `
            <td style="text-align: center; font-weight: bold;">${index + 1}</td>
            <td>${result.licence}</td>
            <td>
              <a href="player-history.html?licence=${result.licence}" class="player-link">
                ${playerName}
              </a>
            </td>
            <td></td>
            <td style="text-align: center; font-weight: bold;">${result.match_points}</td>
            <td style="text-align: center;">${result.points}</td>
            <td style="text-align: center;">${result.reprises}</td>
            <td style="text-align: center;">${moyenne}</td>
            <td style="text-align: center;">${result.serie}</td>
          `;

          // Set club logo HTML separately
          const clubCell = row.cells[3];
          clubCell.innerHTML = getClubLogoHTML(result.club_name);

          tbody.appendChild(row);
        });

        document.getElementById('loadingTournament').style.display = 'none';
        document.getElementById('tournamentContent').style.display = 'block';

        // Update rankings link with category ID
        const rankingsBtn = document.getElementById('viewRankingsBtn');
        if (data.tournament.category_id) {
          rankingsBtn.href = `rankings.html?categoryId=${data.tournament.category_id}`;
        } else {
          rankingsBtn.href = 'rankings.html';
        }

      } catch (error) {
        console.error('Error loading tournament results:', error);
        document.getElementById('loadingTournament').style.display = 'none';
        document.getElementById('errorMessage').textContent = `Erreur: ${error.message}`;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Display podium for finale
    function displayPodium(topThree) {
      const podiumCard = document.getElementById('podiumCard');
      const podiumContainer = document.getElementById('podiumContainer');

      podiumCard.style.display = 'block';
      podiumContainer.innerHTML = '';

      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const positions = ['1er', '2√®me', '3√®me'];

      topThree.forEach((result, index) => {
        const moyenne = result.reprises > 0
          ? (result.points / result.reprises).toFixed(3)
          : '0.000';

        // Format player name as "FirstName LastName"
        const playerName = result.first_name && result.last_name
          ? `${result.first_name} ${result.last_name}`
          : result.player_name;

        const podiumPlace = document.createElement('div');
        podiumPlace.className = 'podium-place';

        podiumPlace.innerHTML = `
          <div class="podium-medal">${medals[index]}</div>
          <div class="podium-player">
            <div class="podium-rank">${positions[index]}</div>
            <div class="podium-name">${playerName}</div>
            <div class="podium-stats">
              <strong>${result.match_points}</strong> pts match<br>
              Moy: <strong>${moyenne}</strong><br>
              Meilleure S√©rie: <strong>${result.serie || 0}</strong><br>
              <div class="podium-club-container"></div>
            </div>
          </div>
          <div class="podium-base">${index + 1}</div>
        `;

        // Set club logo HTML separately
        const clubContainer = podiumPlace.querySelector('.podium-club-container');
        clubContainer.innerHTML = getClubLogoForPodium(result.club_name);

        podiumContainer.appendChild(podiumPlace);
      });
    }

    // Export to Excel
    document.getElementById('exportExcelBtn').addEventListener('click', async () => {
      try {
        const response = await fetch(`${API_URL}/tournaments/${tournamentId}/export`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors de l\'export');
        }

        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `Resultats_Tournoi_${tournamentId}.xlsx`; // fallback
        if (contentDisposition) {
          const matches = /filename="([^"]+)"/.exec(contentDisposition);
          if (matches && matches[1]) {
            filename = matches[1];
          }
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Erreur lors de l\'export Excel');
      }
    });
  </script>
</body>
</html>
