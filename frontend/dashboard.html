<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="ğŸ±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">ğŸ±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="active">Accueil</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">Fichiers</button>
          <div class="nav-dropdown-content">
            <a href="players-list.html"><span class="nav-icon">ğŸ‘¥</span> Joueurs</a>
            <a href="tournaments-list.html"><span class="nav-icon">ğŸ†</span> CompÃ©titions jouÃ©es</a>
            <a href="tournois-list.html"><span class="nav-icon">ğŸ“‹</span> Tournois (IONOS)</a>
            <a href="inscriptions-list.html"><span class="nav-icon">ğŸ“</span> Inscriptions (IONOS)</a>
            <a href="clubs.html"><span class="nav-icon">ğŸ¢</span> Clubs</a>
            <div class="nav-divider admin-only"></div>
            <a href="import-external.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import CompÃ©titions</a>
            <a href="import-players.html" class="admin-only"><span class="nav-icon">ğŸ“¥</span> Import Joueurs</a>
            <a href="import-tournament.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import Tournoi</a>
          </div>
        </div>

        <a href="rankings.html">Classements</a>
        <a href="tournaments-list.html">CompÃ©titions jouÃ©es</a>
        <a href="generate-poules.html">CompÃ©titions Ã  jouer</a>
        <a href="emailing.html">Emailing</a>
        <a href="statistiques.html">Statistiques</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">ParamÃ¨tres</button>
          <div class="nav-dropdown-content">
            <a href="settings.html"><span class="nav-icon">âš™ï¸</span> Configuration</a>
            <a href="calendar.html"><span class="nav-icon">ğŸ“…</span> Calendrier</a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-logout">DÃ©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Season selector -->
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
      <label style="font-weight: bold; color: #333;">Saison :</label>
      <select id="seasonSelect" style="padding: 8px 15px; border: 2px solid #1F4788; border-radius: 8px; font-size: 16px; font-weight: bold; color: #1F4788; background: white; cursor: pointer; min-width: 150px;">
        <option value="">Chargement...</option>
      </select>
    </div>

    <!-- Joueurs stats -->
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card">
        <h4>Joueurs Actifs</h4>
        <div class="stat-value" id="activePlayerCount">-</div>
      </div>
      <div class="stat-card">
        <h4>CompÃ©titions jouÃ©es</h4>
        <div class="stat-value" id="tournamentCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Participants cumulÃ©s</h4>
        <div class="stat-value" id="cumulativeParticipants">-</div>
      </div>
    </div>

    <!-- Inscriptions saison en cours (green) -->
    <h4 id="inscSectionTitle" style="margin: 20px 0 10px 0; color: #666;">Inscriptions saison en cours</h4>
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Total</h4>
        <div class="stat-value" id="inscTotalSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>ConvoquÃ©s</h4>
        <div class="stat-value" id="inscConvoquesSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Forfaits</h4>
        <div class="stat-value" id="inscForfaitsSeason">-</div>
      </div>
    </div>

    <!-- CompÃ©titions saison en cours (green) -->
    <h4 id="tournoiSectionTitle" style="margin: 20px 0 10px 0; color: #666;">CompÃ©titions saison en cours</h4>
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Total</h4>
        <div class="stat-value" id="tournoiTotalSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>A venir</h4>
        <div class="stat-value" id="tournoiUpcomingSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>PassÃ©s</h4>
        <div class="stat-value" id="tournoiPastSeason">-</div>
      </div>
    </div>

    <div class="card">
      <h3>Actions Rapides</h3>
      <div class="action-buttons">
        <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
          Importer un Tournoi
        </button>
        <button class="btn" onclick="window.location.href='generate-poules.html'">
          CompÃ©titions Ã  jouer
        </button>
        <button class="btn" onclick="window.location.href='rankings.html'">
          Voir les Classements
        </button>
        <button class="btn" onclick="window.location.href='calendar.html'">
          Calendrier
        </button>
        <button class="btn" onclick="window.location.href='players-list.html'">
          Joueurs
        </button>
      </div>
    </div>

  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Get season for a given date (Sept-Aug cycle)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Current selected season
    let selectedSeason = getSeasonForDate(new Date());

    // Load available seasons and populate selector
    async function loadSeasons() {
      try {
        const response = await fetch(`${API_URL}/statistics/seasons`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const seasons = await response.json();
          const select = document.getElementById('seasonSelect');
          select.innerHTML = '';

          // Add current season if not in list
          const currentSeason = getSeasonForDate(new Date());
          if (!seasons.includes(currentSeason)) {
            seasons.unshift(currentSeason);
          }

          seasons.forEach(season => {
            const option = document.createElement('option');
            option.value = season;
            option.textContent = season;
            if (season === selectedSeason) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading seasons:', error);
      }
    }

    // Season selector change handler
    document.getElementById('seasonSelect').addEventListener('change', (e) => {
      selectedSeason = e.target.value;
      loadDashboardStats();
    });

    // Load dashboard data
    async function loadDashboard() {
      await loadSeasons();
      await loadDashboardStats();
    }

    // Load all stats for selected season
    async function loadDashboardStats() {
      try {
        // Load player counts (global - not season specific)
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
        }

        // Load tournaments (played) for selected season
        const tournamentsResponse = await fetch(`${API_URL}/tournaments?season=${selectedSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Calculate cumulative participants (sum of all player_count from tournaments)
          const cumulativeParticipants = tournaments.reduce((sum, t) => sum + (parseInt(t.player_count, 10) || 0), 0);
          document.getElementById('cumulativeParticipants').textContent = cumulativeParticipants;
        }

        // Load inscriptions and tournois IONOS stats
        await loadInscriptionsStats();
        await loadTournoisStats();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Get season for a tournoi, handling finals specially
    // Finals played in September belong to the PREVIOUS season
    function getSeasonForTournoi(tournoi) {
      if (!tournoi || !tournoi.debut) return null;
      const date = new Date(tournoi.debut);
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      const isFinale = tournoi.nom && tournoi.nom.toLowerCase().includes('finale');

      // Finals in September belong to previous season
      if (isFinale && month === 8) { // September
        return `${year - 1}-${year}`;
      }

      // Regular season calculation
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Load inscriptions stats for selected season
    async function loadInscriptionsStats() {
      try {
        // Load inscriptions
        const inscResponse = await fetch(`${API_URL}/inscriptions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Load tournois for season reference
        const tournoisResponse = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (inscResponse.ok && tournoisResponse.ok) {
          const inscriptions = await inscResponse.json();
          const tournois = await tournoisResponse.json();

          // Create tournoi lookup by ID
          const tournoiMap = {};
          tournois.forEach(t => { tournoiMap[t.tournoi_id] = t; });

          // Filter by selected season
          const seasonInscriptions = inscriptions.filter(i => {
            const tournoi = tournoiMap[i.tournoi_id];
            if (!tournoi) return false;
            return getSeasonForTournoi(tournoi) === selectedSeason;
          });

          const totalSeason = seasonInscriptions.length;
          const convoquesSeason = seasonInscriptions.filter(i => i.convoque === 1).length;
          const forfaitsSeason = seasonInscriptions.filter(i => i.forfait === 1).length;

          // Update section title with season
          document.getElementById('inscSectionTitle').textContent = `Inscriptions saison ${selectedSeason}`;

          // Update values
          document.getElementById('inscTotalSeason').textContent = totalSeason;
          document.getElementById('inscConvoquesSeason').textContent = convoquesSeason;
          document.getElementById('inscForfaitsSeason').textContent = forfaitsSeason;
        }
      } catch (error) {
        console.error('Error loading inscriptions stats:', error);
      }
    }

    // Load tournois stats for selected season
    // Uses tournaments table (played) for PassÃ©s, tournoi_ext for A venir
    // Total = PassÃ©s + A venir to ensure consistency
    async function loadTournoisStats() {
      try {
        // Get played competitions from tournaments table (like Statistics page)
        const response = await fetch(`${API_URL}/tournaments?season=${selectedSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Get upcoming from tournoi_ext (future scheduled competitions)
        const tournoiResponse = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const tournaments = await response.json();
          const pastSeason = tournaments.length; // Played competitions for this season

          // Calculate upcoming from tournoi_ext (future dates only, for selected season)
          let upcomingSeason = 0;
          if (tournoiResponse.ok) {
            const tournois = await tournoiResponse.json();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter by season, then count only future dates
            const seasonTournois = tournois.filter(t => getSeasonForTournoi(t) === selectedSeason);
            upcomingSeason = seasonTournois.filter(t => {
              const debut = t.debut ? new Date(t.debut) : null;
              return debut && debut >= today;
            }).length;
          }

          // Total = PassÃ©s + A venir (ensures math is consistent)
          const totalSeason = pastSeason + upcomingSeason;

          // Update section title with season
          document.getElementById('tournoiSectionTitle').textContent = `CompÃ©titions saison ${selectedSeason}`;

          // Update values
          document.getElementById('tournoiTotalSeason').textContent = totalSeason;
          document.getElementById('tournoiUpcomingSeason').textContent = upcomingSeason;
          document.getElementById('tournoiPastSeason').textContent = pastSeason;
        }
      } catch (error) {
        console.error('Error loading tournois stats:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
