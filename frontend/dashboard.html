<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="ğŸ±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">ğŸ±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="active">Accueil</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">Fichiers</button>
          <div class="nav-dropdown-content">
            <a href="players-list.html"><span class="nav-icon">ğŸ‘¥</span> Joueurs</a>
            <a href="tournaments-list.html"><span class="nav-icon">ğŸ†</span> CompÃ©titions jouÃ©es</a>
            <a href="tournois-list.html"><span class="nav-icon">ğŸ“‹</span> Tournois (IONOS)</a>
            <a href="inscriptions-list.html"><span class="nav-icon">ğŸ“</span> Inscriptions (IONOS)</a>
            <a href="clubs.html"><span class="nav-icon">ğŸ¢</span> Clubs</a>
            <div class="nav-divider admin-only"></div>
            <a href="import-external.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import CompÃ©titions</a>
            <a href="import-players.html" class="admin-only"><span class="nav-icon">ğŸ“¥</span> Import Joueurs</a>
            <a href="import-tournament.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import Tournoi</a>
          </div>
        </div>

        <a href="rankings.html">Classements</a>
        <a href="statistiques.html">Statistiques</a>
        <a href="tournaments-list.html">CompÃ©titions jouÃ©es</a>
        <a href="generate-poules.html">CompÃ©titions Ã  jouer</a>
        <a href="emailing.html">Emailing</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">ParamÃ¨tres</button>
          <div class="nav-dropdown-content">
            <a href="settings.html"><span class="nav-icon">âš™ï¸</span> Configuration</a>
            <a href="calendar.html"><span class="nav-icon">ğŸ“…</span> Calendrier</a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-logout">DÃ©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Joueurs stats -->
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card">
        <h4>Joueurs Actifs</h4>
        <div class="stat-value" id="activePlayerCount">-</div>
      </div>
      <div class="stat-card">
        <h4>CompÃ©titions jouÃ©es</h4>
        <div class="stat-value" id="tournamentCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Participants cumulÃ©s</h4>
        <div class="stat-value" id="cumulativeParticipants">-</div>
      </div>
    </div>

    <!-- Inscriptions saison en cours (green) -->
    <h4 id="inscSectionTitle" style="margin: 20px 0 10px 0; color: #666;">Inscriptions saison en cours</h4>
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Total</h4>
        <div class="stat-value" id="inscTotalSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>ConvoquÃ©s</h4>
        <div class="stat-value" id="inscConvoquesSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Forfaits</h4>
        <div class="stat-value" id="inscForfaitsSeason">-</div>
      </div>
    </div>

    <!-- CompÃ©titions saison en cours (green) -->
    <h4 id="tournoiSectionTitle" style="margin: 20px 0 10px 0; color: #666;">CompÃ©titions saison en cours</h4>
    <div class="stats-grid" style="margin-bottom: 20px;">
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>Total</h4>
        <div class="stat-value" id="tournoiTotalSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>A venir</h4>
        <div class="stat-value" id="tournoiUpcomingSeason">-</div>
      </div>
      <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h4>PassÃ©s</h4>
        <div class="stat-value" id="tournoiPastSeason">-</div>
      </div>
    </div>

    <div class="card">
      <h3>Actions Rapides</h3>
      <div class="action-buttons">
        <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
          Importer un Tournoi
        </button>
        <button class="btn" onclick="window.location.href='generate-poules.html'">
          CompÃ©titions Ã  jouer
        </button>
        <button class="btn" onclick="window.location.href='rankings.html'">
          Voir les Classements
        </button>
        <button class="btn" onclick="window.location.href='calendar.html'">
          Calendrier
        </button>
        <button class="btn" onclick="window.location.href='players-list.html'">
          Joueurs
        </button>
      </div>
    </div>

  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Get season for a given date (Sept-Aug cycle)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load player counts
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
        }

        // Load tournaments (played) for current season
        const currentSeasonForTournaments = getSeasonForDate(new Date());
        const tournamentsResponse = await fetch(`${API_URL}/tournaments?season=${currentSeasonForTournaments}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Calculate cumulative participants (sum of all player_count from tournaments)
          const cumulativeParticipants = tournaments.reduce((sum, t) => sum + (parseInt(t.player_count, 10) || 0), 0);
          document.getElementById('cumulativeParticipants').textContent = cumulativeParticipants;
        }

        // Load inscriptions and tournois IONOS stats
        await loadInscriptionsStats();
        await loadTournoisStats();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Load inscriptions stats (current season only)
    async function loadInscriptionsStats() {
      try {
        // Load inscriptions
        const inscResponse = await fetch(`${API_URL}/inscriptions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Load tournois for season reference
        const tournoisResponse = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (inscResponse.ok && tournoisResponse.ok) {
          const inscriptions = await inscResponse.json();
          const tournois = await tournoisResponse.json();

          // Create tournoi lookup by ID
          const tournoiMap = {};
          tournois.forEach(t => { tournoiMap[t.tournoi_id] = t; });

          // Current season stats - use the saison field from tournoi records
          const currentSeason = getSeasonForDate(new Date());
          const seasonInscriptions = inscriptions.filter(i => {
            const tournoi = tournoiMap[i.tournoi_id];
            if (!tournoi) return false;
            // Use the saison field directly instead of calculating from date
            return tournoi.saison === currentSeason;
          });

          const totalSeason = seasonInscriptions.length;
          const convoquesSeason = seasonInscriptions.filter(i => i.convoque === 1).length;
          const forfaitsSeason = seasonInscriptions.filter(i => i.forfait === 1).length;

          // Update section title with season
          document.getElementById('inscSectionTitle').textContent = `Inscriptions saison ${currentSeason}`;

          // Update values
          document.getElementById('inscTotalSeason').textContent = totalSeason;
          document.getElementById('inscConvoquesSeason').textContent = convoquesSeason;
          document.getElementById('inscForfaitsSeason').textContent = forfaitsSeason;
        }
      } catch (error) {
        console.error('Error loading inscriptions stats:', error);
      }
    }

    // Load tournois stats (current season only)
    async function loadTournoisStats() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const tournois = await response.json();
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          // Current season stats - use the saison field from tournoi records
          const currentSeason = getSeasonForDate(new Date());
          const seasonTournois = tournois.filter(t => {
            // Use the saison field directly instead of calculating from date
            // This properly handles finals that belong to previous season but played in September
            return t.saison === currentSeason;
          });

          const totalSeason = seasonTournois.length;
          const upcomingSeason = seasonTournois.filter(t => {
            const debut = t.debut ? new Date(t.debut) : null;
            return debut && debut >= today;
          }).length;
          const pastSeason = seasonTournois.filter(t => {
            const debut = t.debut ? new Date(t.debut) : null;
            return debut && debut < today;
          }).length;

          // Update section title with season
          document.getElementById('tournoiSectionTitle').textContent = `CompÃ©titions saison ${currentSeason}`;

          // Update values
          document.getElementById('tournoiTotalSeason').textContent = totalSeason;
          document.getElementById('tournoiUpcomingSeason').textContent = upcomingSeason;
          document.getElementById('tournoiPastSeason').textContent = pastSeason;
        }
      } catch (error) {
        console.error('Error loading tournois stats:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
