<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <div>
        <h2 style="margin-bottom: 0;"><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> CDBHS Tournois</h2>
        <span style="font-size: 11px; color: #888; margin-left: 36px;">V2.0</span>
      </div>
      <div class="nav-links">
        <a href="dashboard.html" class="active">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="emailing.html" class="admin-only">Emailing</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Tournament Alerts - Admin Only (Ultra Compact) -->
    <div id="tournamentAlertsCard" class="admin-only" style="display: none; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 10px; padding: 6px 10px; border-radius: 4px;">
      <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
        <span style="font-size: 13px; color: #856404; font-weight: bold;">‚ö†Ô∏è Relances:</span>
        <div id="tournamentAlertsList" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
      </div>
    </div>

    <!-- Actions Rapides -->
    <div class="card" style="margin-bottom: 15px; padding: 15px;">
      <h3 style="margin-top: 0; margin-bottom: 12px;">Actions Rapides</h3>
      <div class="action-buttons">
        <button class="btn" style="background: #dc3545;" onclick="window.location.href='generate-poules.html'">
          Comp√©titions √† jouer
        </button>
        <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
          Importer une comp√©tition
        </button>
        <button class="btn" onclick="window.location.href='tournaments-list.html'">
          Comp√©titions jou√©es
        </button>
        <button class="btn" onclick="window.location.href='rankings.html'">
          Voir les Classements
        </button>
        <button class="btn" onclick="window.location.href='calendar.html'">
          Calendrier
        </button>
      </div>
    </div>

    <!-- Season selector -->
    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
      <label style="font-weight: bold; color: #333; font-size: 13px;">Saison :</label>
      <select id="seasonSelect" style="padding: 5px 10px; border: 2px solid #1F4788; border-radius: 6px; font-size: 14px; font-weight: bold; color: #1F4788; background: white; cursor: pointer;">
        <option value="">Chargement...</option>
      </select>
    </div>

    <!-- Compact Stats Grid -->
    <style>
      .compact-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px; }
      .compact-stat { padding: 12px; border-radius: 8px; text-align: center; color: white; }
      .compact-stat h5 { margin: 0 0 4px 0; font-size: 11px; opacity: 0.9; text-transform: uppercase; }
      .compact-stat .val { font-size: 28px; font-weight: bold; line-height: 1; }
      .compact-section-title { font-size: 12px; color: #666; margin: 8px 0 6px 0; font-weight: bold; }
    </style>

    <!-- Joueurs stats -->
    <div class="compact-stats">
      <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5>Joueurs Actifs</h5>
        <div class="val" id="activePlayerCount">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5>Comp√©titions jou√©es</h5>
        <div class="val" id="tournamentCount">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <h5>Participants cumul√©s</h5>
        <div class="val" id="cumulativeParticipants">-</div>
      </div>
    </div>

    <!-- Inscriptions saison en cours (green) -->
    <div class="compact-section-title" id="inscSectionTitle">Inscriptions saison 2025-2026</div>
    <div class="compact-stats">
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>Total</h5>
        <div class="val" id="inscTotalSeason">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>Convoqu√©s</h5>
        <div class="val" id="inscConvoquesSeason">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>Forfaits</h5>
        <div class="val" id="inscForfaitsSeason">-</div>
      </div>
    </div>

    <!-- Comp√©titions saison en cours (green) -->
    <div class="compact-section-title" id="tournoiSectionTitle">Comp√©titions saison 2025-2026</div>
    <div class="compact-stats">
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>Total</h5>
        <div class="val" id="tournoiTotalSeason">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>A venir</h5>
        <div class="val" id="tournoiUpcomingSeason">-</div>
      </div>
      <div class="compact-stat" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
        <h5>Pass√©s</h5>
        <div class="val" id="tournoiPastSeason">-</div>
      </div>
    </div>

  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
      // Load tournament alerts for admins
      loadTournamentAlerts();
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Load tournament alerts (tournaments needing relances + already sent)
    async function loadTournamentAlerts() {
      try {
        const response = await fetch(`${API_URL}/inscriptions/upcoming-relances`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) return;

        const data = await response.json();
        const alertsCard = document.getElementById('tournamentAlertsCard');
        const alertsList = document.getElementById('tournamentAlertsList');

        // Separate tournaments into pending and already sent
        const needsRelance = data.needs_relance || [];
        const alreadySent = (data.all_upcoming || []).filter(t => t.relance_sent_at);

        if (needsRelance.length > 0 || alreadySent.length > 0) {
          alertsCard.style.display = 'block';

          let html = '';

          // Show pending relances first (orange/red badges)
          if (needsRelance.length > 0) {
            html += needsRelance.map(tournoi => {
              const dateObj = new Date(tournoi.debut);
              const daysLeft = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
              const urgentColor = daysLeft <= 7 ? '#dc3545' : '#ffc107';
              const lieu = (tournoi.lieu || '').replace(/'/g, "\\'");
              const debut = tournoi.debut || '';

              return `
                <div style="display: inline-flex; align-items: center; gap: 2px;">
                  <button onclick="goToRelance(${tournoi.tournoi_id}, '${tournoi.mode}', '${tournoi.categorie}', '${tournoi.nom.replace(/'/g, "\\'")}', '${lieu}', '${debut}')"
                          style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: white; border: 1px solid ${urgentColor}; border-radius: 4px 0 0 4px; font-size: 12px; cursor: pointer; white-space: nowrap;">
                    <span style="color: #333; font-weight: 500;">${tournoi.nom}</span>
                    <span style="color: #666;">${tournoi.mode} ${tournoi.categorie}</span>
                    ${lieu ? `<span style="color: #17a2b8;">${lieu}</span>` : ''}
                    <span style="color: ${urgentColor}; font-weight: bold;">(${daysLeft}j)</span>
                    <span style="background: ${urgentColor}; color: ${urgentColor === '#ffc107' ? '#333' : 'white'}; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Relancer</span>
                  </button>
                  <button onclick="markRelanceAsSent(${tournoi.tournoi_id})" title="Marquer comme d√©j√† envoy√©"
                          style="padding: 4px 8px; background: #28a745; border: 1px solid #28a745; border-radius: 0 4px 4px 0; font-size: 12px; cursor: pointer; color: white;">‚úì</button>
                </div>
              `;
            }).join('');
          }

          // Show already sent relances (green badges)
          if (alreadySent.length > 0) {
            html += alreadySent.map(tournoi => {
              const dateObj = new Date(tournoi.debut);
              const daysLeft = Math.ceil((dateObj - new Date()) / (1000 * 60 * 60 * 24));
              const lieu = (tournoi.lieu || '').replace(/'/g, "\\'");
              const debut = tournoi.debut || '';
              const sentDate = new Date(tournoi.relance_sent_at).toLocaleDateString('fr-FR');

              return `
                <button onclick="goToRelance(${tournoi.tournoi_id}, '${tournoi.mode}', '${tournoi.categorie}', '${tournoi.nom.replace(/'/g, "\\'")}', '${lieu}', '${debut}')"
                        style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: #f8f9fa; border: 1px solid #28a745; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap; opacity: 0.8;">
                  <span style="color: #333; font-weight: 500;">${tournoi.nom}</span>
                  <span style="color: #666;">${tournoi.mode} ${tournoi.categorie}</span>
                  ${lieu ? `<span style="color: #17a2b8;">${lieu}</span>` : ''}
                  <span style="color: #666;">(${daysLeft}j)</span>
                  <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;" title="Envoy√© le ${sentDate}">‚úì Envoy√©</span>
                </button>
              `;
            }).join('');
          }

          alertsList.innerHTML = html;
        } else {
          alertsCard.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading tournament alerts:', error);
      }
    }

    // Navigate to emailing page with tournament pre-selected
    function goToRelance(tournoiId, mode, categorie, nom, lieu, debut) {
      // Store the tournament info for the emailing page
      localStorage.setItem('relanceTournoi', JSON.stringify({ tournoiId, mode, categorie, nom, lieu, debut }));
      window.location.href = 'emailing.html?action=relance&tournoi=' + tournoiId;
    }

    // Mark a relance as sent without actually sending (for already-sent relances)
    async function markRelanceAsSent(tournoiId) {
      if (!confirm('Marquer cette relance comme d√©j√† envoy√©e ?')) return;

      try {
        const response = await fetch(`${API_URL}/inscriptions/relances/${tournoiId}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ recipients_count: 0 })
        });

        if (response.ok) {
          // Reload the alerts to show the updated status
          loadTournamentAlerts();
        } else {
          alert('Erreur lors du marquage de la relance');
        }
      } catch (error) {
        console.error('Error marking relance:', error);
        alert('Erreur: ' + error.message);
      }
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Get season for a given date (Sept-Aug cycle)
    function getSeasonForDate(date) {
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Current selected season
    let selectedSeason = getSeasonForDate(new Date());

    // Load available seasons and populate selector
    async function loadSeasons() {
      try {
        const response = await fetch(`${API_URL}/statistics/seasons`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const seasons = await response.json();
          const select = document.getElementById('seasonSelect');
          select.innerHTML = '';

          // Add current season if not in list
          const currentSeason = getSeasonForDate(new Date());
          if (!seasons.includes(currentSeason)) {
            seasons.unshift(currentSeason);
          }

          seasons.forEach(season => {
            const option = document.createElement('option');
            option.value = season;
            option.textContent = season;
            if (season === selectedSeason) {
              option.selected = true;
            }
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading seasons:', error);
      }
    }

    // Season selector change handler
    document.getElementById('seasonSelect').addEventListener('change', (e) => {
      selectedSeason = e.target.value;
      loadDashboardStats();
    });

    // Load dashboard data
    async function loadDashboard() {
      await loadSeasons();
      await loadDashboardStats();
    }

    // Load all stats for selected season
    async function loadDashboardStats() {
      try {
        // Load player counts (global - not season specific)
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
        }

        // Load tournaments (played) for selected season
        const tournamentsResponse = await fetch(`${API_URL}/tournaments?season=${selectedSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Calculate cumulative participants (sum of all player_count from tournaments)
          const cumulativeParticipants = tournaments.reduce((sum, t) => sum + (parseInt(t.player_count, 10) || 0), 0);
          document.getElementById('cumulativeParticipants').textContent = cumulativeParticipants;
        }

        // Load inscriptions and tournois IONOS stats
        await loadInscriptionsStats();
        await loadTournoisStats();

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    // Get season for a tournoi, handling finals specially
    // Finals played in September belong to the PREVIOUS season
    function getSeasonForTournoi(tournoi) {
      if (!tournoi || !tournoi.debut) return null;
      const date = new Date(tournoi.debut);
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      const isFinale = tournoi.nom && tournoi.nom.toLowerCase().includes('finale');

      // Finals in September belong to previous season
      if (isFinale && month === 8) { // September
        return `${year - 1}-${year}`;
      }

      // Regular season calculation
      if (month >= 8) {
        return `${year}-${year + 1}`;
      } else {
        return `${year - 1}-${year}`;
      }
    }

    // Load inscriptions stats for selected season
    async function loadInscriptionsStats() {
      try {
        // Load inscriptions
        const inscResponse = await fetch(`${API_URL}/inscriptions`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Load tournois for season reference
        const tournoisResponse = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (inscResponse.ok && tournoisResponse.ok) {
          const inscriptions = await inscResponse.json();
          const tournois = await tournoisResponse.json();

          // Create tournoi lookup by ID
          const tournoiMap = {};
          tournois.forEach(t => { tournoiMap[t.tournoi_id] = t; });

          // Filter by selected season
          const seasonInscriptions = inscriptions.filter(i => {
            const tournoi = tournoiMap[i.tournoi_id];
            if (!tournoi) return false;
            return getSeasonForTournoi(tournoi) === selectedSeason;
          });

          const totalSeason = seasonInscriptions.length;
          const convoquesSeason = seasonInscriptions.filter(i => i.convoque === 1).length;
          const forfaitsSeason = seasonInscriptions.filter(i => i.forfait === 1).length;

          // Update section title with season
          document.getElementById('inscSectionTitle').textContent = `Inscriptions saison ${selectedSeason}`;

          // Update values
          document.getElementById('inscTotalSeason').textContent = totalSeason;
          document.getElementById('inscConvoquesSeason').textContent = convoquesSeason;
          document.getElementById('inscForfaitsSeason').textContent = forfaitsSeason;
        }
      } catch (error) {
        console.error('Error loading inscriptions stats:', error);
      }
    }

    // Load tournois stats for selected season
    // Uses tournaments table (played) for Pass√©s, tournoi_ext for A venir
    // Total = Pass√©s + A venir to ensure consistency
    async function loadTournoisStats() {
      try {
        // Get played competitions from tournaments table (like Statistics page)
        const response = await fetch(`${API_URL}/tournaments?season=${selectedSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        // Get upcoming from tournoi_ext (future scheduled competitions)
        const tournoiResponse = await fetch(`${API_URL}/inscriptions/tournoi`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const tournaments = await response.json();
          const pastSeason = tournaments.length; // Played competitions for this season

          // Calculate upcoming from tournoi_ext (future dates only, for selected season)
          let upcomingSeason = 0;
          if (tournoiResponse.ok) {
            const tournois = await tournoiResponse.json();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter by season, then count only future dates
            const seasonTournois = tournois.filter(t => getSeasonForTournoi(t) === selectedSeason);
            upcomingSeason = seasonTournois.filter(t => {
              const debut = t.debut ? new Date(t.debut) : null;
              return debut && debut >= today;
            }).length;
          }

          // Total = Pass√©s + A venir (ensures math is consistent)
          const totalSeason = pastSeason + upcomingSeason;

          // Update section title with season
          document.getElementById('tournoiSectionTitle').textContent = `Comp√©titions saison ${selectedSeason}`;

          // Update values
          document.getElementById('tournoiTotalSeason').textContent = totalSeason;
          document.getElementById('tournoiUpcomingSeason').textContent = upcomingSeason;
          document.getElementById('tournoiPastSeason').textContent = pastSeason;
        }
      } catch (error) {
        console.error('Error loading tournois stats:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
