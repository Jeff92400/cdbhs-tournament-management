<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="ğŸ±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">ğŸ±</span> CDBHS Tournois</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="active">Accueil</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">Fichiers</button>
          <div class="nav-dropdown-content">
            <a href="players-list.html"><span class="nav-icon">ğŸ‘¥</span> Joueurs</a>
            <a href="tournaments-list.html"><span class="nav-icon">ğŸ†</span> Tournois jouÃ©s</a>
            <a href="tournois-list.html"><span class="nav-icon">ğŸ“‹</span> Tournois (IONOS)</a>
            <a href="inscriptions-list.html"><span class="nav-icon">ğŸ“</span> Inscriptions (IONOS)</a>
            <a href="clubs.html"><span class="nav-icon">ğŸ¢</span> Clubs</a>
            <div class="nav-divider admin-only"></div>
            <a href="import-external.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import CompÃ©titions</a>
            <a href="import-players.html" class="admin-only"><span class="nav-icon">ğŸ“¥</span> Import Joueurs</a>
            <a href="import-tournament.html" class="admin-only"><span class="nav-icon">ğŸ“¤</span> Import Tournoi</a>
          </div>
        </div>

        <a href="rankings.html">Classements</a>
        <a href="tournaments-list.html">Tournois jouÃ©s</a>
        <a href="generate-poules.html">Tournois Ã  jouer</a>
        <a href="emailing.html">Emailing</a>

        <div class="nav-dropdown admin-only">
          <button class="nav-dropdown-btn">ParamÃ¨tres</button>
          <div class="nav-dropdown-content">
            <a href="settings.html"><span class="nav-icon">âš™ï¸</span> Configuration</a>
            <a href="calendar.html"><span class="nav-icon">ğŸ“…</span> Calendrier</a>
          </div>
        </div>

        <a href="#" id="logoutBtn" class="nav-logout">DÃ©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="stats-grid">
      <div class="stat-card">
        <h4>Joueurs Actifs</h4>
        <div class="stat-value" id="activePlayerCount">-</div>
      </div>
      <div class="stat-card">
        <h4>CompÃ©titions jouÃ©es</h4>
        <div class="stat-value" id="tournamentCount">-</div>
      </div>
      <div class="stat-card">
        <h4>Participants cumulÃ©s</h4>
        <div class="stat-value" id="cumulativeParticipants">-</div>
      </div>
    </div>

    <div class="card">
      <h3>Actions Rapides</h3>
      <div class="action-buttons">
        <button class="btn btn-success admin-only" onclick="window.location.href='import-tournament.html'">
          Importer un Tournoi
        </button>
        <button class="btn" onclick="window.location.href='generate-poules.html'">
          Tournois Ã  jouer
        </button>
        <button class="btn" onclick="window.location.href='rankings.html'">
          Voir les Classements
        </button>
        <button class="btn" onclick="window.location.href='calendar.html'">
          Calendrier
        </button>
        <button class="btn" onclick="window.location.href='players-list.html'">
          Joueurs
        </button>
      </div>
    </div>

  </div>

  <script>
    const API_URL = '/api';

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and show/hide admin elements
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load player counts
        const allPlayersResponse = await fetch(`${API_URL}/players`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (allPlayersResponse.status === 401 || allPlayersResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (allPlayersResponse.ok) {
          const allPlayers = await allPlayersResponse.json();
          const activePlayers = allPlayers.filter(p => p.is_active === 1);
          document.getElementById('activePlayerCount').textContent = activePlayers.length;
        }

        // Load tournaments
        const tournamentsResponse = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (tournamentsResponse.status === 401 || tournamentsResponse.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }

        if (tournamentsResponse.ok) {
          const tournaments = await tournamentsResponse.json();
          document.getElementById('tournamentCount').textContent = tournaments.length;

          // Calculate cumulative participants (sum of all player_count from tournaments)
          const cumulativeParticipants = tournaments.reduce((sum, t) => sum + (parseInt(t.player_count, 10) || 0), 0);
          document.getElementById('cumulativeParticipants').textContent = cumulativeParticipants;
        }
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
