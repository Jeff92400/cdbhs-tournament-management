<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ParamÃ¨tres - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .settings-hub {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .settings-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e0e0e0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .settings-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .settings-card h4 {
      margin: 0 0 8px 0;
      color: #1F4788;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings-card h4 .icon {
      font-size: 24px;
    }
    .settings-card p {
      color: #666;
      font-size: 13px;
      margin: 0 0 15px 0;
      line-height: 1.4;
    }
    .settings-card .card-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .settings-card .card-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
      transition: background 0.2s;
    }
    .settings-card .card-link:hover {
      background: #e9ecef;
    }
    .settings-card .card-link .link-icon {
      font-size: 16px;
    }
    .section-title {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 30px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    .section-title:first-of-type {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="ğŸ±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">ğŸ±</span> ParamÃ¨tres</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par catÃ©gorie de jeu au fur et Ã  mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="CompÃ©titions Ã  jouer / Convocations">CompÃ©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, rÃ©sultats, convocation">Com joueurs</a>
        <a href="activity-logs.html" class="admin-only nav-tooltip" data-tooltip="Logs d'activitÃ© Player App">Logs</a>
        <a href="settings.html" class="active">ParamÃ¨tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">DÃ©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Personal Settings Card - For All Users -->
    <div class="card" style="margin-bottom: 20px;">
      <h3 style="margin-top: 0;">Mes paramÃ¨tres</h3>
      <form id="mySettingsForm">
        <div class="form-group">
          <label for="myEmail">Mon email :</label>
          <input type="email" id="myEmail" placeholder="ex: mon.email@exemple.com" style="width: 100%; max-width: 400px;">
          <small style="color: #666; display: block; margin-top: 5px;">UtilisÃ© pour la rÃ©initialisation du mot de passe et les notifications</small>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="myTournamentAlerts" style="width: 20px; height: 20px; cursor: pointer;">
            <span>Recevoir les alertes de tournois Ã  venir</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Enregistrer mes paramÃ¨tres</button>
      </form>
      <div id="mySettingsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Admin Settings Hub -->
    <div class="admin-only">
      <h3 class="section-title">Applications</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ“±</span> Espace Joueur</h4>
          <p>Application mobile pour les joueurs : inscriptions, classements, rÃ©sultats.</p>
          <div class="card-links">
            <a href="#" id="openPlayerAppBtn" class="card-link" style="background: #1F4788; color: white;">
              <span class="link-icon">ğŸš€</span> Ouvrir l'Espace Joueur
            </a>
          </div>
        </div>
      </div>

      <h3 class="section-title">Gestion des fichiers</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ‘¥</span> Joueurs</h4>
          <p>Consulter et gÃ©rer la liste des joueurs du comitÃ©.</p>
          <div class="card-links">
            <a href="players-list.html" class="card-link"><span class="link-icon">ğŸ“‹</span> Liste des joueurs</a>
            <a href="import-players.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer des joueurs</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ†</span> CompÃ©titions</h4>
          <p>GÃ©rer les compÃ©titions jouÃ©es et leurs rÃ©sultats.</p>
          <div class="card-links">
            <a href="tournaments-list.html" class="card-link"><span class="link-icon">ğŸ“‹</span> CompÃ©titions jouÃ©es</a>
            <a href="import-tournament.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer une compÃ©tition</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“…</span> Tournois CDBHS</h4>
          <p>GÃ©rer les tournois et inscriptions depuis IONOS.</p>
          <div class="card-links">
            <a href="tournois-list.html" class="card-link"><span class="link-icon">ğŸ“‹</span> Liste des tournois</a>
            <a href="inscriptions-list.html" class="card-link"><span class="link-icon">ğŸ“</span> Inscriptions</a>
            <a href="import-external.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer inscriptions</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ¢</span> Clubs</h4>
          <p>GÃ©rer les clubs et leurs logos.</p>
          <div class="card-links">
            <a href="clubs.html" class="card-link"><span class="link-icon">ğŸ“‹</span> Liste des clubs</a>
          </div>
        </div>
      </div>

      <h3 class="section-title">Configuration</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ‘¤</span> Utilisateurs</h4>
          <p>GÃ©rer les comptes administrateurs et viewers.</p>
          <div class="card-links">
            <a href="settings-admin.html#userManagementSection" class="card-link"><span class="link-icon">âš™ï¸</span> Gestion des utilisateurs</a>
            <a href="player-accounts.html" class="card-link"><span class="link-icon">ğŸ“±</span> Comptes Espace Joueur</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ¯</span> CatÃ©gories</h4>
          <p>Configurer les paramÃ¨tres des Ã©preuves et correspondances.</p>
          <div class="card-links">
            <a href="settings-admin.html#gameParametersSection" class="card-link"><span class="link-icon">âš™ï¸</span> ParamÃ¨tres des Ã©preuves</a>
            <a href="settings-admin.html#categoryMappingsSection" class="card-link"><span class="link-icon">ğŸ”—</span> Correspondances IONOS</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“§</span> Email</h4>
          <p>Configurer les paramÃ¨tres d'envoi d'emails.</p>
          <div class="card-links">
            <a href="emailing.html" class="card-link"><span class="link-icon">âœ‰ï¸</span> Envoyer des emails</a>
            <a href="settings-admin.html#contactEmailSection" class="card-link"><span class="link-icon">âš™ï¸</span> Email de contact</a>
            <a href="settings-admin.html#emailSchedulerSection" class="card-link"><span class="link-icon">ğŸ•</span> Planification</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“†</span> Calendrier</h4>
          <p>GÃ©rer le calendrier de la saison.</p>
          <div class="card-links">
            <a href="calendar.html" class="card-link"><span class="link-icon">ğŸ“„</span> Voir / TÃ©lÃ©verser</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“Š</span> Statistiques</h4>
          <p>Consulter les statistiques du comitÃ©.</p>
          <div class="card-links">
            <a href="statistiques.html" class="card-link"><span class="link-icon">ğŸ“ˆ</span> Voir les statistiques</a>
          </div>
        </div>

        <div class="settings-card admin-only">
          <h4><span class="icon">ğŸ”§</span> Maintenance</h4>
          <p>Outils de maintenance pour corriger les donnÃ©es.</p>
          <div class="card-links">
            <a href="settings-admin.html#maintenanceSection" class="card-link"><span class="link-icon">ğŸ“Š</span> Recalculer les moyennes</a>
            <a href="settings-admin.html#maintenanceSection" class="card-link"><span class="link-icon">ğŸ†</span> Recalculer les classements</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    const userRole = localStorage.getItem('userRole');

    // Show/hide admin elements
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = userRole === 'admin' ? '' : 'none';
    });

    // Load my settings
    async function loadMySettings() {
      try {
        const response = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const user = await response.json();
          document.getElementById('myEmail').value = user.email || '';
          document.getElementById('myTournamentAlerts').checked = user.receive_tournament_alerts === true;
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    loadMySettings();

    // Save my settings
    document.getElementById('mySettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('mySettingsMessage');

      try {
        const response = await fetch(`${API_URL}/auth/me/settings`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: document.getElementById('myEmail').value,
            receive_tournament_alerts: document.getElementById('myTournamentAlerts').checked
          })
        });

        if (response.ok) {
          messageDiv.textContent = 'ParamÃ¨tres enregistrÃ©s avec succÃ¨s';
          messageDiv.style.background = '#d4edda';
          messageDiv.style.color = '#155724';
        } else {
          const data = await response.json();
          messageDiv.textContent = data.error || 'Erreur lors de la sauvegarde';
          messageDiv.style.background = '#f8d7da';
          messageDiv.style.color = '#721c24';
        }
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
      } catch (error) {
        messageDiv.textContent = 'Erreur de connexion';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.display = 'block';
      }
    });

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Player App button
    document.getElementById('openPlayerAppBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const currentHost = window.location.hostname;
      let playerAppUrl;

      if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
        playerAppUrl = 'http://localhost:3001';
      } else {
        playerAppUrl = 'https://cdbhs-player-app-production.up.railway.app/?admin';
      }

      window.open(playerAppUrl, '_blank');
    });
  </script>
</body>
</html>
