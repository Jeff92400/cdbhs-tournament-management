<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-wrapper input {
      flex: 1;
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #666;
      padding: 5px;
    }
    .toggle-password:hover {
      color: #1F4788;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Param√®tres</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="btn" style="background: #1F4788; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; margin-right: 10px;">‚Üê Accueil</a>
        <a href="#" id="logoutBtn" class="btn" style="background: #dc3545; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none;">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <h3>Mon mot de passe</h3>
      <form id="changePasswordForm">
        <div class="form-group">
          <label for="oldPassword">Mot de passe actuel :</label>
          <div class="password-wrapper">
            <input type="password" id="oldPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('oldPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label for="newPassword">Nouveau mot de passe :</label>
          <div class="password-wrapper">
            <input type="password" id="newPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('newPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirmer le nouveau mot de passe :</label>
          <div class="password-wrapper">
            <input type="password" id="confirmPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
      </form>
    </div>

    <!-- My Settings Section -->
    <div class="card">
      <h3>Mes param√®tres</h3>
      <form id="mySettingsForm">
        <div class="form-group">
          <label for="myEmail">Mon email :</label>
          <input type="email" id="myEmail" placeholder="ex: mon.email@exemple.com" style="width: 100%; max-width: 400px;">
          <small style="color: #666; display: block; margin-top: 5px;">Utilis√© pour la r√©initialisation du mot de passe et les notifications</small>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="myTournamentAlerts" style="width: 20px; height: 20px; cursor: pointer;">
            <span>Recevoir les alertes de tournois √† venir</span>
          </label>
          <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
            Vous serez notifi√© par email lorsqu'un tournoi approche (2 semaines avant) et que les relances n'ont pas encore √©t√© envoy√©es
          </small>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Enregistrer mes param√®tres</button>
      </form>
      <div id="mySettingsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- User Management Section - Admin Only -->
    <div class="card admin-only" id="userManagementSection">
      <h3>Gestion des Utilisateurs</h3>
      <p style="margin-bottom: 20px; color: #666;">G√©rez les comptes utilisateurs de l'application (administrateurs et viewers).</p>

      <!-- Add New User Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Ajouter un utilisateur</h4>
        <form id="addUserForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUsername">Nom d'utilisateur :</label>
            <input type="text" id="newUsername" required minlength="3" placeholder="ex: jean.dupont">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserEmail">Email :</label>
            <input type="email" id="newUserEmail" placeholder="ex: jean@email.com">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserPassword">Mot de passe :</label>
            <div class="password-wrapper">
              <input type="password" id="newUserPassword" required minlength="6" placeholder="Min. 6 caract√®res">
              <button type="button" class="toggle-password" onclick="togglePassword('newUserPassword', this)">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserRole">R√¥le :</label>
            <select id="newUserRole" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
              <option value="viewer">Viewer (lecture seule)</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Ajouter</button>
        </form>
      </div>

      <!-- Users List -->
      <div id="usersListContainer">
        <h4 style="margin-bottom: 15px; color: #1F4788;">Utilisateurs existants</h4>
        <div id="usersList" style="display: grid; gap: 10px;">
          <!-- Users will be loaded here -->
          <p style="color: #666; text-align: center;">Chargement...</p>
        </div>
      </div>
    </div>

    <!-- Player App Accounts Section - Admin Only -->
    <div class="card admin-only" id="playerAppAccountsSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Comptes Espace Joueur</h3>
        <a href="player-accounts.html" class="btn" style="background: #1F4788; padding: 8px 16px; font-size: 14px;">
          Voir tous les comptes
        </a>
      </div>
      <p style="margin-bottom: 20px; color: #666;">G√©rez les comptes de l'application Espace Joueur. Les comptes "Admin" peuvent se connecter en tant que n'importe quel joueur.</p>

      <!-- Add New Player Account Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Cr√©er un compte joueur</h4>
        <form id="addPlayerAccountForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerLicence">Licence :</label>
            <input type="text" id="playerLicence" required placeholder="Ex: 123456A" style="text-transform: uppercase;">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerEmail">Email :</label>
            <input type="email" id="playerEmail" required placeholder="ex: joueur@email.com">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerPassword">Mot de passe :</label>
            <div class="password-wrapper">
              <input type="password" id="playerPassword" required minlength="8" placeholder="Min. 8 car., 1 maj., 1 chiffre, 1 special">
              <button type="button" class="toggle-password" onclick="togglePassword('playerPassword', this)">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
              <input type="checkbox" id="playerIsAdmin" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="white-space: nowrap;">Admin</span>
            </label>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Cr√©er</button>
        </form>
      </div>

      <!-- Player Accounts List -->
      <div id="playerAccountsListContainer">
        <h4 style="margin-bottom: 15px; color: #1F4788;">Comptes existants</h4>
        <div id="playerAccountsList" style="display: grid; gap: 10px;">
          <p style="color: #666; text-align: center;">Chargement...</p>
        </div>
      </div>
    </div>

    <!-- Game Parameters Section - Admin Only -->
    <div class="card admin-only" id="gameParametersSection">
      <h3>Param√®tres des √©preuves</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les r√®gles pour chaque mode de jeu et cat√©gorie (distance, reprises, moyennes qualificatives).
      </p>

      <div id="gameParametersTable" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Mode</th>
              <th style="padding: 12px; text-align: left;">Cat√©gorie</th>
              <th style="padding: 12px; text-align: center;">Coin</th>
              <th style="padding: 12px; text-align: center;">Distance Normale</th>
              <th style="padding: 12px; text-align: center;">Distance R√©duite</th>
              <th style="padding: 12px; text-align: center;">Reprises</th>
              <th style="padding: 12px; text-align: center;">Moy. Mini</th>
              <th style="padding: 12px; text-align: center;">Moy. Maxi</th>
              <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="gameParametersBody">
            <tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="gameParamsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Contact Email Settings - Admin Only -->
    <div class="card admin-only" id="contactEmailSection">
      <h3>Email de contact</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez l'adresse email qui appara√Ætra dans tous les emails envoy√©s (contact, reply-to, pied de page).
      </p>

      <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px; max-width: 400px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Adresse email de contact :</label>
          <input type="email" id="contactEmail" placeholder="ex: cdbhs92@gmail.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <button onclick="saveContactEmail()" class="btn" style="background: #28a745; padding: 12px 25px;">
          Enregistrer
        </button>
      </div>

      <div id="contactEmailMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Information :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          Cette adresse sera utilis√©e dans la phrase de contact, le pied de page et comme adresse de r√©ponse (reply-to) pour tous les emails.
        </p>
      </div>
    </div>

    <!-- Email Scheduler Settings - Admin Only -->
    <div class="card admin-only" id="emailSchedulerSection">
      <h3>Planification des emails</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez l'heure d'envoi automatique des emails programm√©s.
      </p>

      <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px; max-width: 300px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Heure d'envoi (heure de Paris) :</label>
          <select id="schedulerHour" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="0">00h00 (minuit)</option>
            <option value="1">01h00</option>
            <option value="2">02h00</option>
            <option value="3">03h00</option>
            <option value="4">04h00</option>
            <option value="5">05h00</option>
            <option value="6">06h00</option>
            <option value="7">07h00</option>
            <option value="8">08h00</option>
            <option value="9">09h00</option>
            <option value="10">10h00</option>
            <option value="11">11h00</option>
            <option value="12">12h00</option>
            <option value="13">13h00</option>
            <option value="14">14h00</option>
            <option value="15">15h00</option>
            <option value="16">16h00</option>
            <option value="17">17h00</option>
            <option value="18">18h00</option>
            <option value="19">19h00</option>
            <option value="20">20h00</option>
            <option value="21">21h00</option>
            <option value="22">22h00</option>
            <option value="23">23h00</option>
          </select>
        </div>
        <button onclick="saveSchedulerHour()" class="btn" style="background: #28a745; padding: 12px 25px;">
          Enregistrer
        </button>
      </div>

      <div id="schedulerMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Information :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          Les emails programm√©s seront envoy√©s automatiquement chaque jour √† l'heure configur√©e.
          Si un email a d√©j√† √©t√© envoy√© manuellement avant la date programm√©e, il sera automatiquement bloqu√©.
        </p>
      </div>
    </div>

    <!-- Club Aliases Section - Admin Only -->
    <div class="card admin-only" id="clubAliasesSection">
      <h3>Alias des Clubs</h3>
      <p style="margin-bottom: 20px; color: #666;">
        G√©rez les correspondances entre les diff√©rentes variantes de noms de clubs.
        Cela permet d'afficher le bon logo m√™me si le nom du club varie selon les sources.
      </p>

      <!-- Add New Alias Form -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0; color: #1F4788;">Ajouter un alias</h4>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Variante (alias) :</label>
            <input type="text" id="newAliasName" placeholder="Ex: A DE BILLARD COURBEVOIE LA DEFENSE" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nom canonique (officiel) :</label>
            <select id="newAliasCanonical" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- S√©lectionner un club --</option>
            </select>
          </div>
          <button onclick="addClubAlias()" class="btn" style="background: #28a745; padding: 10px 20px;">
            + Ajouter
          </button>
        </div>
      </div>

      <!-- Existing Aliases Table -->
      <div id="aliasesTableContainer" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Variante (alias)</th>
              <th style="padding: 12px; text-align: left;">Nom Canonique</th>
              <th style="padding: 12px; text-align: center; width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="aliasesTableBody">
            <tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="aliasesMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and hide admin sections for viewers
    function checkUserRole() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      } catch (e) {
        console.error('Error parsing token:', e);
      }
    }
    checkUserRole();

    // ============= MY SETTINGS =============

    // Load current user settings
    async function loadMySettings() {
      try {
        const response = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('myEmail').value = data.email || '';
          document.getElementById('myTournamentAlerts').checked = data.receive_tournament_alerts || false;
        }
      } catch (error) {
        console.error('Error loading my settings:', error);
      }
    }

    // Save my settings
    document.getElementById('mySettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('myEmail').value.trim();
      const receive_tournament_alerts = document.getElementById('myTournamentAlerts').checked;
      const msgDiv = document.getElementById('mySettingsMessage');

      // Basic email validation if not empty
      if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        msgDiv.textContent = 'Format d\'email invalide';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/me/settings`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email || null,
            receive_tournament_alerts
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Param√®tres enregistr√©s avec succ√®s !';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    });

    // Load my settings on page load
    loadMySettings();

    // ============= END MY SETTINGS =============

    // ============= USER MANAGEMENT =============

    // Load users list
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 403) {
            // User is not admin, hide the section
            document.getElementById('userManagementSection').style.display = 'none';
            return;
          }
          throw new Error('Erreur lors du chargement des utilisateurs');
        }

        const users = await response.json();
        renderUsersList(users);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = `
          <p style="color: #dc3545; text-align: center;">Erreur: ${error.message}</p>
        `;
      }
    }

    // Render users list
    function renderUsersList(users) {
      const container = document.getElementById('usersList');

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Aucun utilisateur trouv√©</p>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: white; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 250px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${user.role === 'admin' ? '#1F4788' : '#6c757d'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              ${user.username.charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <strong>${user.username}</strong>
                <span style="padding: 2px 6px; border-radius: 10px; font-size: 11px; background: ${user.role === 'admin' ? '#d4edda' : '#e2e3e5'}; color: ${user.role === 'admin' ? '#155724' : '#383d41'};">
                  ${user.role === 'admin' ? 'Admin' : 'Viewer'}
                </span>
                ${user.is_active === false ? '<span style="padding: 2px 6px; border-radius: 10px; font-size: 11px; background: #f8d7da; color: #721c24;">Inactif</span>' : ''}
              </div>
              <div style="display: flex; align-items: center; gap: 10px; margin-top: 4px; font-size: 12px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #666;" title="Recevoir les alertes tournois">
                  <input type="checkbox" ${user.receive_tournament_alerts ? 'checked' : ''} onchange="toggleUserAlerts(${user.id}, this.checked)" style="cursor: pointer;">
                  <span>Alertes</span>
                </label>
                ${user.email ? `<span style="color: #666;">${user.email}</span>` : '<span style="color: #999; font-style: italic;">Pas d\'email</span>'}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
            <button onclick="editUserEmail(${user.id}, '${user.username}', '${user.email || ''}')" class="btn" style="background: #6f42c1; padding: 5px 10px; font-size: 12px;">
              Email
            </button>
            ${user.id !== 1 ? `
              <button onclick="toggleUserRole(${user.id}, '${user.role}')" class="btn" style="background: #17a2b8; padding: 5px 10px; font-size: 12px;">
                ${user.role === 'admin' ? 'R√©tro.' : 'Promo.'}
              </button>
              <button onclick="resetUserPassword(${user.id}, '${user.username}')" class="btn" style="background: #ffc107; color: #000; padding: 5px 10px; font-size: 12px;">
                MDP
              </button>
              <button onclick="toggleUserActive(${user.id}, ${user.is_active !== false})" class="btn" style="background: ${user.is_active !== false ? '#6c757d' : '#28a745'}; padding: 5px 10px; font-size: 12px;">
                ${user.is_active !== false ? 'D√©sact.' : 'Activer'}
              </button>
              <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
                Suppr.
              </button>
            ` : '<span style="color: #666; font-style: italic; font-size: 12px;">Principal</span>'}
          </div>
        </div>
      `).join('');
    }

    // Add new user
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('newUsername').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;

      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email: email || null, password, role })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation de l\'utilisateur');
        }

        // Success
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" cr√©√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        // Reset form and reload users
        document.getElementById('addUserForm').reset();
        loadUsers();

      } catch (error) {
        console.error('Error creating user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    });

    // Toggle user alerts
    async function toggleUserAlerts(userId, enabled) {
      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ receive_tournament_alerts: enabled })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        // Show brief success message
        document.getElementById('successMessage').textContent = `Alertes ${enabled ? 'activ√©es' : 'd√©sactiv√©es'}`;
        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('successMessage').style.display = 'none'; }, 2000);

      } catch (error) {
        console.error('Error toggling alerts:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        loadUsers(); // Reload to reset checkbox state
      }
    }

    // Toggle user role
    async function toggleUserRole(userId, currentRole) {
      const newRole = currentRole === 'admin' ? 'viewer' : 'admin';
      const action = currentRole === 'admin' ? 'r√©trograder en viewer' : 'promouvoir en admin';

      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ role: newRole })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = 'R√¥le modifi√© avec succ√®s !';
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error updating user role:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Edit user email - Open modal
    function editUserEmail(userId, username, currentEmail) {
      document.getElementById('editEmailUserId').value = userId;
      document.getElementById('editEmailUsername').textContent = username;
      document.getElementById('editEmailInput').value = currentEmail || '';
      document.getElementById('editEmailError').style.display = 'none';
      document.getElementById('editEmailModal').style.display = 'flex';
      document.getElementById('editEmailInput').focus();
    }

    // Close edit email modal
    function closeEditEmailModal() {
      document.getElementById('editEmailModal').style.display = 'none';
    }

    // Submit email update
    async function submitEmailUpdate() {
      const userId = document.getElementById('editEmailUserId').value;
      const username = document.getElementById('editEmailUsername').textContent;
      const newEmail = document.getElementById('editEmailInput').value.trim();
      const errorDiv = document.getElementById('editEmailError');

      // Basic email validation if not empty
      if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errorDiv.textContent = 'Format d\'email invalide';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: newEmail || null })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closeEditEmailModal();
        loadUsers();
        document.getElementById('successMessage').textContent = `Email de "${username}" modifi√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error updating email:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Reset user password - Open modal
    function resetUserPassword(userId, username) {
      document.getElementById('resetPasswordUserId').value = userId;
      document.getElementById('resetPasswordUsername').textContent = username;
      document.getElementById('resetPasswordInput').value = '';
      document.getElementById('resetPasswordInput').type = 'password';
      document.getElementById('resetPasswordError').style.display = 'none';

      // Reset the eye icon
      const eyeBtn = document.querySelector('#resetPasswordModal .toggle-password');
      if (eyeBtn) eyeBtn.textContent = 'üëÅÔ∏è';

      document.getElementById('resetPasswordModal').style.display = 'flex';
      document.getElementById('resetPasswordInput').focus();
    }

    // Toggle password visibility in modal
    function togglePasswordModal() {
      const input = document.getElementById('resetPasswordInput');
      const btn = document.querySelector('#resetPasswordModal .toggle-password');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    // Close reset password modal
    function closeResetPasswordModal() {
      document.getElementById('resetPasswordModal').style.display = 'none';
    }

    // Submit password reset
    async function submitPasswordReset() {
      const userId = document.getElementById('resetPasswordUserId').value;
      const username = document.getElementById('resetPasswordUsername').textContent;
      const newPassword = document.getElementById('resetPasswordInput').value;
      const errorDiv = document.getElementById('resetPasswordError');

      if (!newPassword) {
        errorDiv.textContent = 'Veuillez entrer un mot de passe';
        errorDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caracteres';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closeResetPasswordModal();
        document.getElementById('successMessage').textContent = `Mot de passe de "${username}" modifie avec succes !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error resetting password:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Toggle user active status
    async function toggleUserActive(userId, isCurrentlyActive) {
      const action = isCurrentlyActive ? 'd√©sactiver' : 'activer';
      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_active: !isCurrentlyActive })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur ${isCurrentlyActive ? 'd√©sactiv√©' : 'activ√©'} avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error toggling user status:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Delete user
    async function deleteUser(userId, username) {
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?\n\nCette action est irr√©versible.`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la suppression');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" supprim√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error deleting user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Load users on page load
    loadUsers();

    // ============= END USER MANAGEMENT =============

    // ============= PLAYER APP ACCOUNTS =============

    // Load player accounts
    async function loadPlayerAccounts() {
      try {
        const response = await fetch(`${API_URL}/player-accounts`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 403) {
            document.getElementById('playerAppAccountsSection').style.display = 'none';
            return;
          }
          throw new Error('Erreur lors du chargement');
        }

        const accounts = await response.json();
        renderPlayerAccountsList(accounts);
      } catch (error) {
        console.error('Error loading player accounts:', error);
        document.getElementById('playerAccountsList').innerHTML = `
          <p style="color: #dc3545; text-align: center;">Erreur: ${error.message}</p>
        `;
      }
    }

    // Render player accounts list
    function renderPlayerAccountsList(accounts) {
      const container = document.getElementById('playerAccountsList');

      if (accounts.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Aucun compte joueur cr√©√©</p>';
        return;
      }

      container.innerHTML = accounts.map(account => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: white; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 300px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${account.is_admin ? '#d32f2f' : '#1F4788'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              ${account.is_admin ? 'üîë' : 'üë§'}
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <strong>${account.player_name || account.licence}</strong>
                <span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #e2e3e5; color: #383d41;">
                  ${account.licence}
                </span>
                ${account.is_admin ? '<span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #f8d7da; color: #721c24;">Admin</span>' : ''}
              </div>
              <div style="font-size: 12px; color: #666; margin-top: 4px;">
                ${account.email}
                ${account.last_login ? ` ‚Ä¢ Derni√®re connexion: ${new Date(account.last_login).toLocaleDateString('fr-FR')}` : ' ‚Ä¢ Jamais connect√©'}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
            <button onclick="resetPlayerPassword(${account.id}, '${account.licence}')" class="btn" style="background: #ffc107; color: #000; padding: 5px 10px; font-size: 12px;">
              MDP
            </button>
            <button onclick="togglePlayerAdmin(${account.id}, ${account.is_admin})" class="btn" style="background: ${account.is_admin ? '#6c757d' : '#d32f2f'}; padding: 5px 10px; font-size: 12px;">
              ${account.is_admin ? 'Retirer Admin' : 'Rendre Admin'}
            </button>
            <button onclick="deletePlayerAccount(${account.id}, '${account.licence}')" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
              Supprimer
            </button>
          </div>
        </div>
      `).join('');
    }

    // Add player account form
    document.getElementById('addPlayerAccountForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const licence = document.getElementById('playerLicence').value.trim().toUpperCase();
      const email = document.getElementById('playerEmail').value.trim();
      const password = document.getElementById('playerPassword').value;
      const isAdmin = document.getElementById('playerIsAdmin').checked;

      try {
        const response = await fetch(`${API_URL}/player-accounts`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ licence, email, password, isAdmin })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation');
        }

        document.getElementById('successMessage').textContent = `Compte joueur cr√©√© pour ${licence} !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        document.getElementById('addPlayerAccountForm').reset();
        loadPlayerAccounts();

      } catch (error) {
        console.error('Error creating player account:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    });

    // Toggle player admin status
    async function togglePlayerAdmin(id, currentIsAdmin) {
      const action = currentIsAdmin ? 'retirer les droits admin de' : 'donner les droits admin √†';
      if (!confirm(`Voulez-vous ${action} ce compte ?`)) return;

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isAdmin: !currentIsAdmin })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadPlayerAccounts();
        document.getElementById('successMessage').textContent = 'Statut admin modifi√© !';
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error toggling admin:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Delete player account
    async function deletePlayerAccount(id, licence) {
      if (!confirm(`Supprimer le compte joueur "${licence}" ?\n\nCette action est irr√©versible.`)) return;

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la suppression');
        }

        loadPlayerAccounts();
        document.getElementById('successMessage').textContent = `Compte "${licence}" supprim√© !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error deleting player account:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Reset player password - Open modal
    function resetPlayerPassword(id, licence) {
      document.getElementById('resetPlayerPasswordId').value = id;
      document.getElementById('resetPlayerPasswordLicence').textContent = licence;
      document.getElementById('resetPlayerPasswordInput').value = '';
      document.getElementById('resetPlayerPasswordInput').type = 'password';
      document.getElementById('resetPlayerPasswordError').style.display = 'none';

      // Reset the eye icon
      const eyeBtn = document.querySelector('#resetPlayerPasswordModal .toggle-password');
      if (eyeBtn) eyeBtn.textContent = 'üëÅÔ∏è';

      document.getElementById('resetPlayerPasswordModal').style.display = 'flex';
      document.getElementById('resetPlayerPasswordInput').focus();
    }

    // Toggle password visibility in player modal
    function togglePlayerPasswordModal() {
      const input = document.getElementById('resetPlayerPasswordInput');
      const btn = document.querySelector('#resetPlayerPasswordModal .toggle-password');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    // Close player password modal
    function closePlayerPasswordModal() {
      document.getElementById('resetPlayerPasswordModal').style.display = 'none';
    }

    // Submit player password reset
    async function submitPlayerPasswordReset() {
      const id = document.getElementById('resetPlayerPasswordId').value;
      const licence = document.getElementById('resetPlayerPasswordLicence').textContent;
      const newPassword = document.getElementById('resetPlayerPasswordInput').value;
      const errorDiv = document.getElementById('resetPlayerPasswordError');

      if (!newPassword) {
        errorDiv.textContent = 'Veuillez entrer un mot de passe';
        errorDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closePlayerPasswordModal();
        document.getElementById('successMessage').textContent = `Mot de passe du compte "${licence}" modifi√© !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error resetting player password:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Load player accounts on page load
    loadPlayerAccounts();

    // ============= END PLAYER APP ACCOUNTS =============

    // ============= CONTACT EMAIL SETTINGS =============

    // Load contact email setting
    async function loadContactEmail() {
      try {
        const response = await fetch(`${API_URL}/settings/app/contact_email`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('contactEmail').value = data.value;
          }
        }
      } catch (error) {
        console.error('Error loading contact email:', error);
      }
    }

    // Save contact email setting
    async function saveContactEmail() {
      const email = document.getElementById('contactEmail').value.trim();
      const msgDiv = document.getElementById('contactEmailMessage');

      // Basic email validation
      if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        msgDiv.textContent = 'Format d\'email invalide';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/app/contact_email`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: email || null })
        });

        if (response.ok) {
          msgDiv.textContent = email ? `Email de contact configur√© : ${email}` : 'Email de contact supprim√© (valeur par d√©faut utilis√©e)';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving contact email:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    // Load on page load
    loadContactEmail();

    // ============= END CONTACT EMAIL SETTINGS =============

    // ============= EMAIL SCHEDULER SETTINGS =============

    // Load scheduler hour setting
    async function loadSchedulerHour() {
      try {
        const response = await fetch(`${API_URL}/settings/app/email_scheduler_hour`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('schedulerHour').value = data.value;
          }
        }
      } catch (error) {
        console.error('Error loading scheduler hour:', error);
      }
    }

    // Save scheduler hour setting
    async function saveSchedulerHour() {
      const hour = document.getElementById('schedulerHour').value;
      const msgDiv = document.getElementById('schedulerMessage');

      try {
        const response = await fetch(`${API_URL}/settings/app/email_scheduler_hour`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: hour })
        });

        if (response.ok) {
          msgDiv.textContent = `Heure d'envoi configur√©e √† ${hour}h00`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving scheduler hour:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    // Load on page load
    loadSchedulerHour();

    // ============= END EMAIL SCHEDULER SETTINGS =============

    // ============= CLUB ALIASES MANAGEMENT =============

    let clubsList = [];

    // Load clubs for the dropdown
    async function loadClubsForAliases() {
      try {
        const response = await fetch(`${API_URL}/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          clubsList = await response.json();
          const select = document.getElementById('newAliasCanonical');
          select.innerHTML = '<option value="">-- S√©lectionner un club --</option>';
          clubsList.forEach(club => {
            const option = document.createElement('option');
            option.value = club.name;
            option.textContent = club.display_name || club.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    // Load existing aliases
    async function loadClubAliases() {
      try {
        const response = await fetch(`${API_URL}/clubs/aliases/list`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const tbody = document.getElementById('aliasesTableBody');

        if (response.ok) {
          const aliases = await response.json();

          if (aliases.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">Aucun alias configur√©</td></tr>';
            return;
          }

          tbody.innerHTML = aliases.map(alias => `
            <tr style="border-bottom: 1px solid #ddd;">
              <td style="padding: 12px;">${alias.alias}</td>
              <td style="padding: 12px;">${alias.canonical_name}</td>
              <td style="padding: 12px; text-align: center;">
                <button onclick="deleteClubAlias(${alias.id}, '${alias.alias.replace(/'/g, "\\'")}')"
                        class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
                  Supprimer
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
        }
      } catch (error) {
        console.error('Error loading aliases:', error);
        document.getElementById('aliasesTableBody').innerHTML =
          '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
      }
    }

    // Add new alias
    async function addClubAlias() {
      const alias = document.getElementById('newAliasName').value.trim();
      const canonicalName = document.getElementById('newAliasCanonical').value;

      if (!alias || !canonicalName) {
        showAliasMessage('Veuillez remplir tous les champs', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/clubs/aliases`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ alias, canonical_name: canonicalName })
        });

        if (response.ok) {
          document.getElementById('newAliasName').value = '';
          document.getElementById('newAliasCanonical').value = '';
          showAliasMessage('Alias ajout√© avec succ√®s !', 'success');
          loadClubAliases();
        } else {
          const data = await response.json();
          showAliasMessage(data.error || 'Erreur lors de l\'ajout', 'error');
        }
      } catch (error) {
        console.error('Error adding alias:', error);
        showAliasMessage('Erreur de connexion', 'error');
      }
    }

    // Delete alias
    async function deleteClubAlias(id, aliasName) {
      if (!confirm(`Supprimer l'alias "${aliasName}" ?`)) return;

      try {
        const response = await fetch(`${API_URL}/clubs/aliases/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          showAliasMessage('Alias supprim√©', 'success');
          loadClubAliases();
        } else {
          showAliasMessage('Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        console.error('Error deleting alias:', error);
        showAliasMessage('Erreur de connexion', 'error');
      }
    }

    // Show message for aliases section
    function showAliasMessage(message, type) {
      const msgDiv = document.getElementById('aliasesMessage');
      msgDiv.textContent = message;
      msgDiv.style.display = 'block';
      msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
      msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';

      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 3000);
    }

    // Load aliases on page load
    loadClubsForAliases();
    loadClubAliases();

    // ============= END CLUB ALIASES MANAGEMENT =============

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Change password form
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Hide previous messages
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';

      // Validate new password
      if (newPassword.length < 6) {
        document.getElementById('errorMessage').textContent = 'Le nouveau mot de passe doit contenir au moins 6 caract√®res';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      if (newPassword !== confirmPassword) {
        document.getElementById('errorMessage').textContent = 'Les nouveaux mots de passe ne correspondent pas';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            oldPassword,
            newPassword
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors du changement de mot de passe');
        }

        // Success
        document.getElementById('successMessage').textContent = 'Mot de passe chang√© avec succ√®s !';
        document.getElementById('successMessage').style.display = 'block';

        // Clear form
        document.getElementById('changePasswordForm').reset();

      } catch (error) {
        console.error('Error changing password:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    });

    // ============= GAME PARAMETERS MANAGEMENT =============

    let gameParameters = [];

    // Load game parameters
    async function loadGameParameters() {
      try {
        const response = await fetch(`${API_URL}/settings/game-parameters`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des param√®tres');
        }

        gameParameters = await response.json();
        renderGameParametersTable();
      } catch (error) {
        console.error('Error loading game parameters:', error);
        document.getElementById('gameParametersBody').innerHTML = `
          <tr><td colspan="9" style="text-align: center; padding: 20px; color: #dc3545;">Erreur: ${error.message}</td></tr>
        `;
      }
    }

    // Render game parameters table
    function renderGameParametersTable() {
      const tbody = document.getElementById('gameParametersBody');

      if (gameParameters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Aucun param√®tre configur√©</td></tr>';
        return;
      }

      const modeLabels = {
        'LIBRE': 'LIBRE',
        'CADRE': 'CADRE',
        'BANDE': 'BANDE',
        '3BANDES': '3 BANDES'
      };

      let currentMode = '';
      tbody.innerHTML = gameParameters.map(param => {
        const showMode = param.mode !== currentMode;
        currentMode = param.mode;
        const rowStyle = showMode ? 'border-top: 2px solid #1F4788;' : '';

        return `
          <tr style="${rowStyle}" data-id="${param.id}">
            <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: ${showMode ? 'bold' : 'normal'};">
              ${showMode ? modeLabels[param.mode] || param.mode : ''}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">${param.categorie}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <span style="padding: 3px 8px; border-radius: 4px; background: ${param.coin === 'GC' ? '#ffc107' : '#17a2b8'}; color: ${param.coin === 'GC' ? '#000' : '#fff'}; font-size: 12px;">
                ${param.coin}
              </span>
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; font-weight: bold;">${param.distance_normale}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; color: ${param.distance_reduite ? '#28a745' : '#999'};">
              ${param.distance_reduite || '-'}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${param.reprises}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_mini).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_maxi).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <button onclick="editGameParameter(${param.id})" class="btn" style="background: #17a2b8; padding: 5px 10px; font-size: 12px;">
                Modifier
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Edit game parameter
    function editGameParameter(id) {
      const param = gameParameters.find(p => p.id === id);
      if (!param) return;

      const modeLabels = { 'LIBRE': 'LIBRE', 'CADRE': 'CADRE', 'BANDE': 'BANDE', '3BANDES': '3 BANDES' };

      // Fill the modal form with current values
      document.getElementById('editParamId').value = id;
      document.getElementById('editParamTitle').textContent = `${modeLabels[param.mode] || param.mode} - ${param.categorie}`;
      document.getElementById('editParamCoin').value = param.coin;
      document.getElementById('editParamDistNorm').value = param.distance_normale;
      document.getElementById('editParamDistRed').value = param.distance_reduite || '';
      document.getElementById('editParamReprises').value = param.reprises;
      document.getElementById('editParamMoyMini').value = parseFloat(param.moyenne_mini).toFixed(3);
      document.getElementById('editParamMoyMaxi').value = parseFloat(param.moyenne_maxi).toFixed(3);

      // Show the modal
      document.getElementById('editParamModal').style.display = 'flex';
    }

    function closeEditParamModal() {
      document.getElementById('editParamModal').style.display = 'none';
    }

    function saveGameParameter() {
      const id = parseInt(document.getElementById('editParamId').value);
      const coin = document.getElementById('editParamCoin').value;
      const distNorm = document.getElementById('editParamDistNorm').value;
      const distRed = document.getElementById('editParamDistRed').value;
      const reprises = document.getElementById('editParamReprises').value;
      const moyMini = document.getElementById('editParamMoyMini').value;
      const moyMaxi = document.getElementById('editParamMoyMaxi').value;

      if (!distNorm || !reprises || moyMini === '' || moyMaxi === '') {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }

      updateGameParameter(id, {
        coin: coin,
        distance_normale: parseInt(distNorm),
        distance_reduite: distRed ? parseInt(distRed) : null,
        reprises: parseInt(reprises),
        moyenne_mini: parseFloat(moyMini),
        moyenne_maxi: parseFloat(moyMaxi)
      });

      closeEditParamModal();
    }

    // Update game parameter
    async function updateGameParameter(id, data) {
      const msgDiv = document.getElementById('gameParamsMessage');

      try {
        const response = await fetch(`${API_URL}/settings/game-parameters/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Erreur lors de la mise √† jour');
        }

        msgDiv.textContent = 'Param√®tre mis √† jour avec succ√®s !';
        msgDiv.style.background = '#d4edda';
        msgDiv.style.color = '#155724';
        msgDiv.style.display = 'block';

        loadGameParameters();

        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);

      } catch (error) {
        console.error('Error updating game parameter:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
      }
    }

    // Load game parameters on page load
    loadGameParameters();

    // ============= END GAME PARAMETERS MANAGEMENT =============
  </script>

  <!-- Edit Game Parameter Modal -->
  <div id="editParamModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Modifier les parametres</h3>
      <h4 id="editParamTitle" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;"></h4>

      <input type="hidden" id="editParamId">

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Coin *</label>
          <select id="editParamCoin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="GC">GC (Grand Coin)</option>
            <option value="PC">PC (Petit Coin)</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Reprises *</label>
          <input type="number" id="editParamReprises" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Normale *</label>
          <input type="number" id="editParamDistNorm" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Reduite</label>
          <input type="number" id="editParamDistRed" placeholder="Optionnel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Mini *</label>
          <input type="number" id="editParamMoyMini" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Maxi *</label>
          <input type="number" id="editParamMoyMaxi" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button onclick="saveGameParameter()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditParamModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Reinitialiser le mot de passe</h3>
      <p id="resetPasswordUsername" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="resetPasswordUserId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nouveau mot de passe *</label>
        <div class="password-wrapper" style="position: relative;">
          <input type="password" id="resetPasswordInput" minlength="6" placeholder="Min. 6 caracteres" style="width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <button type="button" class="toggle-password" onclick="togglePasswordModal()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">üëÅÔ∏è</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">Min. 8 caracteres, 1 majuscule, 1 chiffre, 1 caractere special</small>
      </div>

      <div id="resetPasswordError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitPasswordReset()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeResetPasswordModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Edit Email Modal -->
  <div id="editEmailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Modifier l'email</h3>
      <p id="editEmailUsername" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="editEmailUserId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Adresse email</label>
        <input type="email" id="editEmailInput" placeholder="ex: utilisateur@email.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        <small style="color: #666; display: block; margin-top: 5px;">L'email permet la r√©initialisation du mot de passe en self-service</small>
      </div>

      <div id="editEmailError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitEmailUpdate()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditEmailModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Reset Player Password Modal -->
  <div id="resetPlayerPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Reinitialiser le mot de passe joueur</h3>
      <p id="resetPlayerPasswordLicence" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="resetPlayerPasswordId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nouveau mot de passe *</label>
        <div class="password-wrapper" style="position: relative;">
          <input type="password" id="resetPlayerPasswordInput" minlength="6" placeholder="Min. 6 caracteres" style="width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <button type="button" class="toggle-password" onclick="togglePlayerPasswordModal()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">üëÅÔ∏è</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">Min. 8 caracteres, 1 majuscule, 1 chiffre, 1 caractere special</small>
      </div>

      <div id="resetPlayerPasswordError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitPlayerPasswordReset()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closePlayerPasswordModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>
</body>
</html>
