<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ParamÃ¨tres - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <script src="js/branding.js"></script>
  <style>
    .settings-hub {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .settings-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #e0e0e0;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .settings-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .settings-card h4 {
      margin: 0 0 8px 0;
      color: #1F4788;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings-card h4 .icon {
      font-size: 24px;
    }
    .settings-card p {
      color: #666;
      font-size: 13px;
      margin: 0 0 15px 0;
      line-height: 1.4;
    }
    .settings-card .card-links {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .settings-card .card-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      color: #333;
      text-decoration: none;
      font-size: 13px;
      transition: background 0.2s;
    }
    .settings-card .card-link:hover {
      background: #e9ecef;
    }
    .settings-card .card-link .link-icon {
      font-size: 16px;
    }
    .section-title {
      font-size: 14px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 30px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e0e0e0;
    }
    .section-title:first-of-type {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';">ParamÃ¨tres</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par catÃ©gorie de jeu au fur et Ã  mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="CompÃ©titions Ã  jouer / Convocations">CompÃ©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, rÃ©sultats, convocation">Com joueurs</a>
        <a href="settings.html" class="active">ParamÃ¨tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">DÃ©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- Personal Settings Card - For All Users -->
    <div class="card" style="margin-bottom: 20px;">
      <h3 style="margin-top: 0;">Mes paramÃ¨tres</h3>
      <form id="mySettingsForm">
        <div class="form-group">
          <label for="myEmail">Mon email :</label>
          <input type="email" id="myEmail" placeholder="ex: mon.email@exemple.com" style="width: 100%; max-width: 400px;">
          <small style="color: #666; display: block; margin-top: 5px;">UtilisÃ© pour la rÃ©initialisation du mot de passe et les notifications</small>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="myTournamentAlerts" style="width: 20px; height: 20px; cursor: pointer;">
            <span>Recevoir les alertes de tournois Ã  venir</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Enregistrer mes paramÃ¨tres</button>
      </form>
      <div id="mySettingsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Admin Settings Hub -->
    <div class="admin-only">
      <h3 class="section-title">Applications</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ“±</span> Espace Joueur</h4>
          <p>Application mobile pour les joueurs : inscriptions, classements, rÃ©sultats.</p>
          <div class="card-links">
            <a href="#" id="openPlayerAppBtn" class="card-link" style="background: #1F4788; color: white;">
              <span class="link-icon">ğŸš€</span> Ouvrir l'Espace Joueur
            </a>
            <a href="player-accounts.html" class="card-link"><span class="link-icon">ğŸ“±</span> Comptes Espace Joueur</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">âœ‰ï¸</span> Inscription App Joueurs</h4>
          <p>Gerer les invitations pour l'inscription a l'application joueur.</p>
          <div class="card-links">
            <a href="player-invitations.html" class="card-link" style="background: #28a745; color: white;">
              <span class="link-icon">ğŸ“¨</span> Gerer les inscriptions
            </a>
          </div>
        </div>
      </div>

      <h3 class="section-title">Gestion des fichiers</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ‘¥</span> Joueurs</h4>
          <p>Consulter et gÃ©rer la liste des joueurs du comitÃ©.</p>
          <div class="card-links">
            <a href="players-list.html" class="card-link"><span class="link-icon">ğŸ“‹</span> Liste des joueurs</a>
            <a href="import-players.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer des joueurs</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ†</span> Tournois & CompÃ©titions</h4>
          <p>GÃ©rer les tournois, compÃ©titions et inscriptions.</p>
          <div class="card-links">
            <a href="tournois-list.html" class="card-link"><span class="link-icon">ğŸ“…</span> Liste des tournois</a>
            <a href="inscriptions-list.html" class="card-link"><span class="link-icon">ğŸ“</span> Inscriptions</a>
            <a href="tournaments-list.html" class="card-link"><span class="link-icon">ğŸ“‹</span> CompÃ©titions jouÃ©es</a>
            <a href="import-tournament.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer une compÃ©tition</a>
            <a href="import-external.html" class="card-link"><span class="link-icon">ğŸ“¥</span> Importer inscriptions</a>
          </div>
        </div>

        <div class="settings-card admin-only">
          <h4><span class="icon">ğŸ›ï¸</span> EntitÃ© & Organisation</h4>
          <p>ParamÃ¨tres de l'organisation, identitÃ© visuelle et configuration.</p>
          <div class="card-links">
            <a href="settings-admin.html#organisationSection" class="card-link"><span class="link-icon">ğŸ›ï¸</span> Nom et logo</a>
            <a href="settings-admin.html#brandingSection" class="card-link"><span class="link-icon">ğŸ¨</span> IdentitÃ© visuelle</a>
            <a href="settings-admin.html#emailsConfigSection" class="card-link"><span class="link-icon">ğŸ“§</span> Configuration emails</a>
            <a href="clubs.html" class="card-link"><span class="link-icon">ğŸ¢</span> Clubs</a>
            <a href="settings-admin.html#userManagementSection" class="card-link"><span class="link-icon">ğŸ‘¤</span> Gestion des utilisateurs</a>
            <a href="settings-admin.html#seasonSection" class="card-link"><span class="link-icon">ğŸ“…</span> Saison</a>
            <a href="privacy-policy-editor.html" class="card-link"><span class="link-icon">ğŸ“‹</span> Politique de confidentialitÃ©</a>
          </div>
        </div>
      </div>

      <h3 class="section-title">Configuration</h3>
      <div class="settings-hub">
        <div class="settings-card">
          <h4><span class="icon">ğŸ¯</span> Configuration jeux et distances</h4>
          <p>GÃ©rer les modes de jeu, catÃ©gories, paramÃ¨tres des Ã©preuves et qualifications.</p>
          <div class="card-links">
            <a href="settings-admin.html#gameParametersSection" class="card-link"><span class="link-icon">âš™ï¸</span> ParamÃ¨tres des Ã©preuves</a>
            <a href="settings-reference.html" class="card-link"><img src="images/FrenchBillard-Icon-small.png" alt="" style="height: 16px; width: 16px; vertical-align: middle;"> Modes de jeu</a>
            <a href="settings-reference.html#ffb-rankings" class="card-link"><span class="link-icon">ğŸ…</span> Classements FFB</a>
            <a href="settings-reference.html#categories" class="card-link"><span class="link-icon">ğŸ“‹</span> CatÃ©gories</a>
            <a href="settings-admin.html#rankingsConfigSection" class="card-link"><span class="link-icon">ğŸ†</span> Classements / Qualifications</a>
            <a href="settings-admin.html#tournamentTypesSection" class="card-link"><span class="link-icon">ğŸ¯</span> Types de tournoi</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“§</span> Email</h4>
          <p>Configurer les paramÃ¨tres d'envoi d'emails.</p>
          <div class="card-links">
            <a href="emailing.html" class="card-link"><span class="link-icon">âœ‰ï¸</span> Envoyer des emails</a>
            <a href="settings-admin.html#contactEmailSection" class="card-link"><span class="link-icon">âš™ï¸</span> Email de contact</a>
            <a href="settings-admin.html#emailSchedulerSection" class="card-link"><span class="link-icon">ğŸ•</span> Planification</a>
          </div>
        </div>

        <div class="settings-card">
          <h4><span class="icon">ğŸ“†</span> Calendrier</h4>
          <p>GÃ©rer le calendrier de la saison.</p>
          <div class="card-links">
            <a href="calendar.html" class="card-link"><span class="link-icon">ğŸ“„</span> Voir / TÃ©lÃ©verser</a>
            <a href="#" onclick="openSeasonImportModal(); return false;" class="card-link" style="background: #28a745; color: white;"><span class="link-icon">ğŸ—“ï¸</span> GÃ©nÃ©rer tournois saison</a>
          </div>
        </div>

        <div class="settings-card admin-only">
          <h4><span class="icon">ğŸ“Š</span> Statistiques & Logs</h4>
          <p>Statistiques du comitÃ© et historique des actions.</p>
          <div class="card-links">
            <a href="statistiques.html" class="card-link"><span class="link-icon">ğŸ“ˆ</span> Statistiques</a>
            <a href="admin-activity-logs.html" class="card-link"><span class="link-icon">ğŸ”</span> Logs Administrateur</a>
            <a href="activity-logs.html" class="card-link"><span class="link-icon">ğŸ“±</span> Logs Espace Joueur</a>
          </div>
        </div>

        <div class="settings-card admin-only">
          <h4><span class="icon">ğŸ”§</span> Maintenance</h4>
          <p>Outils de maintenance pour corriger les donnÃ©es.</p>
          <div class="card-links">
            <a href="settings-admin.html#maintenanceSection" class="card-link"><span class="link-icon">ğŸ“Š</span> Recalculer les moyennes</a>
            <a href="settings-admin.html#maintenanceSection" class="card-link"><span class="link-icon">ğŸ†</span> Recalculer les classements</a>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Season Import Modal -->
  <div id="seasonImportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; max-width: 900px; margin: 30px auto; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">ğŸ—“ï¸ GÃ©nÃ©rer les tournois de la saison</h3>
        <button onclick="closeSeasonImportModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
      </div>
      <div style="padding: 20px;">
        <!-- Step 1: Upload -->
        <div id="importStep1">
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 10px 0; color: #1565c0;">ğŸ“‹ Format attendu du fichier Excel</h4>
            <p style="margin: 0; font-size: 13px; color: #1565c0;">
              Utilisez le mÃªme format que le calendrier actuel. Dans chaque cellule, indiquez :<br>
              â€¢ <strong>T1/A</strong>, <strong>T2/B</strong>, <strong>T3/C</strong> = Tournoi + Club<br>
              â€¢ <strong>F/?</strong> = Finale (lieu inconnu)<br>
              â€¢ <strong>L</strong> = LBIF (ignorÃ©, juste pour le calendrier)<br><br>
              <strong>Codes clubs :</strong> <span id="clubCodesDisplay">Chargement...</span>
            </p>
          </div>

          <form id="seasonImportForm" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="importSeason">Saison :</label>
              <select id="importSeason" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="2026-2027">2026-2027</option>
                <option value="2027-2028">2027-2028</option>
                <option value="2025-2026">2025-2026</option>
              </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
              <label for="seasonCalendarFile">Fichier calendrier Excel :</label>
              <input type="file" id="seasonCalendarFile" accept=".xlsx,.xls" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
            </div>
            <button type="submit" class="btn" style="padding: 12px 25px;">
              ğŸ“¥ PrÃ©visualiser
            </button>
          </form>
        </div>

        <!-- Step 2: Preview -->
        <div id="importStep2" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
              <h4 style="margin: 0;" id="previewTitle">PrÃ©visualisation</h4>
              <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;" id="previewSubtitle"></p>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="backToUpload()" class="btn" style="background: #6c757d;">â† Retour</button>
              <button onclick="executeImport()" class="btn btn-success" id="executeImportBtn">âœ“ Importer les tournois</button>
            </div>
          </div>

          <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead style="position: sticky; top: 0; background: #f8f9fa;">
                <tr>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">ID</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Nom</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Mode</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">CatÃ©gorie</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Lieu</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Taille</th>
                </tr>
              </thead>
              <tbody id="previewTableBody">
              </tbody>
            </table>
          </div>
        </div>

        <!-- Step 3: Result -->
        <div id="importStep3" style="display: none;">
          <div id="importResult" style="text-align: center; padding: 40px;">
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button onclick="closeSeasonImportModal()" class="btn btn-success">Fermer</button>
          </div>
        </div>

        <div id="importError" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin-top: 15px;">
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    const userRole = localStorage.getItem('userRole');

    // Show/hide admin elements
    document.querySelectorAll('.admin-only').forEach(el => {
      el.style.display = userRole === 'admin' ? '' : 'none';
    });

    // Load my settings
    async function loadMySettings() {
      try {
        const response = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const user = await response.json();
          document.getElementById('myEmail').value = user.email || '';
          document.getElementById('myTournamentAlerts').checked = user.receive_tournament_alerts === true;
        }
      } catch (error) {
        console.error('Error loading settings:', error);
      }
    }

    loadMySettings();

    // Save my settings
    document.getElementById('mySettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('mySettingsMessage');

      try {
        const response = await fetch(`${API_URL}/auth/me/settings`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: document.getElementById('myEmail').value,
            receive_tournament_alerts: document.getElementById('myTournamentAlerts').checked
          })
        });

        if (response.ok) {
          messageDiv.textContent = 'ParamÃ¨tres enregistrÃ©s avec succÃ¨s';
          messageDiv.style.background = '#d4edda';
          messageDiv.style.color = '#155724';
        } else {
          const data = await response.json();
          messageDiv.textContent = data.error || 'Erreur lors de la sauvegarde';
          messageDiv.style.background = '#f8d7da';
          messageDiv.style.color = '#721c24';
        }
        messageDiv.style.display = 'block';
        setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
      } catch (error) {
        messageDiv.textContent = 'Erreur de connexion';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.display = 'block';
      }
    });

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      window.location.href = 'login.html';
    });

    // Player App button
    document.getElementById('openPlayerAppBtn').addEventListener('click', (e) => {
      e.preventDefault();
      const currentHost = window.location.hostname;
      let playerAppUrl;

      if (currentHost === 'localhost' || currentHost === '127.0.0.1') {
        playerAppUrl = 'http://localhost:3001';
      } else {
        playerAppUrl = 'https://cdbhs-player-app-production.up.railway.app/?admin';
      }

      window.open(playerAppUrl, '_blank');
    });

    // ============================================================
    // SEASON IMPORT FUNCTIONALITY
    // ============================================================

    let previewData = null;
    let selectedFile = null;

    async function loadClubCodes() {
      try {
        const response = await fetch(`${API_URL}/calendar/club-codes`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const codes = await response.json();
          const display = document.getElementById('clubCodesDisplay');
          if (codes && Array.isArray(codes) && codes.length > 0) {
            // Format as "A=ClubName, B=ClubName"
            const formatted = codes
              .map(item => `${item.code}=${item.name}`)
              .join(', ');
            display.textContent = formatted;
          } else {
            display.textContent = 'Aucun code configurÃ© (voir section Clubs)';
          }
        }
      } catch (error) {
        console.error('Error loading club codes:', error);
        document.getElementById('clubCodesDisplay').textContent = 'Erreur de chargement';
      }
    }

    function openSeasonImportModal() {
      document.getElementById('seasonImportModal').style.display = 'block';
      document.getElementById('importStep1').style.display = 'block';
      document.getElementById('importStep2').style.display = 'none';
      document.getElementById('importStep3').style.display = 'none';
      document.getElementById('importError').style.display = 'none';
      document.getElementById('seasonCalendarFile').value = '';
      previewData = null;
      selectedFile = null;
      loadClubCodes(); // Load club codes dynamically
    }

    function closeSeasonImportModal() {
      document.getElementById('seasonImportModal').style.display = 'none';
    }

    function backToUpload() {
      document.getElementById('importStep1').style.display = 'block';
      document.getElementById('importStep2').style.display = 'none';
      document.getElementById('importError').style.display = 'none';
    }

    // Handle preview form submission
    document.getElementById('seasonImportForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('seasonCalendarFile');
      const season = document.getElementById('importSeason').value;
      const errorDiv = document.getElementById('importError');

      if (!fileInput.files.length) {
        errorDiv.textContent = 'Veuillez sÃ©lectionner un fichier Excel';
        errorDiv.style.display = 'block';
        return;
      }

      selectedFile = fileInput.files[0];
      const formData = new FormData();
      formData.append('calendar', selectedFile);
      formData.append('season', season);

      // Show loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = 'â³ Analyse en cours...';
      submitBtn.disabled = true;
      errorDiv.style.display = 'none';

      try {
        const response = await fetch(`${API_URL}/calendar/import-season/preview`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de l\'analyse');
        }

        previewData = data;
        showPreview(data);

      } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    function showPreview(data) {
      document.getElementById('importStep1').style.display = 'none';
      document.getElementById('importStep2').style.display = 'block';

      document.getElementById('previewTitle').textContent = `Saison ${data.season} - ${data.count} tournois trouvÃ©s`;
      document.getElementById('previewSubtitle').textContent = `IDs: ${data.tournaments[0]?.tournoi_id} Ã  ${data.tournaments[data.tournaments.length - 1]?.tournoi_id}`;

      const tbody = document.getElementById('previewTableBody');
      tbody.innerHTML = data.tournaments.map(t => {
        const isFinale = t._is_finale;
        const rowStyle = isFinale ? 'background: #fff3cd;' : '';
        return `
          <tr style="${rowStyle}">
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${t.tournoi_id}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${formatDate(t.debut)}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${isFinale ? 'ğŸ† ' : ''}${t.nom}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${t.mode}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${t.categorie}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${t.lieu || '<span style="color: #999;">Non dÃ©fini</span>'}</td>
            <td style="padding: 8px; border-bottom: 1px solid #eee;">${t.taille || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    async function executeImport() {
      if (!selectedFile || !previewData) return;

      const season = document.getElementById('importSeason').value;
      const formData = new FormData();
      formData.append('calendar', selectedFile);
      formData.append('season', season);

      const btn = document.getElementById('executeImportBtn');
      btn.innerHTML = 'â³ Import en cours...';
      btn.disabled = true;

      try {
        const response = await fetch(`${API_URL}/calendar/import-season/execute`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de l\'import');
        }

        // Show result
        document.getElementById('importStep2').style.display = 'none';
        document.getElementById('importStep3').style.display = 'block';

        let resultHtml = `
          <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
          <h3 style="color: #28a745; margin-bottom: 20px;">Import rÃ©ussi !</h3>
          <p style="font-size: 16px; color: #333;">${data.message}</p>
          <div style="display: flex; justify-content: center; gap: 30px; margin-top: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.imported}</div>
              <div style="font-size: 12px; color: #666;">Nouveaux</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${data.updated}</div>
              <div style="font-size: 12px; color: #666;">Mis Ã  jour</div>
            </div>
          </div>
        `;

        if (data.errors && data.errors.length > 0) {
          resultHtml += `
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; text-align: left;">
              <strong>âš ï¸ ${data.errors.length} erreur(s) :</strong>
              <ul style="margin: 10px 0 0 20px; font-size: 13px;">
                ${data.errors.map(e => `<li>ID ${e.tournoi_id}: ${e.error}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        document.getElementById('importResult').innerHTML = resultHtml;

      } catch (error) {
        document.getElementById('importError').textContent = error.message;
        document.getElementById('importError').style.display = 'block';
        btn.innerHTML = 'âœ“ Importer les tournois';
        btn.disabled = false;
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Close modal on outside click
    document.getElementById('seasonImportModal').addEventListener('click', (e) => {
      if (e.target.id === 'seasonImportModal') {
        closeSeasonImportModal();
      }
    });
  </script>
</body>
</html>
