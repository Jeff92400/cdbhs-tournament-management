<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-wrapper input {
      flex: 1;
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #666;
      padding: 5px;
    }
    .toggle-password:hover {
      color: #1F4788;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Param√®tres</h2>
      <div class="nav-links">
        <a href="dashboard.html" class="btn" style="background: #1F4788; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; margin-right: 10px;">‚Üê Accueil</a>
        <a href="#" id="logoutBtn" class="btn" style="background: #dc3545; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none;">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <div class="card">
      <h3>Changer le mot de passe administrateur</h3>
      <form id="changePasswordForm">
        <div class="form-group">
          <label for="oldPassword">Mot de passe actuel :</label>
          <div class="password-wrapper">
            <input type="password" id="oldPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('oldPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label for="newPassword">Nouveau mot de passe :</label>
          <div class="password-wrapper">
            <input type="password" id="newPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('newPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="form-group">
          <label for="confirmPassword">Confirmer le nouveau mot de passe :</label>
          <div class="password-wrapper">
            <input type="password" id="confirmPassword" required minlength="6">
            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword', this)">üëÅÔ∏è</button>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
      </form>
    </div>

    <!-- User Management Section - Admin Only -->
    <div class="card admin-only" id="userManagementSection">
      <h3>Gestion des Utilisateurs</h3>
      <p style="margin-bottom: 20px; color: #666;">G√©rez les comptes utilisateurs de l'application (administrateurs et viewers).</p>

      <!-- Add New User Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Ajouter un utilisateur</h4>
        <form id="addUserForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUsername">Nom d'utilisateur :</label>
            <input type="text" id="newUsername" required minlength="3" placeholder="ex: jean.dupont">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserPassword">Mot de passe :</label>
            <div class="password-wrapper">
              <input type="password" id="newUserPassword" required minlength="6" placeholder="Min. 6 caract√®res">
              <button type="button" class="toggle-password" onclick="togglePassword('newUserPassword', this)">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserRole">R√¥le :</label>
            <select id="newUserRole" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
              <option value="viewer">Viewer (lecture seule)</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Ajouter</button>
        </form>
      </div>

      <!-- Users List -->
      <div id="usersListContainer">
        <h4 style="margin-bottom: 15px; color: #1F4788;">Utilisateurs existants</h4>
        <div id="usersList" style="display: grid; gap: 10px;">
          <!-- Users will be loaded here -->
          <p style="color: #666; text-align: center;">Chargement...</p>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Calendrier de la saison</h3>
      <p style="margin-bottom: 20px; color: #666;">T√©l√©versez le calendrier de la saison (PDF ou Excel) pour le rendre accessible √† tous les utilisateurs.</p>

      <div id="currentCalendarInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #28a745; border-radius: 4px;">
        <strong>Calendrier actuel :</strong>
        <div id="calendarDetails" style="margin-top: 8px; color: #666;"></div>
      </div>

      <form id="calendarUploadForm" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
          <label for="calendarFile">Fichier calendrier (PDF ou Excel) :</label>
          <input type="file" id="calendarFile" accept=".pdf,.xlsx,.xls" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
        </div>
        <button type="submit" class="btn btn-primary" id="uploadCalendarBtn" style="padding: 12px 25px;">
          T√©l√©verser
        </button>
      </form>

      <div id="calendarUploadStatus" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <div class="card">
      <h3>Sauvegardes et Exports</h3>
      <p style="margin-bottom: 20px; color: #666;">Exportez vos donn√©es au format Excel pour cr√©er des sauvegardes locales.</p>

      <div id="lastExportInfo" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #28a745; border-radius: 4px;">
        <strong>üìÖ Dernier export :</strong>
        <div id="lastExportDetails" style="margin-top: 8px; color: #666;"></div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <button onclick="exportData('players')" class="btn" style="background: #28a745;">
          üë• Exporter les Joueurs
        </button>
        <button onclick="exportData('tournaments')" class="btn" style="background: #17a2b8;">
          üèÜ Exporter les Tournois
        </button>
        <button onclick="exportData('rankings')" class="btn" style="background: #ffc107; color: #000;">
          üìä Exporter les Classements
        </button>
        <button onclick="exportData('all')" class="btn" style="background: #dc3545;">
          üíæ Sauvegarde Compl√®te
        </button>
      </div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>‚ÑπÔ∏è Information :</strong>
        <ul style="margin: 10px 0 0 20px; color: #666;">
          <li>Les exports incluent toutes les donn√©es actuelles de la base de donn√©es PostgreSQL</li>
          <li>Les fichiers sont t√©l√©charg√©s au format Excel (.xlsx)</li>
          <li><strong>Important :</strong> Ces exports sont votre m√©thode principale de sauvegarde</li>
          <li>Recommand√© : effectuez une sauvegarde compl√®te apr√®s chaque tournoi</li>
          <li>Conservez vos fichiers de sauvegarde dans un endroit s√ªr (OneDrive, etc.)</li>
        </ul>
      </div>
    </div>

    <!-- Game Parameters Section - Admin Only -->
    <div class="card admin-only" id="gameParametersSection">
      <h3>Param√®tres des √©preuves</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les r√®gles pour chaque mode de jeu et cat√©gorie (distance, reprises, moyennes qualificatives).
      </p>

      <div id="gameParametersTable" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Mode</th>
              <th style="padding: 12px; text-align: left;">Cat√©gorie</th>
              <th style="padding: 12px; text-align: center;">Coin</th>
              <th style="padding: 12px; text-align: center;">Distance Normale</th>
              <th style="padding: 12px; text-align: center;">Distance R√©duite</th>
              <th style="padding: 12px; text-align: center;">Reprises</th>
              <th style="padding: 12px; text-align: center;">Moy. Mini</th>
              <th style="padding: 12px; text-align: center;">Moy. Maxi</th>
              <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="gameParametersBody">
            <tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="gameParamsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Email Template Section - Admin Only -->
    <div class="card admin-only" id="emailTemplateSection">
      <h3>Template Email de Convocation</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Personnalisez le contenu des emails de convocation. Utilisez les variables entre accolades pour les valeurs dynamiques.
      </p>

      <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 4px; font-size: 13px;">
        <strong>Variables disponibles :</strong><br>
        <code>{first_name}</code> - Pr√©nom du joueur<br>
        <code>{last_name}</code> - Nom de famille du joueur<br>
        <code>{player_name}</code> - Nom complet du joueur<br>
        <code>{category}</code> - Cat√©gorie (ex: LIBRE R1)<br>
        <code>{tournament}</code> - Num√©ro du tournoi<br>
        <code>{date}</code> - Date du tournoi<br>
        <code>{time}</code> - Heure de d√©but<br>
        <code>{location}</code> - Lieu du tournoi<br>
        <code>{poule}</code> - Num√©ro de poule du joueur
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Objet de l'email :</label>
        <input type="text" id="emailSubjectTemplate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" placeholder="Convocation {category} - {tournament} - {date}">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: 500; margin-bottom: 5px;">Corps de l'email :</label>
        <textarea id="emailBodyTemplate" rows="15" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; font-family: inherit; line-height: 1.5;" placeholder="Contenu de l'email..."></textarea>
      </div>

      <div style="display: flex; gap: 10px;">
        <button onclick="saveEmailTemplate()" class="btn" style="background: #28a745;">
          Enregistrer le template
        </button>
        <button onclick="resetEmailTemplate()" class="btn" style="background: #6c757d;">
          R√©initialiser par d√©faut
        </button>
      </div>

      <div id="emailTemplateMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>
  </div>

  <script>
    const API_URL = '/api';

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }

    // Check authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    // Check user role and hide admin sections for viewers
    function checkUserRole() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      } catch (e) {
        console.error('Error parsing token:', e);
      }
    }
    checkUserRole();

    // ============= USER MANAGEMENT =============

    // Load users list
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 403) {
            // User is not admin, hide the section
            document.getElementById('userManagementSection').style.display = 'none';
            return;
          }
          throw new Error('Erreur lors du chargement des utilisateurs');
        }

        const users = await response.json();
        renderUsersList(users);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = `
          <p style="color: #dc3545; text-align: center;">Erreur: ${error.message}</p>
        `;
      }
    }

    // Render users list
    function renderUsersList(users) {
      const container = document.getElementById('usersList');

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Aucun utilisateur trouv√©</p>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: white; border: 1px solid #ddd; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${user.role === 'admin' ? '#1F4788' : '#6c757d'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
              ${user.username.charAt(0).toUpperCase()}
            </div>
            <div>
              <strong>${user.username}</strong>
              <span style="display: inline-block; margin-left: 10px; padding: 2px 8px; border-radius: 12px; font-size: 12px; background: ${user.role === 'admin' ? '#d4edda' : '#e2e3e5'}; color: ${user.role === 'admin' ? '#155724' : '#383d41'};">
                ${user.role === 'admin' ? 'Administrateur' : 'Viewer'}
              </span>
              ${user.is_active === false ? '<span style="display: inline-block; margin-left: 5px; padding: 2px 8px; border-radius: 12px; font-size: 12px; background: #f8d7da; color: #721c24;">D√©sactiv√©</span>' : ''}
            </div>
          </div>
          <div style="display: flex; gap: 10px;">
            ${user.id !== 1 ? `
              <button onclick="toggleUserRole(${user.id}, '${user.role}')" class="btn" style="background: #17a2b8; padding: 6px 12px; font-size: 13px;">
                ${user.role === 'admin' ? 'R√©trograder' : 'Promouvoir'}
              </button>
              <button onclick="resetUserPassword(${user.id}, '${user.username}')" class="btn" style="background: #ffc107; color: #000; padding: 6px 12px; font-size: 13px;">
                Reset MDP
              </button>
              <button onclick="toggleUserActive(${user.id}, ${user.is_active !== false})" class="btn" style="background: ${user.is_active !== false ? '#6c757d' : '#28a745'}; padding: 6px 12px; font-size: 13px;">
                ${user.is_active !== false ? 'D√©sactiver' : 'Activer'}
              </button>
              <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn" style="background: #dc3545; padding: 6px 12px; font-size: 13px;">
                Supprimer
              </button>
            ` : '<span style="color: #666; font-style: italic; font-size: 13px;">Compte principal</span>'}
          </div>
        </div>
      `).join('');
    }

    // Add new user
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;

      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password, role })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation de l\'utilisateur');
        }

        // Success
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" cr√©√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        // Reset form and reload users
        document.getElementById('addUserForm').reset();
        loadUsers();

      } catch (error) {
        console.error('Error creating user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    });

    // Toggle user role
    async function toggleUserRole(userId, currentRole) {
      const newRole = currentRole === 'admin' ? 'viewer' : 'admin';
      const action = currentRole === 'admin' ? 'r√©trograder en viewer' : 'promouvoir en admin';

      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ role: newRole })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = 'R√¥le modifi√© avec succ√®s !';
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error updating user role:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Reset user password - Open modal
    function resetUserPassword(userId, username) {
      document.getElementById('resetPasswordUserId').value = userId;
      document.getElementById('resetPasswordUsername').textContent = username;
      document.getElementById('resetPasswordInput').value = '';
      document.getElementById('resetPasswordInput').type = 'password';
      document.getElementById('resetPasswordError').style.display = 'none';

      // Reset the eye icon
      const eyeBtn = document.querySelector('#resetPasswordModal .toggle-password');
      if (eyeBtn) eyeBtn.textContent = 'üëÅÔ∏è';

      document.getElementById('resetPasswordModal').style.display = 'flex';
      document.getElementById('resetPasswordInput').focus();
    }

    // Toggle password visibility in modal
    function togglePasswordModal() {
      const input = document.getElementById('resetPasswordInput');
      const btn = document.querySelector('#resetPasswordModal .toggle-password');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    // Close reset password modal
    function closeResetPasswordModal() {
      document.getElementById('resetPasswordModal').style.display = 'none';
    }

    // Submit password reset
    async function submitPasswordReset() {
      const userId = document.getElementById('resetPasswordUserId').value;
      const username = document.getElementById('resetPasswordUsername').textContent;
      const newPassword = document.getElementById('resetPasswordInput').value;
      const errorDiv = document.getElementById('resetPasswordError');

      if (!newPassword) {
        errorDiv.textContent = 'Veuillez entrer un mot de passe';
        errorDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caracteres';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closeResetPasswordModal();
        document.getElementById('successMessage').textContent = `Mot de passe de "${username}" modifie avec succes !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error resetting password:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Toggle user active status
    async function toggleUserActive(userId, isCurrentlyActive) {
      const action = isCurrentlyActive ? 'd√©sactiver' : 'activer';
      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_active: !isCurrentlyActive })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur ${isCurrentlyActive ? 'd√©sactiv√©' : 'activ√©'} avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error toggling user status:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Delete user
    async function deleteUser(userId, username) {
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?\n\nCette action est irr√©versible.`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la suppression');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" supprim√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error deleting user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Load users on page load
    loadUsers();

    // ============= END USER MANAGEMENT =============

    // Load and display last export info
    function displayLastExport() {
      const lastExport = localStorage.getItem('lastExport');
      if (lastExport) {
        try {
          const exportData = JSON.parse(lastExport);
          const date = new Date(exportData.timestamp);
          const formattedDate = date.toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          const formattedTime = date.toLocaleTimeString('fr-FR', {
            hour: '2-digit',
            minute: '2-digit'
          });

          const typeLabels = {
            'players': 'Joueurs',
            'tournaments': 'Tournois',
            'rankings': 'Classements',
            'all': 'Sauvegarde Compl√®te'
          };

          document.getElementById('lastExportDetails').innerHTML = `
            <strong>${typeLabels[exportData.type]}</strong><br>
            ${formattedDate} √† ${formattedTime}
          `;
          document.getElementById('lastExportInfo').style.display = 'block';
        } catch (e) {
          console.error('Error parsing last export data:', e);
        }
      }
    }

    // Display on page load
    displayLastExport();

    // Load current calendar info
    async function loadCalendarInfo() {
      try {
        const response = await fetch(`${API_URL}/calendar/info`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          if (data.exists) {
            const uploadDate = new Date(data.uploadedAt);
            const formattedDate = uploadDate.toLocaleDateString('fr-FR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            const formattedTime = uploadDate.toLocaleTimeString('fr-FR', {
              hour: '2-digit',
              minute: '2-digit'
            });

            document.getElementById('calendarDetails').innerHTML = `
              <strong>${data.filename}</strong><br>
              T√©l√©vers√© le ${formattedDate} √† ${formattedTime}<br>
              Par: ${data.uploadedBy || 'admin'}
            `;
            document.getElementById('currentCalendarInfo').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error loading calendar info:', error);
      }
    }

    // Load calendar info on page load
    loadCalendarInfo();

    // Calendar upload form
    document.getElementById('calendarUploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('calendarFile');
      const file = fileInput.files[0];
      const statusDiv = document.getElementById('calendarUploadStatus');
      const uploadBtn = document.getElementById('uploadCalendarBtn');

      if (!file) {
        statusDiv.textContent = 'Veuillez s√©lectionner un fichier';
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.display = 'block';
        return;
      }

      // Show loading state
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'T√©l√©versement...';
      statusDiv.textContent = 'T√©l√©versement en cours...';
      statusDiv.style.background = '#cce5ff';
      statusDiv.style.color = '#004085';
      statusDiv.style.display = 'block';

      try {
        const formData = new FormData();
        formData.append('calendar', file);

        const response = await fetch(`${API_URL}/calendar/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors du t√©l√©versement');
        }

        // Success
        statusDiv.textContent = `Calendrier "${data.filename}" t√©l√©vers√© avec succ√®s !`;
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';

        // Reset form and reload info
        fileInput.value = '';
        loadCalendarInfo();

      } catch (error) {
        console.error('Error uploading calendar:', error);
        statusDiv.textContent = error.message;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'T√©l√©verser';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // Change password form
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const oldPassword = document.getElementById('oldPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // Hide previous messages
      document.getElementById('errorMessage').style.display = 'none';
      document.getElementById('successMessage').style.display = 'none';

      // Validate new password
      if (newPassword.length < 6) {
        document.getElementById('errorMessage').textContent = 'Le nouveau mot de passe doit contenir au moins 6 caract√®res';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      if (newPassword !== confirmPassword) {
        document.getElementById('errorMessage').textContent = 'Les nouveaux mots de passe ne correspondent pas';
        document.getElementById('errorMessage').style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            oldPassword,
            newPassword
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors du changement de mot de passe');
        }

        // Success
        document.getElementById('successMessage').textContent = 'Mot de passe chang√© avec succ√®s !';
        document.getElementById('successMessage').style.display = 'block';

        // Clear form
        document.getElementById('changePasswordForm').reset();

      } catch (error) {
        console.error('Error changing password:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    });

    // Export data function
    async function exportData(type) {
      const endpoints = {
        'players': '/backup/export-players',
        'tournaments': '/backup/export-tournaments',
        'rankings': '/backup/export-rankings',
        'all': '/backup/export-all'
      };

      const labels = {
        'players': 'Joueurs',
        'tournaments': 'Tournois',
        'rankings': 'Classements',
        'all': 'Sauvegarde Compl√®te'
      };

      try {
        // Hide previous messages
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';

        // Show loading message
        document.getElementById('successMessage').textContent = `Export ${labels[type]} en cours...`;
        document.getElementById('successMessage').style.display = 'block';

        const response = await fetch(`${API_URL}${endpoints[type]}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          // Try to parse JSON error, but handle HTML responses too
          let errorMessage = 'Erreur lors de l\'export';
          try {
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              const data = await response.json();
              errorMessage = data.error || errorMessage;
            }
          } catch (e) {
            // Ignore JSON parse errors for HTML responses
          }
          throw new Error(errorMessage);
        }

        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = `Export_${type}_${new Date().toISOString().split('T')[0]}.xlsx`;
        if (contentDisposition) {
          const matches = /filename="([^"]+)"/.exec(contentDisposition);
          if (matches && matches[1]) {
            filename = matches[1];
          }
        }

        // Create blob and trigger download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // Show success message
        document.getElementById('successMessage').textContent = `Export ${labels[type]} r√©ussi ! Le fichier a √©t√© t√©l√©charg√©.`;

        // Save last export info
        localStorage.setItem('lastExport', JSON.stringify({
          type: type,
          timestamp: new Date().toISOString()
        }));

        // Update display
        displayLastExport();

      } catch (error) {
        console.error('Error exporting data:', error);
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // ============= GAME PARAMETERS MANAGEMENT =============

    let gameParameters = [];

    // Load game parameters
    async function loadGameParameters() {
      try {
        const response = await fetch(`${API_URL}/settings/game-parameters`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des param√®tres');
        }

        gameParameters = await response.json();
        renderGameParametersTable();
      } catch (error) {
        console.error('Error loading game parameters:', error);
        document.getElementById('gameParametersBody').innerHTML = `
          <tr><td colspan="9" style="text-align: center; padding: 20px; color: #dc3545;">Erreur: ${error.message}</td></tr>
        `;
      }
    }

    // Render game parameters table
    function renderGameParametersTable() {
      const tbody = document.getElementById('gameParametersBody');

      if (gameParameters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Aucun param√®tre configur√©</td></tr>';
        return;
      }

      const modeLabels = {
        'LIBRE': 'LIBRE',
        'CADRE': 'CADRE',
        'BANDE': 'BANDE',
        '3BANDES': '3 BANDES'
      };

      let currentMode = '';
      tbody.innerHTML = gameParameters.map(param => {
        const showMode = param.mode !== currentMode;
        currentMode = param.mode;
        const rowStyle = showMode ? 'border-top: 2px solid #1F4788;' : '';

        return `
          <tr style="${rowStyle}" data-id="${param.id}">
            <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: ${showMode ? 'bold' : 'normal'};">
              ${showMode ? modeLabels[param.mode] || param.mode : ''}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">${param.categorie}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <span style="padding: 3px 8px; border-radius: 4px; background: ${param.coin === 'GC' ? '#ffc107' : '#17a2b8'}; color: ${param.coin === 'GC' ? '#000' : '#fff'}; font-size: 12px;">
                ${param.coin}
              </span>
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; font-weight: bold;">${param.distance_normale}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; color: ${param.distance_reduite ? '#28a745' : '#999'};">
              ${param.distance_reduite || '-'}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${param.reprises}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_mini).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_maxi).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <button onclick="editGameParameter(${param.id})" class="btn" style="background: #17a2b8; padding: 5px 10px; font-size: 12px;">
                Modifier
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Edit game parameter
    function editGameParameter(id) {
      const param = gameParameters.find(p => p.id === id);
      if (!param) return;

      const modeLabels = { 'LIBRE': 'LIBRE', 'CADRE': 'CADRE', 'BANDE': 'BANDE', '3BANDES': '3 BANDES' };

      // Fill the modal form with current values
      document.getElementById('editParamId').value = id;
      document.getElementById('editParamTitle').textContent = `${modeLabels[param.mode] || param.mode} - ${param.categorie}`;
      document.getElementById('editParamCoin').value = param.coin;
      document.getElementById('editParamDistNorm').value = param.distance_normale;
      document.getElementById('editParamDistRed').value = param.distance_reduite || '';
      document.getElementById('editParamReprises').value = param.reprises;
      document.getElementById('editParamMoyMini').value = parseFloat(param.moyenne_mini).toFixed(3);
      document.getElementById('editParamMoyMaxi').value = parseFloat(param.moyenne_maxi).toFixed(3);

      // Show the modal
      document.getElementById('editParamModal').style.display = 'flex';
    }

    function closeEditParamModal() {
      document.getElementById('editParamModal').style.display = 'none';
    }

    function saveGameParameter() {
      const id = parseInt(document.getElementById('editParamId').value);
      const coin = document.getElementById('editParamCoin').value;
      const distNorm = document.getElementById('editParamDistNorm').value;
      const distRed = document.getElementById('editParamDistRed').value;
      const reprises = document.getElementById('editParamReprises').value;
      const moyMini = document.getElementById('editParamMoyMini').value;
      const moyMaxi = document.getElementById('editParamMoyMaxi').value;

      if (!distNorm || !reprises || moyMini === '' || moyMaxi === '') {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }

      updateGameParameter(id, {
        coin: coin,
        distance_normale: parseInt(distNorm),
        distance_reduite: distRed ? parseInt(distRed) : null,
        reprises: parseInt(reprises),
        moyenne_mini: parseFloat(moyMini),
        moyenne_maxi: parseFloat(moyMaxi)
      });

      closeEditParamModal();
    }

    // Update game parameter
    async function updateGameParameter(id, data) {
      const msgDiv = document.getElementById('gameParamsMessage');

      try {
        const response = await fetch(`${API_URL}/settings/game-parameters/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Erreur lors de la mise √† jour');
        }

        msgDiv.textContent = 'Param√®tre mis √† jour avec succ√®s !';
        msgDiv.style.background = '#d4edda';
        msgDiv.style.color = '#155724';
        msgDiv.style.display = 'block';

        loadGameParameters();

        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);

      } catch (error) {
        console.error('Error updating game parameter:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
      }
    }

    // Load game parameters on page load
    loadGameParameters();

    // ============= END GAME PARAMETERS MANAGEMENT =============

    // ============= EMAIL TEMPLATE MANAGEMENT =============

    const DEFAULT_EMAIL_TEMPLATE = {
      subject: 'Convocation {category} - {tournament} - {date}',
      body: `Bonjour {player_name},

Le CDBHS a le plaisir de vous convier au tournoi suivant.

Veuillez trouver en attachement votre convocation detaillee avec la composition de toutes les poules du tournoi.

En cas d'empechement, merci d'informer des que possible l'equipe en charge du sportif a l'adresse ci-dessous.

Vous aurez not√© un changement significatif quant au processus d'invitation et sommes a votre ecoute si vous avez des remarques ou des suggestions.

Nous vous souhaitons une excellente competition.

Cordialement,
Comite Departemental Billard Hauts-de-Seine`
    };

    // Load email template
    async function loadEmailTemplate() {
      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement du template');
        }

        const template = await response.json();
        document.getElementById('emailSubjectTemplate').value = template.subject_template || DEFAULT_EMAIL_TEMPLATE.subject;
        document.getElementById('emailBodyTemplate').value = template.body_template || DEFAULT_EMAIL_TEMPLATE.body;
      } catch (error) {
        console.error('Error loading email template:', error);
        // Use defaults on error
        document.getElementById('emailSubjectTemplate').value = DEFAULT_EMAIL_TEMPLATE.subject;
        document.getElementById('emailBodyTemplate').value = DEFAULT_EMAIL_TEMPLATE.body;
      }
    }

    // Save email template
    async function saveEmailTemplate() {
      const msgDiv = document.getElementById('emailTemplateMessage');
      const subject = document.getElementById('emailSubjectTemplate').value.trim();
      const body = document.getElementById('emailBodyTemplate').value.trim();

      if (!subject || !body) {
        msgDiv.textContent = 'L\'objet et le corps de l\'email sont obligatoires';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/email-template/convocation`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            subject_template: subject,
            body_template: body
          })
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Erreur lors de la sauvegarde');
        }

        msgDiv.textContent = 'Template email enregistr√© avec succ√®s !';
        msgDiv.style.background = '#d4edda';
        msgDiv.style.color = '#155724';
        msgDiv.style.display = 'block';

        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
      } catch (error) {
        console.error('Error saving email template:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
      }
    }

    // Reset email template to default
    function resetEmailTemplate() {
      if (confirm('Voulez-vous vraiment r√©initialiser le template par d√©faut ?')) {
        document.getElementById('emailSubjectTemplate').value = DEFAULT_EMAIL_TEMPLATE.subject;
        document.getElementById('emailBodyTemplate').value = DEFAULT_EMAIL_TEMPLATE.body;
      }
    }

    // Load email template on page load
    loadEmailTemplate();

    // ============= END EMAIL TEMPLATE MANAGEMENT =============
  </script>

  <!-- Edit Game Parameter Modal -->
  <div id="editParamModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Modifier les parametres</h3>
      <h4 id="editParamTitle" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;"></h4>

      <input type="hidden" id="editParamId">

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Coin *</label>
          <select id="editParamCoin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="GC">GC (Grand Coin)</option>
            <option value="PC">PC (Petit Coin)</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Reprises *</label>
          <input type="number" id="editParamReprises" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Normale *</label>
          <input type="number" id="editParamDistNorm" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Reduite</label>
          <input type="number" id="editParamDistRed" placeholder="Optionnel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Mini *</label>
          <input type="number" id="editParamMoyMini" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Maxi *</label>
          <input type="number" id="editParamMoyMaxi" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button onclick="saveGameParameter()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditParamModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Reinitialiser le mot de passe</h3>
      <p id="resetPasswordUsername" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="resetPasswordUserId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nouveau mot de passe *</label>
        <div class="password-wrapper" style="position: relative;">
          <input type="password" id="resetPasswordInput" minlength="6" placeholder="Min. 6 caracteres" style="width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <button type="button" class="toggle-password" onclick="togglePasswordModal()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">üëÅÔ∏è</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">Le mot de passe doit contenir au moins 6 caracteres</small>
      </div>

      <div id="resetPasswordError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitPasswordReset()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeResetPasswordModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>
</body>
</html>
