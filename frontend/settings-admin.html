<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Param√®tres - Billard Ranking</title>
  <link rel="icon" type="image/png" href="images/FrenchBillard-Icon-small.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .password-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-wrapper input {
      flex: 1;
      padding-right: 40px;
    }
    .toggle-password {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      color: #666;
      padding: 5px;
    }
    .toggle-password:hover {
      color: #1F4788;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img id="app-header-icon" src="images/FrenchBillard-Icon-small.png" alt="" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.src='images/FrenchBillard-Icon-small.png';">Param√®tres</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html" class="nav-tooltip" data-tooltip="Classement par cat√©gorie de jeu au fur et √† mesure des tournois">Classements</a>
        <a href="generate-poules.html" class="nav-tooltip" data-tooltip="Comp√©titions √† jouer / Convocations">Comp√©titions</a>
        <a href="calendar.html" class="nav-tooltip" data-tooltip="Calendrier de la saison">Calendrier</a>
        <a href="emailing.html" class="nav-tooltip" data-tooltip="Annonces, relances, r√©sultats, convocation">Com joueurs</a>
        <a href="settings.html" class="active">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>
    <div id="successMessage" class="success" style="display: none;"></div>

    <!-- My Settings Section -->
    <div class="card">
      <h3>Mes param√®tres</h3>
      <form id="mySettingsForm">
        <div class="form-group">
          <label for="myEmail">Mon email :</label>
          <input type="email" id="myEmail" placeholder="ex: mon.email@exemple.com" style="width: 100%; max-width: 400px;">
          <small style="color: #666; display: block; margin-top: 5px;">Utilis√© pour la r√©initialisation du mot de passe et les notifications</small>
        </div>
        <div class="form-group" style="margin-top: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="myTournamentAlerts" style="width: 20px; height: 20px; cursor: pointer;">
            <span>Recevoir les alertes de tournois √† venir</span>
          </label>
          <small style="color: #666; display: block; margin-top: 5px; margin-left: 30px;">
            Vous serez notifi√© par email lorsqu'un tournoi approche (2 semaines avant) et que les relances n'ont pas encore √©t√© envoy√©es
          </small>
        </div>
        <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Enregistrer mes param√®tres</button>
      </form>
      <div id="mySettingsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- User Management Section - Admin Only -->
    <div class="card admin-only" id="userManagementSection">
      <h3>Gestion des Utilisateurs</h3>
      <p style="margin-bottom: 20px; color: #666;">G√©rez les comptes utilisateurs de l'application (administrateurs et viewers).</p>

      <!-- Add New User Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Ajouter un utilisateur</h4>
        <form id="addUserForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUsername">Nom d'utilisateur :</label>
            <input type="text" id="newUsername" required minlength="3" placeholder="ex: jean.dupont">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserEmail">Email :</label>
            <input type="email" id="newUserEmail" placeholder="ex: jean@email.com">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserPassword">Mot de passe :</label>
            <div class="password-wrapper">
              <input type="password" id="newUserPassword" required minlength="6" placeholder="Min. 6 caract√®res">
              <button type="button" class="toggle-password" onclick="togglePassword('newUserPassword', this)">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newUserRole">R√¥le :</label>
            <select id="newUserRole" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
              <option value="viewer">Viewer (lecture seule)</option>
              <option value="admin">Administrateur</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Ajouter</button>
        </form>
      </div>

      <!-- Users List -->
      <div id="usersListContainer">
        <h4 style="margin-bottom: 15px; color: #1F4788;">Utilisateurs existants</h4>
        <div id="usersList" style="display: grid; gap: 10px;">
          <!-- Users will be loaded here -->
          <p style="color: #666; text-align: center;">Chargement...</p>
        </div>
      </div>
    </div>

    <!-- Player App Accounts Section - Admin Only -->
    <div class="card admin-only" id="playerAppAccountsSection">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0;">Comptes Espace Joueur</h3>
        <a href="player-accounts.html" class="btn" style="background: #1F4788; padding: 8px 16px; font-size: 14px;">
          Voir tous les comptes
        </a>
      </div>
      <p style="margin-bottom: 20px; color: #666;">G√©rez les comptes de l'application Espace Joueur. Les comptes "Admin" peuvent se connecter en tant que n'importe quel joueur.</p>

      <!-- Add New Player Account Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Cr√©er un compte joueur</h4>
        <form id="addPlayerAccountForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerLicence">Licence :</label>
            <input type="text" id="playerLicence" required placeholder="Ex: 123456A" style="text-transform: uppercase;">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerEmail">Email :</label>
            <input type="email" id="playerEmail" required placeholder="ex: joueur@email.com">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="playerPassword">Mot de passe :</label>
            <div class="password-wrapper">
              <input type="password" id="playerPassword" required minlength="8" placeholder="Min. 8 car., 1 maj., 1 chiffre, 1 special">
              <button type="button" class="toggle-password" onclick="togglePassword('playerPassword', this)">üëÅÔ∏è</button>
            </div>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
              <input type="checkbox" id="playerIsAdmin" style="width: 18px; height: 18px; cursor: pointer;">
              <span style="white-space: nowrap;">Admin</span>
            </label>
          </div>
          <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Cr√©er</button>
        </form>
      </div>

      <!-- Player Accounts Search -->
      <div id="playerAccountsListContainer">
        <h4 style="margin-bottom: 15px; color: #1F4788;">Rechercher un compte</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <input type="text" id="playerAccountSearch" placeholder="Rechercher par nom, licence ou email..."
                 style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          <button onclick="searchPlayerAccounts()" class="btn" style="background: #1F4788; padding: 10px 20px;">
            Rechercher
          </button>
        </div>
        <div id="playerAccountsList" style="display: grid; gap: 10px;">
          <p style="color: #666; text-align: center; font-style: italic;">Entrez au moins 2 caract√®res pour rechercher</p>
        </div>
      </div>
    </div>

    <!-- Game Parameters Section - Admin Only -->
    <div class="card admin-only" id="gameParametersSection">
      <h3>Param√®tres des √©preuves</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les r√®gles pour chaque mode de jeu et cat√©gorie (distance, reprises, moyennes qualificatives).
      </p>

      <div id="gameParametersTable" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Mode</th>
              <th style="padding: 12px; text-align: left;">Cat√©gorie</th>
              <th style="padding: 12px; text-align: center;">Coin</th>
              <th style="padding: 12px; text-align: center;">Distance Normale</th>
              <th style="padding: 12px; text-align: center;">Distance R√©duite</th>
              <th style="padding: 12px; text-align: center;">Reprises</th>
              <th style="padding: 12px; text-align: center;">Moy. Mini</th>
              <th style="padding: 12px; text-align: center;">Moy. Maxi</th>
              <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="gameParametersBody">
            <tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="gameParamsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Category Mappings Section - Hidden (deprecated: IONOS decommissioned, remove for 2025-2026 season) -->
    <div class="card admin-only" id="categoryMappingsSection" style="display: none;">
      <h3>Correspondances de cat√©gories IONOS</h3>
      <p style="margin-bottom: 20px; color: #666;">
        G√©rez les correspondances entre les noms de cat√©gories dans les fichiers IONOS et les cat√©gories internes du syst√®me.
        Cela permet de reconna√Ætre automatiquement les variations d'√©criture (ex: "N3", "N 3", "NATIONALE 3").
      </p>

      <!-- Add New Mapping Form -->
      <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-top: 0; margin-bottom: 15px; color: #1F4788;">Ajouter une correspondance</h4>
        <form id="addMappingForm" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newIonosCategorie">Valeur IONOS :</label>
            <input type="text" id="newIonosCategorie" required placeholder="ex: N 3, NATIONALE 3">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newMappingGameType">Mode :</label>
            <select id="newMappingGameType" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
              <option value="">S√©lectionner...</option>
              <option value="LIBRE">LIBRE</option>
              <option value="CADRE">CADRE</option>
              <option value="BANDE">BANDE</option>
              <option value="3BANDES">3 BANDES</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label for="newMappingCategory">Cat√©gorie interne :</label>
            <select id="newMappingCategory" required style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
              <option value="">S√©lectionner...</option>
            </select>
          </div>
          <button type="submit" class="btn" style="background: #28a745; padding: 10px 20px;">
            Ajouter
          </button>
        </form>
      </div>

      <!-- Mappings Table -->
      <div id="categoryMappingsTable" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Mode</th>
              <th style="padding: 12px; text-align: left;">Cat√©gorie interne</th>
              <th style="padding: 12px; text-align: left;">Variations IONOS accept√©es</th>
              <th style="padding: 12px; text-align: center; width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="categoryMappingsBody">
            <tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="categoryMappingsMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
        <strong>Note :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          Les correspondances permettent au syst√®me de reconna√Ætre automatiquement les cat√©gories lors de l'import des fichiers IONOS,
          m√™me si l'orthographe varie. Par exemple, "N3", "N 3" et "NATIONALE 3" peuvent tous correspondre √† la m√™me cat√©gorie interne.
        </p>
      </div>
    </div>

    <!-- Email Scheduler Settings - Admin Only -->
    <div class="card admin-only" id="emailSchedulerSection">
      <h3>Planification des emails</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez l'heure d'envoi automatique des emails programm√©s.
      </p>

      <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px; max-width: 300px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Heure d'envoi (heure de Paris) :</label>
          <select id="schedulerHour" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="0">00h00 (minuit)</option>
            <option value="1">01h00</option>
            <option value="2">02h00</option>
            <option value="3">03h00</option>
            <option value="4">04h00</option>
            <option value="5">05h00</option>
            <option value="6">06h00</option>
            <option value="7">07h00</option>
            <option value="8">08h00</option>
            <option value="9">09h00</option>
            <option value="10">10h00</option>
            <option value="11">11h00</option>
            <option value="12">12h00</option>
            <option value="13">13h00</option>
            <option value="14">14h00</option>
            <option value="15">15h00</option>
            <option value="16">16h00</option>
            <option value="17">17h00</option>
            <option value="18">18h00</option>
            <option value="19">19h00</option>
            <option value="20">20h00</option>
            <option value="21">21h00</option>
            <option value="22">22h00</option>
            <option value="23">23h00</option>
          </select>
        </div>
        <button onclick="saveSchedulerHour()" class="btn" style="background: #28a745; padding: 12px 25px;">
          Enregistrer
        </button>
      </div>

      <div id="schedulerMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Information :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          Les emails programm√©s seront envoy√©s automatiquement chaque jour √† l'heure configur√©e.
          Si un email a d√©j√† √©t√© envoy√© manuellement avant la date programm√©e, il sera automatiquement bloqu√©.
        </p>
      </div>
    </div>

    <!-- Player App Settings Section - Admin Only -->
    <div class="card admin-only" id="playerAppSettingsSection">
      <h3>Param√®tres Espace Joueur</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les param√®tres de l'application Espace Joueur.
      </p>

      <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 300px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">URL du R√®glement Sportif :</label>
          <input type="url" id="reglementUrl" placeholder="ex: https://docs.google.com/document/..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <button onclick="saveReglementUrl()" class="btn" style="background: #28a745; padding: 12px 25px;">
          Enregistrer
        </button>
      </div>

      <div id="reglementUrlMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Information :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          Ce lien sera affich√© dans l'application Espace Joueur lors des inscriptions aux tournois.
          Les joueurs devront confirmer avoir pris connaissance du r√®glement avant de s'inscrire.
        </p>
      </div>
    </div>

    <!-- Club Aliases Section - Hidden (deprecated: club names now standardized in player file) -->
    <div class="card admin-only" id="clubAliasesSection" style="display: none;">
      <h3>Alias des Clubs</h3>
      <p style="margin-bottom: 20px; color: #666;">
        G√©rez les correspondances entre les diff√©rentes variantes de noms de clubs.
        Cela permet d'afficher le bon logo m√™me si le nom du club varie selon les sources.
      </p>

      <!-- Add New Alias Form -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 15px 0; color: #1F4788;">Ajouter un alias</h4>
        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Variante (alias) :</label>
            <input type="text" id="newAliasName" placeholder="Ex: A DE BILLARD COURBEVOIE LA DEFENSE" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Nom canonique (officiel) :</label>
            <select id="newAliasCanonical" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">-- S√©lectionner un club --</option>
            </select>
          </div>
          <button onclick="addClubAlias()" class="btn" style="background: #28a745; padding: 10px 20px;">
            + Ajouter
          </button>
        </div>
      </div>

      <!-- Existing Aliases Table -->
      <div id="aliasesTableContainer" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: left;">Variante (alias)</th>
              <th style="padding: 12px; text-align: left;">Nom Canonique</th>
              <th style="padding: 12px; text-align: center; width: 100px;">Actions</th>
            </tr>
          </thead>
          <tbody id="aliasesTableBody">
            <tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="aliasesMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Maintenance Section - Admin Only -->
    <div class="card admin-only" id="maintenanceSection">
      <h3>üîß Maintenance</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Outils de maintenance pour corriger les donn√©es existantes.
      </p>

      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <!-- Recalculate Moyennes -->
        <div style="flex: 1; min-width: 300px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 10px 0; color: #1F4788;">üìä Recalculer les moyennes</h4>
          <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
            Recalcule la moyenne (points √∑ reprises) pour les r√©sultats de tournois.
          </p>

          <!-- All tournaments -->
          <button onclick="recalculateMoyennes()" class="btn" style="background: #17a2b8; margin-bottom: 15px; width: 100%;">
            üîÑ Recalculer TOUS les tournois
          </button>

          <!-- Specific tournament -->
          <div style="border-top: 1px solid #dee2e6; padding-top: 15px; margin-top: 5px;">
            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #666;">Ou s√©lectionner un tournoi sp√©cifique :</label>
            <select id="maintenanceTournamentSelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;">
              <option value="">-- Chargement... --</option>
            </select>
            <button onclick="recalculateSingleTournament()" class="btn" style="background: #6c757d; width: 100%;">
              üîÑ Recalculer ce tournoi
            </button>
          </div>
        </div>

        <!-- Recalculate Rankings -->
        <div style="flex: 1; min-width: 300px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
          <h4 style="margin: 0 0 10px 0; color: #1F4788;">üèÜ Recalculer les classements</h4>
          <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
            Recalcule tous les classements de la saison en cours √† partir des r√©sultats de tournois.
          </p>
          <button onclick="recalculateAllRankings()" class="btn" style="background: #28a745;">
            üîÑ Recalculer tous les classements
          </button>
        </div>
      </div>

      <div id="maintenanceMessage" style="display: none; margin-top: 20px; padding: 15px; border-radius: 4px;"></div>
    </div>

    <!-- Organisation Section - Admin Only -->
    <div class="card admin-only" id="organisationSection">
      <h3>üè¢ Organisation</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les informations de votre organisation. Ces informations seront utilis√©es dans les emails et l'application.
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nom complet de l'organisation :</label>
          <input type="text" id="organizationName" placeholder="ex: Comit√© D√©partemental de Billard des Hauts-de-Seine" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nom court / Sigle :</label>
          <input type="text" id="organizationShortName" placeholder="ex: CDBHS" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email de notification :</label>
          <input type="email" id="organizationEmail" placeholder="ex: cdbhs92@gmail.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Re√ßoit les notifications (inscriptions joueurs, etc.) et utilis√© comme adresse de r√©ponse</small>
        </div>
      </div>

      <!-- Logo Upload -->
      <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee;">
        <label style="display: block; margin-bottom: 8px; font-weight: 500;">Logo de l'organisation (pour les emails) :</label>
        <div id="logoPreview" style="margin-bottom: 15px; display: none;">
          <img id="logoPreviewImg" src="" alt="Logo" style="max-height: 80px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white;">
          <button onclick="deleteLogo()" class="btn btn-danger" style="margin-left: 15px; padding: 8px 15px; font-size: 13px;">Supprimer</button>
        </div>
        <div id="logoUploadZone" style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: border-color 0.2s;" onclick="document.getElementById('logoFileInput').click()">
          <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="uploadLogo(this.files[0])">
          <p style="margin: 0; color: #666;">Cliquez pour telecharger un logo (PNG, JPG - max 2 MB)</p>
        </div>
      </div>

      <button onclick="saveOrganisationSettings()" class="btn" style="background: #28a745; padding: 12px 25px; margin-top: 20px;">
        Enregistrer
      </button>
      <div id="organisationMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Identit√© Visuelle Section - Admin Only -->
    <div class="card admin-only" id="brandingSection">
      <h3>üé® Identit√© Visuelle</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Personnalisez les couleurs de l'application et des emails.
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Couleur principale :</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="primaryColor" value="#1F4788" style="width: 50px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="text" id="primaryColorText" value="#1F4788" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" onchange="document.getElementById('primaryColor').value = this.value">
          </div>
          <p style="font-size: 11px; font-style: italic; color: #666; margin: 6px 0 0 0;">En-t√™tes emails, navbar, boutons, liens</p>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Couleur secondaire :</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="secondaryColor" value="#667EEA" style="width: 50px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="text" id="secondaryColorText" value="#667EEA" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" onchange="document.getElementById('secondaryColor').value = this.value">
          </div>
          <p style="font-size: 11px; font-style: italic; color: #666; margin: 6px 0 0 0;">D√©grad√©s, survols, boutons secondaires</p>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Couleur d'accent :</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="accentColor" value="#FFC107" style="width: 50px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="text" id="accentColorText" value="#FFC107" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" onchange="document.getElementById('accentColor').value = this.value">
          </div>
          <p style="font-size: 11px; font-style: italic; color: #666; margin: 6px 0 0 0;">Alertes, avertissements, badges</p>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fond principal :</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="backgroundColor" value="#FFFFFF" style="width: 50px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="text" id="backgroundColorText" value="#FFFFFF" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" onchange="document.getElementById('backgroundColor').value = this.value">
          </div>
          <p style="font-size: 11px; font-style: italic; color: #666; margin: 6px 0 0 0;">Corps des emails, arri√®re-plan pages</p>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Fond secondaire :</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" id="backgroundSecondaryColor" value="#F5F5F5" style="width: 50px; height: 40px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
            <input type="text" id="backgroundSecondaryColorText" value="#F5F5F5" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;" onchange="document.getElementById('backgroundSecondaryColor').value = this.value">
          </div>
          <p style="font-size: 11px; font-style: italic; color: #666; margin: 6px 0 0 0;">Lignes altern√©es, sections, cartes</p>
        </div>
      </div>

      <button onclick="saveBrandingSettings()" class="btn" style="background: #28a745; padding: 12px 25px; margin-top: 20px;">
        Enregistrer
      </button>
      <div id="brandingMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Emails Configuration Section - Admin Only -->
    <div class="card admin-only" id="emailsConfigSection">
      <h3>üìß Configuration des Emails</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les adresses email utilis√©es pour les diff√©rents types de communications.
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email de communication :</label>
          <input type="email" id="emailCommunication" placeholder="ex: communication@cdbhs.net" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Utilis√© pour les annonces g√©n√©rales</small>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email des convocations :</label>
          <input type="email" id="emailConvocations" placeholder="ex: convocations@cdbhs.net" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Utilis√© pour les convocations aux tournois</small>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email no-reply :</label>
          <input type="email" id="emailNoreply" placeholder="ex: noreply@cdbhs.net" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Utilis√© pour les emails automatiques</small>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Nom de l'exp√©diteur :</label>
          <input type="text" id="emailSenderName" placeholder="ex: CDBHS" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Nom affich√© dans les emails envoy√©s</small>
        </div>
      </div>

      <button onclick="saveEmailsConfig()" class="btn" style="background: #28a745; padding: 12px 25px; margin-top: 20px;">
        Enregistrer
      </button>
      <div id="emailsConfigMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Saison Section - Admin Only -->
    <div class="card admin-only" id="seasonSection">
      <h3>üìÖ Configuration de la Saison</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez le mois de d√©but de saison pour le calcul automatique de la saison en cours.
      </p>

      <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px; max-width: 300px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Mois de d√©but de saison :</label>
          <select id="seasonCutoffMonth" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="0">Janvier</option>
            <option value="1">F√©vrier</option>
            <option value="2">Mars</option>
            <option value="3">Avril</option>
            <option value="4">Mai</option>
            <option value="5">Juin</option>
            <option value="6">Juillet</option>
            <option value="7">Ao√ªt</option>
            <option value="8">Septembre</option>
            <option value="9">Octobre</option>
            <option value="10">Novembre</option>
            <option value="11">D√©cembre</option>
          </select>
        </div>
        <button onclick="saveSeasonSettings()" class="btn" style="background: #28a745; padding: 12px 25px;">
          Enregistrer
        </button>
      </div>

      <div id="seasonMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>Information :</strong>
        <p style="margin: 10px 0 0 0; color: #666;">
          La saison est calcul√©e automatiquement en fonction du mois actuel.
          Par exemple, avec Septembre comme mois de d√©but, de Septembre 2024 √† Ao√ªt 2025, la saison sera "2024-2025".
        </p>
      </div>
    </div>

    <!-- Classements Section - Admin Only -->
    <div class="card admin-only" id="rankingsConfigSection">
      <h3>üèÜ Configuration des Classements</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les r√®gles de qualification pour la finale d√©partementale.
      </p>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Seuil petite cat√©gorie :</label>
          <input type="number" id="qualificationThreshold" min="1" max="20" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Si moins de X joueurs, c'est une petite cat√©gorie</small>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Qualifi√©s (petite cat√©gorie) :</label>
          <input type="number" id="qualificationSmall" min="1" max="10" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Nombre de qualifi√©s pour la finale</small>
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; font-weight: 500;">Qualifi√©s (grande cat√©gorie) :</label>
          <input type="number" id="qualificationLarge" min="1" max="20" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666;">Nombre de qualifi√©s pour la finale</small>
        </div>
      </div>

      <button onclick="saveRankingsConfig()" class="btn" style="background: #28a745; padding: 12px 25px; margin-top: 20px;">
        Enregistrer
      </button>
      <div id="rankingsConfigMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>

      <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-left: 4px solid #1F4788; border-radius: 4px;">
        <strong>R√®gle actuelle :</strong>
        <p style="margin: 10px 0 0 0; color: #666;" id="rankingsRuleDisplay">
          Chargement...
        </p>
      </div>
    </div>

    <!-- Types de Tournoi Section - Admin Only -->
    <div class="card admin-only" id="tournamentTypesSection">
      <h3>üéØ Types de Tournoi</h3>
      <p style="margin-bottom: 20px; color: #666;">
        Configurez les types de tournois disponibles et leurs libell√©s.
      </p>

      <div id="tournamentTypesTable" style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
          <thead>
            <tr style="background: #1F4788; color: white;">
              <th style="padding: 12px; text-align: center;">N¬∞</th>
              <th style="padding: 12px; text-align: left;">Code</th>
              <th style="padding: 12px; text-align: left;">Nom d'affichage</th>
              <th style="padding: 12px; text-align: center;">Compte dans classement</th>
              <th style="padding: 12px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="tournamentTypesBody">
            <tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">Chargement...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="tournamentTypesMessage" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>

    <!-- Politique de Confidentialit√© Section - Admin Only -->
    <div class="card admin-only" id="privacyPolicySection">
      <h3>üìã Politique de Confidentialit√©</h3>
      <p style="margin-bottom: 20px; color: #666;">
        G√©rez le texte complet de la politique de confidentialit√© affich√© dans l'Espace Joueur.
      </p>

      <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
        <div style="flex: 1;">
          <p style="margin: 0; color: #666;">
            <strong>Derni√®re modification :</strong> <span id="privacyPolicyLastUpdate">Non configur√©e</span>
          </p>
        </div>
        <a href="privacy-policy-editor.html" class="btn" style="background: #1F4788; padding: 12px 25px; text-decoration: none;">
          Modifier la politique ‚Üí
        </a>
      </div>
    </div>

    <!-- Activity Logs Section - Admin Only -->
    <div class="card admin-only">
      <h3>üìã Logs d'activit√©</h3>
      <p style="margin-bottom: 20px; color: #666;">Consultez l'historique des actions des utilisateurs : connexions, inscriptions, cr√©ations de compte, etc.</p>
      <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
        <a href="activity-logs.html" class="btn" style="background: #1F4788; padding: 12px 25px; text-decoration: none;">
          Voir les logs complets ‚Üí
        </a>
        <div id="logsQuickStats" style="display: flex; gap: 20px; color: #666; font-size: 0.9rem;">
          <span>Chargement des stats...</span>
        </div>
      </div>
    </div>
  </div>

  <script src="js/auth-utils.js"></script>
  <script src="js/app-branding.js"></script>
  <script>
    const API_URL = '/api';

    // Toggle password visibility
    function togglePassword(inputId, button) {
      const input = document.getElementById(inputId);
      if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
      } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
      }
    }

    // Check authentication
    if (!requireAuth()) {
      throw new Error('Not authenticated'); // Stop script execution
    }
    const token = localStorage.getItem('token');

    // Check user role and hide admin sections for viewers
    function checkUserRole() {
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') {
          document.querySelectorAll('.admin-only').forEach(el => {
            el.style.display = 'none';
          });
        }
      } catch (e) {
        console.error('Error parsing token:', e);
      }
    }
    checkUserRole();

    // ============= MY SETTINGS =============

    // Load current user settings
    async function loadMySettings() {
      try {
        const response = await fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('myEmail').value = data.email || '';
          document.getElementById('myTournamentAlerts').checked = data.receive_tournament_alerts || false;
        }
      } catch (error) {
        console.error('Error loading my settings:', error);
      }
    }

    // Save my settings
    document.getElementById('mySettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('myEmail').value.trim();
      const receive_tournament_alerts = document.getElementById('myTournamentAlerts').checked;
      const msgDiv = document.getElementById('mySettingsMessage');

      // Basic email validation if not empty
      if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        msgDiv.textContent = 'Format d\'email invalide';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/me/settings`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email || null,
            receive_tournament_alerts
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Param√®tres enregistr√©s avec succ√®s !';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    });

    // Load my settings on page load
    loadMySettings();

    // ============= END MY SETTINGS =============

    // ============= USER MANAGEMENT =============

    // Load users list
    async function loadUsers() {
      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          if (response.status === 403) {
            // User is not admin, hide the section
            document.getElementById('userManagementSection').style.display = 'none';
            return;
          }
          throw new Error('Erreur lors du chargement des utilisateurs');
        }

        const users = await response.json();
        renderUsersList(users);
      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = `
          <p style="color: #dc3545; text-align: center;">Erreur: ${error.message}</p>
        `;
      }
    }

    // Render users list
    function renderUsersList(users) {
      const container = document.getElementById('usersList');

      if (users.length === 0) {
        container.innerHTML = '<p style="color: #666; text-align: center;">Aucun utilisateur trouv√©</p>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: white; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 250px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${user.role === 'admin' ? '#1F4788' : '#6c757d'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              ${user.username.charAt(0).toUpperCase()}
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <strong>${user.username}</strong>
                <span style="padding: 2px 6px; border-radius: 10px; font-size: 11px; background: ${user.role === 'admin' ? '#d4edda' : '#e2e3e5'}; color: ${user.role === 'admin' ? '#155724' : '#383d41'};">
                  ${user.role === 'admin' ? 'Admin' : 'Viewer'}
                </span>
                ${user.is_active === false ? '<span style="padding: 2px 6px; border-radius: 10px; font-size: 11px; background: #f8d7da; color: #721c24;">Inactif</span>' : ''}
              </div>
              <div style="display: flex; align-items: center; gap: 10px; margin-top: 4px; font-size: 12px;">
                <label style="display: flex; align-items: center; gap: 4px; cursor: pointer; color: #666;" title="Recevoir les alertes tournois">
                  <input type="checkbox" ${user.receive_tournament_alerts ? 'checked' : ''} onchange="toggleUserAlerts(${user.id}, this.checked)" style="cursor: pointer;">
                  <span>Alertes</span>
                </label>
                ${user.email ? `<span style="color: #666;">${user.email}</span>` : '<span style="color: #999; font-style: italic;">Pas d\'email</span>'}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
            <button onclick="editUserEmail(${user.id}, '${user.username}', '${user.email || ''}')" class="btn" style="background: #6f42c1; padding: 5px 10px; font-size: 12px;">
              Email
            </button>
            ${user.id !== 1 ? `
              <button onclick="toggleUserRole(${user.id}, '${user.role}')" class="btn" style="background: #17a2b8; padding: 5px 10px; font-size: 12px;">
                ${user.role === 'admin' ? 'R√©tro.' : 'Promo.'}
              </button>
              <button onclick="resetUserPassword(${user.id}, '${user.username}')" class="btn" style="background: #ffc107; color: #000; padding: 5px 10px; font-size: 12px;">
                MDP
              </button>
              <button onclick="toggleUserActive(${user.id}, ${user.is_active !== false})" class="btn" style="background: ${user.is_active !== false ? '#6c757d' : '#28a745'}; padding: 5px 10px; font-size: 12px;">
                ${user.is_active !== false ? 'D√©sact.' : 'Activer'}
              </button>
              <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
                Suppr.
              </button>
            ` : '<span style="color: #666; font-style: italic; font-size: 12px;">Principal</span>'}
          </div>
        </div>
      `).join('');
    }

    // Add new user
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('newUsername').value.trim();
      const email = document.getElementById('newUserEmail').value.trim();
      const password = document.getElementById('newUserPassword').value;
      const role = document.getElementById('newUserRole').value;

      try {
        const response = await fetch(`${API_URL}/auth/users`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email: email || null, password, role })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation de l\'utilisateur');
        }

        // Success
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" cr√©√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        // Reset form and reload users
        document.getElementById('addUserForm').reset();
        loadUsers();

      } catch (error) {
        console.error('Error creating user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    });

    // Toggle user alerts
    async function toggleUserAlerts(userId, enabled) {
      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ receive_tournament_alerts: enabled })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        // Show brief success message
        document.getElementById('successMessage').textContent = `Alertes ${enabled ? 'activ√©es' : 'd√©sactiv√©es'}`;
        document.getElementById('successMessage').style.display = 'block';
        setTimeout(() => { document.getElementById('successMessage').style.display = 'none'; }, 2000);

      } catch (error) {
        console.error('Error toggling alerts:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        loadUsers(); // Reload to reset checkbox state
      }
    }

    // Toggle user role
    async function toggleUserRole(userId, currentRole) {
      const newRole = currentRole === 'admin' ? 'viewer' : 'admin';
      const action = currentRole === 'admin' ? 'r√©trograder en viewer' : 'promouvoir en admin';

      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ role: newRole })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = 'R√¥le modifi√© avec succ√®s !';
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error updating user role:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Edit user email - Open modal
    function editUserEmail(userId, username, currentEmail) {
      document.getElementById('editEmailUserId').value = userId;
      document.getElementById('editEmailUsername').textContent = username;
      document.getElementById('editEmailInput').value = currentEmail || '';
      document.getElementById('editEmailError').style.display = 'none';
      document.getElementById('editEmailModal').style.display = 'flex';
      document.getElementById('editEmailInput').focus();
    }

    // Close edit email modal
    function closeEditEmailModal() {
      document.getElementById('editEmailModal').style.display = 'none';
    }

    // Submit email update
    async function submitEmailUpdate() {
      const userId = document.getElementById('editEmailUserId').value;
      const username = document.getElementById('editEmailUsername').textContent;
      const newEmail = document.getElementById('editEmailInput').value.trim();
      const errorDiv = document.getElementById('editEmailError');

      // Basic email validation if not empty
      if (newEmail && !newEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        errorDiv.textContent = 'Format d\'email invalide';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: newEmail || null })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closeEditEmailModal();
        loadUsers();
        document.getElementById('successMessage').textContent = `Email de "${username}" modifi√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error updating email:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Reset user password - Open modal
    function resetUserPassword(userId, username) {
      document.getElementById('resetPasswordUserId').value = userId;
      document.getElementById('resetPasswordUsername').textContent = username;
      document.getElementById('resetPasswordInput').value = '';
      document.getElementById('resetPasswordInput').type = 'password';
      document.getElementById('resetPasswordError').style.display = 'none';

      // Reset the eye icon
      const eyeBtn = document.querySelector('#resetPasswordModal .toggle-password');
      if (eyeBtn) eyeBtn.textContent = 'üëÅÔ∏è';

      document.getElementById('resetPasswordModal').style.display = 'flex';
      document.getElementById('resetPasswordInput').focus();
    }

    // Toggle password visibility in modal
    function togglePasswordModal() {
      const input = document.getElementById('resetPasswordInput');
      const btn = document.querySelector('#resetPasswordModal .toggle-password');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    // Close reset password modal
    function closeResetPasswordModal() {
      document.getElementById('resetPasswordModal').style.display = 'none';
    }

    // Submit password reset
    async function submitPasswordReset() {
      const userId = document.getElementById('resetPasswordUserId').value;
      const username = document.getElementById('resetPasswordUsername').textContent;
      const newPassword = document.getElementById('resetPasswordInput').value;
      const errorDiv = document.getElementById('resetPasswordError');

      if (!newPassword) {
        errorDiv.textContent = 'Veuillez entrer un mot de passe';
        errorDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caracteres';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closeResetPasswordModal();
        document.getElementById('successMessage').textContent = `Mot de passe de "${username}" modifie avec succes !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error resetting password:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // Toggle user active status
    async function toggleUserActive(userId, isCurrentlyActive) {
      const action = isCurrentlyActive ? 'd√©sactiver' : 'activer';
      if (!confirm(`Voulez-vous ${action} cet utilisateur ?`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ is_active: !isCurrentlyActive })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur ${isCurrentlyActive ? 'd√©sactiv√©' : 'activ√©'} avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error toggling user status:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Delete user
    async function deleteUser(userId, username) {
      if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?\n\nCette action est irr√©versible.`)) return;

      try {
        const response = await fetch(`${API_URL}/auth/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la suppression');
        }

        loadUsers();
        document.getElementById('successMessage').textContent = `Utilisateur "${username}" supprim√© avec succ√®s !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error deleting user:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Load users on page load
    loadUsers();

    // ============= END USER MANAGEMENT =============

    // ============= PLAYER APP ACCOUNTS =============

    // Search player accounts
    async function searchPlayerAccounts() {
      const searchInput = document.getElementById('playerAccountSearch');
      const search = searchInput.value.trim();

      if (search.length < 2) {
        document.getElementById('playerAccountsList').innerHTML = `
          <p style="color: #666; text-align: center; font-style: italic;">Entrez au moins 2 caract√®res pour rechercher</p>
        `;
        return;
      }

      try {
        document.getElementById('playerAccountsList').innerHTML = `
          <p style="color: #666; text-align: center;">Recherche...</p>
        `;

        const response = await fetch(`${API_URL}/player-accounts?search=${encodeURIComponent(search)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          if (response.status === 403) {
            document.getElementById('playerAppAccountsSection').style.display = 'none';
            return;
          }
          throw new Error('Erreur lors du chargement');
        }

        const accounts = await response.json();
        renderPlayerAccountsList(accounts, search);
      } catch (error) {
        console.error('Error loading player accounts:', error);
        document.getElementById('playerAccountsList').innerHTML = `
          <p style="color: #dc3545; text-align: center;">Erreur: ${error.message}</p>
        `;
      }
    }

    // Keyboard support for search
    document.getElementById('playerAccountSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchPlayerAccounts();
      }
    });

    // Render player accounts list
    function renderPlayerAccountsList(accounts, searchQuery = '') {
      const container = document.getElementById('playerAccountsList');

      if (accounts.length === 0) {
        container.innerHTML = searchQuery
          ? `<p style="color: #666; text-align: center;">Aucun compte trouv√© pour "${searchQuery}"</p>`
          : '<p style="color: #666; text-align: center; font-style: italic;">Entrez au moins 2 caract√®res pour rechercher</p>';
        return;
      }

      container.innerHTML = accounts.map(account => `
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; background: white; border: 1px solid #ddd; border-radius: 8px; flex-wrap: wrap; gap: 10px;">
          <div style="display: flex; align-items: center; gap: 12px; flex: 1; min-width: 300px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: ${account.is_admin ? '#d32f2f' : '#1F4788'}; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
              ${account.is_admin ? 'üîë' : 'üë§'}
            </div>
            <div>
              <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <strong>${account.player_name || account.licence}</strong>
                <span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #e2e3e5; color: #383d41;">
                  ${account.licence}
                </span>
                ${account.is_admin ? '<span style="padding: 2px 8px; border-radius: 10px; font-size: 11px; background: #f8d7da; color: #721c24;">Admin</span>' : ''}
              </div>
              <div style="font-size: 12px; color: #666; margin-top: 4px;">
                ${account.email}
                ${account.last_login ? ` ‚Ä¢ Derni√®re connexion: ${new Date(account.last_login).toLocaleDateString('fr-FR')}` : ' ‚Ä¢ Jamais connect√©'}
              </div>
            </div>
          </div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
            <button onclick="resetPlayerPassword(${account.id}, '${account.licence}')" class="btn" style="background: #ffc107; color: #000; padding: 5px 10px; font-size: 12px;">
              MDP
            </button>
            <button onclick="togglePlayerAdmin(${account.id}, ${account.is_admin})" class="btn" style="background: ${account.is_admin ? '#6c757d' : '#d32f2f'}; padding: 5px 10px; font-size: 12px;">
              ${account.is_admin ? 'Retirer Admin' : 'Rendre Admin'}
            </button>
            <button onclick="deletePlayerAccount(${account.id}, '${account.licence}')" class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
              Supprimer
            </button>
          </div>
        </div>
      `).join('');
    }

    // Add player account form
    document.getElementById('addPlayerAccountForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const licence = document.getElementById('playerLicence').value.trim().toUpperCase();
      const email = document.getElementById('playerEmail').value.trim();
      const password = document.getElementById('playerPassword').value;
      const isAdmin = document.getElementById('playerIsAdmin').checked;

      try {
        const response = await fetch(`${API_URL}/player-accounts`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ licence, email, password, isAdmin })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation');
        }

        document.getElementById('successMessage').textContent = `Compte joueur cr√©√© pour ${licence} !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

        document.getElementById('addPlayerAccountForm').reset();
        searchPlayerAccounts();

      } catch (error) {
        console.error('Error creating player account:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('successMessage').style.display = 'none';
      }
    });

    // Toggle player admin status
    async function togglePlayerAdmin(id, currentIsAdmin) {
      const action = currentIsAdmin ? 'retirer les droits admin de' : 'donner les droits admin √†';
      if (!confirm(`Voulez-vous ${action} ce compte ?`)) return;

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ isAdmin: !currentIsAdmin })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        searchPlayerAccounts();
        document.getElementById('successMessage').textContent = 'Statut admin modifi√© !';
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error toggling admin:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Delete player account
    async function deletePlayerAccount(id, licence) {
      if (!confirm(`Supprimer le compte joueur "${licence}" ?\n\nCette action est irr√©versible.`)) return;

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la suppression');
        }

        searchPlayerAccounts();
        document.getElementById('successMessage').textContent = `Compte "${licence}" supprim√© !`;
        document.getElementById('successMessage').style.display = 'block';

      } catch (error) {
        console.error('Error deleting player account:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('errorMessage').style.display = 'block';
      }
    }

    // Reset player password - Open modal
    function resetPlayerPassword(id, licence) {
      document.getElementById('resetPlayerPasswordId').value = id;
      document.getElementById('resetPlayerPasswordLicence').textContent = licence;
      document.getElementById('resetPlayerPasswordInput').value = '';
      document.getElementById('resetPlayerPasswordInput').type = 'password';
      document.getElementById('resetPlayerPasswordError').style.display = 'none';

      // Reset the eye icon
      const eyeBtn = document.querySelector('#resetPlayerPasswordModal .toggle-password');
      if (eyeBtn) eyeBtn.textContent = 'üëÅÔ∏è';

      document.getElementById('resetPlayerPasswordModal').style.display = 'flex';
      document.getElementById('resetPlayerPasswordInput').focus();
    }

    // Toggle password visibility in player modal
    function togglePlayerPasswordModal() {
      const input = document.getElementById('resetPlayerPasswordInput');
      const btn = document.querySelector('#resetPlayerPasswordModal .toggle-password');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è';
      }
    }

    // Close player password modal
    function closePlayerPasswordModal() {
      document.getElementById('resetPlayerPasswordModal').style.display = 'none';
    }

    // Submit player password reset
    async function submitPlayerPasswordReset() {
      const id = document.getElementById('resetPlayerPasswordId').value;
      const licence = document.getElementById('resetPlayerPasswordLicence').textContent;
      const newPassword = document.getElementById('resetPlayerPasswordInput').value;
      const errorDiv = document.getElementById('resetPlayerPasswordError');

      if (!newPassword) {
        errorDiv.textContent = 'Veuillez entrer un mot de passe';
        errorDiv.style.display = 'block';
        return;
      }

      if (newPassword.length < 6) {
        errorDiv.textContent = 'Le mot de passe doit contenir au moins 6 caract√®res';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/player-accounts/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: newPassword })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors de la modification');
        }

        closePlayerPasswordModal();
        document.getElementById('successMessage').textContent = `Mot de passe du compte "${licence}" modifi√© !`;
        document.getElementById('successMessage').style.display = 'block';
        document.getElementById('errorMessage').style.display = 'none';

      } catch (error) {
        console.error('Error resetting player password:', error);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
      }
    }

    // ============= END PLAYER APP ACCOUNTS =============

    // ============= EMAIL SCHEDULER SETTINGS =============

    // Load scheduler hour setting
    async function loadSchedulerHour() {
      try {
        const response = await fetch(`${API_URL}/settings/app/email_scheduler_hour`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('schedulerHour').value = data.value;
          }
        }
      } catch (error) {
        console.error('Error loading scheduler hour:', error);
      }
    }

    // Save scheduler hour setting
    async function saveSchedulerHour() {
      const hour = document.getElementById('schedulerHour').value;
      const msgDiv = document.getElementById('schedulerMessage');

      try {
        const response = await fetch(`${API_URL}/settings/app/email_scheduler_hour`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: hour })
        });

        if (response.ok) {
          msgDiv.textContent = `Heure d'envoi configur√©e √† ${hour}h00`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving scheduler hour:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    // Load on page load
    loadSchedulerHour();

    // ============= END EMAIL SCHEDULER SETTINGS =============

    // ============= PLAYER APP SETTINGS =============

    // Load r√®glement URL setting
    async function loadReglementUrl() {
      try {
        const response = await fetch(`${API_URL}/settings/app/reglement_url`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('reglementUrl').value = data.value;
          }
        }
      } catch (error) {
        console.error('Error loading r√®glement URL:', error);
      }
    }

    // Save r√®glement URL setting
    async function saveReglementUrl() {
      const url = document.getElementById('reglementUrl').value.trim();
      const msgDiv = document.getElementById('reglementUrlMessage');

      // Basic URL validation
      if (url && !url.match(/^https?:\/\/.+/)) {
        msgDiv.textContent = 'Format d\'URL invalide (doit commencer par http:// ou https://)';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/app/reglement_url`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: url })
        });

        if (response.ok) {
          msgDiv.textContent = 'URL du r√®glement enregistr√©e';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving r√®glement URL:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    // Load on page load
    loadReglementUrl();

    // ============= END PLAYER APP SETTINGS =============

    // ============= CLUB ALIASES MANAGEMENT =============

    let clubsList = [];

    // Load clubs for the dropdown
    async function loadClubsForAliases() {
      try {
        const response = await fetch(`${API_URL}/clubs`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          clubsList = await response.json();
          const select = document.getElementById('newAliasCanonical');
          select.innerHTML = '<option value="">-- S√©lectionner un club --</option>';
          clubsList.forEach(club => {
            const option = document.createElement('option');
            option.value = club.name;
            option.textContent = club.display_name || club.name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading clubs:', error);
      }
    }

    // Load existing aliases
    async function loadClubAliases() {
      try {
        const response = await fetch(`${API_URL}/clubs/aliases/list`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const tbody = document.getElementById('aliasesTableBody');

        if (response.ok) {
          const aliases = await response.json();

          if (aliases.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #666;">Aucun alias configur√©</td></tr>';
            return;
          }

          tbody.innerHTML = aliases.map(alias => `
            <tr style="border-bottom: 1px solid #ddd;">
              <td style="padding: 12px;">${alias.alias}</td>
              <td style="padding: 12px;">${alias.canonical_name}</td>
              <td style="padding: 12px; text-align: center;">
                <button onclick="deleteClubAlias(${alias.id}, '${alias.alias.replace(/'/g, "\\'")}')"
                        class="btn" style="background: #dc3545; padding: 5px 10px; font-size: 12px;">
                  Supprimer
                </button>
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
        }
      } catch (error) {
        console.error('Error loading aliases:', error);
        document.getElementById('aliasesTableBody').innerHTML =
          '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
      }
    }

    // Add new alias
    async function addClubAlias() {
      const alias = document.getElementById('newAliasName').value.trim();
      const canonicalName = document.getElementById('newAliasCanonical').value;

      if (!alias || !canonicalName) {
        showAliasMessage('Veuillez remplir tous les champs', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/clubs/aliases`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ alias, canonical_name: canonicalName })
        });

        if (response.ok) {
          document.getElementById('newAliasName').value = '';
          document.getElementById('newAliasCanonical').value = '';
          showAliasMessage('Alias ajout√© avec succ√®s !', 'success');
          loadClubAliases();
        } else {
          const data = await response.json();
          showAliasMessage(data.error || 'Erreur lors de l\'ajout', 'error');
        }
      } catch (error) {
        console.error('Error adding alias:', error);
        showAliasMessage('Erreur de connexion', 'error');
      }
    }

    // Delete alias
    async function deleteClubAlias(id, aliasName) {
      if (!confirm(`Supprimer l'alias "${aliasName}" ?`)) return;

      try {
        const response = await fetch(`${API_URL}/clubs/aliases/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          showAliasMessage('Alias supprim√©', 'success');
          loadClubAliases();
        } else {
          showAliasMessage('Erreur lors de la suppression', 'error');
        }
      } catch (error) {
        console.error('Error deleting alias:', error);
        showAliasMessage('Erreur de connexion', 'error');
      }
    }

    // Show message for aliases section
    function showAliasMessage(message, type) {
      const msgDiv = document.getElementById('aliasesMessage');
      msgDiv.textContent = message;
      msgDiv.style.display = 'block';
      msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
      msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';

      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 3000);
    }

    // Load aliases on page load
    loadClubsForAliases();
    loadClubAliases();

    // ============= END CLUB ALIASES MANAGEMENT =============

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    });

    // ============= GAME PARAMETERS MANAGEMENT =============

    let gameParameters = [];

    // Load game parameters
    async function loadGameParameters() {
      try {
        const response = await fetch(`${API_URL}/settings/game-parameters`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement des param√®tres');
        }

        gameParameters = await response.json();
        renderGameParametersTable();
      } catch (error) {
        console.error('Error loading game parameters:', error);
        document.getElementById('gameParametersBody').innerHTML = `
          <tr><td colspan="9" style="text-align: center; padding: 20px; color: #dc3545;">Erreur: ${error.message}</td></tr>
        `;
      }
    }

    // Render game parameters table
    function renderGameParametersTable() {
      const tbody = document.getElementById('gameParametersBody');

      if (gameParameters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #666;">Aucun param√®tre configur√©</td></tr>';
        return;
      }

      const modeLabels = {
        'LIBRE': 'LIBRE',
        'CADRE': 'CADRE',
        'BANDE': 'BANDE',
        '3BANDES': '3 BANDES'
      };

      let currentMode = '';
      tbody.innerHTML = gameParameters.map(param => {
        const showMode = param.mode !== currentMode;
        currentMode = param.mode;
        const rowStyle = showMode ? 'border-top: 2px solid #1F4788;' : '';

        return `
          <tr style="${rowStyle}" data-id="${param.id}">
            <td style="padding: 10px; border-bottom: 1px solid #ddd; font-weight: ${showMode ? 'bold' : 'normal'};">
              ${showMode ? modeLabels[param.mode] || param.mode : ''}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd;">${param.categorie}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <span style="padding: 3px 8px; border-radius: 4px; background: ${param.coin === 'GC' ? '#ffc107' : param.coin === 'PC' ? '#17a2b8' : '#6c757d'}; color: ${param.coin === 'GC' ? '#000' : '#fff'}; font-size: 12px;">
                ${param.coin}
              </span>
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; font-weight: bold;">${param.distance_normale}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center; color: ${param.distance_reduite ? '#28a745' : '#999'};">
              ${param.distance_reduite || '-'}
            </td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${param.reprises}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_mini).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">${parseFloat(param.moyenne_maxi).toFixed(3)}</td>
            <td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: center;">
              <button onclick="editGameParameter(${param.id})" class="btn" style="background: #17a2b8; padding: 5px 10px; font-size: 12px;">
                Modifier
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Edit game parameter
    function editGameParameter(id) {
      const param = gameParameters.find(p => p.id === id);
      if (!param) return;

      const modeLabels = { 'LIBRE': 'LIBRE', 'CADRE': 'CADRE', 'BANDE': 'BANDE', '3BANDES': '3 BANDES' };

      // Fill the modal form with current values
      document.getElementById('editParamId').value = id;
      document.getElementById('editParamTitle').textContent = `${modeLabels[param.mode] || param.mode} - ${param.categorie}`;
      document.getElementById('editParamCoin').value = param.coin;
      document.getElementById('editParamDistNorm').value = param.distance_normale;
      document.getElementById('editParamDistRed').value = param.distance_reduite || '';
      document.getElementById('editParamReprises').value = param.reprises;
      document.getElementById('editParamMoyMini').value = parseFloat(param.moyenne_mini).toFixed(3);
      document.getElementById('editParamMoyMaxi').value = parseFloat(param.moyenne_maxi).toFixed(3);

      // Show the modal
      document.getElementById('editParamModal').style.display = 'flex';
    }

    function closeEditParamModal() {
      document.getElementById('editParamModal').style.display = 'none';
    }

    function saveGameParameter() {
      const id = parseInt(document.getElementById('editParamId').value);
      const coin = document.getElementById('editParamCoin').value;
      const distNorm = document.getElementById('editParamDistNorm').value;
      const distRed = document.getElementById('editParamDistRed').value;
      const reprises = document.getElementById('editParamReprises').value;
      const moyMini = document.getElementById('editParamMoyMini').value;
      const moyMaxi = document.getElementById('editParamMoyMaxi').value;

      if (!distNorm || !reprises || moyMini === '' || moyMaxi === '') {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
      }

      updateGameParameter(id, {
        coin: coin,
        distance_normale: parseInt(distNorm),
        distance_reduite: distRed ? parseInt(distRed) : null,
        reprises: parseInt(reprises),
        moyenne_mini: parseFloat(moyMini),
        moyenne_maxi: parseFloat(moyMaxi)
      });

      closeEditParamModal();
    }

    // Update game parameter
    async function updateGameParameter(id, data) {
      const msgDiv = document.getElementById('gameParamsMessage');

      try {
        const response = await fetch(`${API_URL}/settings/game-parameters/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const result = await response.json();
          throw new Error(result.error || 'Erreur lors de la mise √† jour');
        }

        msgDiv.textContent = 'Param√®tre mis √† jour avec succ√®s !';
        msgDiv.style.background = '#d4edda';
        msgDiv.style.color = '#155724';
        msgDiv.style.display = 'block';

        loadGameParameters();

        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);

      } catch (error) {
        console.error('Error updating game parameter:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
      }
    }

    // Load game parameters on page load
    loadGameParameters();

    // ============= END GAME PARAMETERS MANAGEMENT =============

    // ============= CATEGORY MAPPINGS MANAGEMENT =============

    let allCategories = [];

    // Load categories for dropdown
    async function loadCategories() {
      try {
        const response = await fetch(`${API_URL}/settings/categories`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          allCategories = await response.json();
          updateCategoryDropdown();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // Update category dropdown based on selected game type
    function updateCategoryDropdown() {
      const gameType = document.getElementById('newMappingGameType').value;
      const categorySelect = document.getElementById('newMappingCategory');

      categorySelect.innerHTML = '<option value="">S√©lectionner...</option>';

      const filtered = allCategories.filter(c => !gameType || c.game_type === gameType);
      filtered.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.game_type} - ${c.level}`;
        categorySelect.appendChild(option);
      });
    }

    // Load category mappings
    async function loadCategoryMappings() {
      try {
        const response = await fetch(`${API_URL}/settings/category-mappings/grouped`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load category mappings');

        const mappings = await response.json();
        const tbody = document.getElementById('categoryMappingsBody');

        if (mappings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #666;">Aucune correspondance configur√©e</td></tr>';
          return;
        }

        tbody.innerHTML = mappings.map(group => `
          <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 12px; font-weight: 500;">${group.game_type}</td>
            <td style="padding: 12px;">${group.level || 'N/A'}</td>
            <td style="padding: 12px;">
              <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                ${group.variations.map(v => `
                  <span style="background: #e7f3ff; padding: 4px 10px; border-radius: 15px; font-size: 13px; display: inline-flex; align-items: center; gap: 5px;">
                    ${v.ionos_categorie}
                    <button onclick="deleteMapping(${v.id})" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 14px; padding: 0; line-height: 1;" title="Supprimer">√ó</button>
                  </span>
                `).join('')}
              </div>
            </td>
            <td style="padding: 12px; text-align: center;">
              <span style="color: #666; font-size: 12px;">${group.variations.length} variation(s)</span>
            </td>
          </tr>
        `).join('');

      } catch (error) {
        console.error('Error loading category mappings:', error);
        document.getElementById('categoryMappingsBody').innerHTML =
          '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
      }
    }

    // Add new mapping
    document.getElementById('addMappingForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const ionos_categorie = document.getElementById('newIonosCategorie').value.trim();
      const game_type = document.getElementById('newMappingGameType').value;
      const category_id = document.getElementById('newMappingCategory').value;

      if (!ionos_categorie || !game_type || !category_id) {
        showCategoryMappingsMessage('Tous les champs sont requis', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/category-mappings`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ionos_categorie, game_type, category_id: parseInt(category_id) })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur lors de l\'ajout');
        }

        showCategoryMappingsMessage('Correspondance ajout√©e avec succ√®s', 'success');
        document.getElementById('addMappingForm').reset();
        loadCategoryMappings();
      } catch (error) {
        showCategoryMappingsMessage(error.message, 'error');
      }
    });

    // Delete mapping
    async function deleteMapping(id) {
      if (!confirm('Supprimer cette correspondance ?')) return;

      try {
        const response = await fetch(`${API_URL}/settings/category-mappings/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Erreur lors de la suppression');
        }

        showCategoryMappingsMessage('Correspondance supprim√©e', 'success');
        loadCategoryMappings();
      } catch (error) {
        showCategoryMappingsMessage(error.message, 'error');
      }
    }

    // Show message
    function showCategoryMappingsMessage(message, type) {
      const msgDiv = document.getElementById('categoryMappingsMessage');
      msgDiv.textContent = message;
      msgDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
      msgDiv.style.color = type === 'success' ? '#155724' : '#721c24';
      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 5000);
    }

    // Update category dropdown when game type changes
    document.getElementById('newMappingGameType').addEventListener('change', updateCategoryDropdown);

    // Load category mappings on page load
    loadCategories();
    loadCategoryMappings();

    // ============= END CATEGORY MAPPINGS MANAGEMENT =============

    // ============= MAINTENANCE FUNCTIONS =============

    // Load tournaments for maintenance dropdown
    async function loadMaintenanceTournaments() {
      try {
        const response = await fetch(`${API_URL}/tournaments`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const tournaments = await response.json();

        const select = document.getElementById('maintenanceTournamentSelect');
        select.innerHTML = '<option value="">-- S√©lectionner un tournoi --</option>';

        // Sort by date descending
        tournaments.sort((a, b) => new Date(b.tournament_date) - new Date(a.tournament_date));

        tournaments.forEach(t => {
          const date = t.tournament_date ? new Date(t.tournament_date).toLocaleDateString('fr-FR') : '';
          const option = document.createElement('option');
          option.value = t.id;
          option.textContent = `${t.display_name} - ${t.tournament_number || ''} (${date})`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading tournaments:', error);
      }
    }

    // Load tournaments on page load
    loadMaintenanceTournaments();

    // Recalculate moyennes for a single tournament
    async function recalculateSingleTournament() {
      const select = document.getElementById('maintenanceTournamentSelect');
      const tournamentId = select.value;
      const tournamentName = select.options[select.selectedIndex]?.text || '';
      const msgDiv = document.getElementById('maintenanceMessage');

      if (!tournamentId) {
        alert('Veuillez s√©lectionner un tournoi');
        return;
      }

      if (!confirm(`Voulez-vous recalculer les moyennes pour :\n\n${tournamentName} ?`)) {
        return;
      }

      try {
        msgDiv.textContent = '‚è≥ Recalcul en cours...';
        msgDiv.style.background = '#fff3cd';
        msgDiv.style.color = '#856404';
        msgDiv.style.display = 'block';

        const response = await fetch(`${API_URL}/tournaments/${tournamentId}/recalculate-moyennes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          let detailsHtml = '';
          if (data.details && data.details.length > 0) {
            detailsHtml = '<br><br><strong>Corrections :</strong><ul style="margin: 5px 0; padding-left: 20px;">';
            data.details.forEach(d => {
              detailsHtml += `<li>${d.player}: ${d.old} ‚Üí ${d.new}</li>`;
            });
            detailsHtml += '</ul>';
          }

          msgDiv.innerHTML = `‚úÖ <strong>Termin√© !</strong><br>
            ${data.total_checked} r√©sultats v√©rifi√©s<br>
            ${data.updated} moyennes corrig√©es${detailsHtml}`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error(data.error || 'Erreur lors du recalcul');
        }
      } catch (error) {
        msgDiv.textContent = '‚ùå Erreur: ' + error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      setTimeout(() => { msgDiv.style.display = 'none'; }, 15000);
    }

    // Recalculate all moyennes
    async function recalculateMoyennes() {
      const msgDiv = document.getElementById('maintenanceMessage');

      if (!confirm('Voulez-vous recalculer les moyennes de tous les r√©sultats de tournois ?\n\nCette op√©ration va recalculer moyenne = points √∑ reprises pour tous les r√©sultats.')) {
        return;
      }

      try {
        msgDiv.textContent = '‚è≥ Recalcul en cours...';
        msgDiv.style.background = '#fff3cd';
        msgDiv.style.color = '#856404';
        msgDiv.style.display = 'block';

        const response = await fetch(`${API_URL}/tournaments/recalculate-moyennes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          msgDiv.innerHTML = `‚úÖ <strong>Termin√© !</strong><br>
            ${data.total_checked} r√©sultats v√©rifi√©s<br>
            ${data.updated} moyennes corrig√©es`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error(data.error || 'Erreur lors du recalcul');
        }
      } catch (error) {
        msgDiv.textContent = '‚ùå Erreur: ' + error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      setTimeout(() => { msgDiv.style.display = 'none'; }, 10000);
    }

    // Recalculate all rankings
    async function recalculateAllRankings() {
      const msgDiv = document.getElementById('maintenanceMessage');

      if (!confirm('Voulez-vous recalculer tous les classements de la saison en cours ?\n\nCette op√©ration peut prendre quelques secondes.')) {
        return;
      }

      try {
        msgDiv.textContent = '‚è≥ Recalcul des classements en cours...';
        msgDiv.style.background = '#fff3cd';
        msgDiv.style.color = '#856404';
        msgDiv.style.display = 'block';

        const response = await fetch(`${API_URL}/tournaments/recalculate-all-rankings`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          msgDiv.innerHTML = `‚úÖ <strong>Termin√© !</strong><br>
            ${data.categories_updated || 'Tous les'} classements recalcul√©s`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error(data.error || 'Erreur lors du recalcul');
        }
      } catch (error) {
        msgDiv.textContent = '‚ùå Erreur: ' + error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      setTimeout(() => { msgDiv.style.display = 'none'; }, 10000);
    }

    // ============= END MAINTENANCE FUNCTIONS =============

    // ============= ORGANISATION SETTINGS =============

    async function loadOrganisationSettings() {
      try {
        const response = await fetch(`${API_URL}/settings/app-all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const settings = await response.json();
          document.getElementById('organizationName').value = settings.organization_name || '';
          document.getElementById('organizationShortName').value = settings.organization_short_name || '';
          document.getElementById('organizationEmail').value = settings.summary_email || '';
        }

        // Load logo info
        await loadLogoInfo();
      } catch (error) {
        console.error('Error loading organisation settings:', error);
      }
    }

    async function loadLogoInfo() {
      try {
        const response = await fetch(`${API_URL}/settings/organization-logo`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const info = await response.json();
          if (info.exists) {
            document.getElementById('logoPreviewImg').src = info.url + '?t=' + Date.now();
            document.getElementById('logoPreview').style.display = 'block';
          } else {
            document.getElementById('logoPreview').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error loading logo info:', error);
      }
    }

    async function uploadLogo(file) {
      if (!file) return;

      if (file.size > 2 * 1024 * 1024) {
        alert('Le fichier est trop volumineux (max 2 MB)');
        return;
      }

      const formData = new FormData();
      formData.append('logo', file);

      try {
        const response = await fetch(`${API_URL}/settings/organization-logo`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        if (response.ok) {
          await loadLogoInfo();
          const msgDiv = document.getElementById('organisationMessage');
          msgDiv.textContent = 'Logo televerse avec succes';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
          msgDiv.style.display = 'block';
          setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Erreur lors du telechargement');
        }
      } catch (error) {
        console.error('Error uploading logo:', error);
        alert('Erreur: ' + error.message);
      }

      // Clear file input
      document.getElementById('logoFileInput').value = '';
    }

    async function deleteLogo() {
      if (!confirm('Supprimer le logo ?')) return;

      try {
        const response = await fetch(`${API_URL}/settings/organization-logo`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          document.getElementById('logoPreview').style.display = 'none';
          const msgDiv = document.getElementById('organisationMessage');
          msgDiv.textContent = 'Logo supprime';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
          msgDiv.style.display = 'block';
          setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
        }
      } catch (error) {
        console.error('Error deleting logo:', error);
      }
    }

    async function saveOrganisationSettings() {
      const msgDiv = document.getElementById('organisationMessage');

      // Validate email
      const email = document.getElementById('organizationEmail').value.trim();
      if (email && !email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
        msgDiv.textContent = 'Adresse email invalide';
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
        msgDiv.style.display = 'block';
        setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
        return;
      }

      try {
        const response = await fetch(`${API_URL}/settings/app-bulk`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            organization_name: document.getElementById('organizationName').value.trim(),
            organization_short_name: document.getElementById('organizationShortName').value.trim(),
            summary_email: email
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Param√®tres de l\'organisation enregistr√©s';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving organisation settings:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadOrganisationSettings();

    // ============= END ORGANISATION SETTINGS =============

    // ============= BRANDING SETTINGS =============

    // Sync color picker with text input
    function setupColorSync(colorId) {
      const colorInput = document.getElementById(colorId);
      const textInput = document.getElementById(colorId + 'Text');

      colorInput.addEventListener('input', () => {
        textInput.value = colorInput.value.toUpperCase();
      });

      textInput.addEventListener('change', () => {
        const value = textInput.value.trim();
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
          colorInput.value = value;
        }
      });
    }

    // Setup all color pickers
    ['primaryColor', 'secondaryColor', 'accentColor', 'backgroundColor', 'backgroundSecondaryColor'].forEach(setupColorSync);

    async function loadBrandingSettings() {
      try {
        const response = await fetch(`${API_URL}/settings/app-all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const settings = await response.json();

          const colors = {
            primaryColor: settings.primary_color || '#1F4788',
            secondaryColor: settings.secondary_color || '#667EEA',
            accentColor: settings.accent_color || '#FFC107',
            backgroundColor: settings.background_color || '#FFFFFF',
            backgroundSecondaryColor: settings.background_secondary_color || '#F5F5F5'
          };

          for (const [id, value] of Object.entries(colors)) {
            document.getElementById(id).value = value;
            document.getElementById(id + 'Text').value = value;
          }
        }
      } catch (error) {
        console.error('Error loading branding settings:', error);
      }
    }

    async function saveBrandingSettings() {
      const msgDiv = document.getElementById('brandingMessage');

      try {
        const response = await fetch(`${API_URL}/settings/app-bulk`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            primary_color: document.getElementById('primaryColor').value,
            secondary_color: document.getElementById('secondaryColor').value,
            accent_color: document.getElementById('accentColor').value,
            background_color: document.getElementById('backgroundColor').value,
            background_secondary_color: document.getElementById('backgroundSecondaryColor').value
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Identit√© visuelle enregistr√©e';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving branding settings:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadBrandingSettings();

    // ============= END BRANDING SETTINGS =============

    // ============= EMAILS CONFIG SETTINGS =============

    async function loadEmailsConfig() {
      try {
        const response = await fetch(`${API_URL}/settings/app-all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const settings = await response.json();
          document.getElementById('emailCommunication').value = settings.email_communication || '';
          document.getElementById('emailConvocations').value = settings.email_convocations || '';
          document.getElementById('emailNoreply').value = settings.email_noreply || '';
          document.getElementById('emailSenderName').value = settings.email_sender_name || '';
        }
      } catch (error) {
        console.error('Error loading emails config:', error);
      }
    }

    async function saveEmailsConfig() {
      const msgDiv = document.getElementById('emailsConfigMessage');

      try {
        const response = await fetch(`${API_URL}/settings/app-bulk`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email_communication: document.getElementById('emailCommunication').value.trim(),
            email_convocations: document.getElementById('emailConvocations').value.trim(),
            email_noreply: document.getElementById('emailNoreply').value.trim(),
            email_sender_name: document.getElementById('emailSenderName').value.trim()
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Configuration des emails enregistr√©e';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving emails config:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadEmailsConfig();

    // ============= END EMAILS CONFIG SETTINGS =============

    // ============= SEASON SETTINGS =============

    async function loadSeasonSettings() {
      try {
        const response = await fetch(`${API_URL}/settings/app/season_cutoff_month`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          if (data.value) {
            document.getElementById('seasonCutoffMonth').value = data.value;
          }
        }
      } catch (error) {
        console.error('Error loading season settings:', error);
      }
    }

    async function saveSeasonSettings() {
      const msgDiv = document.getElementById('seasonMessage');
      const month = document.getElementById('seasonCutoffMonth').value;
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

      try {
        const response = await fetch(`${API_URL}/settings/app/season_cutoff_month`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ value: month })
        });

        if (response.ok) {
          msgDiv.textContent = `Mois de d√©but de saison configur√© : ${monthNames[parseInt(month)]}`;
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving season settings:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadSeasonSettings();

    // ============= END SEASON SETTINGS =============

    // ============= RANKINGS CONFIG SETTINGS =============

    async function loadRankingsConfig() {
      try {
        const response = await fetch(`${API_URL}/settings/app-all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const settings = await response.json();
          document.getElementById('qualificationThreshold').value = settings.qualification_threshold || '9';
          document.getElementById('qualificationSmall').value = settings.qualification_small || '4';
          document.getElementById('qualificationLarge').value = settings.qualification_large || '6';

          // Update display
          updateRankingsRuleDisplay(
            settings.qualification_threshold || '9',
            settings.qualification_small || '4',
            settings.qualification_large || '6'
          );
        }
      } catch (error) {
        console.error('Error loading rankings config:', error);
      }
    }

    function updateRankingsRuleDisplay(threshold, small, large) {
      document.getElementById('rankingsRuleDisplay').innerHTML = `
        Si une cat√©gorie a <strong>moins de ${threshold} joueurs</strong>, les <strong>${small} premiers</strong> sont qualifi√©s pour la finale.<br>
        Si une cat√©gorie a <strong>${threshold} joueurs ou plus</strong>, les <strong>${large} premiers</strong> sont qualifi√©s.
      `;
    }

    async function saveRankingsConfig() {
      const msgDiv = document.getElementById('rankingsConfigMessage');
      const threshold = document.getElementById('qualificationThreshold').value;
      const small = document.getElementById('qualificationSmall').value;
      const large = document.getElementById('qualificationLarge').value;

      try {
        const response = await fetch(`${API_URL}/settings/app-bulk`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            qualification_threshold: threshold,
            qualification_small: small,
            qualification_large: large
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Configuration des classements enregistr√©e';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
          updateRankingsRuleDisplay(threshold, small, large);
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving rankings config:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadRankingsConfig();

    // ============= END RANKINGS CONFIG SETTINGS =============

    // ============= TOURNAMENT TYPES SETTINGS =============

    async function loadTournamentTypes() {
      try {
        const response = await fetch(`${API_URL}/settings/tournament-types`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const types = await response.json();
          renderTournamentTypes(types);
        }
      } catch (error) {
        console.error('Error loading tournament types:', error);
        document.getElementById('tournamentTypesBody').innerHTML =
          '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">Erreur de chargement</td></tr>';
      }
    }

    function renderTournamentTypes(types) {
      const tbody = document.getElementById('tournamentTypesBody');

      if (!types || types.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">Aucun type de tournoi configur√©</td></tr>';
        return;
      }

      tbody.innerHTML = types.map(t => `
        <tr style="border-bottom: 1px solid #ddd;" data-id="${t.id}">
          <td style="padding: 12px; text-align: center; font-weight: bold;">${t.tournament_number}</td>
          <td style="padding: 12px;">
            <input type="text" value="${t.code}" class="tt-code" style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 12px;">
            <input type="text" value="${t.display_name}" class="tt-display-name" style="width: 200px; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 12px; text-align: center;">
            <input type="checkbox" ${t.include_in_ranking ? 'checked' : ''} class="tt-include" style="width: 20px; height: 20px; cursor: pointer;">
          </td>
          <td style="padding: 12px; text-align: center;">
            <button onclick="saveTournamentType(${t.id})" class="btn" style="background: #28a745; padding: 5px 12px; font-size: 12px;">
              Sauver
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function saveTournamentType(id) {
      const row = document.querySelector(`tr[data-id="${id}"]`);
      const code = row.querySelector('.tt-code').value.trim();
      const displayName = row.querySelector('.tt-display-name').value.trim();
      const includeInRanking = row.querySelector('.tt-include').checked;
      const msgDiv = document.getElementById('tournamentTypesMessage');

      try {
        const response = await fetch(`${API_URL}/settings/tournament-types/${id}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            code: code,
            display_name: displayName,
            include_in_ranking: includeInRanking
          })
        });

        if (response.ok) {
          msgDiv.textContent = 'Type de tournoi mis √† jour';
          msgDiv.style.background = '#d4edda';
          msgDiv.style.color = '#155724';
        } else {
          throw new Error('Erreur lors de la sauvegarde');
        }
      } catch (error) {
        console.error('Error saving tournament type:', error);
        msgDiv.textContent = error.message;
        msgDiv.style.background = '#f8d7da';
        msgDiv.style.color = '#721c24';
      }

      msgDiv.style.display = 'block';
      setTimeout(() => { msgDiv.style.display = 'none'; }, 3000);
    }

    loadTournamentTypes();

    // ============= END TOURNAMENT TYPES SETTINGS =============

    // ============= PRIVACY POLICY SETTINGS =============

    async function loadPrivacyPolicyInfo() {
      try {
        const response = await fetch(`${API_URL}/settings/app/privacy_policy`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const data = await response.json();
          const updateEl = document.getElementById('privacyPolicyLastUpdate');
          if (data.value && data.value.length > 0) {
            if (data.updated_at) {
              updateEl.textContent = new Date(data.updated_at).toLocaleDateString('fr-FR');
            } else {
              updateEl.textContent = 'Configur√©e';
            }
          } else {
            updateEl.textContent = 'Non configur√©e';
          }
        }
      } catch (error) {
        console.error('Error loading privacy policy info:', error);
      }
    }

    loadPrivacyPolicyInfo();

    // ============= END PRIVACY POLICY SETTINGS =============

    // ============= ACTIVITY LOGS QUICK STATS =============
    async function loadLogsQuickStats() {
      try {
        const response = await fetch(`${API_URL}/activity-logs/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const stats = await response.json();
          const container = document.getElementById('logsQuickStats');
          if (container) {
            container.innerHTML = `
              <span title="7 derniers jours">üîë <strong>${stats.logins || 0}</strong> connexions</span>
              <span title="7 derniers jours">üìù <strong>${stats.inscriptions || 0}</strong> inscriptions</span>
              <span title="7 derniers jours">üë§ <strong>${stats.newAccounts || 0}</strong> nouveaux comptes</span>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading logs quick stats:', error);
        const container = document.getElementById('logsQuickStats');
        if (container) {
          container.innerHTML = '<span style="color: #999;">Stats indisponibles</span>';
        }
      }
    }

    // Load logs stats on page load (admin only)
    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      loadLogsQuickStats();
    }

    // ============= END ACTIVITY LOGS QUICK STATS =============

    // ============= HASH-BASED CARD NAVIGATION =============

    // Show only the targeted card when navigating via URL hash
    function handleHashNavigation() {
      const hash = window.location.hash;
      const allCards = document.querySelectorAll('.card');

      if (hash && hash.length > 1) {
        const targetId = hash.substring(1);
        const targetCard = document.getElementById(targetId);

        if (targetCard) {
          // Hide all cards
          allCards.forEach(card => {
            card.style.display = 'none';
          });

          // Show only the targeted card
          targetCard.style.display = 'block';

          // Add back button if not already present
          if (!document.getElementById('backToSettingsBtn')) {
            const backBtn = document.createElement('div');
            backBtn.id = 'backToSettingsBtn';
            backBtn.innerHTML = `
              <a href="settings.html" style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 10px 20px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; text-decoration: none; color: #333; font-weight: 500;">
                ‚Üê Retour aux param√®tres
              </a>
              <a href="settings-admin.html" style="display: inline-flex; align-items: center; gap: 8px; margin-left: 10px; padding: 10px 20px; background: #e7f3ff; border: 1px solid #1F4788; border-radius: 6px; text-decoration: none; color: #1F4788; font-weight: 500;">
                Voir tous les param√®tres
              </a>
            `;
            targetCard.parentNode.insertBefore(backBtn, targetCard);
          }

          // Scroll to top
          window.scrollTo(0, 0);
        }
      }
    }

    // Handle hash changes and initial load
    handleHashNavigation();
    window.addEventListener('hashchange', handleHashNavigation);

    // ============= END HASH-BASED CARD NAVIGATION =============
  </script>

  <!-- Edit Game Parameter Modal -->
  <div id="editParamModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Modifier les parametres</h3>
      <h4 id="editParamTitle" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center;"></h4>

      <input type="hidden" id="editParamId">

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Coin *</label>
          <select id="editParamCoin" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="GC">GC (Grand Coin)</option>
            <option value="PC">PC (Petit Coin)</option>
            <option value="-">- (Non applicable)</option>
          </select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Reprises *</label>
          <input type="number" id="editParamReprises" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Normale *</label>
          <input type="number" id="editParamDistNorm" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Distance Reduite</label>
          <input type="number" id="editParamDistRed" placeholder="Optionnel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Mini *</label>
          <input type="number" id="editParamMoyMini" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>

        <div>
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Moyenne Maxi *</label>
          <input type="number" id="editParamMoyMaxi" step="0.001" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;" required>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button onclick="saveGameParameter()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditParamModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div id="resetPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Reinitialiser le mot de passe</h3>
      <p id="resetPasswordUsername" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="resetPasswordUserId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nouveau mot de passe *</label>
        <div class="password-wrapper" style="position: relative;">
          <input type="password" id="resetPasswordInput" minlength="6" placeholder="Min. 6 caracteres" style="width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <button type="button" class="toggle-password" onclick="togglePasswordModal()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">üëÅÔ∏è</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">Min. 8 caracteres, 1 majuscule, 1 chiffre, 1 caractere special</small>
      </div>

      <div id="resetPasswordError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitPasswordReset()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeResetPasswordModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Edit Email Modal -->
  <div id="editEmailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Modifier l'email</h3>
      <p id="editEmailUsername" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="editEmailUserId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Adresse email</label>
        <input type="email" id="editEmailInput" placeholder="ex: utilisateur@email.com" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
        <small style="color: #666; display: block; margin-top: 5px;">L'email permet la r√©initialisation du mot de passe en self-service</small>
      </div>

      <div id="editEmailError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitEmailUpdate()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closeEditEmailModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Reset Player Password Modal -->
  <div id="resetPlayerPasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 20px 0; color: #1F4788;">Reinitialiser le mot de passe joueur</h3>
      <p id="resetPlayerPasswordLicence" style="margin: 0 0 20px 0; color: #333; background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold;"></p>

      <input type="hidden" id="resetPlayerPasswordId">

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">Nouveau mot de passe *</label>
        <div class="password-wrapper" style="position: relative;">
          <input type="password" id="resetPlayerPasswordInput" minlength="6" placeholder="Min. 6 caracteres" style="width: 100%; padding: 12px; padding-right: 45px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; box-sizing: border-box;">
          <button type="button" class="toggle-password" onclick="togglePlayerPasswordModal()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666;">üëÅÔ∏è</button>
        </div>
        <small style="color: #666; display: block; margin-top: 5px;">Min. 8 caracteres, 1 majuscule, 1 chiffre, 1 caractere special</small>
      </div>

      <div id="resetPlayerPasswordError" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8d7da; color: #721c24; border-radius: 4px; font-size: 13px;"></div>

      <div style="display: flex; gap: 10px;">
        <button onclick="submitPlayerPasswordReset()" class="btn" style="flex: 1; background: #28a745; padding: 12px; font-size: 14px;">Enregistrer</button>
        <button onclick="closePlayerPasswordModal()" class="btn" style="flex: 1; background: #6c757d; padding: 12px; font-size: 14px;">Annuler</button>
      </div>
    </div>
  </div>
</body>
</html>
