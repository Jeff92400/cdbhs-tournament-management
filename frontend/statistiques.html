<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistiques - CDBHS</title>
  <link rel="icon" type="image/png" href="images/billiard-icon.png">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: #1F4788;
      margin: 0;
    }

    .season-filter {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .season-filter label {
      font-weight: 600;
      color: #666;
    }

    .season-filter select {
      padding: 8px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      min-width: 150px;
    }

    /* Summary Cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .summary-card-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .summary-card-value {
      font-size: 32px;
      font-weight: 700;
      color: #1F4788;
    }

    .summary-card-label {
      font-size: 13px;
      color: #666;
      margin-top: 5px;
    }

    /* Tabs */
    .stats-tabs {
      display: flex;
      gap: 5px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 30px;
      overflow-x: auto;
    }

    .stats-tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .stats-tab:hover {
      color: #1F4788;
    }

    .stats-tab.active {
      color: #1F4788;
      border-bottom-color: #1F4788;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Stats Sections */
    .stats-section {
      margin-bottom: 30px;
    }

    .stats-section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }

    .stats-card {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .stats-card-header {
      background: linear-gradient(135deg, #1F4788 0%, #3B5998 100%);
      color: white;
      padding: 12px 20px;
      font-weight: 600;
    }

    .stats-card-header.libre {
      background: linear-gradient(135deg, #1F4788 0%, #3B5998 100%);
    }

    .stats-card-header.bande {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .stats-card-header.trois-bandes {
      background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }

    .stats-card-header.cadre {
      background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
    }

    .stats-card-body {
      padding: 15px;
    }

    /* Ranking Table */
    .ranking-table {
      width: 100%;
      border-collapse: collapse;
    }

    .ranking-table th,
    .ranking-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    .ranking-table thead {
      background: linear-gradient(135deg, #1F4788 0%, #8B5CF6 100%);
    }

    .ranking-table th {
      font-weight: 600;
      color: white;
      font-size: 11px;
      text-transform: uppercase;
    }

    .ranking-table tr:last-child td {
      border-bottom: none;
    }

    .ranking-table tr:hover {
      background: #f8f9fa;
    }

    .rank-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 12px;
    }

    .rank-other {
      background: #f0f0f0;
      color: #666;
    }

    .medal {
      font-size: 18px;
    }

    .player-name {
      font-weight: 600;
      color: #333;
    }

    .player-club {
      font-size: 11px;
      color: #888;
    }

    .stat-value {
      font-weight: 700;
      color: #1F4788;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #1F4788;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      background: linear-gradient(135deg, #1F4788 0%, #3B5998 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 16px;
    }

    .modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-body {
      padding: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .player-list-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .player-list-item:last-child {
      border-bottom: none;
    }

    .player-list-name {
      font-weight: 600;
      color: #333;
    }

    .player-list-club {
      font-size: 12px;
      color: #888;
    }

    /* Clickable stat card */
    .stat-card-clickable {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card-clickable:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="navbar">
      <h2><img src="images/billiard-icon.png" alt="üé±" style="height: 28px; width: 28px; vertical-align: middle; margin-right: 8px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';"><span style="display:none;">üé±</span> Statistiques</h2>
      <div class="nav-links">
        <a href="dashboard.html">Accueil</a>
        <a href="rankings.html">Classements</a>
        <a href="generate-poules.html">Comp√©titions</a>
        <a href="emailing.html" class="admin-only">Emailing</a>
        <a href="settings.html" class="admin-only">Param√®tres</a>
        <a href="#" id="logoutBtn" class="nav-logout">D√©connexion</a>
      </div>
    </div>

    <div id="errorMessage" class="error" style="display: none;"></div>

    <div class="card">
      <!-- Page Header -->
      <div class="page-header">
        <h3 class="page-title">üìà Statistiques</h3>
        <div class="season-filter">
          <label for="seasonSelect">Saison :</label>
          <select id="seasonSelect">
            <option value="">Chargement...</option>
          </select>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="summary-cards" id="summaryCards">
        <div class="summary-card">
          <div class="summary-card-icon">üèÜ</div>
          <div class="summary-card-value" id="totalTournaments">-</div>
          <div class="summary-card-label">Comp√©titions jou√©es</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">üë•</div>
          <div class="summary-card-value" id="totalPlayers">-</div>
          <div class="summary-card-label">Joueurs uniques</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">üéØ</div>
          <div class="summary-card-value" id="totalParticipations">-</div>
          <div class="summary-card-label">Participations totales</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="stats-tabs">
        <button class="stats-tab active" data-tab="clubs">üè¢ Clubs</button>
        <button class="stats-tab" data-tab="players">üë§ Joueurs</button>
        <button class="stats-tab" data-tab="general">üìä G√©n√©ral</button>
      </div>

      <!-- Tab: Clubs -->
      <div class="tab-content active" id="tab-clubs">
        <!-- Club Podiums by Mode -->
        <div class="stats-section">
          <h2 class="stats-section-title">üèÖ Podiums par Club et Mode de Jeu</h2>
          <div class="stats-grid" id="clubPodiumsGrid">
            <div class="loading">
              <div class="loading-spinner"></div>
              <p>Chargement des statistiques...</p>
            </div>
          </div>
        </div>

        <!-- Most Active Clubs -->
        <div class="stats-section">
          <h2 class="stats-section-title">üî• Clubs les Plus Actifs</h2>
          <div class="stats-card">
            <div class="stats-card-header">Participations aux tournois</div>
            <div class="stats-card-body" id="activeClubsTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Players -->
      <div class="tab-content" id="tab-players">
        <!-- Most Active Players -->
        <div class="stats-section">
          <h2 class="stats-section-title">üî• Joueurs les Plus Actifs</h2>
          <div class="stats-card">
            <div class="stats-card-header">Top 10 - Nombre de tournois jou√©s</div>
            <div class="stats-card-body" id="activePlayersTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Best Moyenne by Category -->
        <div class="stats-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h2 class="stats-section-title" style="margin-bottom: 0;">üìä Meilleures Moyennes par Cat√©gorie</h2>
            <select id="moyenneCategorySelect" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; min-width: 200px;">
              <option value="">S√©lectionner une cat√©gorie...</option>
            </select>
          </div>
          <div class="stats-card">
            <div class="stats-card-header" id="moyenneCardHeader">Top 10 - Moyennes</div>
            <div class="stats-card-body" id="playerMoyenneTable">
              <div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>
            </div>
          </div>
        </div>

        <!-- Best Serie by Category -->
        <div class="stats-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h2 class="stats-section-title" style="margin-bottom: 0;">‚ö° Meilleures S√©ries par Cat√©gorie</h2>
            <select id="serieCategorySelect" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; min-width: 200px;">
              <option value="">S√©lectionner une cat√©gorie...</option>
            </select>
          </div>
          <div class="stats-card">
            <div class="stats-card-header" id="serieCardHeader">Top 10 - S√©ries</div>
            <div class="stats-card-body" id="playerSerieTable">
              <div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>
            </div>
          </div>
        </div>

        <!-- New Players -->
        <div class="stats-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h2 class="stats-section-title" style="margin-bottom: 0;">üåü Nouveaux Joueurs</h2>
            <select id="newPlayersSeasonSelect" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 14px; min-width: 150px;">
              <option value="">Chargement...</option>
            </select>
          </div>
          <div class="stats-card">
            <div class="stats-card-header" id="newPlayersCardHeader">Premi√®re participation en comp√©tition</div>
            <div class="stats-card-body" id="newPlayersTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Multi-Category Players -->
        <div class="stats-section">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
            <h2 class="stats-section-title" style="margin-bottom: 0;">üéØ Joueurs Multi-Cat√©gories</h2>
            <span style="font-size: 12px; color: #888;">(bas√© sur le fichier joueurs)</span>
          </div>
          <div class="stats-card">
            <div class="stats-card-header">R√©partition des joueurs actifs par nombre de cat√©gories (non-NC)</div>
            <div class="stats-card-body" id="multiCatTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: General -->
      <div class="tab-content" id="tab-general">
        <!-- Participation Rate -->
        <div class="stats-section">
          <h2 class="stats-section-title">üìà Taux de Participation par Mode</h2>
          <div class="stats-card">
            <div class="stats-card-header">Inscriptions vs Forfaits</div>
            <div class="stats-card-body" id="participationTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Categories -->
        <div class="stats-section">
          <h2 class="stats-section-title">üìã Participation par Cat√©gorie</h2>
          <div class="stats-card">
            <div class="stats-card-header">Nombre de joueurs par cat√©gorie</div>
            <div class="stats-card-body" id="categoriesTable">
              <div class="loading">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    let currentSeason = '';

    // Authentication
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html';
    }

    const userRole = localStorage.getItem('userRole');
    if (userRole === 'admin') {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
    } else {
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    document.getElementById('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('userRole');
      localStorage.removeItem('username');
      window.location.href = 'login.html';
    });

    // Tab management
    document.querySelectorAll('.stats-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.stats-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    // Helper: Get mode header class
    function getModeClass(mode) {
      const m = (mode || '').toUpperCase();
      if (m === 'LIBRE') return 'libre';
      if (m === 'BANDE') return 'bande';
      if (m === '3BANDES' || m === '3 BANDES') return 'trois-bandes';
      if (m === 'CADRE') return 'cadre';
      return '';
    }

    // Helper: Get mode display name
    function getModeDisplayName(mode) {
      const m = (mode || '').toUpperCase();
      if (m === 'LIBRE') return 'Libre';
      if (m === 'BANDE') return 'Bande';
      if (m === '3BANDES' || m === '3 BANDES') return '3 Bandes';
      if (m === 'CADRE') return 'Cadre';
      return mode;
    }

    // Helper: Create ranking badge
    function createRankBadge(rank) {
      const badges = ['ü•á', 'ü•à', 'ü•â'];
      if (rank <= 3) {
        return `<span class="medal">${badges[rank - 1]}</span>`;
      }
      return `<span class="rank-badge rank-other">${rank}</span>`;
    }

    // Load seasons
    async function loadSeasons() {
      try {
        const response = await fetch(`${API_URL}/statistics/seasons`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const seasons = await response.json();
          const select = document.getElementById('seasonSelect');
          select.innerHTML = seasons.map((s, i) =>
            `<option value="${s}" ${i === 0 ? 'selected' : ''}>${s}</option>`
          ).join('');

          // Also populate new players season dropdown
          const newPlayersSeasonSelect = document.getElementById('newPlayersSeasonSelect');
          newPlayersSeasonSelect.innerHTML = seasons.map((s, i) =>
            `<option value="${s}" ${i === 0 ? 'selected' : ''}>${s}</option>`
          ).join('');

          currentSeason = seasons[0] || '';
          loadAllStats();
        }
      } catch (error) {
        console.error('Error loading seasons:', error);
      }
    }

    // Season change handler
    document.getElementById('seasonSelect').addEventListener('change', (e) => {
      currentSeason = e.target.value;
      loadAllStats();
    });

    // Category dropdown handlers
    document.getElementById('moyenneCategorySelect').addEventListener('change', (e) => {
      loadPlayerMoyenne(e.target.value);
    });

    document.getElementById('serieCategorySelect').addEventListener('change', (e) => {
      loadPlayerSerie(e.target.value);
    });

    // New players season selector
    document.getElementById('newPlayersSeasonSelect').addEventListener('change', (e) => {
      loadNewPlayers(e.target.value);
    });


    // Load all statistics
    async function loadAllStats() {
      loadSummary();
      loadClubPodiums();
      loadActiveClubs();
      loadActivePlayers();
      loadStatCategories(); // Load categories for dropdowns (wins, moyenne, serie)
      loadNewPlayers();
      loadMultiCatStats();
      loadParticipation();
      loadCategories();
    }

    // Load categories for dropdowns
    async function loadStatCategories() {
      try {
        const response = await fetch(`${API_URL}/statistics/categories?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const categories = await response.json();

          // Populate dropdowns
          const moyenneSelect = document.getElementById('moyenneCategorySelect');
          const serieSelect = document.getElementById('serieCategorySelect');

          const options = categories.map(c =>
            `<option value="${c.id}">${c.display_name}</option>`
          ).join('');

          moyenneSelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie...</option>' + options;
          serieSelect.innerHTML = '<option value="">S√©lectionner une cat√©gorie...</option>' + options;

          // Reset tables
          document.getElementById('playerMoyenneTable').innerHTML = '<div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>';
          document.getElementById('playerSerieTable').innerHTML = '<div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>';
        }
      } catch (error) {
        console.error('Error loading stat categories:', error);
      }
    }

    // Load summary
    async function loadSummary() {
      try {
        const response = await fetch(`${API_URL}/statistics/summary?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          document.getElementById('totalTournaments').textContent = data.totalTournaments || 0;
          document.getElementById('totalPlayers').textContent = data.totalPlayers || 0;
          document.getElementById('totalParticipations').textContent = data.totalParticipations || 0;
        }
      } catch (error) {
        console.error('Error loading summary:', error);
      }
    }

    // Load club podiums
    async function loadClubPodiums() {
      const container = document.getElementById('clubPodiumsGrid');
      try {
        const response = await fetch(`${API_URL}/statistics/clubs/podiums?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          const modes = Object.keys(data);

          if (modes.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>Aucune donn√©e disponible pour cette saison</p></div>';
            return;
          }

          container.innerHTML = modes.map(mode => `
            <div class="stats-card">
              <div class="stats-card-header ${getModeClass(mode)}">${getModeDisplayName(mode)}</div>
              <div class="stats-card-body">
                <table class="ranking-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Club</th>
                      <th>ü•á</th>
                      <th>ü•à</th>
                      <th>ü•â</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${(() => {
                      const top3 = data[mode].slice(0, 3);
                      const others = data[mode].slice(3);
                      const othersTotal = others.reduce((acc, c) => ({
                        gold: acc.gold + c.gold,
                        silver: acc.silver + c.silver,
                        bronze: acc.bronze + c.bronze,
                        podiums: acc.podiums + c.podiums
                      }), { gold: 0, silver: 0, bronze: 0, podiums: 0 });

                      let html = top3.map((club, i) => `
                        <tr>
                          <td>${createRankBadge(i + 1)}</td>
                          <td class="player-name">${club.club}</td>
                          <td class="stat-value">${club.gold}</td>
                          <td>${club.silver}</td>
                          <td>${club.bronze}</td>
                          <td class="stat-value">${club.podiums}</td>
                        </tr>
                      `).join('');

                      if (others.length > 0) {
                        html += `
                          <tr style="background: #f8f9fa; font-style: italic;">
                            <td></td>
                            <td class="player-name">Autres clubs (${others.length})</td>
                            <td class="stat-value">${othersTotal.gold}</td>
                            <td>${othersTotal.silver}</td>
                            <td>${othersTotal.bronze}</td>
                            <td class="stat-value">${othersTotal.podiums}</td>
                          </tr>
                        `;
                      }
                      return html;
                    })()}
                  </tbody>
                </table>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading club podiums:', error);
        container.innerHTML = '<div class="empty-state"><p>Erreur de chargement</p></div>';
      }
    }

    // Load active clubs
    async function loadActiveClubs() {
      const container = document.getElementById('activeClubsTable');
      try {
        const response = await fetch(`${API_URL}/statistics/clubs/participations?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible</div>';
            return;
          }

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Club</th>
                  <th>Joueurs</th>
                  <th>Participations</th>
                </tr>
              </thead>
              <tbody>
                ${data.map((club, i) => `
                  <tr>
                    <td>${createRankBadge(i + 1)}</td>
                    <td class="player-name">${club.club}</td>
                    <td>${club.unique_players}</td>
                    <td class="stat-value">${club.total_participations}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading active clubs:', error);
      }
    }

    // Load active players
    async function loadActivePlayers() {
      const container = document.getElementById('activePlayersTable');
      try {
        const response = await fetch(`${API_URL}/statistics/players/active?season=${currentSeason}&limit=10`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible</div>';
            return;
          }

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Joueur</th>
                  <th>Club</th>
                  <th>Comp√©titions</th>
                  <th>Modes</th>
                </tr>
              </thead>
              <tbody>
                ${data.map((player, i) => `
                  <tr>
                    <td>${createRankBadge(i + 1)}</td>
                    <td class="player-name">${player.player_name}</td>
                    <td class="player-club">${player.club || '-'}</td>
                    <td class="stat-value">${player.competitions}</td>
                    <td>${player.game_types_played}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading active players:', error);
      }
    }

    // Load player moyenne by category
    async function loadPlayerMoyenne(categoryId) {
      const container = document.getElementById('playerMoyenneTable');
      const header = document.getElementById('moyenneCardHeader');

      if (!categoryId) {
        container.innerHTML = '<div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>';
        header.textContent = 'Top 10 - Moyennes';
        return;
      }

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/statistics/players/moyenne?season=${currentSeason}&category_id=${categoryId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible pour cette cat√©gorie</div>';
            return;
          }

          // Update header with category name
          header.textContent = `Top 10 - ${data[0].category}`;

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Joueur</th>
                  <th>Club</th>
                  <th>Moy.</th>
                  <th>Best</th>
                  <th>Tournois</th>
                </tr>
              </thead>
              <tbody>
                ${data.map((player, i) => `
                  <tr>
                    <td>${createRankBadge(i + 1)}</td>
                    <td class="player-name">${player.player_name}</td>
                    <td class="player-club">${player.club || '-'}</td>
                    <td class="stat-value">${player.avg_moyenne}</td>
                    <td>${player.best_moyenne}</td>
                    <td>${player.tournaments}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading player moyenne:', error);
        container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    // Load player serie by category
    async function loadPlayerSerie(categoryId) {
      const container = document.getElementById('playerSerieTable');
      const header = document.getElementById('serieCardHeader');

      if (!categoryId) {
        container.innerHTML = '<div class="empty-state">S√©lectionnez une cat√©gorie pour voir les statistiques</div>';
        header.textContent = 'Top 10 - S√©ries';
        return;
      }

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/statistics/players/serie?season=${currentSeason}&category_id=${categoryId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible pour cette cat√©gorie</div>';
            return;
          }

          // Update header with category name
          header.textContent = `Top 10 - ${data[0].category}`;

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Joueur</th>
                  <th>Club</th>
                  <th>S√©rie</th>
                  <th>Tournoi</th>
                </tr>
              </thead>
              <tbody>
                ${data.map((player, i) => `
                  <tr>
                    <td>${createRankBadge(i + 1)}</td>
                    <td class="player-name">${player.player_name}</td>
                    <td class="player-club">${player.club || '-'}</td>
                    <td class="stat-value">${player.best_serie}</td>
                    <td>${player.tournament}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading player serie:', error);
        container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    // Load new players
    async function loadNewPlayers(season = null) {
      const container = document.getElementById('newPlayersTable');
      const header = document.getElementById('newPlayersCardHeader');
      const targetSeason = season || currentSeason;

      header.textContent = `Premi√®re participation en ${targetSeason}`;
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/statistics/players/new?season=${targetSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucun nouveau joueur pour cette saison</div>';
            return;
          }

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Joueur</th>
                  <th>Club</th>
                  <th>Comp√©titions jou√©es</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(player => `
                  <tr>
                    <td class="player-name">${player.player_name}</td>
                    <td class="player-club">${player.club || '-'}</td>
                    <td class="stat-value">${player.tournaments_played}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading new players:', error);
        container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    // Load multi-category players stats (from players file, not season-specific)
    async function loadMultiCatStats() {
      const container = document.getElementById('multiCatTable');

      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

      try {
        const response = await fetch(`${API_URL}/statistics/players/multi-category`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();
          const total = data.total || 0;

          if (total === 0) {
            container.innerHTML = '<div class="empty-state">Aucun joueur actif</div>';
            return;
          }

          const categories = [
            { count: 4, label: '4 cat√©gories', color: '#1F4788' },
            { count: 3, label: '3 cat√©gories', color: '#28a745' },
            { count: 2, label: '2 cat√©gories', color: '#ffc107' },
            { count: 1, label: '1 cat√©gorie', color: '#6c757d' },
            { count: 0, label: '0 cat√©gorie (NC)', color: '#dc3545' }
          ];

          container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
              ${categories.map(cat => {
                const count = data[`cat_${cat.count}`] || 0;
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                  <div class="stat-card-clickable" onclick="showPlayerListModal(${cat.count})" style="background: ${cat.color}15; border-left: 4px solid ${cat.color}; padding: 15px; border-radius: 8px;">
                    <div style="font-size: 28px; font-weight: bold; color: ${cat.color};">${count}</div>
                    <div style="color: #666; margin-top: 5px;">${cat.label}</div>
                    <div style="color: ${cat.color}; font-weight: bold; font-size: 14px; margin-top: 5px;">${percent}%</div>
                  </div>
                `;
              }).join('')}
            </div>
            <div style="text-align: center; color: #666; font-size: 14px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
              Total joueurs actifs: <strong>${total}</strong>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading multi-category stats:', error);
        container.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    // Load participation stats
    async function loadParticipation() {
      const container = document.getElementById('participationTable');
      try {
        const response = await fetch(`${API_URL}/statistics/general/participation?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible</div>';
            return;
          }

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Mode</th>
                  <th>Inscriptions</th>
                  <th>Pr√©sents</th>
                  <th>Forfaits</th>
                  <th>Taux Forfait</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(row => `
                  <tr>
                    <td class="player-name">${getModeDisplayName(row.game_type)}</td>
                    <td>${row.total_inscriptions}</td>
                    <td class="stat-value">${row.participated}</td>
                    <td style="color: #dc3545;">${row.forfaits}</td>
                    <td>${row.forfait_rate}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading participation:', error);
      }
    }

    // Load categories
    async function loadCategories() {
      const container = document.getElementById('categoriesTable');
      try {
        const response = await fetch(`${API_URL}/statistics/general/categories?season=${currentSeason}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const data = await response.json();

          if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">Aucune donn√©e disponible</div>';
            return;
          }

          container.innerHTML = `
            <table class="ranking-table">
              <thead>
                <tr>
                  <th>Cat√©gorie</th>
                  <th>Mode</th>
                  <th>Joueurs</th>
                  <th>Participations</th>
                  <th>Tournois</th>
                </tr>
              </thead>
              <tbody>
                ${data.map(row => `
                  <tr>
                    <td class="player-name">${row.category}</td>
                    <td>${getModeDisplayName(row.game_type)}</td>
                    <td class="stat-value">${row.unique_players}</td>
                    <td>${row.total_participations}</td>
                    <td>${row.tournaments_played}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    // Show player list modal
    async function showPlayerListModal(numCategories) {
      const modal = document.getElementById('playerListModal');
      const modalTitle = document.getElementById('playerListModalTitle');
      const modalBody = document.getElementById('playerListModalBody');

      const labels = {
        4: '4 cat√©gories',
        3: '3 cat√©gories',
        2: '2 cat√©gories',
        1: '1 cat√©gorie',
        0: '0 cat√©gorie (NC partout)'
      };

      modalTitle.textContent = `Joueurs en ${labels[numCategories]}`;
      modalBody.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      modal.classList.add('active');

      try {
        const response = await fetch(`${API_URL}/statistics/players/multi-category/list?categories=${numCategories}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
          const players = await response.json();

          if (players.length === 0) {
            modalBody.innerHTML = '<div class="empty-state">Aucun joueur trouv√©</div>';
            return;
          }

          modalBody.innerHTML = players.map(player => `
            <div class="player-list-item">
              <div>
                <div class="player-list-name">${player.player_name}</div>
                <div class="player-list-club">${player.club || 'Club non renseign√©'}</div>
                ${player.game_types ? `<div style="font-size: 11px; color: #1F4788; margin-top: 3px;">${player.game_types}</div>` : ''}
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading player list:', error);
        modalBody.innerHTML = '<div class="empty-state">Erreur de chargement</div>';
      }
    }

    // Close modal function
    function closePlayerListModal() {
      document.getElementById('playerListModal').classList.remove('active');
    }

    // Initialize
    loadSeasons();
  </script>

  <!-- Player List Modal -->
  <div id="playerListModal" class="modal-overlay" onclick="if(event.target === this) closePlayerListModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="playerListModalTitle">Joueurs</h3>
        <button class="modal-close" onclick="closePlayerListModal()">&times;</button>
      </div>
      <div class="modal-body" id="playerListModalBody">
      </div>
    </div>
  </div>
</body>
</html>
